/usr/licensed/anaconda/5.0.1/lib/python2.7/site-packages/h5py/__init__.py:34: FutureWarning: Conversion of the second argument of issubdtype from `float` to `np.floating` is deprecated. In future, it will be treated as `np.float64 == np.dtype(float).type`.
  from ._conv import register_converters as _register_converters
#INFO: **** input file is /tigress/xingz/pydmfet/examples/Be.py ****
from pydmfet import locints, sdmfet, oep, tools
from pyscf import gto, scf,dft, ao2mo,cc
import numpy as np
from pyscf.tools import molden, cubegen
import copy,time

DMguess  = None

bondlengths = np.arange(1.8, 4.1, 0.1)
energies = []

bas = 'sto-6g'

for bondlength in bondlengths:

    nat = 30
    mol = gto.Mole()
    mol.atom = []
    r = 0.5 * bondlength / np.sin(np.pi/nat)
    for i in range(nat):
        theta = i * (2*np.pi/nat)
        mol.atom.append(('Be', (r*np.cos(theta), r*np.sin(theta), 0)))

    mol.basis = bas
    mol.build(max_memory=16000, verbose=4)

    mf = scf.RHF(mol)
    #mf = dft.RKS(mol)
    #mf.xc = 'pbe,pbe'
    #mf.smear_sigma = 0.005
    mf.max_cycle = 50
    mf.scf()

    #P=mf.make_rdm1()
    #tools.MatPrint(P,"P_ref_ao")
    #cubegen.density(mol, "h20_dens.cube", P, nx=100, ny=100, nz=100)
    print 'e_mf = ',  mf.e_tot
    continue
    if ( True ):   
#        ENUCL = mf.mol.energy_nuc()
#        OEI   = np.dot(np.dot(mf.mo_coeff.T, mol.intor('cint1e_kin_sph') + mol.intor('cint1e_nuc_sph')), mf.mo_coeff)
#        TEI   = ao2mo.outcore.full_iofree(mol, mf.mo_coeff, compact=False).reshape(mol.nao_nr(), mol.nao_nr(), mol.nao_nr(), mol.nao_nr())
#        import chemps2
#        Energy, OneDM = chemps2.solve( ENUCL, OEI, OEI, TEI, mol.nao_nr(), mol.nelectron, mol.nao_nr(), 0.0, False )
#        print "bl =", bondlength," and energy =", Energy

        mycc = cc.CCSD(mf).run()
	et=0.0
        #et = mycc.ccsd_t()
        e_hf = mf.e_tot
        e_ccsd = e_hf + mycc.e_corr + et

        print 'e_tot = ', e_ccsd    #-4.96124910741
        
    else:
        myInts = locints.LocalIntegrals( mf, range( mol.nao_nr() ), 'meta_lowdin' )
        #myInts.loc_molden( 'hydrogen-loc.molden' )
        #myInts.TI_OK = True # Only s functions

	nbas =  mol.nao_nr()
	natoms = mol.natm

	impAtom = np.zeros([natoms], dtype=int)
	for i in range(20):
	    impAtom[i] = 1

	ghost_frag = 1-impAtom
	ghost_env = 1-ghost_frag

	mol_frag = gto.Mole()
	mol_frag.atom = tools.add_ghost(mol.atom, ghost_frag)
	mol_frag.basis = bas
	mol_frag.build(max_memory = 16000,verbose = 4)
	'''
	mf_frag = dft.RKS(mol_frag)
        mf_frag.xc = 'pbe,pbe'
        mf_frag.smear_sigma = 0.00
        mf_frag.scf()
        P_frag=mf_frag.make_rdm1()
        cubegen.density(mol_frag, "h10_dens_1.cube", P_frag, nx=100, ny=100, nz=100)
	'''

	mol_env = gto.Mole()
	mol_env.atom = tools.add_ghost(mol.atom, ghost_env)
	mol_env.basis =  bas
	mol_env.build(max_memory = 16000,verbose = 4)

	'''
	mf_env = dft.RKS(mol_env)
        mf_env.xc = 'pbe,pbe'
        mf_env.smear_sigma = 0.00
        mf_env.scf()
        P_env=mf_env.make_rdm1()
        cubegen.density(mol_env, "h10_dens_2.cube", P_env, nx=100, ny=100, nz=100)
	exit()
	'''



	aoslice = mol.aoslice_by_atom()
	impurities = np.zeros([nbas], dtype = int)
	for i in range(natoms):
	    if(impAtom[i] == 1):
		impurities[aoslice[i,2]:aoslice[i,3]] = 1

	Ne_frag = 20
	boundary_atoms = np.zeros((natoms))
	boundary_atoms[20:40] = 1.0
	#boundary_atoms[19] = -1
	boundary_atoms2 = np.zeros((natoms),dtype =int)
	#boundary_atoms2[9] = -1
	boundary_atoms2[0:20] = 1

	boundary_atoms = None
	boundary_atoms2 =None

	umat=None
	P_frag=None
	P_env=None
	params = oep.OEPparams(algorithm = '2011', opt_method = 'L-BFGS-B', \
                       ftol = 1e-11, gtol = 1e-5,diffP_tol=1e-5, outer_maxit = 200, maxit = 200,l2_lambda = 0.0, oep_print = 0)
	theDMFET = sdmfet.DMFET( mf, mol_frag, mol_env,myInts,impurities, impAtom, Ne_frag, boundary_atoms=boundary_atoms, boundary_atoms2=boundary_atoms2,\
                         umat = umat, P_frag_ao = P_frag, P_env_ao = P_env, \
                         dim_imp = nbas, dim_bath=nbas, dim_big =nbas, smear_sigma = 0.005, oep_params=params,ecw_method='hf', mf_method = mf.xc)

	umat = theDMFET.embedding_potential()

	exit()

	#write subspace orbitals
	transfo = np.dot( myInts.ao2loc, theDMFET.loc2sub )
	filename =  'hydrogen-sub.molden'
	with open( filename, 'w' ) as thefile:
            molden.header( myInts.mol, thefile )
            molden.orbital_coeff( myInts.mol, thefile, transfo )


        umat = theDMFET.embedding_potential()
	print umat
	exit()
	energy = theDMFET.correction_energy()

#INFO: ******************** input file end ********************


System: ('Linux', 'tigercpu.princeton.edu', '3.10.0-693.21.1.el7.x86_64', '#1 SMP Wed Mar 7 15:59:45 EST 2018', 'x86_64', 'x86_64')  Threads 40
Python 2.7.14 |Anaconda, Inc.| (default, Oct 16 2017, 17:29:19) 
[GCC 7.2.0]
numpy 1.14.3  scipy 1.1.0
Date: Thu Jun  7 01:16:37 2018
PySCF version 1.4.2
PySCF path  /tigress/xingz/pyscf/pyscf
GIT ORIG_HEAD e0edd131499dcc18d035a120533a8a1ddda110d4
GIT HEAD      e0edd131499dcc18d035a120533a8a1ddda110d4

[INPUT] VERBOSE 4
[INPUT] num atoms = 30
[INPUT] num electrons = 120
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT]  1 Be     8.610095010155   0.000000000000   0.000000000000 AA   16.270721475677   0.000000000000   0.000000000000 Bohr
[INPUT]  2 Be     8.421943776273   1.790139411663   0.000000000000 AA   15.915167173642   3.382873212833   0.000000000000 Bohr
[INPUT]  3 Be     7.865713186398   3.502041140994   0.000000000000 AA   14.864043696673   6.617898633438   0.000000000000 Bohr
[INPUT]  4 Be     6.965713186398   5.060886867806   0.000000000000 AA   13.163290184564   9.563690127562   0.000000000000 Bohr
[INPUT]  5 Be     5.761278094952   6.398547553665   0.000000000000 AA   10.887237726916  12.091502471434   0.000000000000 Bohr
[INPUT]  6 Be     4.305047505078   7.456561007792   0.000000000000 AA    8.135360737839  14.090858135838   0.000000000000 Bohr
[INPUT]  7 Be     2.660665681321   8.188686965328   0.000000000000 AA    5.027929446726  15.474375684266   0.000000000000 Bohr
[INPUT]  8 Be     0.900000000000   8.562928008800   0.000000000000 AA    1.700753512109  16.181588761000   0.000000000000 Bohr
[INPUT]  9 Be    -0.900000000000   8.562928008800   0.000000000000 AA   -1.700753512109  16.181588761000   0.000000000000 Bohr
[INPUT] 10 Be    -2.660665681321   8.188686965328   0.000000000000 AA   -5.027929446726  15.474375684266   0.000000000000 Bohr
[INPUT] 11 Be    -4.305047505078   7.456561007792   0.000000000000 AA   -8.135360737839  14.090858135838   0.000000000000 Bohr
[INPUT] 12 Be    -5.761278094952   6.398547553665   0.000000000000 AA  -10.887237726916  12.091502471434   0.000000000000 Bohr
[INPUT] 13 Be    -6.965713186398   5.060886867806   0.000000000000 AA  -13.163290184564   9.563690127562   0.000000000000 Bohr
[INPUT] 14 Be    -7.865713186398   3.502041140994   0.000000000000 AA  -14.864043696673   6.617898633438   0.000000000000 Bohr
[INPUT] 15 Be    -8.421943776273   1.790139411663   0.000000000000 AA  -15.915167173642   3.382873212833   0.000000000000 Bohr
[INPUT] 16 Be    -8.610095010155   0.000000000000   0.000000000000 AA  -16.270721475677   0.000000000000   0.000000000000 Bohr
[INPUT] 17 Be    -8.421943776273  -1.790139411663   0.000000000000 AA  -15.915167173642  -3.382873212833   0.000000000000 Bohr
[INPUT] 18 Be    -7.865713186398  -3.502041140994   0.000000000000 AA  -14.864043696673  -6.617898633438   0.000000000000 Bohr
[INPUT] 19 Be    -6.965713186398  -5.060886867806   0.000000000000 AA  -13.163290184564  -9.563690127562   0.000000000000 Bohr
[INPUT] 20 Be    -5.761278094952  -6.398547553665   0.000000000000 AA  -10.887237726916 -12.091502471434   0.000000000000 Bohr
[INPUT] 21 Be    -4.305047505078  -7.456561007792   0.000000000000 AA   -8.135360737839 -14.090858135838   0.000000000000 Bohr
[INPUT] 22 Be    -2.660665681321  -8.188686965328   0.000000000000 AA   -5.027929446726 -15.474375684266   0.000000000000 Bohr
[INPUT] 23 Be    -0.900000000000  -8.562928008800   0.000000000000 AA   -1.700753512109 -16.181588761000   0.000000000000 Bohr
[INPUT] 24 Be     0.900000000000  -8.562928008800   0.000000000000 AA    1.700753512109 -16.181588761000   0.000000000000 Bohr
[INPUT] 25 Be     2.660665681321  -8.188686965328   0.000000000000 AA    5.027929446726 -15.474375684266   0.000000000000 Bohr
[INPUT] 26 Be     4.305047505078  -7.456561007792   0.000000000000 AA    8.135360737839 -14.090858135838   0.000000000000 Bohr
[INPUT] 27 Be     5.761278094952  -6.398547553665   0.000000000000 AA   10.887237726916 -12.091502471434   0.000000000000 Bohr
[INPUT] 28 Be     6.965713186398  -5.060886867806   0.000000000000 AA   13.163290184564  -9.563690127562   0.000000000000 Bohr
[INPUT] 29 Be     7.865713186398  -3.502041140994   0.000000000000 AA   14.864043696673  -6.617898633438   0.000000000000 Bohr
[INPUT] 30 Be     8.421943776273  -1.790139411663   0.000000000000 AA   15.915167173642  -3.382873212833   0.000000000000 Bohr
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [6    /1   ]  312.8704937       0.00916359628
                                57.36446253       0.04936149294
                                16.0485094        0.1685383049
                                5.513096119       0.3705627997
                                2.140896553       0.4164915298
                                0.8817394283      0.1303340841
[INPUT] 0    0    [6    /1   ]  13.63324744       -0.01325278809
                                2.698375464       -0.04699171014
                                0.8386530829      -0.03378537151
                                0.3226600698      0.2502417861
                                0.1401314882      0.5951172526
                                0.0642325139      0.2407061763
[INPUT] 1    0    [6    /1   ]  13.63324744       0.0037596966
                                2.698375464       0.0376793698
                                0.8386530829      0.1738967435
                                0.3226600698      0.4180364347
                                0.1401314882      0.4258595477
                                0.0642325139      0.1017082955
nuclear repulsion = 496.754291775849
number of shells = 90
number of NR pGTOs = 900
number of NR cGTOs = 150
basis = sto-6g
ecp = {}
CPU time:         3.09


******** <class 'pyscf.scf.hf.RHF'> flags ********
method = RHF
initial guess = minao
damping factor = 0
level shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
DIIS start cycle = 1
DIIS space = 8
SCF tol = 1e-09
SCF gradient tol = None
max. SCF cycles = 50
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /tigress/xingz/pydmfet/examples/tmpdUue7X
max_memory 16000 MB (current use 64 MB)
Set gradient conv threshold to 3.16228e-05
init E= -445.605308463663

WARN: HOMO -0.0435132330200968 == LUMO -0.0435132330200966

cycle= 1 E= -435.172520829571  delta_E= 10.4  |g|= 0.534  |ddm|= 7.29

WARN: HOMO -0.0265340401387712 == LUMO -0.0264335351492938

cycle= 2 E= -435.862116280939  delta_E= -0.69  |g|= 0.327  |ddm|= 3.26
  HOMO = -0.105699703948436  LUMO = -0.0132910013547619
cycle= 3 E= -436.412861992333  delta_E= -0.551  |g|= 0.182  |ddm|= 1.97
  HOMO = -0.21112758132716  LUMO = 0.122534843827542
cycle= 4 E= -436.438523344518  delta_E= -0.0257  |g|= 0.0169  |ddm|= 0.823
  HOMO = -0.18696544636892  LUMO = 0.108448065868175
cycle= 5 E= -436.438747005788  delta_E= -0.000224  |g|= 0.00628  |ddm|= 0.0566
  HOMO = -0.188228964056725  LUMO = 0.109966172003363
cycle= 6 E= -436.438782828647  delta_E= -3.58e-05  |g|= 0.0011  |ddm|= 0.0288
  HOMO = -0.188317939059289  LUMO = 0.110163560139425
cycle= 7 E= -436.438783957885  delta_E= -1.13e-06  |g|= 0.000138  |ddm|= 0.00554
  HOMO = -0.188323742550206  LUMO = 0.110166505351495
cycle= 8 E= -436.43878398365  delta_E= -2.58e-08  |g|= 3.02e-05  |ddm|= 0.000544
  HOMO = -0.188318611543467  LUMO = 0.110161756608975
cycle= 9 E= -436.438783984915  delta_E= -1.27e-09  |g|= 4.28e-06  |ddm|= 0.000119
  HOMO = -0.188319144478074  LUMO = 0.110162018156608
cycle= 10 E= -436.438783984932  delta_E= -1.75e-11  |g|= 6.51e-07  |ddm|= 1.6e-05
  HOMO = -0.188319113413819  LUMO = 0.110161995010163
Extra cycle  E= -436.438783984935  delta_E= -3.07e-12  |g|= 2.93e-07  |ddm|= 1.83e-06
converged SCF energy = -436.438783984935
e_mf =  -436.43878398493547
#INFO: **** input file is /tigress/xingz/pydmfet/examples/Be.py ****
from pydmfet import locints, sdmfet, oep, tools
from pyscf import gto, scf,dft, ao2mo,cc
import numpy as np
from pyscf.tools import molden, cubegen
import copy,time

DMguess  = None

bondlengths = np.arange(1.8, 4.1, 0.1)
energies = []

bas = 'sto-6g'

for bondlength in bondlengths:

    nat = 30
    mol = gto.Mole()
    mol.atom = []
    r = 0.5 * bondlength / np.sin(np.pi/nat)
    for i in range(nat):
        theta = i * (2*np.pi/nat)
        mol.atom.append(('Be', (r*np.cos(theta), r*np.sin(theta), 0)))

    mol.basis = bas
    mol.build(max_memory=16000, verbose=4)

    mf = scf.RHF(mol)
    #mf = dft.RKS(mol)
    #mf.xc = 'pbe,pbe'
    #mf.smear_sigma = 0.005
    mf.max_cycle = 50
    mf.scf()

    #P=mf.make_rdm1()
    #tools.MatPrint(P,"P_ref_ao")
    #cubegen.density(mol, "h20_dens.cube", P, nx=100, ny=100, nz=100)
    print 'e_mf = ',  mf.e_tot
    continue
    if ( True ):   
#        ENUCL = mf.mol.energy_nuc()
#        OEI   = np.dot(np.dot(mf.mo_coeff.T, mol.intor('cint1e_kin_sph') + mol.intor('cint1e_nuc_sph')), mf.mo_coeff)
#        TEI   = ao2mo.outcore.full_iofree(mol, mf.mo_coeff, compact=False).reshape(mol.nao_nr(), mol.nao_nr(), mol.nao_nr(), mol.nao_nr())
#        import chemps2
#        Energy, OneDM = chemps2.solve( ENUCL, OEI, OEI, TEI, mol.nao_nr(), mol.nelectron, mol.nao_nr(), 0.0, False )
#        print "bl =", bondlength," and energy =", Energy

        mycc = cc.CCSD(mf).run()
	et=0.0
        #et = mycc.ccsd_t()
        e_hf = mf.e_tot
        e_ccsd = e_hf + mycc.e_corr + et

        print 'e_tot = ', e_ccsd    #-4.96124910741
        
    else:
        myInts = locints.LocalIntegrals( mf, range( mol.nao_nr() ), 'meta_lowdin' )
        #myInts.loc_molden( 'hydrogen-loc.molden' )
        #myInts.TI_OK = True # Only s functions

	nbas =  mol.nao_nr()
	natoms = mol.natm

	impAtom = np.zeros([natoms], dtype=int)
	for i in range(20):
	    impAtom[i] = 1

	ghost_frag = 1-impAtom
	ghost_env = 1-ghost_frag

	mol_frag = gto.Mole()
	mol_frag.atom = tools.add_ghost(mol.atom, ghost_frag)
	mol_frag.basis = bas
	mol_frag.build(max_memory = 16000,verbose = 4)
	'''
	mf_frag = dft.RKS(mol_frag)
        mf_frag.xc = 'pbe,pbe'
        mf_frag.smear_sigma = 0.00
        mf_frag.scf()
        P_frag=mf_frag.make_rdm1()
        cubegen.density(mol_frag, "h10_dens_1.cube", P_frag, nx=100, ny=100, nz=100)
	'''

	mol_env = gto.Mole()
	mol_env.atom = tools.add_ghost(mol.atom, ghost_env)
	mol_env.basis =  bas
	mol_env.build(max_memory = 16000,verbose = 4)

	'''
	mf_env = dft.RKS(mol_env)
        mf_env.xc = 'pbe,pbe'
        mf_env.smear_sigma = 0.00
        mf_env.scf()
        P_env=mf_env.make_rdm1()
        cubegen.density(mol_env, "h10_dens_2.cube", P_env, nx=100, ny=100, nz=100)
	exit()
	'''



	aoslice = mol.aoslice_by_atom()
	impurities = np.zeros([nbas], dtype = int)
	for i in range(natoms):
	    if(impAtom[i] == 1):
		impurities[aoslice[i,2]:aoslice[i,3]] = 1

	Ne_frag = 20
	boundary_atoms = np.zeros((natoms))
	boundary_atoms[20:40] = 1.0
	#boundary_atoms[19] = -1
	boundary_atoms2 = np.zeros((natoms),dtype =int)
	#boundary_atoms2[9] = -1
	boundary_atoms2[0:20] = 1

	boundary_atoms = None
	boundary_atoms2 =None

	umat=None
	P_frag=None
	P_env=None
	params = oep.OEPparams(algorithm = '2011', opt_method = 'L-BFGS-B', \
                       ftol = 1e-11, gtol = 1e-5,diffP_tol=1e-5, outer_maxit = 200, maxit = 200,l2_lambda = 0.0, oep_print = 0)
	theDMFET = sdmfet.DMFET( mf, mol_frag, mol_env,myInts,impurities, impAtom, Ne_frag, boundary_atoms=boundary_atoms, boundary_atoms2=boundary_atoms2,\
                         umat = umat, P_frag_ao = P_frag, P_env_ao = P_env, \
                         dim_imp = nbas, dim_bath=nbas, dim_big =nbas, smear_sigma = 0.005, oep_params=params,ecw_method='hf', mf_method = mf.xc)

	umat = theDMFET.embedding_potential()

	exit()

	#write subspace orbitals
	transfo = np.dot( myInts.ao2loc, theDMFET.loc2sub )
	filename =  'hydrogen-sub.molden'
	with open( filename, 'w' ) as thefile:
            molden.header( myInts.mol, thefile )
            molden.orbital_coeff( myInts.mol, thefile, transfo )


        umat = theDMFET.embedding_potential()
	print umat
	exit()
	energy = theDMFET.correction_energy()

#INFO: ******************** input file end ********************


System: ('Linux', 'tigercpu.princeton.edu', '3.10.0-693.21.1.el7.x86_64', '#1 SMP Wed Mar 7 15:59:45 EST 2018', 'x86_64', 'x86_64')  Threads 40
Python 2.7.14 |Anaconda, Inc.| (default, Oct 16 2017, 17:29:19) 
[GCC 7.2.0]
numpy 1.14.3  scipy 1.1.0
Date: Thu Jun  7 01:16:40 2018
PySCF version 1.4.2
PySCF path  /tigress/xingz/pyscf/pyscf
GIT ORIG_HEAD e0edd131499dcc18d035a120533a8a1ddda110d4
GIT HEAD      e0edd131499dcc18d035a120533a8a1ddda110d4

[INPUT] VERBOSE 4
[INPUT] num atoms = 30
[INPUT] num electrons = 120
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT]  1 Be     9.088433621830   0.000000000000   0.000000000000 AA   17.174650446548   0.000000000000   0.000000000000 Bohr
[INPUT]  2 Be     8.889829541622   1.889591601200   0.000000000000 AA   16.799343127733   3.570810613546   0.000000000000 Bohr
[INPUT]  3 Be     8.302697252309   3.696598982161   0.000000000000 AA   15.689823902044   6.985559668629   0.000000000000 Bohr
[INPUT]  4 Be     7.352697252309   5.342047249351   0.000000000000 AA   13.894584083707  10.095006245759   0.000000000000 Bohr
[INPUT]  5 Be     6.081349100228   6.754022417758   0.000000000000 AA   11.492084267300  12.763252608735   0.000000000000 Bohr
[INPUT]  6 Be     4.544216810915   7.870814397114   0.000000000000 AA    8.587325223274  14.873683587829   0.000000000000 Bohr
[INPUT]  7 Be     2.808480441394   8.643614018958   0.000000000000 AA    5.307258860433  16.334063222281   0.000000000000 Bohr
[INPUT]  8 Be     0.950000000000   9.038646231511   0.000000000000 AA    1.795239818337  17.080565914389   0.000000000000 Bohr
[INPUT]  9 Be    -0.950000000000   9.038646231511   0.000000000000 AA   -1.795239818337  17.080565914389   0.000000000000 Bohr
[INPUT] 10 Be    -2.808480441394   8.643614018958   0.000000000000 AA   -5.307258860433  16.334063222281   0.000000000000 Bohr
[INPUT] 11 Be    -4.544216810915   7.870814397114   0.000000000000 AA   -8.587325223274  14.873683587829   0.000000000000 Bohr
[INPUT] 12 Be    -6.081349100228   6.754022417758   0.000000000000 AA  -11.492084267300  12.763252608735   0.000000000000 Bohr
[INPUT] 13 Be    -7.352697252309   5.342047249351   0.000000000000 AA  -13.894584083707  10.095006245759   0.000000000000 Bohr
[INPUT] 14 Be    -8.302697252309   3.696598982161   0.000000000000 AA  -15.689823902044   6.985559668629   0.000000000000 Bohr
[INPUT] 15 Be    -8.889829541622   1.889591601200   0.000000000000 AA  -16.799343127733   3.570810613546   0.000000000000 Bohr
[INPUT] 16 Be    -9.088433621830   0.000000000000   0.000000000000 AA  -17.174650446548   0.000000000000   0.000000000000 Bohr
[INPUT] 17 Be    -8.889829541622  -1.889591601200   0.000000000000 AA  -16.799343127733  -3.570810613546   0.000000000000 Bohr
[INPUT] 18 Be    -8.302697252309  -3.696598982161   0.000000000000 AA  -15.689823902044  -6.985559668629   0.000000000000 Bohr
[INPUT] 19 Be    -7.352697252309  -5.342047249351   0.000000000000 AA  -13.894584083707 -10.095006245759   0.000000000000 Bohr
[INPUT] 20 Be    -6.081349100228  -6.754022417758   0.000000000000 AA  -11.492084267300 -12.763252608735   0.000000000000 Bohr
[INPUT] 21 Be    -4.544216810915  -7.870814397114   0.000000000000 AA   -8.587325223274 -14.873683587829   0.000000000000 Bohr
[INPUT] 22 Be    -2.808480441394  -8.643614018958   0.000000000000 AA   -5.307258860433 -16.334063222281   0.000000000000 Bohr
[INPUT] 23 Be    -0.950000000000  -9.038646231511   0.000000000000 AA   -1.795239818337 -17.080565914389   0.000000000000 Bohr
[INPUT] 24 Be     0.950000000000  -9.038646231511   0.000000000000 AA    1.795239818337 -17.080565914389   0.000000000000 Bohr
[INPUT] 25 Be     2.808480441394  -8.643614018958   0.000000000000 AA    5.307258860433 -16.334063222281   0.000000000000 Bohr
[INPUT] 26 Be     4.544216810915  -7.870814397114   0.000000000000 AA    8.587325223274 -14.873683587829   0.000000000000 Bohr
[INPUT] 27 Be     6.081349100228  -6.754022417758   0.000000000000 AA   11.492084267300 -12.763252608735   0.000000000000 Bohr
[INPUT] 28 Be     7.352697252309  -5.342047249351   0.000000000000 AA   13.894584083707 -10.095006245759   0.000000000000 Bohr
[INPUT] 29 Be     8.302697252309  -3.696598982161   0.000000000000 AA   15.689823902044  -6.985559668629   0.000000000000 Bohr
[INPUT] 30 Be     8.889829541622  -1.889591601200   0.000000000000 AA   16.799343127733  -3.570810613546   0.000000000000 Bohr
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [6    /1   ]  312.8704937       0.00916359628
                                57.36446253       0.04936149294
                                16.0485094        0.1685383049
                                5.513096119       0.3705627997
                                2.140896553       0.4164915298
                                0.8817394283      0.1303340841
[INPUT] 0    0    [6    /1   ]  13.63324744       -0.01325278809
                                2.698375464       -0.04699171014
                                0.8386530829      -0.03378537151
                                0.3226600698      0.2502417861
                                0.1401314882      0.5951172526
                                0.0642325139      0.2407061763
[INPUT] 1    0    [6    /1   ]  13.63324744       0.0037596966
                                2.698375464       0.0376793698
                                0.8386530829      0.1738967435
                                0.3226600698      0.4180364347
                                0.1401314882      0.4258595477
                                0.0642325139      0.1017082955
nuclear repulsion = 470.609329050805
number of shells = 90
number of NR pGTOs = 900
number of NR cGTOs = 150
basis = sto-6g
ecp = {}
CPU time:       124.23


******** <class 'pyscf.scf.hf.RHF'> flags ********
method = RHF
initial guess = minao
damping factor = 0
level shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
DIIS start cycle = 1
DIIS space = 8
SCF tol = 1e-09
SCF gradient tol = None
max. SCF cycles = 50
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /tigress/xingz/pydmfet/examples/tmpYj2Y1v
max_memory 16000 MB (current use 164 MB)
Set gradient conv threshold to 3.16228e-05
init E= -444.171545617252

WARN: HOMO -0.0243295755266829 == LUMO -0.0240768215097345

cycle= 1 E= -436.027202929364  delta_E= 8.14  |g|= 0.613  |ddm|= 7.01
  HOMO = -0.103339247609278  LUMO = 0.0284012419781531
cycle= 2 E= -436.77293147572  delta_E= -0.746  |g|= 0.247  |ddm|= 2.88
  HOMO = -0.21346736873062  LUMO = 0.125470893866612
cycle= 3 E= -436.824404261986  delta_E= -0.0515  |g|= 0.0289  |ddm|= 1.28
  HOMO = -0.186814972855047  LUMO = 0.118626426045175
cycle= 4 E= -436.825079258515  delta_E= -0.000675  |g|= 0.00134  |ddm|= 0.133
  HOMO = -0.18764859922894  LUMO = 0.119404359310818
cycle= 5 E= -436.825080933499  delta_E= -1.67e-06  |g|= 0.000246  |ddm|= 0.00477
  HOMO = -0.188067384465612  LUMO = 0.119873614827615
cycle= 6 E= -436.825080989502  delta_E= -5.6e-08  |g|= 1.66e-05  |ddm|= 0.00107
  HOMO = -0.188035762530967  LUMO = 0.119838014767843
cycle= 7 E= -436.825080989736  delta_E= -2.34e-10  |g|= 4.5e-06  |ddm|= 8.84e-05
  HOMO = -0.188040976169434  LUMO = 0.119843579075448
Extra cycle  E= -436.825080989754  delta_E= -1.78e-11  |g|= 1.32e-06  |ddm|= 1.39e-05
converged SCF energy = -436.825080989754
e_mf =  -436.8250809897542
#INFO: **** input file is /tigress/xingz/pydmfet/examples/Be.py ****
from pydmfet import locints, sdmfet, oep, tools
from pyscf import gto, scf,dft, ao2mo,cc
import numpy as np
from pyscf.tools import molden, cubegen
import copy,time

DMguess  = None

bondlengths = np.arange(1.8, 4.1, 0.1)
energies = []

bas = 'sto-6g'

for bondlength in bondlengths:

    nat = 30
    mol = gto.Mole()
    mol.atom = []
    r = 0.5 * bondlength / np.sin(np.pi/nat)
    for i in range(nat):
        theta = i * (2*np.pi/nat)
        mol.atom.append(('Be', (r*np.cos(theta), r*np.sin(theta), 0)))

    mol.basis = bas
    mol.build(max_memory=16000, verbose=4)

    mf = scf.RHF(mol)
    #mf = dft.RKS(mol)
    #mf.xc = 'pbe,pbe'
    #mf.smear_sigma = 0.005
    mf.max_cycle = 50
    mf.scf()

    #P=mf.make_rdm1()
    #tools.MatPrint(P,"P_ref_ao")
    #cubegen.density(mol, "h20_dens.cube", P, nx=100, ny=100, nz=100)
    print 'e_mf = ',  mf.e_tot
    continue
    if ( True ):   
#        ENUCL = mf.mol.energy_nuc()
#        OEI   = np.dot(np.dot(mf.mo_coeff.T, mol.intor('cint1e_kin_sph') + mol.intor('cint1e_nuc_sph')), mf.mo_coeff)
#        TEI   = ao2mo.outcore.full_iofree(mol, mf.mo_coeff, compact=False).reshape(mol.nao_nr(), mol.nao_nr(), mol.nao_nr(), mol.nao_nr())
#        import chemps2
#        Energy, OneDM = chemps2.solve( ENUCL, OEI, OEI, TEI, mol.nao_nr(), mol.nelectron, mol.nao_nr(), 0.0, False )
#        print "bl =", bondlength," and energy =", Energy

        mycc = cc.CCSD(mf).run()
	et=0.0
        #et = mycc.ccsd_t()
        e_hf = mf.e_tot
        e_ccsd = e_hf + mycc.e_corr + et

        print 'e_tot = ', e_ccsd    #-4.96124910741
        
    else:
        myInts = locints.LocalIntegrals( mf, range( mol.nao_nr() ), 'meta_lowdin' )
        #myInts.loc_molden( 'hydrogen-loc.molden' )
        #myInts.TI_OK = True # Only s functions

	nbas =  mol.nao_nr()
	natoms = mol.natm

	impAtom = np.zeros([natoms], dtype=int)
	for i in range(20):
	    impAtom[i] = 1

	ghost_frag = 1-impAtom
	ghost_env = 1-ghost_frag

	mol_frag = gto.Mole()
	mol_frag.atom = tools.add_ghost(mol.atom, ghost_frag)
	mol_frag.basis = bas
	mol_frag.build(max_memory = 16000,verbose = 4)
	'''
	mf_frag = dft.RKS(mol_frag)
        mf_frag.xc = 'pbe,pbe'
        mf_frag.smear_sigma = 0.00
        mf_frag.scf()
        P_frag=mf_frag.make_rdm1()
        cubegen.density(mol_frag, "h10_dens_1.cube", P_frag, nx=100, ny=100, nz=100)
	'''

	mol_env = gto.Mole()
	mol_env.atom = tools.add_ghost(mol.atom, ghost_env)
	mol_env.basis =  bas
	mol_env.build(max_memory = 16000,verbose = 4)

	'''
	mf_env = dft.RKS(mol_env)
        mf_env.xc = 'pbe,pbe'
        mf_env.smear_sigma = 0.00
        mf_env.scf()
        P_env=mf_env.make_rdm1()
        cubegen.density(mol_env, "h10_dens_2.cube", P_env, nx=100, ny=100, nz=100)
	exit()
	'''



	aoslice = mol.aoslice_by_atom()
	impurities = np.zeros([nbas], dtype = int)
	for i in range(natoms):
	    if(impAtom[i] == 1):
		impurities[aoslice[i,2]:aoslice[i,3]] = 1

	Ne_frag = 20
	boundary_atoms = np.zeros((natoms))
	boundary_atoms[20:40] = 1.0
	#boundary_atoms[19] = -1
	boundary_atoms2 = np.zeros((natoms),dtype =int)
	#boundary_atoms2[9] = -1
	boundary_atoms2[0:20] = 1

	boundary_atoms = None
	boundary_atoms2 =None

	umat=None
	P_frag=None
	P_env=None
	params = oep.OEPparams(algorithm = '2011', opt_method = 'L-BFGS-B', \
                       ftol = 1e-11, gtol = 1e-5,diffP_tol=1e-5, outer_maxit = 200, maxit = 200,l2_lambda = 0.0, oep_print = 0)
	theDMFET = sdmfet.DMFET( mf, mol_frag, mol_env,myInts,impurities, impAtom, Ne_frag, boundary_atoms=boundary_atoms, boundary_atoms2=boundary_atoms2,\
                         umat = umat, P_frag_ao = P_frag, P_env_ao = P_env, \
                         dim_imp = nbas, dim_bath=nbas, dim_big =nbas, smear_sigma = 0.005, oep_params=params,ecw_method='hf', mf_method = mf.xc)

	umat = theDMFET.embedding_potential()

	exit()

	#write subspace orbitals
	transfo = np.dot( myInts.ao2loc, theDMFET.loc2sub )
	filename =  'hydrogen-sub.molden'
	with open( filename, 'w' ) as thefile:
            molden.header( myInts.mol, thefile )
            molden.orbital_coeff( myInts.mol, thefile, transfo )


        umat = theDMFET.embedding_potential()
	print umat
	exit()
	energy = theDMFET.correction_energy()

#INFO: ******************** input file end ********************


System: ('Linux', 'tigercpu.princeton.edu', '3.10.0-693.21.1.el7.x86_64', '#1 SMP Wed Mar 7 15:59:45 EST 2018', 'x86_64', 'x86_64')  Threads 40
Python 2.7.14 |Anaconda, Inc.| (default, Oct 16 2017, 17:29:19) 
[GCC 7.2.0]
numpy 1.14.3  scipy 1.1.0
Date: Thu Jun  7 01:16:42 2018
PySCF version 1.4.2
PySCF path  /tigress/xingz/pyscf/pyscf
GIT ORIG_HEAD e0edd131499dcc18d035a120533a8a1ddda110d4
GIT HEAD      e0edd131499dcc18d035a120533a8a1ddda110d4

[INPUT] VERBOSE 4
[INPUT] num atoms = 30
[INPUT] num electrons = 120
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT]  1 Be     9.566772233506   0.000000000000   0.000000000000 AA   18.078579417419   0.000000000000   0.000000000000 Bohr
[INPUT]  2 Be     9.357715306970   1.989043790737   0.000000000000 AA   17.683519081824   3.758748014259   0.000000000000 Bohr
[INPUT]  3 Be     8.739681318220   3.891156823327   0.000000000000 AA   16.515604107414   7.353220703820   0.000000000000 Bohr
[INPUT]  4 Be     7.739681318220   5.623207630896   0.000000000000 AA   14.625877982849  10.626322363957   0.000000000000 Bohr
[INPUT]  5 Be     6.401420105503   7.109497281851   0.000000000000 AA   12.096930807685  13.435002746037   0.000000000000 Bohr
[INPUT]  6 Be     4.783386116753   8.285067786435   0.000000000000 AA    9.039289708710  15.656509039820   0.000000000000 Bohr
[INPUT]  7 Be     2.956295201468   9.098541072587   0.000000000000 AA    5.586588274140  17.193750760296   0.000000000000 Bohr
[INPUT]  8 Be     1.000000000000   9.514364454223   0.000000000000 AA    1.889726124565  17.979543067778   0.000000000000 Bohr
[INPUT]  9 Be    -1.000000000000   9.514364454223   0.000000000000 AA   -1.889726124565  17.979543067778   0.000000000000 Bohr
[INPUT] 10 Be    -2.956295201468   9.098541072587   0.000000000000 AA   -5.586588274140  17.193750760296   0.000000000000 Bohr
[INPUT] 11 Be    -4.783386116753   8.285067786435   0.000000000000 AA   -9.039289708710  15.656509039820   0.000000000000 Bohr
[INPUT] 12 Be    -6.401420105503   7.109497281851   0.000000000000 AA  -12.096930807684  13.435002746037   0.000000000000 Bohr
[INPUT] 13 Be    -7.739681318220   5.623207630896   0.000000000000 AA  -14.625877982849  10.626322363957   0.000000000000 Bohr
[INPUT] 14 Be    -8.739681318220   3.891156823327   0.000000000000 AA  -16.515604107414   7.353220703820   0.000000000000 Bohr
[INPUT] 15 Be    -9.357715306970   1.989043790737   0.000000000000 AA  -17.683519081824   3.758748014259   0.000000000000 Bohr
[INPUT] 16 Be    -9.566772233506   0.000000000000   0.000000000000 AA  -18.078579417419   0.000000000000   0.000000000000 Bohr
[INPUT] 17 Be    -9.357715306970  -1.989043790737   0.000000000000 AA  -17.683519081824  -3.758748014259   0.000000000000 Bohr
[INPUT] 18 Be    -8.739681318220  -3.891156823327   0.000000000000 AA  -16.515604107414  -7.353220703820   0.000000000000 Bohr
[INPUT] 19 Be    -7.739681318220  -5.623207630896   0.000000000000 AA  -14.625877982849 -10.626322363957   0.000000000000 Bohr
[INPUT] 20 Be    -6.401420105503  -7.109497281851   0.000000000000 AA  -12.096930807685 -13.435002746037   0.000000000000 Bohr
[INPUT] 21 Be    -4.783386116753  -8.285067786435   0.000000000000 AA   -9.039289708710 -15.656509039820   0.000000000000 Bohr
[INPUT] 22 Be    -2.956295201468  -9.098541072587   0.000000000000 AA   -5.586588274140 -17.193750760296   0.000000000000 Bohr
[INPUT] 23 Be    -1.000000000000  -9.514364454223   0.000000000000 AA   -1.889726124565 -17.979543067778   0.000000000000 Bohr
[INPUT] 24 Be     1.000000000000  -9.514364454223   0.000000000000 AA    1.889726124565 -17.979543067778   0.000000000000 Bohr
[INPUT] 25 Be     2.956295201468  -9.098541072587   0.000000000000 AA    5.586588274140 -17.193750760296   0.000000000000 Bohr
[INPUT] 26 Be     4.783386116753  -8.285067786435   0.000000000000 AA    9.039289708710 -15.656509039820   0.000000000000 Bohr
[INPUT] 27 Be     6.401420105503  -7.109497281851   0.000000000000 AA   12.096930807684 -13.435002746037   0.000000000000 Bohr
[INPUT] 28 Be     7.739681318220  -5.623207630896   0.000000000000 AA   14.625877982849 -10.626322363957   0.000000000000 Bohr
[INPUT] 29 Be     8.739681318220  -3.891156823327   0.000000000000 AA   16.515604107414  -7.353220703820   0.000000000000 Bohr
[INPUT] 30 Be     9.357715306970  -1.989043790737   0.000000000000 AA   17.683519081824  -3.758748014259   0.000000000000 Bohr
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [6    /1   ]  312.8704937       0.00916359628
                                57.36446253       0.04936149294
                                16.0485094        0.1685383049
                                5.513096119       0.3705627997
                                2.140896553       0.4164915298
                                0.8817394283      0.1303340841
[INPUT] 0    0    [6    /1   ]  13.63324744       -0.01325278809
                                2.698375464       -0.04699171014
                                0.8386530829      -0.03378537151
                                0.3226600698      0.2502417861
                                0.1401314882      0.5951172526
                                0.0642325139      0.2407061763
[INPUT] 1    0    [6    /1   ]  13.63324744       0.0037596966
                                2.698375464       0.0376793698
                                0.8386530829      0.1738967435
                                0.3226600698      0.4180364347
                                0.1401314882      0.4258595477
                                0.0642325139      0.1017082955
nuclear repulsion = 447.078862598264
number of shells = 90
number of NR pGTOs = 900
number of NR cGTOs = 150
basis = sto-6g
ecp = {}
CPU time:       206.30


******** <class 'pyscf.scf.hf.RHF'> flags ********
method = RHF
initial guess = minao
damping factor = 0
level shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
DIIS start cycle = 1
DIIS space = 8
SCF tol = 1e-09
SCF gradient tol = None
max. SCF cycles = 50
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /tigress/xingz/pydmfet/examples/tmp1qbhUG
max_memory 16000 MB (current use 228 MB)
Set gradient conv threshold to 3.16228e-05
init E= -442.882655768013
  HOMO = -0.0169801456782417  LUMO = -0.0044829973572646
cycle= 1 E= -436.573522327553  delta_E= 6.31  |g|= 0.671  |ddm|= 6.74
  HOMO = -0.164489394639524  LUMO = 0.115126923071679
cycle= 2 E= -436.976193804667  delta_E= -0.403  |g|= 0.236  |ddm|= 2.45
  HOMO = -0.188202234435042  LUMO = 0.12904892815074
cycle= 3 E= -437.028247643051  delta_E= -0.0521  |g|= 0.006  |ddm|= 1.14
  HOMO = -0.185967769985457  LUMO = 0.128600858043204
cycle= 4 E= -437.028276017249  delta_E= -2.84e-05  |g|= 0.000463  |ddm|= 0.0234
  HOMO = -0.185880424417487  LUMO = 0.128618132977318
cycle= 5 E= -437.028276238838  delta_E= -2.22e-07  |g|= 9.83e-05  |ddm|= 0.00143
  HOMO = -0.185910436459118  LUMO = 0.128620208949063
cycle= 6 E= -437.028276249762  delta_E= -1.09e-08  |g|= 8.66e-06  |ddm|= 0.000369
  HOMO = -0.185908293918363  LUMO = 0.128619687256204
cycle= 7 E= -437.028276249808  delta_E= -4.62e-11  |g|= 3.61e-07  |ddm|= 3.22e-05
  HOMO = -0.185908409378959  LUMO = 0.128619682095489
Extra cycle  E= -437.02827624981  delta_E= -2.16e-12  |g|= 1.07e-07  |ddm|= 1.07e-06
converged SCF energy = -437.02827624981
e_mf =  -437.0282762498102
#INFO: **** input file is /tigress/xingz/pydmfet/examples/Be.py ****
from pydmfet import locints, sdmfet, oep, tools
from pyscf import gto, scf,dft, ao2mo,cc
import numpy as np
from pyscf.tools import molden, cubegen
import copy,time

DMguess  = None

bondlengths = np.arange(1.8, 4.1, 0.1)
energies = []

bas = 'sto-6g'

for bondlength in bondlengths:

    nat = 30
    mol = gto.Mole()
    mol.atom = []
    r = 0.5 * bondlength / np.sin(np.pi/nat)
    for i in range(nat):
        theta = i * (2*np.pi/nat)
        mol.atom.append(('Be', (r*np.cos(theta), r*np.sin(theta), 0)))

    mol.basis = bas
    mol.build(max_memory=16000, verbose=4)

    mf = scf.RHF(mol)
    #mf = dft.RKS(mol)
    #mf.xc = 'pbe,pbe'
    #mf.smear_sigma = 0.005
    mf.max_cycle = 50
    mf.scf()

    #P=mf.make_rdm1()
    #tools.MatPrint(P,"P_ref_ao")
    #cubegen.density(mol, "h20_dens.cube", P, nx=100, ny=100, nz=100)
    print 'e_mf = ',  mf.e_tot
    continue
    if ( True ):   
#        ENUCL = mf.mol.energy_nuc()
#        OEI   = np.dot(np.dot(mf.mo_coeff.T, mol.intor('cint1e_kin_sph') + mol.intor('cint1e_nuc_sph')), mf.mo_coeff)
#        TEI   = ao2mo.outcore.full_iofree(mol, mf.mo_coeff, compact=False).reshape(mol.nao_nr(), mol.nao_nr(), mol.nao_nr(), mol.nao_nr())
#        import chemps2
#        Energy, OneDM = chemps2.solve( ENUCL, OEI, OEI, TEI, mol.nao_nr(), mol.nelectron, mol.nao_nr(), 0.0, False )
#        print "bl =", bondlength," and energy =", Energy

        mycc = cc.CCSD(mf).run()
	et=0.0
        #et = mycc.ccsd_t()
        e_hf = mf.e_tot
        e_ccsd = e_hf + mycc.e_corr + et

        print 'e_tot = ', e_ccsd    #-4.96124910741
        
    else:
        myInts = locints.LocalIntegrals( mf, range( mol.nao_nr() ), 'meta_lowdin' )
        #myInts.loc_molden( 'hydrogen-loc.molden' )
        #myInts.TI_OK = True # Only s functions

	nbas =  mol.nao_nr()
	natoms = mol.natm

	impAtom = np.zeros([natoms], dtype=int)
	for i in range(20):
	    impAtom[i] = 1

	ghost_frag = 1-impAtom
	ghost_env = 1-ghost_frag

	mol_frag = gto.Mole()
	mol_frag.atom = tools.add_ghost(mol.atom, ghost_frag)
	mol_frag.basis = bas
	mol_frag.build(max_memory = 16000,verbose = 4)
	'''
	mf_frag = dft.RKS(mol_frag)
        mf_frag.xc = 'pbe,pbe'
        mf_frag.smear_sigma = 0.00
        mf_frag.scf()
        P_frag=mf_frag.make_rdm1()
        cubegen.density(mol_frag, "h10_dens_1.cube", P_frag, nx=100, ny=100, nz=100)
	'''

	mol_env = gto.Mole()
	mol_env.atom = tools.add_ghost(mol.atom, ghost_env)
	mol_env.basis =  bas
	mol_env.build(max_memory = 16000,verbose = 4)

	'''
	mf_env = dft.RKS(mol_env)
        mf_env.xc = 'pbe,pbe'
        mf_env.smear_sigma = 0.00
        mf_env.scf()
        P_env=mf_env.make_rdm1()
        cubegen.density(mol_env, "h10_dens_2.cube", P_env, nx=100, ny=100, nz=100)
	exit()
	'''



	aoslice = mol.aoslice_by_atom()
	impurities = np.zeros([nbas], dtype = int)
	for i in range(natoms):
	    if(impAtom[i] == 1):
		impurities[aoslice[i,2]:aoslice[i,3]] = 1

	Ne_frag = 20
	boundary_atoms = np.zeros((natoms))
	boundary_atoms[20:40] = 1.0
	#boundary_atoms[19] = -1
	boundary_atoms2 = np.zeros((natoms),dtype =int)
	#boundary_atoms2[9] = -1
	boundary_atoms2[0:20] = 1

	boundary_atoms = None
	boundary_atoms2 =None

	umat=None
	P_frag=None
	P_env=None
	params = oep.OEPparams(algorithm = '2011', opt_method = 'L-BFGS-B', \
                       ftol = 1e-11, gtol = 1e-5,diffP_tol=1e-5, outer_maxit = 200, maxit = 200,l2_lambda = 0.0, oep_print = 0)
	theDMFET = sdmfet.DMFET( mf, mol_frag, mol_env,myInts,impurities, impAtom, Ne_frag, boundary_atoms=boundary_atoms, boundary_atoms2=boundary_atoms2,\
                         umat = umat, P_frag_ao = P_frag, P_env_ao = P_env, \
                         dim_imp = nbas, dim_bath=nbas, dim_big =nbas, smear_sigma = 0.005, oep_params=params,ecw_method='hf', mf_method = mf.xc)

	umat = theDMFET.embedding_potential()

	exit()

	#write subspace orbitals
	transfo = np.dot( myInts.ao2loc, theDMFET.loc2sub )
	filename =  'hydrogen-sub.molden'
	with open( filename, 'w' ) as thefile:
            molden.header( myInts.mol, thefile )
            molden.orbital_coeff( myInts.mol, thefile, transfo )


        umat = theDMFET.embedding_potential()
	print umat
	exit()
	energy = theDMFET.correction_energy()

#INFO: ******************** input file end ********************


System: ('Linux', 'tigercpu.princeton.edu', '3.10.0-693.21.1.el7.x86_64', '#1 SMP Wed Mar 7 15:59:45 EST 2018', 'x86_64', 'x86_64')  Threads 40
Python 2.7.14 |Anaconda, Inc.| (default, Oct 16 2017, 17:29:19) 
[GCC 7.2.0]
numpy 1.14.3  scipy 1.1.0
Date: Thu Jun  7 01:16:45 2018
PySCF version 1.4.2
PySCF path  /tigress/xingz/pyscf/pyscf
GIT ORIG_HEAD e0edd131499dcc18d035a120533a8a1ddda110d4
GIT HEAD      e0edd131499dcc18d035a120533a8a1ddda110d4

[INPUT] VERBOSE 4
[INPUT] num atoms = 30
[INPUT] num electrons = 120
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT]  1 Be    10.045110845181   0.000000000000   0.000000000000 AA   18.982508388290   0.000000000000   0.000000000000 Bohr
[INPUT]  2 Be     9.825601072319   2.088495980273   0.000000000000 AA   18.567695035915   3.946685414972   0.000000000000 Bohr
[INPUT]  3 Be     9.176665384131   4.085714664493   0.000000000000 AA   17.341384312785   7.720881739011   0.000000000000 Bohr
[INPUT]  4 Be     8.126665384131   5.904368012441   0.000000000000 AA   15.357171881992  11.157638482155   0.000000000000 Bohr
[INPUT]  5 Be     6.721491110778   7.464972145943   0.000000000000 AA   12.701777348069  14.106752883339   0.000000000000 Bohr
[INPUT]  6 Be     5.022555422590   8.699321175757   0.000000000000 AA    9.491254194145  16.439334491811   0.000000000000 Bohr
[INPUT]  7 Be     3.104109961541   9.553468126216   0.000000000000 AA    5.865917687847  18.053438298311   0.000000000000 Bohr
[INPUT]  8 Be     1.050000000000   9.990082676934   0.000000000000 AA    1.984212430793  18.878520221167   0.000000000000 Bohr
[INPUT]  9 Be    -1.050000000000   9.990082676934   0.000000000000 AA   -1.984212430793  18.878520221167   0.000000000000 Bohr
[INPUT] 10 Be    -3.104109961541   9.553468126216   0.000000000000 AA   -5.865917687847  18.053438298311   0.000000000000 Bohr
[INPUT] 11 Be    -5.022555422590   8.699321175757   0.000000000000 AA   -9.491254194145  16.439334491811   0.000000000000 Bohr
[INPUT] 12 Be    -6.721491110778   7.464972145943   0.000000000000 AA  -12.701777348069  14.106752883339   0.000000000000 Bohr
[INPUT] 13 Be    -8.126665384131   5.904368012441   0.000000000000 AA  -15.357171881992  11.157638482155   0.000000000000 Bohr
[INPUT] 14 Be    -9.176665384131   4.085714664493   0.000000000000 AA  -17.341384312785   7.720881739011   0.000000000000 Bohr
[INPUT] 15 Be    -9.825601072319   2.088495980273   0.000000000000 AA  -18.567695035915   3.946685414972   0.000000000000 Bohr
[INPUT] 16 Be   -10.045110845181   0.000000000000   0.000000000000 AA  -18.982508388290   0.000000000000   0.000000000000 Bohr
[INPUT] 17 Be    -9.825601072319  -2.088495980273   0.000000000000 AA  -18.567695035915  -3.946685414972   0.000000000000 Bohr
[INPUT] 18 Be    -9.176665384131  -4.085714664493   0.000000000000 AA  -17.341384312785  -7.720881739011   0.000000000000 Bohr
[INPUT] 19 Be    -8.126665384131  -5.904368012441   0.000000000000 AA  -15.357171881992 -11.157638482155   0.000000000000 Bohr
[INPUT] 20 Be    -6.721491110778  -7.464972145943   0.000000000000 AA  -12.701777348069 -14.106752883339   0.000000000000 Bohr
[INPUT] 21 Be    -5.022555422590  -8.699321175757   0.000000000000 AA   -9.491254194145 -16.439334491811   0.000000000000 Bohr
[INPUT] 22 Be    -3.104109961541  -9.553468126216   0.000000000000 AA   -5.865917687847 -18.053438298311   0.000000000000 Bohr
[INPUT] 23 Be    -1.050000000000  -9.990082676934   0.000000000000 AA   -1.984212430793 -18.878520221167   0.000000000000 Bohr
[INPUT] 24 Be     1.050000000000  -9.990082676934   0.000000000000 AA    1.984212430793 -18.878520221167   0.000000000000 Bohr
[INPUT] 25 Be     3.104109961541  -9.553468126216   0.000000000000 AA    5.865917687847 -18.053438298311   0.000000000000 Bohr
[INPUT] 26 Be     5.022555422590  -8.699321175757   0.000000000000 AA    9.491254194145 -16.439334491811   0.000000000000 Bohr
[INPUT] 27 Be     6.721491110778  -7.464972145943   0.000000000000 AA   12.701777348069 -14.106752883339   0.000000000000 Bohr
[INPUT] 28 Be     8.126665384131  -5.904368012441   0.000000000000 AA   15.357171881992 -11.157638482155   0.000000000000 Bohr
[INPUT] 29 Be     9.176665384131  -4.085714664493   0.000000000000 AA   17.341384312785  -7.720881739011   0.000000000000 Bohr
[INPUT] 30 Be     9.825601072319  -2.088495980273   0.000000000000 AA   18.567695035915  -3.946685414972   0.000000000000 Bohr
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [6    /1   ]  312.8704937       0.00916359628
                                57.36446253       0.04936149294
                                16.0485094        0.1685383049
                                5.513096119       0.3705627997
                                2.140896553       0.4164915298
                                0.8817394283      0.1303340841
[INPUT] 0    0    [6    /1   ]  13.63324744       -0.01325278809
                                2.698375464       -0.04699171014
                                0.8386530829      -0.03378537151
                                0.3226600698      0.2502417861
                                0.1401314882      0.5951172526
                                0.0642325139      0.2407061763
[INPUT] 1    0    [6    /1   ]  13.63324744       0.0037596966
                                2.698375464       0.0376793698
                                0.8386530829      0.1738967435
                                0.3226600698      0.4180364347
                                0.1401314882      0.4258595477
                                0.0642325139      0.1017082955
nuclear repulsion = 425.789392950728
number of shells = 90
number of NR pGTOs = 900
number of NR cGTOs = 150
basis = sto-6g
ecp = {}
CPU time:       302.14


******** <class 'pyscf.scf.hf.RHF'> flags ********
method = RHF
initial guess = minao
damping factor = 0
level shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
DIIS start cycle = 1
DIIS space = 8
SCF tol = 1e-09
SCF gradient tol = None
max. SCF cycles = 50
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /tigress/xingz/pydmfet/examples/tmpz8jj_i
max_memory 16000 MB (current use 228 MB)
Set gradient conv threshold to 3.16228e-05
init E= -441.733486037777
  HOMO = -0.0142520301390209  LUMO = 0.0132081082235957
cycle= 1 E= -436.558336657521  delta_E= 5.18  |g|= 0.671  |ddm|= 6.48
  HOMO = -0.153608509768606  LUMO = 0.123191744470322
cycle= 2 E= -437.019969352625  delta_E= -0.462  |g|= 0.259  |ddm|= 2.56
  HOMO = -0.186557767404266  LUMO = 0.137114691231178
cycle= 3 E= -437.090910522519  delta_E= -0.0709  |g|= 0.0115  |ddm|= 1.33
  HOMO = -0.182269656392574  LUMO = 0.136541262947834
cycle= 4 E= -437.091039440651  delta_E= -0.000129  |g|= 0.000531  |ddm|= 0.0524
  HOMO = -0.18223315657908  LUMO = 0.136581185206477
cycle= 5 E= -437.091039734507  delta_E= -2.94e-07  |g|= 0.000116  |ddm|= 0.00166
  HOMO = -0.182268843522803  LUMO = 0.136584709890211
cycle= 6 E= -437.091039749954  delta_E= -1.54e-08  |g|= 1.03e-05  |ddm|= 0.00047
  HOMO = -0.182266893321716  LUMO = 0.136584011793705
cycle= 7 E= -437.091039750029  delta_E= -7.51e-11  |g|= 6.44e-07  |ddm|= 3.67e-05
  HOMO = -0.182267105019675  LUMO = 0.136584015183857
Extra cycle  E= -437.09103975003  delta_E= -6.82e-13  |g|= 2.03e-07  |ddm|= 2.03e-06
converged SCF energy = -437.09103975003
e_mf =  -437.0910397500296
#INFO: **** input file is /tigress/xingz/pydmfet/examples/Be.py ****
from pydmfet import locints, sdmfet, oep, tools
from pyscf import gto, scf,dft, ao2mo,cc
import numpy as np
from pyscf.tools import molden, cubegen
import copy,time

DMguess  = None

bondlengths = np.arange(1.8, 4.1, 0.1)
energies = []

bas = 'sto-6g'

for bondlength in bondlengths:

    nat = 30
    mol = gto.Mole()
    mol.atom = []
    r = 0.5 * bondlength / np.sin(np.pi/nat)
    for i in range(nat):
        theta = i * (2*np.pi/nat)
        mol.atom.append(('Be', (r*np.cos(theta), r*np.sin(theta), 0)))

    mol.basis = bas
    mol.build(max_memory=16000, verbose=4)

    mf = scf.RHF(mol)
    #mf = dft.RKS(mol)
    #mf.xc = 'pbe,pbe'
    #mf.smear_sigma = 0.005
    mf.max_cycle = 50
    mf.scf()

    #P=mf.make_rdm1()
    #tools.MatPrint(P,"P_ref_ao")
    #cubegen.density(mol, "h20_dens.cube", P, nx=100, ny=100, nz=100)
    print 'e_mf = ',  mf.e_tot
    continue
    if ( True ):   
#        ENUCL = mf.mol.energy_nuc()
#        OEI   = np.dot(np.dot(mf.mo_coeff.T, mol.intor('cint1e_kin_sph') + mol.intor('cint1e_nuc_sph')), mf.mo_coeff)
#        TEI   = ao2mo.outcore.full_iofree(mol, mf.mo_coeff, compact=False).reshape(mol.nao_nr(), mol.nao_nr(), mol.nao_nr(), mol.nao_nr())
#        import chemps2
#        Energy, OneDM = chemps2.solve( ENUCL, OEI, OEI, TEI, mol.nao_nr(), mol.nelectron, mol.nao_nr(), 0.0, False )
#        print "bl =", bondlength," and energy =", Energy

        mycc = cc.CCSD(mf).run()
	et=0.0
        #et = mycc.ccsd_t()
        e_hf = mf.e_tot
        e_ccsd = e_hf + mycc.e_corr + et

        print 'e_tot = ', e_ccsd    #-4.96124910741
        
    else:
        myInts = locints.LocalIntegrals( mf, range( mol.nao_nr() ), 'meta_lowdin' )
        #myInts.loc_molden( 'hydrogen-loc.molden' )
        #myInts.TI_OK = True # Only s functions

	nbas =  mol.nao_nr()
	natoms = mol.natm

	impAtom = np.zeros([natoms], dtype=int)
	for i in range(20):
	    impAtom[i] = 1

	ghost_frag = 1-impAtom
	ghost_env = 1-ghost_frag

	mol_frag = gto.Mole()
	mol_frag.atom = tools.add_ghost(mol.atom, ghost_frag)
	mol_frag.basis = bas
	mol_frag.build(max_memory = 16000,verbose = 4)
	'''
	mf_frag = dft.RKS(mol_frag)
        mf_frag.xc = 'pbe,pbe'
        mf_frag.smear_sigma = 0.00
        mf_frag.scf()
        P_frag=mf_frag.make_rdm1()
        cubegen.density(mol_frag, "h10_dens_1.cube", P_frag, nx=100, ny=100, nz=100)
	'''

	mol_env = gto.Mole()
	mol_env.atom = tools.add_ghost(mol.atom, ghost_env)
	mol_env.basis =  bas
	mol_env.build(max_memory = 16000,verbose = 4)

	'''
	mf_env = dft.RKS(mol_env)
        mf_env.xc = 'pbe,pbe'
        mf_env.smear_sigma = 0.00
        mf_env.scf()
        P_env=mf_env.make_rdm1()
        cubegen.density(mol_env, "h10_dens_2.cube", P_env, nx=100, ny=100, nz=100)
	exit()
	'''



	aoslice = mol.aoslice_by_atom()
	impurities = np.zeros([nbas], dtype = int)
	for i in range(natoms):
	    if(impAtom[i] == 1):
		impurities[aoslice[i,2]:aoslice[i,3]] = 1

	Ne_frag = 20
	boundary_atoms = np.zeros((natoms))
	boundary_atoms[20:40] = 1.0
	#boundary_atoms[19] = -1
	boundary_atoms2 = np.zeros((natoms),dtype =int)
	#boundary_atoms2[9] = -1
	boundary_atoms2[0:20] = 1

	boundary_atoms = None
	boundary_atoms2 =None

	umat=None
	P_frag=None
	P_env=None
	params = oep.OEPparams(algorithm = '2011', opt_method = 'L-BFGS-B', \
                       ftol = 1e-11, gtol = 1e-5,diffP_tol=1e-5, outer_maxit = 200, maxit = 200,l2_lambda = 0.0, oep_print = 0)
	theDMFET = sdmfet.DMFET( mf, mol_frag, mol_env,myInts,impurities, impAtom, Ne_frag, boundary_atoms=boundary_atoms, boundary_atoms2=boundary_atoms2,\
                         umat = umat, P_frag_ao = P_frag, P_env_ao = P_env, \
                         dim_imp = nbas, dim_bath=nbas, dim_big =nbas, smear_sigma = 0.005, oep_params=params,ecw_method='hf', mf_method = mf.xc)

	umat = theDMFET.embedding_potential()

	exit()

	#write subspace orbitals
	transfo = np.dot( myInts.ao2loc, theDMFET.loc2sub )
	filename =  'hydrogen-sub.molden'
	with open( filename, 'w' ) as thefile:
            molden.header( myInts.mol, thefile )
            molden.orbital_coeff( myInts.mol, thefile, transfo )


        umat = theDMFET.embedding_potential()
	print umat
	exit()
	energy = theDMFET.correction_energy()

#INFO: ******************** input file end ********************


System: ('Linux', 'tigercpu.princeton.edu', '3.10.0-693.21.1.el7.x86_64', '#1 SMP Wed Mar 7 15:59:45 EST 2018', 'x86_64', 'x86_64')  Threads 40
Python 2.7.14 |Anaconda, Inc.| (default, Oct 16 2017, 17:29:19) 
[GCC 7.2.0]
numpy 1.14.3  scipy 1.1.0
Date: Thu Jun  7 01:16:48 2018
PySCF version 1.4.2
PySCF path  /tigress/xingz/pyscf/pyscf
GIT ORIG_HEAD e0edd131499dcc18d035a120533a8a1ddda110d4
GIT HEAD      e0edd131499dcc18d035a120533a8a1ddda110d4

[INPUT] VERBOSE 4
[INPUT] num atoms = 30
[INPUT] num electrons = 120
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT]  1 Be    10.523449456856   0.000000000000   0.000000000000 AA   19.886437359161   0.000000000000   0.000000000000 Bohr
[INPUT]  2 Be    10.293486837667   2.187948169810   0.000000000000 AA   19.451870990007   4.134622815685   0.000000000000 Bohr
[INPUT]  3 Be     9.613649450042   4.280272505660   0.000000000000 AA   18.167164518156   8.088542774202   0.000000000000 Bohr
[INPUT]  4 Be     8.513649450042   6.185528393985   0.000000000000 AA   16.088465781134  11.688954600353   0.000000000000 Bohr
[INPUT]  5 Be     7.041562116053   7.820447010036   0.000000000000 AA   13.306623888453  14.778503020641   0.000000000000 Bohr
[INPUT]  6 Be     5.261724728428   9.113574565079   0.000000000000 AA    9.943218679581  17.222159943801   0.000000000000 Bohr
[INPUT]  7 Be     3.251924721614  10.008395179846   0.000000000000 AA    6.145247101554  18.913125836326   0.000000000000 Bohr
[INPUT]  8 Be     1.100000000000  10.465800899645   0.000000000000 AA    2.078698737022  19.777497374555   0.000000000000 Bohr
[INPUT]  9 Be    -1.100000000000  10.465800899645   0.000000000000 AA   -2.078698737022  19.777497374555   0.000000000000 Bohr
[INPUT] 10 Be    -3.251924721614  10.008395179846   0.000000000000 AA   -6.145247101554  18.913125836326   0.000000000000 Bohr
[INPUT] 11 Be    -5.261724728428   9.113574565079   0.000000000000 AA   -9.943218679581  17.222159943801   0.000000000000 Bohr
[INPUT] 12 Be    -7.041562116053   7.820447010036   0.000000000000 AA  -13.306623888453  14.778503020641   0.000000000000 Bohr
[INPUT] 13 Be    -8.513649450042   6.185528393985   0.000000000000 AA  -16.088465781134  11.688954600353   0.000000000000 Bohr
[INPUT] 14 Be    -9.613649450042   4.280272505660   0.000000000000 AA  -18.167164518156   8.088542774202   0.000000000000 Bohr
[INPUT] 15 Be   -10.293486837667   2.187948169810   0.000000000000 AA  -19.451870990007   4.134622815685   0.000000000000 Bohr
[INPUT] 16 Be   -10.523449456856   0.000000000000   0.000000000000 AA  -19.886437359161   0.000000000000   0.000000000000 Bohr
[INPUT] 17 Be   -10.293486837667  -2.187948169810   0.000000000000 AA  -19.451870990007  -4.134622815685   0.000000000000 Bohr
[INPUT] 18 Be    -9.613649450042  -4.280272505660   0.000000000000 AA  -18.167164518156  -8.088542774202   0.000000000000 Bohr
[INPUT] 19 Be    -8.513649450042  -6.185528393985   0.000000000000 AA  -16.088465781134 -11.688954600353   0.000000000000 Bohr
[INPUT] 20 Be    -7.041562116053  -7.820447010036   0.000000000000 AA  -13.306623888453 -14.778503020641   0.000000000000 Bohr
[INPUT] 21 Be    -5.261724728428  -9.113574565079   0.000000000000 AA   -9.943218679581 -17.222159943801   0.000000000000 Bohr
[INPUT] 22 Be    -3.251924721614 -10.008395179846   0.000000000000 AA   -6.145247101554 -18.913125836326   0.000000000000 Bohr
[INPUT] 23 Be    -1.100000000000 -10.465800899645   0.000000000000 AA   -2.078698737022 -19.777497374555   0.000000000000 Bohr
[INPUT] 24 Be     1.100000000000 -10.465800899645   0.000000000000 AA    2.078698737022 -19.777497374555   0.000000000000 Bohr
[INPUT] 25 Be     3.251924721614 -10.008395179846   0.000000000000 AA    6.145247101554 -18.913125836326   0.000000000000 Bohr
[INPUT] 26 Be     5.261724728428  -9.113574565079   0.000000000000 AA    9.943218679581 -17.222159943801   0.000000000000 Bohr
[INPUT] 27 Be     7.041562116053  -7.820447010036   0.000000000000 AA   13.306623888453 -14.778503020641   0.000000000000 Bohr
[INPUT] 28 Be     8.513649450042  -6.185528393985   0.000000000000 AA   16.088465781134 -11.688954600353   0.000000000000 Bohr
[INPUT] 29 Be     9.613649450042  -4.280272505660   0.000000000000 AA   18.167164518156  -8.088542774202   0.000000000000 Bohr
[INPUT] 30 Be    10.293486837667  -2.187948169810   0.000000000000 AA   19.451870990007  -4.134622815685   0.000000000000 Bohr
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [6    /1   ]  312.8704937       0.00916359628
                                57.36446253       0.04936149294
                                16.0485094        0.1685383049
                                5.513096119       0.3705627997
                                2.140896553       0.4164915298
                                0.8817394283      0.1303340841
[INPUT] 0    0    [6    /1   ]  13.63324744       -0.01325278809
                                2.698375464       -0.04699171014
                                0.8386530829      -0.03378537151
                                0.3226600698      0.2502417861
                                0.1401314882      0.5951172526
                                0.0642325139      0.2407061763
[INPUT] 1    0    [6    /1   ]  13.63324744       0.0037596966
                                2.698375464       0.0376793698
                                0.8386530829      0.1738967435
                                0.3226600698      0.4180364347
                                0.1401314882      0.4258595477
                                0.0642325139      0.1017082955
nuclear repulsion = 406.435329634786
number of shells = 90
number of NR pGTOs = 900
number of NR cGTOs = 150
basis = sto-6g
ecp = {}
CPU time:       411.10


******** <class 'pyscf.scf.hf.RHF'> flags ********
method = RHF
initial guess = minao
damping factor = 0
level shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
DIIS start cycle = 1
DIIS space = 8
SCF tol = 1e-09
SCF gradient tol = None
max. SCF cycles = 50
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /tigress/xingz/pydmfet/examples/tmp7Ob07z
max_memory 16000 MB (current use 229 MB)
Set gradient conv threshold to 3.16228e-05
init E= -440.716443095273
  HOMO = -0.0106220543273052  LUMO = 0.02902967849167
cycle= 1 E= -436.421762155646  delta_E= 4.29  |g|= 0.661  |ddm|= 6.24
  HOMO = -0.13951905297693  LUMO = 0.130386826148269
cycle= 2 E= -436.947289733336  delta_E= -0.526  |g|= 0.285  |ddm|= 2.71
  HOMO = -0.185144161894845  LUMO = 0.14458216123946
cycle= 3 E= -437.045503528253  delta_E= -0.0982  |g|= 0.0206  |ddm|= 1.61
  HOMO = -0.177119094981159  LUMO = 0.143730979988944
cycle= 4 E= -437.045979921211  delta_E= -0.000476  |g|= 0.00114  |ddm|= 0.104
  HOMO = -0.177307361178529  LUMO = 0.143809513978211
cycle= 5 E= -437.045981332644  delta_E= -1.41e-06  |g|= 0.000138  |ddm|= 0.00461
  HOMO = -0.177348693815861  LUMO = 0.143815095138604
cycle= 6 E= -437.045981354573  delta_E= -2.19e-08  |g|= 1.12e-05  |ddm|= 0.000587
  HOMO = -0.177347018868089  LUMO = 0.143814287032604
cycle= 7 E= -437.045981354681  delta_E= -1.08e-10  |g|= 1.18e-06  |ddm|= 3.99e-05
  HOMO = -0.177347418933917  LUMO = 0.143814311748181
Extra cycle  E= -437.045981354681  delta_E= -2.27e-13  |g|= 3.95e-07  |ddm|= 3.9e-06
converged SCF energy = -437.045981354681
e_mf =  -437.04598135468086
#INFO: **** input file is /tigress/xingz/pydmfet/examples/Be.py ****
from pydmfet import locints, sdmfet, oep, tools
from pyscf import gto, scf,dft, ao2mo,cc
import numpy as np
from pyscf.tools import molden, cubegen
import copy,time

DMguess  = None

bondlengths = np.arange(1.8, 4.1, 0.1)
energies = []

bas = 'sto-6g'

for bondlength in bondlengths:

    nat = 30
    mol = gto.Mole()
    mol.atom = []
    r = 0.5 * bondlength / np.sin(np.pi/nat)
    for i in range(nat):
        theta = i * (2*np.pi/nat)
        mol.atom.append(('Be', (r*np.cos(theta), r*np.sin(theta), 0)))

    mol.basis = bas
    mol.build(max_memory=16000, verbose=4)

    mf = scf.RHF(mol)
    #mf = dft.RKS(mol)
    #mf.xc = 'pbe,pbe'
    #mf.smear_sigma = 0.005
    mf.max_cycle = 50
    mf.scf()

    #P=mf.make_rdm1()
    #tools.MatPrint(P,"P_ref_ao")
    #cubegen.density(mol, "h20_dens.cube", P, nx=100, ny=100, nz=100)
    print 'e_mf = ',  mf.e_tot
    continue
    if ( True ):   
#        ENUCL = mf.mol.energy_nuc()
#        OEI   = np.dot(np.dot(mf.mo_coeff.T, mol.intor('cint1e_kin_sph') + mol.intor('cint1e_nuc_sph')), mf.mo_coeff)
#        TEI   = ao2mo.outcore.full_iofree(mol, mf.mo_coeff, compact=False).reshape(mol.nao_nr(), mol.nao_nr(), mol.nao_nr(), mol.nao_nr())
#        import chemps2
#        Energy, OneDM = chemps2.solve( ENUCL, OEI, OEI, TEI, mol.nao_nr(), mol.nelectron, mol.nao_nr(), 0.0, False )
#        print "bl =", bondlength," and energy =", Energy

        mycc = cc.CCSD(mf).run()
	et=0.0
        #et = mycc.ccsd_t()
        e_hf = mf.e_tot
        e_ccsd = e_hf + mycc.e_corr + et

        print 'e_tot = ', e_ccsd    #-4.96124910741
        
    else:
        myInts = locints.LocalIntegrals( mf, range( mol.nao_nr() ), 'meta_lowdin' )
        #myInts.loc_molden( 'hydrogen-loc.molden' )
        #myInts.TI_OK = True # Only s functions

	nbas =  mol.nao_nr()
	natoms = mol.natm

	impAtom = np.zeros([natoms], dtype=int)
	for i in range(20):
	    impAtom[i] = 1

	ghost_frag = 1-impAtom
	ghost_env = 1-ghost_frag

	mol_frag = gto.Mole()
	mol_frag.atom = tools.add_ghost(mol.atom, ghost_frag)
	mol_frag.basis = bas
	mol_frag.build(max_memory = 16000,verbose = 4)
	'''
	mf_frag = dft.RKS(mol_frag)
        mf_frag.xc = 'pbe,pbe'
        mf_frag.smear_sigma = 0.00
        mf_frag.scf()
        P_frag=mf_frag.make_rdm1()
        cubegen.density(mol_frag, "h10_dens_1.cube", P_frag, nx=100, ny=100, nz=100)
	'''

	mol_env = gto.Mole()
	mol_env.atom = tools.add_ghost(mol.atom, ghost_env)
	mol_env.basis =  bas
	mol_env.build(max_memory = 16000,verbose = 4)

	'''
	mf_env = dft.RKS(mol_env)
        mf_env.xc = 'pbe,pbe'
        mf_env.smear_sigma = 0.00
        mf_env.scf()
        P_env=mf_env.make_rdm1()
        cubegen.density(mol_env, "h10_dens_2.cube", P_env, nx=100, ny=100, nz=100)
	exit()
	'''



	aoslice = mol.aoslice_by_atom()
	impurities = np.zeros([nbas], dtype = int)
	for i in range(natoms):
	    if(impAtom[i] == 1):
		impurities[aoslice[i,2]:aoslice[i,3]] = 1

	Ne_frag = 20
	boundary_atoms = np.zeros((natoms))
	boundary_atoms[20:40] = 1.0
	#boundary_atoms[19] = -1
	boundary_atoms2 = np.zeros((natoms),dtype =int)
	#boundary_atoms2[9] = -1
	boundary_atoms2[0:20] = 1

	boundary_atoms = None
	boundary_atoms2 =None

	umat=None
	P_frag=None
	P_env=None
	params = oep.OEPparams(algorithm = '2011', opt_method = 'L-BFGS-B', \
                       ftol = 1e-11, gtol = 1e-5,diffP_tol=1e-5, outer_maxit = 200, maxit = 200,l2_lambda = 0.0, oep_print = 0)
	theDMFET = sdmfet.DMFET( mf, mol_frag, mol_env,myInts,impurities, impAtom, Ne_frag, boundary_atoms=boundary_atoms, boundary_atoms2=boundary_atoms2,\
                         umat = umat, P_frag_ao = P_frag, P_env_ao = P_env, \
                         dim_imp = nbas, dim_bath=nbas, dim_big =nbas, smear_sigma = 0.005, oep_params=params,ecw_method='hf', mf_method = mf.xc)

	umat = theDMFET.embedding_potential()

	exit()

	#write subspace orbitals
	transfo = np.dot( myInts.ao2loc, theDMFET.loc2sub )
	filename =  'hydrogen-sub.molden'
	with open( filename, 'w' ) as thefile:
            molden.header( myInts.mol, thefile )
            molden.orbital_coeff( myInts.mol, thefile, transfo )


        umat = theDMFET.embedding_potential()
	print umat
	exit()
	energy = theDMFET.correction_energy()

#INFO: ******************** input file end ********************


System: ('Linux', 'tigercpu.princeton.edu', '3.10.0-693.21.1.el7.x86_64', '#1 SMP Wed Mar 7 15:59:45 EST 2018', 'x86_64', 'x86_64')  Threads 40
Python 2.7.14 |Anaconda, Inc.| (default, Oct 16 2017, 17:29:19) 
[GCC 7.2.0]
numpy 1.14.3  scipy 1.1.0
Date: Thu Jun  7 01:16:52 2018
PySCF version 1.4.2
PySCF path  /tigress/xingz/pyscf/pyscf
GIT ORIG_HEAD e0edd131499dcc18d035a120533a8a1ddda110d4
GIT HEAD      e0edd131499dcc18d035a120533a8a1ddda110d4

[INPUT] VERBOSE 4
[INPUT] num atoms = 30
[INPUT] num electrons = 120
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT]  1 Be    11.001788068531   0.000000000000   0.000000000000 AA   20.790366330032   0.000000000000   0.000000000000 Bohr
[INPUT]  2 Be    10.761372603016   2.287400359347   0.000000000000 AA   20.336046944098   4.322560216398   0.000000000000 Bohr
[INPUT]  3 Be    10.050633515953   4.474830346826   0.000000000000 AA   18.992944723527   8.456203809393   0.000000000000 Bohr
[INPUT]  4 Be     8.900633515953   6.466688775530   0.000000000000 AA   16.819759680277  12.220270718551   0.000000000000 Bohr
[INPUT]  5 Be     7.361633121328   8.175921874128   0.000000000000 AA   13.911470428837  15.450253157943   0.000000000000 Bohr
[INPUT]  6 Be     5.500894034266   9.527827954401   0.000000000000 AA   10.395183165016  18.004985395792   0.000000000000 Bohr
[INPUT]  7 Be     3.399739481688  10.463322233475   0.000000000000 AA    6.424576515261  19.772813374340   0.000000000000 Bohr
[INPUT]  8 Be     1.150000000000  10.941519122356   0.000000000000 AA    2.173185043250  20.676474527944   0.000000000000 Bohr
[INPUT]  9 Be    -1.150000000000  10.941519122356   0.000000000000 AA   -2.173185043250  20.676474527944   0.000000000000 Bohr
[INPUT] 10 Be    -3.399739481688  10.463322233475   0.000000000000 AA   -6.424576515261  19.772813374340   0.000000000000 Bohr
[INPUT] 11 Be    -5.500894034266   9.527827954401   0.000000000000 AA  -10.395183165016  18.004985395792   0.000000000000 Bohr
[INPUT] 12 Be    -7.361633121328   8.175921874128   0.000000000000 AA  -13.911470428837  15.450253157943   0.000000000000 Bohr
[INPUT] 13 Be    -8.900633515953   6.466688775530   0.000000000000 AA  -16.819759680277  12.220270718551   0.000000000000 Bohr
[INPUT] 14 Be   -10.050633515953   4.474830346826   0.000000000000 AA  -18.992944723527   8.456203809393   0.000000000000 Bohr
[INPUT] 15 Be   -10.761372603016   2.287400359347   0.000000000000 AA  -20.336046944098   4.322560216398   0.000000000000 Bohr
[INPUT] 16 Be   -11.001788068531   0.000000000000   0.000000000000 AA  -20.790366330032   0.000000000000   0.000000000000 Bohr
[INPUT] 17 Be   -10.761372603016  -2.287400359347   0.000000000000 AA  -20.336046944098  -4.322560216398   0.000000000000 Bohr
[INPUT] 18 Be   -10.050633515953  -4.474830346826   0.000000000000 AA  -18.992944723527  -8.456203809393   0.000000000000 Bohr
[INPUT] 19 Be    -8.900633515953  -6.466688775530   0.000000000000 AA  -16.819759680277 -12.220270718551   0.000000000000 Bohr
[INPUT] 20 Be    -7.361633121328  -8.175921874128   0.000000000000 AA  -13.911470428837 -15.450253157943   0.000000000000 Bohr
[INPUT] 21 Be    -5.500894034266  -9.527827954401   0.000000000000 AA  -10.395183165016 -18.004985395792   0.000000000000 Bohr
[INPUT] 22 Be    -3.399739481688 -10.463322233475   0.000000000000 AA   -6.424576515261 -19.772813374340   0.000000000000 Bohr
[INPUT] 23 Be    -1.150000000000 -10.941519122356   0.000000000000 AA   -2.173185043250 -20.676474527944   0.000000000000 Bohr
[INPUT] 24 Be     1.150000000000 -10.941519122356   0.000000000000 AA    2.173185043250 -20.676474527944   0.000000000000 Bohr
[INPUT] 25 Be     3.399739481688 -10.463322233475   0.000000000000 AA    6.424576515261 -19.772813374340   0.000000000000 Bohr
[INPUT] 26 Be     5.500894034266  -9.527827954401   0.000000000000 AA   10.395183165016 -18.004985395792   0.000000000000 Bohr
[INPUT] 27 Be     7.361633121328  -8.175921874128   0.000000000000 AA   13.911470428837 -15.450253157943   0.000000000000 Bohr
[INPUT] 28 Be     8.900633515953  -6.466688775530   0.000000000000 AA   16.819759680277 -12.220270718551   0.000000000000 Bohr
[INPUT] 29 Be    10.050633515953  -4.474830346826   0.000000000000 AA   18.992944723527  -8.456203809393   0.000000000000 Bohr
[INPUT] 30 Be    10.761372603016  -2.287400359347   0.000000000000 AA   20.336046944098  -4.322560216398   0.000000000000 Bohr
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [6    /1   ]  312.8704937       0.00916359628
                                57.36446253       0.04936149294
                                16.0485094        0.1685383049
                                5.513096119       0.3705627997
                                2.140896553       0.4164915298
                                0.8817394283      0.1303340841
[INPUT] 0    0    [6    /1   ]  13.63324744       -0.01325278809
                                2.698375464       -0.04699171014
                                0.8386530829      -0.03378537151
                                0.3226600698      0.2502417861
                                0.1401314882      0.5951172526
                                0.0642325139      0.2407061763
[INPUT] 1    0    [6    /1   ]  13.63324744       0.0037596966
                                2.698375464       0.0376793698
                                0.8386530829      0.1738967435
                                0.3226600698      0.4180364347
                                0.1401314882      0.4258595477
                                0.0642325139      0.1017082955
nuclear repulsion = 388.764228346317
number of shells = 90
number of NR pGTOs = 900
number of NR cGTOs = 150
basis = sto-6g
ecp = {}
CPU time:       545.71


******** <class 'pyscf.scf.hf.RHF'> flags ********
method = RHF
initial guess = minao
damping factor = 0
level shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
DIIS start cycle = 1
DIIS space = 8
SCF tol = 1e-09
SCF gradient tol = None
max. SCF cycles = 50
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /tigress/xingz/pydmfet/examples/tmpa2JDHZ
max_memory 16000 MB (current use 229 MB)
Set gradient conv threshold to 3.16228e-05
init E= -439.822424825057
  HOMO = -0.00623297105475318  LUMO = 0.0432173251129772
cycle= 1 E= -436.186493302029  delta_E= 3.64  |g|= 0.635  |ddm|= 5.99
  HOMO = -0.121226478390645  LUMO = 0.136788183078576
cycle= 2 E= -436.777176465486  delta_E= -0.591  |g|= 0.314  |ddm|= 2.91
  HOMO = -0.186322807163294  LUMO = 0.151724651336098
cycle= 3 E= -436.91649897366  delta_E= -0.139  |g|= 0.0386  |ddm|= 2.04
  HOMO = -0.170574105551528  LUMO = 0.150238938232953
cycle= 4 E= -436.918376219904  delta_E= -0.00188  |g|= 0.00259  |ddm|= 0.212
  HOMO = -0.171232354950622  LUMO = 0.150369072989658
cycle= 5 E= -436.918384843727  delta_E= -8.62e-06  |g|= 0.000187  |ddm|= 0.0126
  HOMO = -0.17129432817859  LUMO = 0.150378702237182
cycle= 6 E= -436.918384888438  delta_E= -4.47e-08  |g|= 1.48e-05  |ddm|= 0.000921
  HOMO = -0.171290255446742  LUMO = 0.150377371128472
cycle= 7 E= -436.918384888661  delta_E= -2.23e-10  |g|= 2.72e-06  |ddm|= 7.11e-05
  HOMO = -0.171291211177175  LUMO = 0.150377452494303
Extra cycle  E= -436.918384888669  delta_E= -8.19e-12  |g|= 9.8e-07  |ddm|= 9.21e-06
converged SCF energy = -436.918384888669
e_mf =  -436.9183848886687
#INFO: **** input file is /tigress/xingz/pydmfet/examples/Be.py ****
from pydmfet import locints, sdmfet, oep, tools
from pyscf import gto, scf,dft, ao2mo,cc
import numpy as np
from pyscf.tools import molden, cubegen
import copy,time

DMguess  = None

bondlengths = np.arange(1.8, 4.1, 0.1)
energies = []

bas = 'sto-6g'

for bondlength in bondlengths:

    nat = 30
    mol = gto.Mole()
    mol.atom = []
    r = 0.5 * bondlength / np.sin(np.pi/nat)
    for i in range(nat):
        theta = i * (2*np.pi/nat)
        mol.atom.append(('Be', (r*np.cos(theta), r*np.sin(theta), 0)))

    mol.basis = bas
    mol.build(max_memory=16000, verbose=4)

    mf = scf.RHF(mol)
    #mf = dft.RKS(mol)
    #mf.xc = 'pbe,pbe'
    #mf.smear_sigma = 0.005
    mf.max_cycle = 50
    mf.scf()

    #P=mf.make_rdm1()
    #tools.MatPrint(P,"P_ref_ao")
    #cubegen.density(mol, "h20_dens.cube", P, nx=100, ny=100, nz=100)
    print 'e_mf = ',  mf.e_tot
    continue
    if ( True ):   
#        ENUCL = mf.mol.energy_nuc()
#        OEI   = np.dot(np.dot(mf.mo_coeff.T, mol.intor('cint1e_kin_sph') + mol.intor('cint1e_nuc_sph')), mf.mo_coeff)
#        TEI   = ao2mo.outcore.full_iofree(mol, mf.mo_coeff, compact=False).reshape(mol.nao_nr(), mol.nao_nr(), mol.nao_nr(), mol.nao_nr())
#        import chemps2
#        Energy, OneDM = chemps2.solve( ENUCL, OEI, OEI, TEI, mol.nao_nr(), mol.nelectron, mol.nao_nr(), 0.0, False )
#        print "bl =", bondlength," and energy =", Energy

        mycc = cc.CCSD(mf).run()
	et=0.0
        #et = mycc.ccsd_t()
        e_hf = mf.e_tot
        e_ccsd = e_hf + mycc.e_corr + et

        print 'e_tot = ', e_ccsd    #-4.96124910741
        
    else:
        myInts = locints.LocalIntegrals( mf, range( mol.nao_nr() ), 'meta_lowdin' )
        #myInts.loc_molden( 'hydrogen-loc.molden' )
        #myInts.TI_OK = True # Only s functions

	nbas =  mol.nao_nr()
	natoms = mol.natm

	impAtom = np.zeros([natoms], dtype=int)
	for i in range(20):
	    impAtom[i] = 1

	ghost_frag = 1-impAtom
	ghost_env = 1-ghost_frag

	mol_frag = gto.Mole()
	mol_frag.atom = tools.add_ghost(mol.atom, ghost_frag)
	mol_frag.basis = bas
	mol_frag.build(max_memory = 16000,verbose = 4)
	'''
	mf_frag = dft.RKS(mol_frag)
        mf_frag.xc = 'pbe,pbe'
        mf_frag.smear_sigma = 0.00
        mf_frag.scf()
        P_frag=mf_frag.make_rdm1()
        cubegen.density(mol_frag, "h10_dens_1.cube", P_frag, nx=100, ny=100, nz=100)
	'''

	mol_env = gto.Mole()
	mol_env.atom = tools.add_ghost(mol.atom, ghost_env)
	mol_env.basis =  bas
	mol_env.build(max_memory = 16000,verbose = 4)

	'''
	mf_env = dft.RKS(mol_env)
        mf_env.xc = 'pbe,pbe'
        mf_env.smear_sigma = 0.00
        mf_env.scf()
        P_env=mf_env.make_rdm1()
        cubegen.density(mol_env, "h10_dens_2.cube", P_env, nx=100, ny=100, nz=100)
	exit()
	'''



	aoslice = mol.aoslice_by_atom()
	impurities = np.zeros([nbas], dtype = int)
	for i in range(natoms):
	    if(impAtom[i] == 1):
		impurities[aoslice[i,2]:aoslice[i,3]] = 1

	Ne_frag = 20
	boundary_atoms = np.zeros((natoms))
	boundary_atoms[20:40] = 1.0
	#boundary_atoms[19] = -1
	boundary_atoms2 = np.zeros((natoms),dtype =int)
	#boundary_atoms2[9] = -1
	boundary_atoms2[0:20] = 1

	boundary_atoms = None
	boundary_atoms2 =None

	umat=None
	P_frag=None
	P_env=None
	params = oep.OEPparams(algorithm = '2011', opt_method = 'L-BFGS-B', \
                       ftol = 1e-11, gtol = 1e-5,diffP_tol=1e-5, outer_maxit = 200, maxit = 200,l2_lambda = 0.0, oep_print = 0)
	theDMFET = sdmfet.DMFET( mf, mol_frag, mol_env,myInts,impurities, impAtom, Ne_frag, boundary_atoms=boundary_atoms, boundary_atoms2=boundary_atoms2,\
                         umat = umat, P_frag_ao = P_frag, P_env_ao = P_env, \
                         dim_imp = nbas, dim_bath=nbas, dim_big =nbas, smear_sigma = 0.005, oep_params=params,ecw_method='hf', mf_method = mf.xc)

	umat = theDMFET.embedding_potential()

	exit()

	#write subspace orbitals
	transfo = np.dot( myInts.ao2loc, theDMFET.loc2sub )
	filename =  'hydrogen-sub.molden'
	with open( filename, 'w' ) as thefile:
            molden.header( myInts.mol, thefile )
            molden.orbital_coeff( myInts.mol, thefile, transfo )


        umat = theDMFET.embedding_potential()
	print umat
	exit()
	energy = theDMFET.correction_energy()

#INFO: ******************** input file end ********************


System: ('Linux', 'tigercpu.princeton.edu', '3.10.0-693.21.1.el7.x86_64', '#1 SMP Wed Mar 7 15:59:45 EST 2018', 'x86_64', 'x86_64')  Threads 40
Python 2.7.14 |Anaconda, Inc.| (default, Oct 16 2017, 17:29:19) 
[GCC 7.2.0]
numpy 1.14.3  scipy 1.1.0
Date: Thu Jun  7 01:16:54 2018
PySCF version 1.4.2
PySCF path  /tigress/xingz/pyscf/pyscf
GIT ORIG_HEAD e0edd131499dcc18d035a120533a8a1ddda110d4
GIT HEAD      e0edd131499dcc18d035a120533a8a1ddda110d4

[INPUT] VERBOSE 4
[INPUT] num atoms = 30
[INPUT] num electrons = 120
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT]  1 Be    11.480126680207   0.000000000000   0.000000000000 AA   21.694295300903   0.000000000000   0.000000000000 Bohr
[INPUT]  2 Be    11.229258368364   2.386852548884   0.000000000000 AA   21.220222898189   4.510497617111   0.000000000000 Bohr
[INPUT]  3 Be    10.487617581865   4.669388187992   0.000000000000 AA   19.818724928897   8.823864844584   0.000000000000 Bohr
[INPUT]  4 Be     9.287617581865   6.747849157075   0.000000000000 AA   17.551053579419  12.751586836749   0.000000000000 Bohr
[INPUT]  5 Be     7.681704126603   8.531396738221   0.000000000000 AA   14.516316969221  16.122003295245   0.000000000000 Bohr
[INPUT]  6 Be     5.740063340103   9.942081343723   0.000000000000 AA   10.847147650452  18.787810847783   0.000000000000 Bohr
[INPUT]  7 Be     3.547554241761  10.918249287104   0.000000000000 AA    6.703905928968  20.632500912355   0.000000000000 Bohr
[INPUT]  8 Be     1.200000000000  11.417237345067   0.000000000000 AA    2.267671349478  21.575451681333   0.000000000000 Bohr
[INPUT]  9 Be    -1.200000000000  11.417237345067   0.000000000000 AA   -2.267671349478  21.575451681333   0.000000000000 Bohr
[INPUT] 10 Be    -3.547554241761  10.918249287104   0.000000000000 AA   -6.703905928968  20.632500912355   0.000000000000 Bohr
[INPUT] 11 Be    -5.740063340103   9.942081343723   0.000000000000 AA  -10.847147650452  18.787810847783   0.000000000000 Bohr
[INPUT] 12 Be    -7.681704126603   8.531396738221   0.000000000000 AA  -14.516316969221  16.122003295245   0.000000000000 Bohr
[INPUT] 13 Be    -9.287617581865   6.747849157075   0.000000000000 AA  -17.551053579419  12.751586836749   0.000000000000 Bohr
[INPUT] 14 Be   -10.487617581865   4.669388187992   0.000000000000 AA  -19.818724928897   8.823864844584   0.000000000000 Bohr
[INPUT] 15 Be   -11.229258368364   2.386852548884   0.000000000000 AA  -21.220222898189   4.510497617111   0.000000000000 Bohr
[INPUT] 16 Be   -11.480126680207   0.000000000000   0.000000000000 AA  -21.694295300903   0.000000000000   0.000000000000 Bohr
[INPUT] 17 Be   -11.229258368364  -2.386852548884   0.000000000000 AA  -21.220222898189  -4.510497617111   0.000000000000 Bohr
[INPUT] 18 Be   -10.487617581865  -4.669388187992   0.000000000000 AA  -19.818724928897  -8.823864844584   0.000000000000 Bohr
[INPUT] 19 Be    -9.287617581865  -6.747849157075   0.000000000000 AA  -17.551053579419 -12.751586836749   0.000000000000 Bohr
[INPUT] 20 Be    -7.681704126603  -8.531396738221   0.000000000000 AA  -14.516316969221 -16.122003295245   0.000000000000 Bohr
[INPUT] 21 Be    -5.740063340103  -9.942081343723   0.000000000000 AA  -10.847147650452 -18.787810847783   0.000000000000 Bohr
[INPUT] 22 Be    -3.547554241761 -10.918249287104   0.000000000000 AA   -6.703905928968 -20.632500912355   0.000000000000 Bohr
[INPUT] 23 Be    -1.200000000000 -11.417237345067   0.000000000000 AA   -2.267671349478 -21.575451681333   0.000000000000 Bohr
[INPUT] 24 Be     1.200000000000 -11.417237345067   0.000000000000 AA    2.267671349478 -21.575451681333   0.000000000000 Bohr
[INPUT] 25 Be     3.547554241761 -10.918249287104   0.000000000000 AA    6.703905928968 -20.632500912355   0.000000000000 Bohr
[INPUT] 26 Be     5.740063340103  -9.942081343723   0.000000000000 AA   10.847147650452 -18.787810847783   0.000000000000 Bohr
[INPUT] 27 Be     7.681704126603  -8.531396738221   0.000000000000 AA   14.516316969221 -16.122003295245   0.000000000000 Bohr
[INPUT] 28 Be     9.287617581865  -6.747849157075   0.000000000000 AA   17.551053579419 -12.751586836749   0.000000000000 Bohr
[INPUT] 29 Be    10.487617581865  -4.669388187992   0.000000000000 AA   19.818724928897  -8.823864844584   0.000000000000 Bohr
[INPUT] 30 Be    11.229258368364  -2.386852548884   0.000000000000 AA   21.220222898189  -4.510497617111   0.000000000000 Bohr
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [6    /1   ]  312.8704937       0.00916359628
                                57.36446253       0.04936149294
                                16.0485094        0.1685383049
                                5.513096119       0.3705627997
                                2.140896553       0.4164915298
                                0.8817394283      0.1303340841
[INPUT] 0    0    [6    /1   ]  13.63324744       -0.01325278809
                                2.698375464       -0.04699171014
                                0.8386530829      -0.03378537151
                                0.3226600698      0.2502417861
                                0.1401314882      0.5951172526
                                0.0642325139      0.2407061763
[INPUT] 1    0    [6    /1   ]  13.63324744       0.0037596966
                                2.698375464       0.0376793698
                                0.8386530829      0.1738967435
                                0.3226600698      0.4180364347
                                0.1401314882      0.4258595477
                                0.0642325139      0.1017082955
nuclear repulsion = 372.565718831887
number of shells = 90
number of NR pGTOs = 900
number of NR cGTOs = 150
basis = sto-6g
ecp = {}
CPU time:       648.99


******** <class 'pyscf.scf.hf.RHF'> flags ********
method = RHF
initial guess = minao
damping factor = 0
level shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
DIIS start cycle = 1
DIIS space = 8
SCF tol = 1e-09
SCF gradient tol = None
max. SCF cycles = 50
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /tigress/xingz/pydmfet/examples/tmpWPAEv6
max_memory 16000 MB (current use 229 MB)
Set gradient conv threshold to 3.16228e-05
init E= -439.041484548289
  HOMO = -0.0012083576481727  LUMO = 0.030667988137603
cycle= 1 E= -435.877850225449  delta_E= 3.16  |g|= 0.584  |ddm|= 5.75
  HOMO = -0.097451213981823  LUMO = 0.142494390486563
cycle= 2 E= -436.517731125776  delta_E= -0.64  |g|= 0.345  |ddm|= 3.16
  HOMO = -0.197498284697235  LUMO = 0.159275279910212
cycle= 3 E= -436.71861990246  delta_E= -0.201  |g|= 0.0831  |ddm|= 2.79
  HOMO = -0.162701969984908  LUMO = 0.156166443641319
cycle= 4 E= -436.728148635504  delta_E= -0.00953  |g|= 0.00464  |ddm|= 0.477
  HOMO = -0.164005348639728  LUMO = 0.156316096567062
cycle= 5 E= -436.728182161715  delta_E= -3.35e-05  |g|= 0.000407  |ddm|= 0.025
  HOMO = -0.164189504409323  LUMO = 0.156336109360785
cycle= 6 E= -436.728182413644  delta_E= -2.52e-07  |g|= 5.21e-05  |ddm|= 0.00259
  HOMO = -0.164164627107608  LUMO = 0.156331809740217
cycle= 7 E= -436.72818241734  delta_E= -3.7e-09  |g|= 1.33e-05  |ddm|= 0.000367
  HOMO = -0.164169841026143  LUMO = 0.156332463759355
cycle= 8 E= -436.7281824176  delta_E= -2.6e-10  |g|= 3.05e-07  |ddm|= 7.66e-05
  HOMO = -0.164169736398774  LUMO = 0.156332452999066
Extra cycle  E= -436.728182417601  delta_E= -4.55e-13  |g|= 1.17e-07  |ddm|= 1.11e-06
converged SCF energy = -436.728182417601
e_mf =  -436.72818241760075
#INFO: **** input file is /tigress/xingz/pydmfet/examples/Be.py ****
from pydmfet import locints, sdmfet, oep, tools
from pyscf import gto, scf,dft, ao2mo,cc
import numpy as np
from pyscf.tools import molden, cubegen
import copy,time

DMguess  = None

bondlengths = np.arange(1.8, 4.1, 0.1)
energies = []

bas = 'sto-6g'

for bondlength in bondlengths:

    nat = 30
    mol = gto.Mole()
    mol.atom = []
    r = 0.5 * bondlength / np.sin(np.pi/nat)
    for i in range(nat):
        theta = i * (2*np.pi/nat)
        mol.atom.append(('Be', (r*np.cos(theta), r*np.sin(theta), 0)))

    mol.basis = bas
    mol.build(max_memory=16000, verbose=4)

    mf = scf.RHF(mol)
    #mf = dft.RKS(mol)
    #mf.xc = 'pbe,pbe'
    #mf.smear_sigma = 0.005
    mf.max_cycle = 50
    mf.scf()

    #P=mf.make_rdm1()
    #tools.MatPrint(P,"P_ref_ao")
    #cubegen.density(mol, "h20_dens.cube", P, nx=100, ny=100, nz=100)
    print 'e_mf = ',  mf.e_tot
    continue
    if ( True ):   
#        ENUCL = mf.mol.energy_nuc()
#        OEI   = np.dot(np.dot(mf.mo_coeff.T, mol.intor('cint1e_kin_sph') + mol.intor('cint1e_nuc_sph')), mf.mo_coeff)
#        TEI   = ao2mo.outcore.full_iofree(mol, mf.mo_coeff, compact=False).reshape(mol.nao_nr(), mol.nao_nr(), mol.nao_nr(), mol.nao_nr())
#        import chemps2
#        Energy, OneDM = chemps2.solve( ENUCL, OEI, OEI, TEI, mol.nao_nr(), mol.nelectron, mol.nao_nr(), 0.0, False )
#        print "bl =", bondlength," and energy =", Energy

        mycc = cc.CCSD(mf).run()
	et=0.0
        #et = mycc.ccsd_t()
        e_hf = mf.e_tot
        e_ccsd = e_hf + mycc.e_corr + et

        print 'e_tot = ', e_ccsd    #-4.96124910741
        
    else:
        myInts = locints.LocalIntegrals( mf, range( mol.nao_nr() ), 'meta_lowdin' )
        #myInts.loc_molden( 'hydrogen-loc.molden' )
        #myInts.TI_OK = True # Only s functions

	nbas =  mol.nao_nr()
	natoms = mol.natm

	impAtom = np.zeros([natoms], dtype=int)
	for i in range(20):
	    impAtom[i] = 1

	ghost_frag = 1-impAtom
	ghost_env = 1-ghost_frag

	mol_frag = gto.Mole()
	mol_frag.atom = tools.add_ghost(mol.atom, ghost_frag)
	mol_frag.basis = bas
	mol_frag.build(max_memory = 16000,verbose = 4)
	'''
	mf_frag = dft.RKS(mol_frag)
        mf_frag.xc = 'pbe,pbe'
        mf_frag.smear_sigma = 0.00
        mf_frag.scf()
        P_frag=mf_frag.make_rdm1()
        cubegen.density(mol_frag, "h10_dens_1.cube", P_frag, nx=100, ny=100, nz=100)
	'''

	mol_env = gto.Mole()
	mol_env.atom = tools.add_ghost(mol.atom, ghost_env)
	mol_env.basis =  bas
	mol_env.build(max_memory = 16000,verbose = 4)

	'''
	mf_env = dft.RKS(mol_env)
        mf_env.xc = 'pbe,pbe'
        mf_env.smear_sigma = 0.00
        mf_env.scf()
        P_env=mf_env.make_rdm1()
        cubegen.density(mol_env, "h10_dens_2.cube", P_env, nx=100, ny=100, nz=100)
	exit()
	'''



	aoslice = mol.aoslice_by_atom()
	impurities = np.zeros([nbas], dtype = int)
	for i in range(natoms):
	    if(impAtom[i] == 1):
		impurities[aoslice[i,2]:aoslice[i,3]] = 1

	Ne_frag = 20
	boundary_atoms = np.zeros((natoms))
	boundary_atoms[20:40] = 1.0
	#boundary_atoms[19] = -1
	boundary_atoms2 = np.zeros((natoms),dtype =int)
	#boundary_atoms2[9] = -1
	boundary_atoms2[0:20] = 1

	boundary_atoms = None
	boundary_atoms2 =None

	umat=None
	P_frag=None
	P_env=None
	params = oep.OEPparams(algorithm = '2011', opt_method = 'L-BFGS-B', \
                       ftol = 1e-11, gtol = 1e-5,diffP_tol=1e-5, outer_maxit = 200, maxit = 200,l2_lambda = 0.0, oep_print = 0)
	theDMFET = sdmfet.DMFET( mf, mol_frag, mol_env,myInts,impurities, impAtom, Ne_frag, boundary_atoms=boundary_atoms, boundary_atoms2=boundary_atoms2,\
                         umat = umat, P_frag_ao = P_frag, P_env_ao = P_env, \
                         dim_imp = nbas, dim_bath=nbas, dim_big =nbas, smear_sigma = 0.005, oep_params=params,ecw_method='hf', mf_method = mf.xc)

	umat = theDMFET.embedding_potential()

	exit()

	#write subspace orbitals
	transfo = np.dot( myInts.ao2loc, theDMFET.loc2sub )
	filename =  'hydrogen-sub.molden'
	with open( filename, 'w' ) as thefile:
            molden.header( myInts.mol, thefile )
            molden.orbital_coeff( myInts.mol, thefile, transfo )


        umat = theDMFET.embedding_potential()
	print umat
	exit()
	energy = theDMFET.correction_energy()

#INFO: ******************** input file end ********************


System: ('Linux', 'tigercpu.princeton.edu', '3.10.0-693.21.1.el7.x86_64', '#1 SMP Wed Mar 7 15:59:45 EST 2018', 'x86_64', 'x86_64')  Threads 40
Python 2.7.14 |Anaconda, Inc.| (default, Oct 16 2017, 17:29:19) 
[GCC 7.2.0]
numpy 1.14.3  scipy 1.1.0
Date: Thu Jun  7 01:16:57 2018
PySCF version 1.4.2
PySCF path  /tigress/xingz/pyscf/pyscf
GIT ORIG_HEAD e0edd131499dcc18d035a120533a8a1ddda110d4
GIT HEAD      e0edd131499dcc18d035a120533a8a1ddda110d4

[INPUT] VERBOSE 4
[INPUT] num atoms = 30
[INPUT] num electrons = 120
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT]  1 Be    11.958465291882   0.000000000000   0.000000000000 AA   22.598224271774   0.000000000000   0.000000000000 Bohr
[INPUT]  2 Be    11.697144133713   2.486304738421   0.000000000000 AA   22.104398852280   4.698435017823   0.000000000000 Bohr
[INPUT]  3 Be    10.924601647776   4.863946029159   0.000000000000 AA   20.644505134268   9.191525879775   0.000000000000 Bohr
[INPUT]  4 Be     9.674601647776   7.029009538620   0.000000000000 AA   18.282347478562  13.282902954947   0.000000000000 Bohr
[INPUT]  5 Be     8.001775131878   8.886871602313   0.000000000000 AA   15.121163509606  16.793753432547   0.000000000000 Bohr
[INPUT]  6 Be     5.979232645941  10.356334733044   0.000000000000 AA   11.299112135887  19.570636299774   0.000000000000 Bohr
[INPUT]  7 Be     3.695369001835  11.373176340734   0.000000000000 AA    6.983235342675  21.492188450370   0.000000000000 Bohr
[INPUT]  8 Be     1.250000000000  11.892955567778   0.000000000000 AA    2.362157655706  22.474428834722   0.000000000000 Bohr
[INPUT]  9 Be    -1.250000000000  11.892955567778   0.000000000000 AA   -2.362157655706  22.474428834722   0.000000000000 Bohr
[INPUT] 10 Be    -3.695369001835  11.373176340734   0.000000000000 AA   -6.983235342675  21.492188450370   0.000000000000 Bohr
[INPUT] 11 Be    -5.979232645941  10.356334733044   0.000000000000 AA  -11.299112135887  19.570636299774   0.000000000000 Bohr
[INPUT] 12 Be    -8.001775131878   8.886871602313   0.000000000000 AA  -15.121163509606  16.793753432547   0.000000000000 Bohr
[INPUT] 13 Be    -9.674601647776   7.029009538620   0.000000000000 AA  -18.282347478562  13.282902954947   0.000000000000 Bohr
[INPUT] 14 Be   -10.924601647776   4.863946029159   0.000000000000 AA  -20.644505134268   9.191525879775   0.000000000000 Bohr
[INPUT] 15 Be   -11.697144133713   2.486304738421   0.000000000000 AA  -22.104398852280   4.698435017823   0.000000000000 Bohr
[INPUT] 16 Be   -11.958465291882   0.000000000000   0.000000000000 AA  -22.598224271774   0.000000000000   0.000000000000 Bohr
[INPUT] 17 Be   -11.697144133713  -2.486304738421   0.000000000000 AA  -22.104398852280  -4.698435017823   0.000000000000 Bohr
[INPUT] 18 Be   -10.924601647776  -4.863946029159   0.000000000000 AA  -20.644505134268  -9.191525879775   0.000000000000 Bohr
[INPUT] 19 Be    -9.674601647776  -7.029009538620   0.000000000000 AA  -18.282347478562 -13.282902954947   0.000000000000 Bohr
[INPUT] 20 Be    -8.001775131878  -8.886871602313   0.000000000000 AA  -15.121163509606 -16.793753432547   0.000000000000 Bohr
[INPUT] 21 Be    -5.979232645941 -10.356334733044   0.000000000000 AA  -11.299112135887 -19.570636299774   0.000000000000 Bohr
[INPUT] 22 Be    -3.695369001835 -11.373176340734   0.000000000000 AA   -6.983235342675 -21.492188450370   0.000000000000 Bohr
[INPUT] 23 Be    -1.250000000000 -11.892955567778   0.000000000000 AA   -2.362157655706 -22.474428834722   0.000000000000 Bohr
[INPUT] 24 Be     1.250000000000 -11.892955567778   0.000000000000 AA    2.362157655706 -22.474428834722   0.000000000000 Bohr
[INPUT] 25 Be     3.695369001835 -11.373176340734   0.000000000000 AA    6.983235342675 -21.492188450370   0.000000000000 Bohr
[INPUT] 26 Be     5.979232645941 -10.356334733044   0.000000000000 AA   11.299112135887 -19.570636299774   0.000000000000 Bohr
[INPUT] 27 Be     8.001775131878  -8.886871602313   0.000000000000 AA   15.121163509606 -16.793753432547   0.000000000000 Bohr
[INPUT] 28 Be     9.674601647776  -7.029009538620   0.000000000000 AA   18.282347478562 -13.282902954947   0.000000000000 Bohr
[INPUT] 29 Be    10.924601647776  -4.863946029159   0.000000000000 AA   20.644505134268  -9.191525879775   0.000000000000 Bohr
[INPUT] 30 Be    11.697144133713  -2.486304738421   0.000000000000 AA   22.104398852280  -4.698435017823   0.000000000000 Bohr
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [6    /1   ]  312.8704937       0.00916359628
                                57.36446253       0.04936149294
                                16.0485094        0.1685383049
                                5.513096119       0.3705627997
                                2.140896553       0.4164915298
                                0.8817394283      0.1303340841
[INPUT] 0    0    [6    /1   ]  13.63324744       -0.01325278809
                                2.698375464       -0.04699171014
                                0.8386530829      -0.03378537151
                                0.3226600698      0.2502417861
                                0.1401314882      0.5951172526
                                0.0642325139      0.2407061763
[INPUT] 1    0    [6    /1   ]  13.63324744       0.0037596966
                                2.698375464       0.0376793698
                                0.8386530829      0.1738967435
                                0.3226600698      0.4180364347
                                0.1401314882      0.4258595477
                                0.0642325139      0.1017082955
nuclear repulsion = 357.663090078611
number of shells = 90
number of NR pGTOs = 900
number of NR cGTOs = 150
basis = sto-6g
ecp = {}
CPU time:       740.58


******** <class 'pyscf.scf.hf.RHF'> flags ********
method = RHF
initial guess = minao
damping factor = 0
level shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
DIIS start cycle = 1
DIIS space = 8
SCF tol = 1e-09
SCF gradient tol = None
max. SCF cycles = 50
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /tigress/xingz/pydmfet/examples/tmpb40_V5
max_memory 16000 MB (current use 229 MB)
Set gradient conv threshold to 3.16228e-05
init E= -438.363318281722
  HOMO = -0.00343900777014943  LUMO = 0.00434460842063521
cycle= 1 E= -435.354145444993  delta_E= 3.01  |g|= 0.365  |ddm|= 5.82
  HOMO = -0.00973331545678471  LUMO = 0.0281626555167652
cycle= 2 E= -435.998708134108  delta_E= -0.645  |g|= 0.409  |ddm|= 5.05
  HOMO = -0.0278552790131451  LUMO = 0.0404480542955215
cycle= 3 E= -435.435047567475  delta_E= 0.564  |g|= 0.297  |ddm|= 4.94
  HOMO = -0.134084735035454  LUMO = 0.137191800094136
cycle= 4 E= -435.066885419644  delta_E= 0.368  |g|= 0.312  |ddm|= 3.27
  HOMO = -0.135584153492759  LUMO = 0.137074705561691
cycle= 5 E= -435.059531264006  delta_E= 0.00735  |g|= 0.314  |ddm|= 0.0534
  HOMO = -0.147184684000218  LUMO = 0.136002892290152
cycle= 6 E= -435.010352934353  delta_E= 0.0492  |g|= 0.327  |ddm|= 0.35
  HOMO = -0.123541354986981  LUMO = 0.130378794275412
cycle= 7 E= -435.138216483217  delta_E= -0.128  |g|= 0.292  |ddm|= 0.939
  HOMO = -0.135621394566268  LUMO = 0.136752143566082
cycle= 8 E= -435.070063363218  delta_E= 0.0682  |g|= 0.31  |ddm|= 0.513
  HOMO = -0.132111241230626  LUMO = 0.136972382030735
cycle= 9 E= -435.088871772371  delta_E= -0.0188  |g|= 0.305  |ddm|= 0.139
  HOMO = -0.133345999424902  LUMO = 0.137085642971347
cycle= 10 E= -435.086137663813  delta_E= 0.00273  |g|= 0.306  |ddm|= 0.0261
  HOMO = -0.100173850888781  LUMO = 0.126490961130562
cycle= 11 E= -436.409193651621  delta_E= -1.32  |g|= 0.196  |ddm|= 8.56
  HOMO = -0.287272023438882  LUMO = 0.184865247208979
cycle= 12 E= -436.141079709106  delta_E= 0.268  |g|= 0.513  |ddm|= 3.68
  HOMO = -0.307423345585531  LUMO = 0.118202935048516
cycle= 13 E= -434.14115724754  delta_E=    2  |g|= 0.66  |ddm|= 13.9
  HOMO = -0.0905377296898472  LUMO = 0.137722434968135
cycle= 14 E= -436.464318161268  delta_E= -2.32  |g|= 0.135  |ddm|= 12.1
  HOMO = -0.214831278391773  LUMO = 0.165611629891109
cycle= 15 E= -436.470926423508  delta_E= -0.00661  |g|= 0.116  |ddm|= 1.45
  HOMO = -0.1527286093777  LUMO = 0.161616053079432
cycle= 16 E= -436.491330577236  delta_E= -0.0204  |g|= 0.00696  |ddm|= 0.709
  HOMO = -0.155606219097912  LUMO = 0.161706960341814
cycle= 17 E= -436.491400612718  delta_E= -7e-05  |g|= 0.000827  |ddm|= 0.0347
  HOMO = -0.156079060930675  LUMO = 0.161738933407841
cycle= 18 E= -436.491401663914  delta_E= -1.05e-06  |g|= 0.000213  |ddm|= 0.00646
  HOMO = -0.155987075033175  LUMO = 0.161731317828996
cycle= 19 E= -436.491401741126  delta_E= -7.72e-08  |g|= 2.42e-06  |ddm|= 0.00136
  HOMO = -0.15598816564022  LUMO = 0.161731196766225
cycle= 20 E= -436.491401741129  delta_E= -3.3e-12  |g|= 1.4e-06  |ddm|= 5.49e-06
  HOMO = -0.155988780732259  LUMO = 0.161731217848652
Extra cycle  E= -436.491401741132  delta_E= -3.3e-12  |g|= 5.95e-07  |ddm|= 4.89e-06
converged SCF energy = -436.491401741132
e_mf =  -436.49140174113245
#INFO: **** input file is /tigress/xingz/pydmfet/examples/Be.py ****
from pydmfet import locints, sdmfet, oep, tools
from pyscf import gto, scf,dft, ao2mo,cc
import numpy as np
from pyscf.tools import molden, cubegen
import copy,time

DMguess  = None

bondlengths = np.arange(1.8, 4.1, 0.1)
energies = []

bas = 'sto-6g'

for bondlength in bondlengths:

    nat = 30
    mol = gto.Mole()
    mol.atom = []
    r = 0.5 * bondlength / np.sin(np.pi/nat)
    for i in range(nat):
        theta = i * (2*np.pi/nat)
        mol.atom.append(('Be', (r*np.cos(theta), r*np.sin(theta), 0)))

    mol.basis = bas
    mol.build(max_memory=16000, verbose=4)

    mf = scf.RHF(mol)
    #mf = dft.RKS(mol)
    #mf.xc = 'pbe,pbe'
    #mf.smear_sigma = 0.005
    mf.max_cycle = 50
    mf.scf()

    #P=mf.make_rdm1()
    #tools.MatPrint(P,"P_ref_ao")
    #cubegen.density(mol, "h20_dens.cube", P, nx=100, ny=100, nz=100)
    print 'e_mf = ',  mf.e_tot
    continue
    if ( True ):   
#        ENUCL = mf.mol.energy_nuc()
#        OEI   = np.dot(np.dot(mf.mo_coeff.T, mol.intor('cint1e_kin_sph') + mol.intor('cint1e_nuc_sph')), mf.mo_coeff)
#        TEI   = ao2mo.outcore.full_iofree(mol, mf.mo_coeff, compact=False).reshape(mol.nao_nr(), mol.nao_nr(), mol.nao_nr(), mol.nao_nr())
#        import chemps2
#        Energy, OneDM = chemps2.solve( ENUCL, OEI, OEI, TEI, mol.nao_nr(), mol.nelectron, mol.nao_nr(), 0.0, False )
#        print "bl =", bondlength," and energy =", Energy

        mycc = cc.CCSD(mf).run()
	et=0.0
        #et = mycc.ccsd_t()
        e_hf = mf.e_tot
        e_ccsd = e_hf + mycc.e_corr + et

        print 'e_tot = ', e_ccsd    #-4.96124910741
        
    else:
        myInts = locints.LocalIntegrals( mf, range( mol.nao_nr() ), 'meta_lowdin' )
        #myInts.loc_molden( 'hydrogen-loc.molden' )
        #myInts.TI_OK = True # Only s functions

	nbas =  mol.nao_nr()
	natoms = mol.natm

	impAtom = np.zeros([natoms], dtype=int)
	for i in range(20):
	    impAtom[i] = 1

	ghost_frag = 1-impAtom
	ghost_env = 1-ghost_frag

	mol_frag = gto.Mole()
	mol_frag.atom = tools.add_ghost(mol.atom, ghost_frag)
	mol_frag.basis = bas
	mol_frag.build(max_memory = 16000,verbose = 4)
	'''
	mf_frag = dft.RKS(mol_frag)
        mf_frag.xc = 'pbe,pbe'
        mf_frag.smear_sigma = 0.00
        mf_frag.scf()
        P_frag=mf_frag.make_rdm1()
        cubegen.density(mol_frag, "h10_dens_1.cube", P_frag, nx=100, ny=100, nz=100)
	'''

	mol_env = gto.Mole()
	mol_env.atom = tools.add_ghost(mol.atom, ghost_env)
	mol_env.basis =  bas
	mol_env.build(max_memory = 16000,verbose = 4)

	'''
	mf_env = dft.RKS(mol_env)
        mf_env.xc = 'pbe,pbe'
        mf_env.smear_sigma = 0.00
        mf_env.scf()
        P_env=mf_env.make_rdm1()
        cubegen.density(mol_env, "h10_dens_2.cube", P_env, nx=100, ny=100, nz=100)
	exit()
	'''



	aoslice = mol.aoslice_by_atom()
	impurities = np.zeros([nbas], dtype = int)
	for i in range(natoms):
	    if(impAtom[i] == 1):
		impurities[aoslice[i,2]:aoslice[i,3]] = 1

	Ne_frag = 20
	boundary_atoms = np.zeros((natoms))
	boundary_atoms[20:40] = 1.0
	#boundary_atoms[19] = -1
	boundary_atoms2 = np.zeros((natoms),dtype =int)
	#boundary_atoms2[9] = -1
	boundary_atoms2[0:20] = 1

	boundary_atoms = None
	boundary_atoms2 =None

	umat=None
	P_frag=None
	P_env=None
	params = oep.OEPparams(algorithm = '2011', opt_method = 'L-BFGS-B', \
                       ftol = 1e-11, gtol = 1e-5,diffP_tol=1e-5, outer_maxit = 200, maxit = 200,l2_lambda = 0.0, oep_print = 0)
	theDMFET = sdmfet.DMFET( mf, mol_frag, mol_env,myInts,impurities, impAtom, Ne_frag, boundary_atoms=boundary_atoms, boundary_atoms2=boundary_atoms2,\
                         umat = umat, P_frag_ao = P_frag, P_env_ao = P_env, \
                         dim_imp = nbas, dim_bath=nbas, dim_big =nbas, smear_sigma = 0.005, oep_params=params,ecw_method='hf', mf_method = mf.xc)

	umat = theDMFET.embedding_potential()

	exit()

	#write subspace orbitals
	transfo = np.dot( myInts.ao2loc, theDMFET.loc2sub )
	filename =  'hydrogen-sub.molden'
	with open( filename, 'w' ) as thefile:
            molden.header( myInts.mol, thefile )
            molden.orbital_coeff( myInts.mol, thefile, transfo )


        umat = theDMFET.embedding_potential()
	print umat
	exit()
	energy = theDMFET.correction_energy()

#INFO: ******************** input file end ********************


System: ('Linux', 'tigercpu.princeton.edu', '3.10.0-693.21.1.el7.x86_64', '#1 SMP Wed Mar 7 15:59:45 EST 2018', 'x86_64', 'x86_64')  Threads 40
Python 2.7.14 |Anaconda, Inc.| (default, Oct 16 2017, 17:29:19) 
[GCC 7.2.0]
numpy 1.14.3  scipy 1.1.0
Date: Thu Jun  7 01:17:01 2018
PySCF version 1.4.2
PySCF path  /tigress/xingz/pyscf/pyscf
GIT ORIG_HEAD e0edd131499dcc18d035a120533a8a1ddda110d4
GIT HEAD      e0edd131499dcc18d035a120533a8a1ddda110d4

[INPUT] VERBOSE 4
[INPUT] num atoms = 30
[INPUT] num electrons = 120
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT]  1 Be    12.436803903557   0.000000000000   0.000000000000 AA   23.502153242645   0.000000000000   0.000000000000 Bohr
[INPUT]  2 Be    12.165029899061   2.585756927958   0.000000000000 AA   22.988574806371   4.886372418536   0.000000000000 Bohr
[INPUT]  3 Be    11.361585713687   5.058503870325   0.000000000000 AA   21.470285339639   9.559186914966   0.000000000000 Bohr
[INPUT]  4 Be    10.061585713687   7.310169920164   0.000000000000 AA   19.013641377704  13.814219073144   0.000000000000 Bohr
[INPUT]  5 Be     8.321846137154   9.242346466406   0.000000000000 AA   15.726010049990  17.465503569848   0.000000000000 Bohr
[INPUT]  6 Be     6.218401951779  10.770588122366   0.000000000000 AA   11.751076621323  20.353461751765   0.000000000000 Bohr
[INPUT]  7 Be     3.843183761908  11.828103394363   0.000000000000 AA    7.262564756382  22.351875988385   0.000000000000 Bohr
[INPUT]  8 Be     1.300000000000  12.368673790489   0.000000000000 AA    2.456643961935  23.373405988111   0.000000000000 Bohr
[INPUT]  9 Be    -1.300000000000  12.368673790489   0.000000000000 AA   -2.456643961935  23.373405988111   0.000000000000 Bohr
[INPUT] 10 Be    -3.843183761908  11.828103394363   0.000000000000 AA   -7.262564756382  22.351875988385   0.000000000000 Bohr
[INPUT] 11 Be    -6.218401951779  10.770588122366   0.000000000000 AA  -11.751076621322  20.353461751765   0.000000000000 Bohr
[INPUT] 12 Be    -8.321846137154   9.242346466406   0.000000000000 AA  -15.726010049990  17.465503569848   0.000000000000 Bohr
[INPUT] 13 Be   -10.061585713687   7.310169920164   0.000000000000 AA  -19.013641377704  13.814219073144   0.000000000000 Bohr
[INPUT] 14 Be   -11.361585713687   5.058503870325   0.000000000000 AA  -21.470285339639   9.559186914966   0.000000000000 Bohr
[INPUT] 15 Be   -12.165029899061   2.585756927958   0.000000000000 AA  -22.988574806371   4.886372418536   0.000000000000 Bohr
[INPUT] 16 Be   -12.436803903557   0.000000000000   0.000000000000 AA  -23.502153242645   0.000000000000   0.000000000000 Bohr
[INPUT] 17 Be   -12.165029899061  -2.585756927958   0.000000000000 AA  -22.988574806371  -4.886372418536   0.000000000000 Bohr
[INPUT] 18 Be   -11.361585713687  -5.058503870325   0.000000000000 AA  -21.470285339639  -9.559186914966   0.000000000000 Bohr
[INPUT] 19 Be   -10.061585713687  -7.310169920164   0.000000000000 AA  -19.013641377704 -13.814219073144   0.000000000000 Bohr
[INPUT] 20 Be    -8.321846137154  -9.242346466406   0.000000000000 AA  -15.726010049990 -17.465503569848   0.000000000000 Bohr
[INPUT] 21 Be    -6.218401951779 -10.770588122366   0.000000000000 AA  -11.751076621323 -20.353461751765   0.000000000000 Bohr
[INPUT] 22 Be    -3.843183761908 -11.828103394363   0.000000000000 AA   -7.262564756382 -22.351875988385   0.000000000000 Bohr
[INPUT] 23 Be    -1.300000000000 -12.368673790489   0.000000000000 AA   -2.456643961935 -23.373405988111   0.000000000000 Bohr
[INPUT] 24 Be     1.300000000000 -12.368673790489   0.000000000000 AA    2.456643961935 -23.373405988111   0.000000000000 Bohr
[INPUT] 25 Be     3.843183761908 -11.828103394363   0.000000000000 AA    7.262564756382 -22.351875988385   0.000000000000 Bohr
[INPUT] 26 Be     6.218401951779 -10.770588122366   0.000000000000 AA   11.751076621322 -20.353461751765   0.000000000000 Bohr
[INPUT] 27 Be     8.321846137154  -9.242346466406   0.000000000000 AA   15.726010049990 -17.465503569848   0.000000000000 Bohr
[INPUT] 28 Be    10.061585713687  -7.310169920164   0.000000000000 AA   19.013641377704 -13.814219073144   0.000000000000 Bohr
[INPUT] 29 Be    11.361585713687  -5.058503870325   0.000000000000 AA   21.470285339639  -9.559186914966   0.000000000000 Bohr
[INPUT] 30 Be    12.165029899061  -2.585756927958   0.000000000000 AA   22.988574806371  -4.886372418536   0.000000000000 Bohr
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [6    /1   ]  312.8704937       0.00916359628
                                57.36446253       0.04936149294
                                16.0485094        0.1685383049
                                5.513096119       0.3705627997
                                2.140896553       0.4164915298
                                0.8817394283      0.1303340841
[INPUT] 0    0    [6    /1   ]  13.63324744       -0.01325278809
                                2.698375464       -0.04699171014
                                0.8386530829      -0.03378537151
                                0.3226600698      0.2502417861
                                0.1401314882      0.5951172526
                                0.0642325139      0.2407061763
[INPUT] 1    0    [6    /1   ]  13.63324744       0.0037596966
                                2.698375464       0.0376793698
                                0.8386530829      0.1738967435
                                0.3226600698      0.4180364347
                                0.1401314882      0.4258595477
                                0.0642325139      0.1017082955
nuclear repulsion = 343.90681738328
number of shells = 90
number of NR pGTOs = 900
number of NR cGTOs = 150
basis = sto-6g
ecp = {}
CPU time:       887.31


******** <class 'pyscf.scf.hf.RHF'> flags ********
method = RHF
initial guess = minao
damping factor = 0
level shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
DIIS start cycle = 1
DIIS space = 8
SCF tol = 1e-09
SCF gradient tol = None
max. SCF cycles = 50
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /tigress/xingz/pydmfet/examples/tmpUULVVj
max_memory 16000 MB (current use 229 MB)
Set gradient conv threshold to 3.16228e-05
init E= -437.777630810486
  HOMO = -0.034614405016147  LUMO = 0.0103330452457463
cycle= 1 E= -435.236890820974  delta_E= 2.54  |g|= 0.279  |ddm|=  5.5
  HOMO = -0.0173204383963688  LUMO = 0.0158500436655192
cycle= 2 E= -435.406689093349  delta_E= -0.17  |g|= 0.209  |ddm|= 1.64
  HOMO = -0.0367632266514258  LUMO = 0.0449934316286556
cycle= 3 E= -436.018280805609  delta_E= -0.612  |g|= 0.26  |ddm|= 5.18
  HOMO = -0.174793793801739  LUMO = 0.141590538398475
cycle= 4 E= -435.05075044253  delta_E= 0.968  |g|= 0.281  |ddm|= 7.69
  HOMO = -0.153942569716931  LUMO = 0.140079981076584
cycle= 5 E= -435.122085581096  delta_E= -0.0713  |g|= 0.25  |ddm|= 0.579
  HOMO = -0.198163612881402  LUMO = 0.139843965862149
cycle= 6 E= -434.964827973539  delta_E= 0.157  |g|= 0.317  |ddm|=  1.2
  HOMO = -0.0987883083851093  LUMO = 0.0896669296205673
cycle= 7 E= -435.277299919547  delta_E= -0.312  |g|= 0.194  |ddm|=  2.7
  HOMO = -0.16035669876564  LUMO = 0.142471810808072
cycle= 8 E= -435.090012809397  delta_E= 0.187  |g|= 0.26  |ddm|=  1.8
  HOMO = -0.158733934897554  LUMO = 0.142846002801335
cycle= 9 E= -435.098154700283  delta_E= -0.00814  |g|= 0.257  |ddm|= 0.0678
  HOMO = -0.145689547423733  LUMO = 0.133239878477075
cycle= 10 E= -435.143122798603  delta_E= -0.045  |g|= 0.238  |ddm|= 0.39
  HOMO = -0.224238246791111  LUMO = 0.137820502607534
cycle= 11 E= -434.849166999023  delta_E= 0.294  |g|= 0.373  |ddm|= 2.08
  HOMO = -0.0312917346141467  LUMO = 0.0274032780049711
cycle= 12 E= -435.387299800984  delta_E= -0.538  |g|= 0.175  |ddm|= 4.57
  HOMO = -0.0331144672089518  LUMO = 0.0288868196973628
cycle= 13 E= -435.388374284109  delta_E= -0.00107  |g|= 0.174  |ddm|= 0.0523
  HOMO = -0.00889342006233465  LUMO = 0.00772260896933176
cycle= 14 E= -435.480331650798  delta_E= -0.092  |g|= 0.17  |ddm|= 1.15
  HOMO = -0.0519893398027658  LUMO = 0.0444746030002212
cycle= 15 E= -435.34475542284  delta_E= 0.136  |g|= 0.179  |ddm|= 1.67
  HOMO = -0.0733117374823063  LUMO = 0.085490290118893
cycle= 16 E= -436.147933102968  delta_E= -0.803  |g|= 0.169  |ddm|= 6.47
  HOMO = -0.32664225235455  LUMO = 0.124746083169363
cycle= 17 E= -434.518528045995  delta_E= 1.63  |g|= 0.536  |ddm|= 10.4
  HOMO = -0.426626092887615  LUMO = 0.103469809324365
cycle= 18 E= -433.850017679155  delta_E= 0.669  |g|= 0.815  |ddm|= 2.13
  HOMO = -0.428801976509428  LUMO = 0.102742867176919
cycle= 19 E= -433.825396891475  delta_E= 0.0246  |g|= 0.825  |ddm|= 0.0652
  HOMO = -0.437145618543036  LUMO = 0.0999127761064481
cycle= 20 E= -433.748444853749  delta_E= 0.077  |g|= 0.854  |ddm|=  0.2
  HOMO = -0.437233283547087  LUMO = 0.0998914432156711
cycle= 21 E= -433.748881930037  delta_E= -0.000437  |g|= 0.854  |ddm|= 0.0023
  HOMO = -0.382066876206194  LUMO = 0.11462825786737
cycle= 22 E= -434.188074260096  delta_E= -0.439  |g|= 0.68  |ddm|= 1.24
  HOMO = -0.321673651111813  LUMO = 0.125158763930028
cycle= 23 E= -434.565607946752  delta_E= -0.378  |g|= 0.518  |ddm|= 1.36
  HOMO = -0.156133392587559  LUMO = 0.164906672168963
cycle= 24 E= -436.218922857401  delta_E= -1.65  |g|= 0.0374  |ddm|= 11.1
  HOMO = -0.203184017573659  LUMO = 0.172380708699942
cycle= 25 E= -436.187397917876  delta_E= 0.0315  |g|= 0.137  |ddm|= 1.04
  HOMO = -0.100342131986305  LUMO = 0.120844293033207
cycle= 26 E= -436.199358847355  delta_E= -0.012  |g|= 0.103  |ddm|= 1.66
  HOMO = -0.132818537555961  LUMO = 0.155806373754403
cycle= 27 E= -436.219308498033  delta_E= -0.0199  |g|= 0.0317  |ddm|= 0.546
  HOMO = -0.149841737331643  LUMO = 0.16680326486639
cycle= 28 E= -436.221172857436  delta_E= -0.00186  |g|= 0.00678  |ddm|= 0.271
  HOMO = -0.146913512490587  LUMO = 0.166635012807745
cycle= 29 E= -436.221258139842  delta_E= -8.53e-05  |g|= 0.000521  |ddm|= 0.0428
  HOMO = -0.146674762290794  LUMO = 0.166618027352631
cycle= 30 E= -436.221258648634  delta_E= -5.09e-07  |g|= 1.27e-05  |ddm|= 0.00367
  HOMO = -0.14668350759553  LUMO = 0.166618530219161
cycle= 31 E= -436.221258648907  delta_E= -2.73e-10  |g|= 3.26e-06  |ddm|= 0.000107
  HOMO = -0.146681951966393  LUMO = 0.166618511327315
Extra cycle  E= -436.221258648923  delta_E= -1.56e-11  |g|= 1.49e-06  |ddm|= 1.2e-05
converged SCF energy = -436.221258648923
e_mf =  -436.22125864892257
#INFO: **** input file is /tigress/xingz/pydmfet/examples/Be.py ****
from pydmfet import locints, sdmfet, oep, tools
from pyscf import gto, scf,dft, ao2mo,cc
import numpy as np
from pyscf.tools import molden, cubegen
import copy,time

DMguess  = None

bondlengths = np.arange(1.8, 4.1, 0.1)
energies = []

bas = 'sto-6g'

for bondlength in bondlengths:

    nat = 30
    mol = gto.Mole()
    mol.atom = []
    r = 0.5 * bondlength / np.sin(np.pi/nat)
    for i in range(nat):
        theta = i * (2*np.pi/nat)
        mol.atom.append(('Be', (r*np.cos(theta), r*np.sin(theta), 0)))

    mol.basis = bas
    mol.build(max_memory=16000, verbose=4)

    mf = scf.RHF(mol)
    #mf = dft.RKS(mol)
    #mf.xc = 'pbe,pbe'
    #mf.smear_sigma = 0.005
    mf.max_cycle = 50
    mf.scf()

    #P=mf.make_rdm1()
    #tools.MatPrint(P,"P_ref_ao")
    #cubegen.density(mol, "h20_dens.cube", P, nx=100, ny=100, nz=100)
    print 'e_mf = ',  mf.e_tot
    continue
    if ( True ):   
#        ENUCL = mf.mol.energy_nuc()
#        OEI   = np.dot(np.dot(mf.mo_coeff.T, mol.intor('cint1e_kin_sph') + mol.intor('cint1e_nuc_sph')), mf.mo_coeff)
#        TEI   = ao2mo.outcore.full_iofree(mol, mf.mo_coeff, compact=False).reshape(mol.nao_nr(), mol.nao_nr(), mol.nao_nr(), mol.nao_nr())
#        import chemps2
#        Energy, OneDM = chemps2.solve( ENUCL, OEI, OEI, TEI, mol.nao_nr(), mol.nelectron, mol.nao_nr(), 0.0, False )
#        print "bl =", bondlength," and energy =", Energy

        mycc = cc.CCSD(mf).run()
	et=0.0
        #et = mycc.ccsd_t()
        e_hf = mf.e_tot
        e_ccsd = e_hf + mycc.e_corr + et

        print 'e_tot = ', e_ccsd    #-4.96124910741
        
    else:
        myInts = locints.LocalIntegrals( mf, range( mol.nao_nr() ), 'meta_lowdin' )
        #myInts.loc_molden( 'hydrogen-loc.molden' )
        #myInts.TI_OK = True # Only s functions

	nbas =  mol.nao_nr()
	natoms = mol.natm

	impAtom = np.zeros([natoms], dtype=int)
	for i in range(20):
	    impAtom[i] = 1

	ghost_frag = 1-impAtom
	ghost_env = 1-ghost_frag

	mol_frag = gto.Mole()
	mol_frag.atom = tools.add_ghost(mol.atom, ghost_frag)
	mol_frag.basis = bas
	mol_frag.build(max_memory = 16000,verbose = 4)
	'''
	mf_frag = dft.RKS(mol_frag)
        mf_frag.xc = 'pbe,pbe'
        mf_frag.smear_sigma = 0.00
        mf_frag.scf()
        P_frag=mf_frag.make_rdm1()
        cubegen.density(mol_frag, "h10_dens_1.cube", P_frag, nx=100, ny=100, nz=100)
	'''

	mol_env = gto.Mole()
	mol_env.atom = tools.add_ghost(mol.atom, ghost_env)
	mol_env.basis =  bas
	mol_env.build(max_memory = 16000,verbose = 4)

	'''
	mf_env = dft.RKS(mol_env)
        mf_env.xc = 'pbe,pbe'
        mf_env.smear_sigma = 0.00
        mf_env.scf()
        P_env=mf_env.make_rdm1()
        cubegen.density(mol_env, "h10_dens_2.cube", P_env, nx=100, ny=100, nz=100)
	exit()
	'''



	aoslice = mol.aoslice_by_atom()
	impurities = np.zeros([nbas], dtype = int)
	for i in range(natoms):
	    if(impAtom[i] == 1):
		impurities[aoslice[i,2]:aoslice[i,3]] = 1

	Ne_frag = 20
	boundary_atoms = np.zeros((natoms))
	boundary_atoms[20:40] = 1.0
	#boundary_atoms[19] = -1
	boundary_atoms2 = np.zeros((natoms),dtype =int)
	#boundary_atoms2[9] = -1
	boundary_atoms2[0:20] = 1

	boundary_atoms = None
	boundary_atoms2 =None

	umat=None
	P_frag=None
	P_env=None
	params = oep.OEPparams(algorithm = '2011', opt_method = 'L-BFGS-B', \
                       ftol = 1e-11, gtol = 1e-5,diffP_tol=1e-5, outer_maxit = 200, maxit = 200,l2_lambda = 0.0, oep_print = 0)
	theDMFET = sdmfet.DMFET( mf, mol_frag, mol_env,myInts,impurities, impAtom, Ne_frag, boundary_atoms=boundary_atoms, boundary_atoms2=boundary_atoms2,\
                         umat = umat, P_frag_ao = P_frag, P_env_ao = P_env, \
                         dim_imp = nbas, dim_bath=nbas, dim_big =nbas, smear_sigma = 0.005, oep_params=params,ecw_method='hf', mf_method = mf.xc)

	umat = theDMFET.embedding_potential()

	exit()

	#write subspace orbitals
	transfo = np.dot( myInts.ao2loc, theDMFET.loc2sub )
	filename =  'hydrogen-sub.molden'
	with open( filename, 'w' ) as thefile:
            molden.header( myInts.mol, thefile )
            molden.orbital_coeff( myInts.mol, thefile, transfo )


        umat = theDMFET.embedding_potential()
	print umat
	exit()
	energy = theDMFET.correction_energy()

#INFO: ******************** input file end ********************


System: ('Linux', 'tigercpu.princeton.edu', '3.10.0-693.21.1.el7.x86_64', '#1 SMP Wed Mar 7 15:59:45 EST 2018', 'x86_64', 'x86_64')  Threads 40
Python 2.7.14 |Anaconda, Inc.| (default, Oct 16 2017, 17:29:19) 
[GCC 7.2.0]
numpy 1.14.3  scipy 1.1.0
Date: Thu Jun  7 01:17:05 2018
PySCF version 1.4.2
PySCF path  /tigress/xingz/pyscf/pyscf
GIT ORIG_HEAD e0edd131499dcc18d035a120533a8a1ddda110d4
GIT HEAD      e0edd131499dcc18d035a120533a8a1ddda110d4

[INPUT] VERBOSE 4
[INPUT] num atoms = 30
[INPUT] num electrons = 120
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT]  1 Be    12.915142515233   0.000000000000   0.000000000000 AA   24.406082213516   0.000000000000   0.000000000000 Bohr
[INPUT]  2 Be    12.632915664410   2.685209117494   0.000000000000 AA   23.872750760463   5.074309819249   0.000000000000 Bohr
[INPUT]  3 Be    11.798569779598   5.253061711491   0.000000000000 AA   22.296065545009   9.926847950157   0.000000000000 Bohr
[INPUT]  4 Be    10.448569779598   7.591330301709   0.000000000000 AA   19.744935276847  14.345535191342   0.000000000000 Bohr
[INPUT]  5 Be     8.641917142429   9.597821330498   0.000000000000 AA   16.330856590374  18.137253707150   0.000000000000 Bohr
[INPUT]  6 Be     6.457571257616  11.184841511688   0.000000000000 AA   12.203041106758  21.136287203756   0.000000000000 Bohr
[INPUT]  7 Be     3.990998521981  12.283030447993   0.000000000000 AA    7.541894170089  23.211563526400   0.000000000000 Bohr
[INPUT]  8 Be     1.350000000000  12.844392013200   0.000000000000 AA    2.551130268163  24.272383141500   0.000000000000 Bohr
[INPUT]  9 Be    -1.350000000000  12.844392013200   0.000000000000 AA   -2.551130268163  24.272383141500   0.000000000000 Bohr
[INPUT] 10 Be    -3.990998521981  12.283030447993   0.000000000000 AA   -7.541894170089  23.211563526400   0.000000000000 Bohr
[INPUT] 11 Be    -6.457571257616  11.184841511688   0.000000000000 AA  -12.203041106758  21.136287203756   0.000000000000 Bohr
[INPUT] 12 Be    -8.641917142429   9.597821330498   0.000000000000 AA  -16.330856590374  18.137253707150   0.000000000000 Bohr
[INPUT] 13 Be   -10.448569779598   7.591330301709   0.000000000000 AA  -19.744935276847  14.345535191342   0.000000000000 Bohr
[INPUT] 14 Be   -11.798569779598   5.253061711491   0.000000000000 AA  -22.296065545009   9.926847950157   0.000000000000 Bohr
[INPUT] 15 Be   -12.632915664410   2.685209117494   0.000000000000 AA  -23.872750760463   5.074309819249   0.000000000000 Bohr
[INPUT] 16 Be   -12.915142515233   0.000000000000   0.000000000000 AA  -24.406082213516   0.000000000000   0.000000000000 Bohr
[INPUT] 17 Be   -12.632915664410  -2.685209117494   0.000000000000 AA  -23.872750760463  -5.074309819249   0.000000000000 Bohr
[INPUT] 18 Be   -11.798569779598  -5.253061711491   0.000000000000 AA  -22.296065545009  -9.926847950157   0.000000000000 Bohr
[INPUT] 19 Be   -10.448569779598  -7.591330301709   0.000000000000 AA  -19.744935276847 -14.345535191342   0.000000000000 Bohr
[INPUT] 20 Be    -8.641917142429  -9.597821330498   0.000000000000 AA  -16.330856590374 -18.137253707150   0.000000000000 Bohr
[INPUT] 21 Be    -6.457571257616 -11.184841511688   0.000000000000 AA  -12.203041106758 -21.136287203756   0.000000000000 Bohr
[INPUT] 22 Be    -3.990998521981 -12.283030447993   0.000000000000 AA   -7.541894170089 -23.211563526400   0.000000000000 Bohr
[INPUT] 23 Be    -1.350000000000 -12.844392013200   0.000000000000 AA   -2.551130268163 -24.272383141500   0.000000000000 Bohr
[INPUT] 24 Be     1.350000000000 -12.844392013200   0.000000000000 AA    2.551130268163 -24.272383141500   0.000000000000 Bohr
[INPUT] 25 Be     3.990998521981 -12.283030447993   0.000000000000 AA    7.541894170089 -23.211563526400   0.000000000000 Bohr
[INPUT] 26 Be     6.457571257616 -11.184841511688   0.000000000000 AA   12.203041106758 -21.136287203756   0.000000000000 Bohr
[INPUT] 27 Be     8.641917142429  -9.597821330498   0.000000000000 AA   16.330856590374 -18.137253707150   0.000000000000 Bohr
[INPUT] 28 Be    10.448569779598  -7.591330301709   0.000000000000 AA   19.744935276847 -14.345535191342   0.000000000000 Bohr
[INPUT] 29 Be    11.798569779598  -5.253061711491   0.000000000000 AA   22.296065545009  -9.926847950157   0.000000000000 Bohr
[INPUT] 30 Be    12.632915664410  -2.685209117494   0.000000000000 AA   23.872750760463  -5.074309819249   0.000000000000 Bohr
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [6    /1   ]  312.8704937       0.00916359628
                                57.36446253       0.04936149294
                                16.0485094        0.1685383049
                                5.513096119       0.3705627997
                                2.140896553       0.4164915298
                                0.8817394283      0.1303340841
[INPUT] 0    0    [6    /1   ]  13.63324744       -0.01325278809
                                2.698375464       -0.04699171014
                                0.8386530829      -0.03378537151
                                0.3226600698      0.2502417861
                                0.1401314882      0.5951172526
                                0.0642325139      0.2407061763
[INPUT] 1    0    [6    /1   ]  13.63324744       0.0037596966
                                2.698375464       0.0376793698
                                0.8386530829      0.1738967435
                                0.3226600698      0.4180364347
                                0.1401314882      0.4258595477
                                0.0642325139      0.1017082955
nuclear repulsion = 331.169527850566
number of shells = 90
number of NR pGTOs = 900
number of NR cGTOs = 150
basis = sto-6g
ecp = {}
CPU time:      1037.25


******** <class 'pyscf.scf.hf.RHF'> flags ********
method = RHF
initial guess = minao
damping factor = 0
level shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
DIIS start cycle = 1
DIIS space = 8
SCF tol = 1e-09
SCF gradient tol = None
max. SCF cycles = 50
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /tigress/xingz/pydmfet/examples/tmp6C6SDE
max_memory 16000 MB (current use 229 MB)
Set gradient conv threshold to 3.16228e-05
init E= -437.27441146818
  HOMO = -0.0630007642733364  LUMO = 0.0166766086665368
cycle= 1 E= -435.174570747008  delta_E=  2.1  |g|= 0.213  |ddm|= 5.17
  HOMO = -0.0540312323185018  LUMO = 0.0365172464160462
cycle= 2 E= -435.25971971026  delta_E= -0.0851  |g|= 0.138  |ddm|= 1.05
  HOMO = -0.0163424682244016  LUMO = 0.00407543709463331
cycle= 3 E= -435.375363592444  delta_E= -0.116  |g|= 0.105  |ddm|= 2.11
  HOMO = -0.0180790649991923  LUMO = 0.00890891076651737
cycle= 4 E= -435.674274153695  delta_E= -0.299  |g|= 0.233  |ddm|= 4.19
  HOMO = -0.0558827390960462  LUMO = 0.0421494736055631
cycle= 5 E= -435.342354555118  delta_E= 0.332  |g|= 0.104  |ddm|= 4.45
  HOMO = -0.0751897388404501  LUMO = 0.0591038679154269
cycle= 6 E= -435.293119954457  delta_E= 0.0492  |g|= 0.108  |ddm|= 0.979
  HOMO = -0.0773207576783086  LUMO = 0.0609997272537315
cycle= 7 E= -435.288057183835  delta_E= 0.00506  |g|= 0.109  |ddm|= 0.0966
  HOMO = -0.0736973058736805  LUMO = 0.0579118267569993
cycle= 8 E= -435.298134631383  delta_E= -0.0101  |g|= 0.107  |ddm|= 0.193
  HOMO = -0.0824432338488159  LUMO = 0.0646278572731295
cycle= 9 E= -435.266630191108  delta_E= 0.0315  |g|= 0.115  |ddm|= 0.587
  HOMO = -0.0965314967128613  LUMO = 0.076936772730054
cycle= 10 E= -435.233672405678  delta_E= 0.033  |g|= 0.128  |ddm|= 0.554
  HOMO = -0.0957626900366288  LUMO = 0.0763155469684276
cycle= 11 E= -435.235791426818  delta_E= -0.00212  |g|= 0.127  |ddm|= 0.0335
  HOMO = -0.0815108445240008  LUMO = 0.0643811882391761
cycle= 12 E= -435.272300736749  delta_E= -0.0365  |g|= 0.113  |ddm|= 0.621
  HOMO = -0.062967936635408  LUMO = 0.0441870694069989
cycle= 13 E= -435.270238535949  delta_E= 0.00206  |g|= 0.113  |ddm|= 0.0403
  HOMO = -0.0549309556887419  LUMO = 0.0370778580084503
cycle= 14 E= -435.287991706739  delta_E= -0.0178  |g|= 0.108  |ddm|= 0.327
  HOMO = -0.0600013495784413  LUMO = 0.0414735276666413
cycle= 15 E= -435.275962823461  delta_E= 0.012  |g|= 0.111  |ddm|= 0.225
  HOMO = -0.0855669524184891  LUMO = 0.0640323772188714
cycle= 16 E= -435.216290790378  delta_E= 0.0597  |g|= 0.135  |ddm|= 0.993
  HOMO = -0.0500645698729979  LUMO = 0.0326047523019534
cycle= 17 E= -435.297700743588  delta_E= -0.0814  |g|= 0.106  |ddm|=  1.4
  HOMO = -0.102367751335218  LUMO = 0.0790575516403834
cycle= 18 E= -435.176400404341  delta_E= 0.121  |g|= 0.156  |ddm|= 1.94
  HOMO = -0.0941183242434908  LUMO = 0.0716808420588037
cycle= 19 E= -435.195614765112  delta_E= -0.0192  |g|= 0.145  |ddm|= 0.254
  HOMO = -0.0597010939866456  LUMO = 0.0412227640274118
cycle= 20 E= -435.274791039854  delta_E= -0.0792  |g|= 0.111  |ddm|= 1.26
  HOMO = -0.0517696947966264  LUMO = 0.0341759874259459
cycle= 21 E= -435.293440324928  delta_E= -0.0186  |g|= 0.107  |ddm|= 0.351
  HOMO = -0.070587583136095  LUMO = 0.0508599862273798
cycle= 22 E= -435.250360984498  delta_E= 0.0431  |g|= 0.119  |ddm|= 0.781
  HOMO = -0.0976431933206078  LUMO = 0.0747013688365682
cycle= 23 E= -435.187542699953  delta_E= 0.0628  |g|= 0.15  |ddm|= 0.945
  HOMO = -0.150318410749266  LUMO = 0.121637861598224
cycle= 24 E= -435.053496284332  delta_E= 0.134  |g|= 0.232  |ddm|= 1.42
  HOMO = -0.154486539375867  LUMO = 0.12573203062633
cycle= 25 E= -435.043794879861  delta_E= 0.0097  |g|= 0.238  |ddm|= 0.144
  HOMO = -0.154108564082112  LUMO = 0.125379572369937
cycle= 26 E= -435.045303961379  delta_E= -0.00151  |g|= 0.237  |ddm|= 0.0941
  HOMO = -0.151106297084099  LUMO = 0.122741873261056
cycle= 27 E= -435.053326603969  delta_E= -0.00802  |g|= 0.232  |ddm|= 0.0678
  HOMO = -0.105564056731487  LUMO = 0.0828129579849403
cycle= 28 E= -435.168252253016  delta_E= -0.115  |g|= 0.161  |ddm|= 1.21
  HOMO = -0.0954370616552453  LUMO = 0.0736724495827879
cycle= 29 E= -435.191509281807  delta_E= -0.0233  |g|= 0.147  |ddm|= 0.372
  HOMO = -0.0554260857214882  LUMO = 0.0505582469337912
cycle= 30 E= -435.831448268876  delta_E= -0.64  |g|= 0.168  |ddm|= 7.01
  HOMO = -0.144511994328841  LUMO = 0.118658521707999
cycle= 31 E= -435.143474046928  delta_E= 0.688  |g|= 0.181  |ddm|=  7.4
  HOMO = -0.182361108585204  LUMO = 0.149542568293163
cycle= 32 E= -435.052827695356  delta_E= 0.0906  |g|= 0.238  |ddm|= 0.873
  HOMO = -0.227584360904824  LUMO = 0.146042891622086
cycle= 33 E= -434.925205416056  delta_E= 0.128  |g|= 0.318  |ddm|= 0.92
  HOMO = -0.206502258960448  LUMO = 0.147924738425448
cycle= 34 E= -434.993032137351  delta_E= -0.0678  |g|= 0.276  |ddm|= 0.457
  HOMO = -0.185030294646115  LUMO = 0.149511869538653
cycle= 35 E= -435.047908596806  delta_E= -0.0549  |g|= 0.241  |ddm|= 0.424
  HOMO = -0.181938922585167  LUMO = 0.149681049434355
cycle= 36 E= -435.056250683905  delta_E= -0.00834  |g|= 0.236  |ddm|= 0.0715
  HOMO = -0.168167398974963  LUMO = 0.141220638187185
cycle= 37 E= -435.090435761237  delta_E= -0.0342  |g|= 0.214  |ddm|= 0.316
  HOMO = -0.129180067158186  LUMO = 0.104773347562078
cycle= 38 E= -435.16944310934  delta_E= -0.079  |g|= 0.164  |ddm|= 0.848
  HOMO = -0.0119106207968631  LUMO = -0.000452311337943234
cycle= 39 E= -435.426715196331  delta_E= -0.257  |g|= 0.147  |ddm|= 4.09
  HOMO = -0.00880182440546502  LUMO = -0.00204644177951404
cycle= 40 E= -435.580638239378  delta_E= -0.154  |g|= 0.231  |ddm|= 3.58
  HOMO = -0.106158113091507  LUMO = 0.0847654732285245
cycle= 41 E= -435.195517190395  delta_E= 0.385  |g|= 0.145  |ddm|= 5.27
  HOMO = -0.0902139930146743  LUMO = 0.0700957012441702
cycle= 42 E= -435.228004559802  delta_E= -0.0325  |g|= 0.129  |ddm|= 0.479
  HOMO = -0.0893035058049429  LUMO = 0.068851209280564
cycle= 43 E= -435.228076320364  delta_E= -7.18e-05  |g|= 0.129  |ddm|= 0.0759
  HOMO = -0.0849722523584829  LUMO = 0.0650894393818851
cycle= 44 E= -435.238905676173  delta_E= -0.0108  |g|= 0.124  |ddm|= 0.216
  HOMO = -0.083116958623747  LUMO = 0.0636157243030656
cycle= 45 E= -435.244869524698  delta_E= -0.00596  |g|= 0.122  |ddm|= 0.142
  HOMO = -0.114252996721313  LUMO = 0.092801032266774
cycle= 46 E= -435.182661206044  delta_E= 0.0622  |g|= 0.153  |ddm|= 0.923
  HOMO = -0.0980773156481584  LUMO = 0.0777762720306355
cycle= 47 E= -435.219101570355  delta_E= -0.0364  |g|= 0.133  |ddm|= 0.517
  HOMO = -0.0348096702838169  LUMO = 0.021009392524271
cycle= 48 E= -435.351078240587  delta_E= -0.132  |g|= 0.102  |ddm|=  2.4
  HOMO = -0.0941463003011331  LUMO = 0.0719230048147457
cycle= 49 E= -435.193750526631  delta_E= 0.157  |g|= 0.147  |ddm|= 2.75
  HOMO = -0.0875299953711915  LUMO = 0.0663632008811458
cycle= 50 E= -435.208033068379  delta_E= -0.0143  |g|= 0.139  |ddm|= 0.208
  HOMO = -0.0500804368478821  LUMO = 0.0342220304626219
Extra cycle  E= -435.276084338503  delta_E= -0.0681  |g|= 0.12  |ddm|= 1.16
SCF not converged.
SCF energy = -435.276084338503 after 50 cycles
e_mf =  -435.27608433850276
#INFO: **** input file is /tigress/xingz/pydmfet/examples/Be.py ****
from pydmfet import locints, sdmfet, oep, tools
from pyscf import gto, scf,dft, ao2mo,cc
import numpy as np
from pyscf.tools import molden, cubegen
import copy,time

DMguess  = None

bondlengths = np.arange(1.8, 4.1, 0.1)
energies = []

bas = 'sto-6g'

for bondlength in bondlengths:

    nat = 30
    mol = gto.Mole()
    mol.atom = []
    r = 0.5 * bondlength / np.sin(np.pi/nat)
    for i in range(nat):
        theta = i * (2*np.pi/nat)
        mol.atom.append(('Be', (r*np.cos(theta), r*np.sin(theta), 0)))

    mol.basis = bas
    mol.build(max_memory=16000, verbose=4)

    mf = scf.RHF(mol)
    #mf = dft.RKS(mol)
    #mf.xc = 'pbe,pbe'
    #mf.smear_sigma = 0.005
    mf.max_cycle = 50
    mf.scf()

    #P=mf.make_rdm1()
    #tools.MatPrint(P,"P_ref_ao")
    #cubegen.density(mol, "h20_dens.cube", P, nx=100, ny=100, nz=100)
    print 'e_mf = ',  mf.e_tot
    continue
    if ( True ):   
#        ENUCL = mf.mol.energy_nuc()
#        OEI   = np.dot(np.dot(mf.mo_coeff.T, mol.intor('cint1e_kin_sph') + mol.intor('cint1e_nuc_sph')), mf.mo_coeff)
#        TEI   = ao2mo.outcore.full_iofree(mol, mf.mo_coeff, compact=False).reshape(mol.nao_nr(), mol.nao_nr(), mol.nao_nr(), mol.nao_nr())
#        import chemps2
#        Energy, OneDM = chemps2.solve( ENUCL, OEI, OEI, TEI, mol.nao_nr(), mol.nelectron, mol.nao_nr(), 0.0, False )
#        print "bl =", bondlength," and energy =", Energy

        mycc = cc.CCSD(mf).run()
	et=0.0
        #et = mycc.ccsd_t()
        e_hf = mf.e_tot
        e_ccsd = e_hf + mycc.e_corr + et

        print 'e_tot = ', e_ccsd    #-4.96124910741
        
    else:
        myInts = locints.LocalIntegrals( mf, range( mol.nao_nr() ), 'meta_lowdin' )
        #myInts.loc_molden( 'hydrogen-loc.molden' )
        #myInts.TI_OK = True # Only s functions

	nbas =  mol.nao_nr()
	natoms = mol.natm

	impAtom = np.zeros([natoms], dtype=int)
	for i in range(20):
	    impAtom[i] = 1

	ghost_frag = 1-impAtom
	ghost_env = 1-ghost_frag

	mol_frag = gto.Mole()
	mol_frag.atom = tools.add_ghost(mol.atom, ghost_frag)
	mol_frag.basis = bas
	mol_frag.build(max_memory = 16000,verbose = 4)
	'''
	mf_frag = dft.RKS(mol_frag)
        mf_frag.xc = 'pbe,pbe'
        mf_frag.smear_sigma = 0.00
        mf_frag.scf()
        P_frag=mf_frag.make_rdm1()
        cubegen.density(mol_frag, "h10_dens_1.cube", P_frag, nx=100, ny=100, nz=100)
	'''

	mol_env = gto.Mole()
	mol_env.atom = tools.add_ghost(mol.atom, ghost_env)
	mol_env.basis =  bas
	mol_env.build(max_memory = 16000,verbose = 4)

	'''
	mf_env = dft.RKS(mol_env)
        mf_env.xc = 'pbe,pbe'
        mf_env.smear_sigma = 0.00
        mf_env.scf()
        P_env=mf_env.make_rdm1()
        cubegen.density(mol_env, "h10_dens_2.cube", P_env, nx=100, ny=100, nz=100)
	exit()
	'''



	aoslice = mol.aoslice_by_atom()
	impurities = np.zeros([nbas], dtype = int)
	for i in range(natoms):
	    if(impAtom[i] == 1):
		impurities[aoslice[i,2]:aoslice[i,3]] = 1

	Ne_frag = 20
	boundary_atoms = np.zeros((natoms))
	boundary_atoms[20:40] = 1.0
	#boundary_atoms[19] = -1
	boundary_atoms2 = np.zeros((natoms),dtype =int)
	#boundary_atoms2[9] = -1
	boundary_atoms2[0:20] = 1

	boundary_atoms = None
	boundary_atoms2 =None

	umat=None
	P_frag=None
	P_env=None
	params = oep.OEPparams(algorithm = '2011', opt_method = 'L-BFGS-B', \
                       ftol = 1e-11, gtol = 1e-5,diffP_tol=1e-5, outer_maxit = 200, maxit = 200,l2_lambda = 0.0, oep_print = 0)
	theDMFET = sdmfet.DMFET( mf, mol_frag, mol_env,myInts,impurities, impAtom, Ne_frag, boundary_atoms=boundary_atoms, boundary_atoms2=boundary_atoms2,\
                         umat = umat, P_frag_ao = P_frag, P_env_ao = P_env, \
                         dim_imp = nbas, dim_bath=nbas, dim_big =nbas, smear_sigma = 0.005, oep_params=params,ecw_method='hf', mf_method = mf.xc)

	umat = theDMFET.embedding_potential()

	exit()

	#write subspace orbitals
	transfo = np.dot( myInts.ao2loc, theDMFET.loc2sub )
	filename =  'hydrogen-sub.molden'
	with open( filename, 'w' ) as thefile:
            molden.header( myInts.mol, thefile )
            molden.orbital_coeff( myInts.mol, thefile, transfo )


        umat = theDMFET.embedding_potential()
	print umat
	exit()
	energy = theDMFET.correction_energy()

#INFO: ******************** input file end ********************


System: ('Linux', 'tigercpu.princeton.edu', '3.10.0-693.21.1.el7.x86_64', '#1 SMP Wed Mar 7 15:59:45 EST 2018', 'x86_64', 'x86_64')  Threads 40
Python 2.7.14 |Anaconda, Inc.| (default, Oct 16 2017, 17:29:19) 
[GCC 7.2.0]
numpy 1.14.3  scipy 1.1.0
Date: Thu Jun  7 01:17:09 2018
PySCF version 1.4.2
PySCF path  /tigress/xingz/pyscf/pyscf
GIT ORIG_HEAD e0edd131499dcc18d035a120533a8a1ddda110d4
GIT HEAD      e0edd131499dcc18d035a120533a8a1ddda110d4

[INPUT] VERBOSE 4
[INPUT] num atoms = 30
[INPUT] num electrons = 120
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT]  1 Be    13.393481126908   0.000000000000   0.000000000000 AA   25.310011184387   0.000000000000   0.000000000000 Bohr
[INPUT]  2 Be    13.100801429758   2.784661307031   0.000000000000 AA   24.756926714554   5.262247219962   0.000000000000 Bohr
[INPUT]  3 Be    12.235553845509   5.447619552658   0.000000000000 AA   23.121845750380  10.294508985348   0.000000000000 Bohr
[INPUT]  4 Be    10.835553845509   7.872490683254   0.000000000000 AA   20.476229175989  14.876851309540   0.000000000000 Bohr
[INPUT]  5 Be     8.961988147704   9.953296194591   0.000000000000 AA   16.935703130758  18.809003844452   0.000000000000 Bohr
[INPUT]  6 Be     6.696740563454  11.599094901010   0.000000000000 AA   12.655005592193  21.919112655747   0.000000000000 Bohr
[INPUT]  7 Be     4.138813282055  12.737957501622   0.000000000000 AA    7.821223583796  24.071251064414   0.000000000000 Bohr
[INPUT]  8 Be     1.400000000000  13.320110235912   0.000000000000 AA    2.645616574391  25.171360294889   0.000000000000 Bohr
[INPUT]  9 Be    -1.400000000000  13.320110235912   0.000000000000 AA   -2.645616574391  25.171360294889   0.000000000000 Bohr
[INPUT] 10 Be    -4.138813282055  12.737957501622   0.000000000000 AA   -7.821223583796  24.071251064414   0.000000000000 Bohr
[INPUT] 11 Be    -6.696740563454  11.599094901010   0.000000000000 AA  -12.655005592193  21.919112655747   0.000000000000 Bohr
[INPUT] 12 Be    -8.961988147704   9.953296194591   0.000000000000 AA  -16.935703130758  18.809003844452   0.000000000000 Bohr
[INPUT] 13 Be   -10.835553845509   7.872490683254   0.000000000000 AA  -20.476229175989  14.876851309540   0.000000000000 Bohr
[INPUT] 14 Be   -12.235553845509   5.447619552658   0.000000000000 AA  -23.121845750380  10.294508985349   0.000000000000 Bohr
[INPUT] 15 Be   -13.100801429758   2.784661307031   0.000000000000 AA  -24.756926714554   5.262247219962   0.000000000000 Bohr
[INPUT] 16 Be   -13.393481126908   0.000000000000   0.000000000000 AA  -25.310011184387   0.000000000000   0.000000000000 Bohr
[INPUT] 17 Be   -13.100801429758  -2.784661307031   0.000000000000 AA  -24.756926714554  -5.262247219962   0.000000000000 Bohr
[INPUT] 18 Be   -12.235553845509  -5.447619552658   0.000000000000 AA  -23.121845750380 -10.294508985348   0.000000000000 Bohr
[INPUT] 19 Be   -10.835553845509  -7.872490683254   0.000000000000 AA  -20.476229175989 -14.876851309540   0.000000000000 Bohr
[INPUT] 20 Be    -8.961988147704  -9.953296194591   0.000000000000 AA  -16.935703130758 -18.809003844452   0.000000000000 Bohr
[INPUT] 21 Be    -6.696740563454 -11.599094901010   0.000000000000 AA  -12.655005592193 -21.919112655747   0.000000000000 Bohr
[INPUT] 22 Be    -4.138813282055 -12.737957501622   0.000000000000 AA   -7.821223583796 -24.071251064414   0.000000000000 Bohr
[INPUT] 23 Be    -1.400000000000 -13.320110235912   0.000000000000 AA   -2.645616574391 -25.171360294889   0.000000000000 Bohr
[INPUT] 24 Be     1.400000000000 -13.320110235912   0.000000000000 AA    2.645616574391 -25.171360294889   0.000000000000 Bohr
[INPUT] 25 Be     4.138813282055 -12.737957501622   0.000000000000 AA    7.821223583796 -24.071251064414   0.000000000000 Bohr
[INPUT] 26 Be     6.696740563454 -11.599094901010   0.000000000000 AA   12.655005592193 -21.919112655747   0.000000000000 Bohr
[INPUT] 27 Be     8.961988147704  -9.953296194591   0.000000000000 AA   16.935703130758 -18.809003844452   0.000000000000 Bohr
[INPUT] 28 Be    10.835553845509  -7.872490683254   0.000000000000 AA   20.476229175989 -14.876851309540   0.000000000000 Bohr
[INPUT] 29 Be    12.235553845509  -5.447619552658   0.000000000000 AA   23.121845750380 -10.294508985349   0.000000000000 Bohr
[INPUT] 30 Be    13.100801429758  -2.784661307031   0.000000000000 AA   24.756926714554  -5.262247219962   0.000000000000 Bohr
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [6    /1   ]  312.8704937       0.00916359628
                                57.36446253       0.04936149294
                                16.0485094        0.1685383049
                                5.513096119       0.3705627997
                                2.140896553       0.4164915298
                                0.8817394283      0.1303340841
[INPUT] 0    0    [6    /1   ]  13.63324744       -0.01325278809
                                2.698375464       -0.04699171014
                                0.8386530829      -0.03378537151
                                0.3226600698      0.2502417861
                                0.1401314882      0.5951172526
                                0.0642325139      0.2407061763
[INPUT] 1    0    [6    /1   ]  13.63324744       0.0037596966
                                2.698375464       0.0376793698
                                0.8386530829      0.1738967435
                                0.3226600698      0.4180364347
                                0.1401314882      0.4258595477
                                0.0642325139      0.1017082955
nuclear repulsion = 319.342044713046
number of shells = 90
number of NR pGTOs = 900
number of NR cGTOs = 150
basis = sto-6g
ecp = {}
CPU time:      1196.35


******** <class 'pyscf.scf.hf.RHF'> flags ********
method = RHF
initial guess = minao
damping factor = 0
level shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
DIIS start cycle = 1
DIIS space = 8
SCF tol = 1e-09
SCF gradient tol = None
max. SCF cycles = 50
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /tigress/xingz/pydmfet/examples/tmphue4j8
max_memory 16000 MB (current use 230 MB)
Set gradient conv threshold to 3.16228e-05
init E= -436.844136444889
  HOMO = -0.08876012967634  LUMO = 0.0233056929568956
cycle= 1 E= -435.143690801795  delta_E=  1.7  |g|= 0.165  |ddm|=  4.8
  HOMO = -0.0832944117072067  LUMO = 0.0529604200054062
cycle= 2 E= -435.189517052774  delta_E= -0.0458  |g|= 0.0937  |ddm|= 0.713
  HOMO = -0.061258864579601  LUMO = 0.0334663018382456
cycle= 3 E= -435.225616605668  delta_E= -0.0361  |g|= 0.0439  |ddm|= 1.09
  HOMO = -0.0291157208031144  LUMO = 0.00467844204131906
cycle= 4 E= -435.256522391707  delta_E= -0.0309  |g|= 0.0324  |ddm|= 1.72
  HOMO = -0.0151551681715383  LUMO = -0.00779654439348673
cycle= 5 E= -435.269274310449  delta_E= -0.0128  |g|= 0.0332  |ddm|= 0.755
  HOMO = -0.198407003762088  LUMO = 0.153498350707789
cycle= 6 E= -435.016507964769  delta_E= 0.253  |g|= 0.247  |ddm|= 5.38
  HOMO = -0.216465433163634  LUMO = 0.153432149519702
cycle= 7 E= -434.972493328356  delta_E= 0.044  |g|= 0.279  |ddm|= 0.324
  HOMO = -0.250671979573918  LUMO = 0.151419445330058
cycle= 8 E= -434.893947772282  delta_E= 0.0785  |g|= 0.334  |ddm|= 0.489
  HOMO = -0.233800788973369  LUMO = 0.152536593094886
cycle= 9 E= -434.932144905447  delta_E= -0.0382  |g|= 0.308  |ddm|= 0.227
  HOMO = -0.218210509075349  LUMO = 0.153476880198242
cycle= 10 E= -434.967717961174  delta_E= -0.0356  |g|= 0.282  |ddm|= 0.23
  HOMO = -0.136362256850476  LUMO = 0.0994770915990543
cycle= 11 E= -435.131382663906  delta_E= -0.164  |g|= 0.144  |ddm|= 1.49
  HOMO = -0.12677542732904  LUMO = 0.0902449009369776
cycle= 12 E= -435.152877909148  delta_E= -0.0215  |g|= 0.126  |ddm|= 0.329
  HOMO = -0.026198254754517  LUMO = 0.0052150573126355
cycle= 13 E= -435.476240796249  delta_E= -0.323  |g|= 0.161  |ddm|= 6.29
  HOMO = -0.0996476439198226  LUMO = 0.0686060267477494
cycle= 14 E= -435.193912896126  delta_E= 0.282  |g|= 0.0757  |ddm|= 5.79
  HOMO = -0.0888602430444268  LUMO = 0.0588691854544687
cycle= 15 E= -435.207031021458  delta_E= -0.0131  |g|= 0.0617  |ddm|= 0.368
  HOMO = -0.0835912182672497  LUMO = 0.0540428155933659
cycle= 16 E= -435.212482590694  delta_E= -0.00545  |g|= 0.0561  |ddm|= 0.18
  HOMO = -0.082166406501931  LUMO = 0.0527822149583692
cycle= 17 E= -435.214136506577  delta_E= -0.00165  |g|= 0.0544  |ddm|= 0.058
  HOMO = -0.0784328331490177  LUMO = 0.0493428916126349
cycle= 18 E= -435.217724395713  delta_E= -0.00359  |g|= 0.0509  |ddm|= 0.133
  HOMO = -0.0760340214851217  LUMO = 0.0472220551967082
cycle= 19 E= -435.220276436261  delta_E= -0.00255  |g|= 0.0484  |ddm|=  0.1
  HOMO = -0.0577114657846657  LUMO = 0.030570474792607
cycle= 20 E= -435.235860237216  delta_E= -0.0156  |g|= 0.0364  |ddm|= 0.736
  HOMO = -0.06184527835451  LUMO = 0.0345497346909487
cycle= 21 E= -435.234015580266  delta_E= 0.00184  |g|= 0.0376  |ddm|= 0.098
  HOMO = -0.0185523681154195  LUMO = -0.00351047324213021
cycle= 22 E= -435.440513967078  delta_E= -0.206  |g|= 0.167  |ddm|= 4.61
  HOMO = -0.0509939773409845  LUMO = 0.0247202351439083
cycle= 23 E= -435.242332817435  delta_E= 0.198  |g|= 0.0338  |ddm|= 4.36
  HOMO = -0.0768958143887518  LUMO = 0.0476944673531742
cycle= 24 E= -435.217104598002  delta_E= 0.0252  |g|= 0.0514  |ddm|= 1.23
  HOMO = -0.0490365936178803  LUMO = 0.0227282609900419
cycle= 25 E= -435.242748871966  delta_E= -0.0256  |g|= 0.0336  |ddm|= 1.25
  HOMO = -0.0545392225929209  LUMO = 0.0276097395221551
cycle= 26 E= -435.237831472274  delta_E= 0.00492  |g|= 0.0354  |ddm|= 0.284
  HOMO = -0.0575053822367712  LUMO = 0.0304943562090063
cycle= 27 E= -435.23638554283  delta_E= 0.00145  |g|= 0.0361  |ddm|= 0.0802
  HOMO = -0.0546708386667216  LUMO = 0.0277126169369971
cycle= 28 E= -435.23760048456  delta_E= -0.00121  |g|= 0.0355  |ddm|= 0.0673
  HOMO = -0.0511823491684393  LUMO = 0.0246060866476027
cycle= 29 E= -435.240660498182  delta_E= -0.00306  |g|= 0.0342  |ddm|= 0.174
  HOMO = -0.0486493976320347  LUMO = 0.0227780034037949
cycle= 30 E= -435.245138189945  delta_E= -0.00448  |g|= 0.0332  |ddm|= 0.266
  HOMO = -0.1586962811332  LUMO = 0.119877693615694
cycle= 31 E= -435.079800113495  delta_E= 0.165  |g|= 0.188  |ddm|= 3.69
  HOMO = -0.120052410199623  LUMO = 0.085515773991905
cycle= 32 E= -435.153092027745  delta_E= -0.0733  |g|= 0.12  |ddm|= 0.913
  HOMO = -0.279402499732377  LUMO = 0.15077975718181
cycle= 33 E= -434.778061917323  delta_E= 0.375  |g|= 0.399  |ddm|= 2.86
  HOMO = -0.222868869615369  LUMO = 0.154262004160002
cycle= 34 E= -434.929930879204  delta_E= -0.152  |g|= 0.302  |ddm|= 0.822
  HOMO = -0.128433960851952  LUMO = 0.093065707959229
cycle= 35 E= -435.138432450778  delta_E= -0.209  |g|= 0.134  |ddm|= 1.85
  HOMO = -0.0281902580577  LUMO = 0.00733604905719618
cycle= 36 E= -435.482066276873  delta_E= -0.344  |g|= 0.158  |ddm|= 6.53
  HOMO = -0.0596212591541477  LUMO = 0.0324635158231747
cycle= 37 E= -435.235437020851  delta_E= 0.247  |g|= 0.0367  |ddm|= 4.83
  HOMO = -0.0438394101053556  LUMO = 0.0183889717422241
cycle= 38 E= -435.249298236878  delta_E= -0.0139  |g|= 0.0328  |ddm|= 0.811
  HOMO = -0.0775671892252917  LUMO = 0.048351156097368
cycle= 39 E= -435.217338140097  delta_E= 0.032  |g|= 0.0513  |ddm|= 1.63
  HOMO = -0.0814054101621589  LUMO = 0.0516824512534354
cycle= 40 E= -435.212726502337  delta_E= 0.00461  |g|= 0.056  |ddm|= 0.171
  HOMO = -0.0873098927709094  LUMO = 0.0569627600755144
cycle= 41 E= -435.205953641717  delta_E= 0.00677  |g|= 0.0632  |ddm|= 0.221
  HOMO = -0.0859845539726507  LUMO = 0.055600589673418
cycle= 42 E= -435.206316269369  delta_E= -0.000363  |g|= 0.0628  |ddm|= 0.0121
  HOMO = -0.0911674427815917  LUMO = 0.0603148297703119
cycle= 43 E= -435.200442552815  delta_E= 0.00587  |g|= 0.0691  |ddm|= 0.172
  HOMO = -0.0729474460458833  LUMO = 0.0441669143947625
cycle= 44 E= -435.221982842078  delta_E= -0.0215  |g|= 0.047  |ddm|= 0.733
  HOMO = -0.143715665691104  LUMO = 0.106489612009683
cycle= 45 E= -435.111339325797  delta_E= 0.111  |g|= 0.16  |ddm|= 2.25
  HOMO = -0.166654848198104  LUMO = 0.12712533178976
cycle= 46 E= -435.060835296891  delta_E= 0.0505  |g|= 0.203  |ddm|= 0.531
  HOMO = -0.0138795423386281  LUMO = -0.00919283046098169
cycle= 47 E= -435.289556353383  delta_E= -0.229  |g|= 0.0809  |ddm|= 5.35
  HOMO = -0.0176899967417127  LUMO = -0.00586938520734116
cycle= 48 E= -435.267978371654  delta_E= 0.0216  |g|= 0.0373  |ddm|= 0.965
  HOMO = -0.0409027465800094  LUMO = 0.0147211141262854
cycle= 49 E= -435.246857544083  delta_E= 0.0211  |g|= 0.0341  |ddm|= 1.25
  HOMO = -0.0339584962841907  LUMO = 0.0140360809673584
cycle= 50 E= -435.508318973554  delta_E= -0.261  |g|= 0.15  |ddm|= 4.64
  HOMO = -0.0902293107966417  LUMO = 0.0739745133559835
Extra cycle  E= -435.5810450458  delta_E= -0.0727  |g|= 0.11  |ddm|= 1.07
SCF not converged.
SCF energy = -435.5810450458 after 50 cycles
e_mf =  -435.5810450457999
#INFO: **** input file is /tigress/xingz/pydmfet/examples/Be.py ****
from pydmfet import locints, sdmfet, oep, tools
from pyscf import gto, scf,dft, ao2mo,cc
import numpy as np
from pyscf.tools import molden, cubegen
import copy,time

DMguess  = None

bondlengths = np.arange(1.8, 4.1, 0.1)
energies = []

bas = 'sto-6g'

for bondlength in bondlengths:

    nat = 30
    mol = gto.Mole()
    mol.atom = []
    r = 0.5 * bondlength / np.sin(np.pi/nat)
    for i in range(nat):
        theta = i * (2*np.pi/nat)
        mol.atom.append(('Be', (r*np.cos(theta), r*np.sin(theta), 0)))

    mol.basis = bas
    mol.build(max_memory=16000, verbose=4)

    mf = scf.RHF(mol)
    #mf = dft.RKS(mol)
    #mf.xc = 'pbe,pbe'
    #mf.smear_sigma = 0.005
    mf.max_cycle = 50
    mf.scf()

    #P=mf.make_rdm1()
    #tools.MatPrint(P,"P_ref_ao")
    #cubegen.density(mol, "h20_dens.cube", P, nx=100, ny=100, nz=100)
    print 'e_mf = ',  mf.e_tot
    continue
    if ( True ):   
#        ENUCL = mf.mol.energy_nuc()
#        OEI   = np.dot(np.dot(mf.mo_coeff.T, mol.intor('cint1e_kin_sph') + mol.intor('cint1e_nuc_sph')), mf.mo_coeff)
#        TEI   = ao2mo.outcore.full_iofree(mol, mf.mo_coeff, compact=False).reshape(mol.nao_nr(), mol.nao_nr(), mol.nao_nr(), mol.nao_nr())
#        import chemps2
#        Energy, OneDM = chemps2.solve( ENUCL, OEI, OEI, TEI, mol.nao_nr(), mol.nelectron, mol.nao_nr(), 0.0, False )
#        print "bl =", bondlength," and energy =", Energy

        mycc = cc.CCSD(mf).run()
	et=0.0
        #et = mycc.ccsd_t()
        e_hf = mf.e_tot
        e_ccsd = e_hf + mycc.e_corr + et

        print 'e_tot = ', e_ccsd    #-4.96124910741
        
    else:
        myInts = locints.LocalIntegrals( mf, range( mol.nao_nr() ), 'meta_lowdin' )
        #myInts.loc_molden( 'hydrogen-loc.molden' )
        #myInts.TI_OK = True # Only s functions

	nbas =  mol.nao_nr()
	natoms = mol.natm

	impAtom = np.zeros([natoms], dtype=int)
	for i in range(20):
	    impAtom[i] = 1

	ghost_frag = 1-impAtom
	ghost_env = 1-ghost_frag

	mol_frag = gto.Mole()
	mol_frag.atom = tools.add_ghost(mol.atom, ghost_frag)
	mol_frag.basis = bas
	mol_frag.build(max_memory = 16000,verbose = 4)
	'''
	mf_frag = dft.RKS(mol_frag)
        mf_frag.xc = 'pbe,pbe'
        mf_frag.smear_sigma = 0.00
        mf_frag.scf()
        P_frag=mf_frag.make_rdm1()
        cubegen.density(mol_frag, "h10_dens_1.cube", P_frag, nx=100, ny=100, nz=100)
	'''

	mol_env = gto.Mole()
	mol_env.atom = tools.add_ghost(mol.atom, ghost_env)
	mol_env.basis =  bas
	mol_env.build(max_memory = 16000,verbose = 4)

	'''
	mf_env = dft.RKS(mol_env)
        mf_env.xc = 'pbe,pbe'
        mf_env.smear_sigma = 0.00
        mf_env.scf()
        P_env=mf_env.make_rdm1()
        cubegen.density(mol_env, "h10_dens_2.cube", P_env, nx=100, ny=100, nz=100)
	exit()
	'''



	aoslice = mol.aoslice_by_atom()
	impurities = np.zeros([nbas], dtype = int)
	for i in range(natoms):
	    if(impAtom[i] == 1):
		impurities[aoslice[i,2]:aoslice[i,3]] = 1

	Ne_frag = 20
	boundary_atoms = np.zeros((natoms))
	boundary_atoms[20:40] = 1.0
	#boundary_atoms[19] = -1
	boundary_atoms2 = np.zeros((natoms),dtype =int)
	#boundary_atoms2[9] = -1
	boundary_atoms2[0:20] = 1

	boundary_atoms = None
	boundary_atoms2 =None

	umat=None
	P_frag=None
	P_env=None
	params = oep.OEPparams(algorithm = '2011', opt_method = 'L-BFGS-B', \
                       ftol = 1e-11, gtol = 1e-5,diffP_tol=1e-5, outer_maxit = 200, maxit = 200,l2_lambda = 0.0, oep_print = 0)
	theDMFET = sdmfet.DMFET( mf, mol_frag, mol_env,myInts,impurities, impAtom, Ne_frag, boundary_atoms=boundary_atoms, boundary_atoms2=boundary_atoms2,\
                         umat = umat, P_frag_ao = P_frag, P_env_ao = P_env, \
                         dim_imp = nbas, dim_bath=nbas, dim_big =nbas, smear_sigma = 0.005, oep_params=params,ecw_method='hf', mf_method = mf.xc)

	umat = theDMFET.embedding_potential()

	exit()

	#write subspace orbitals
	transfo = np.dot( myInts.ao2loc, theDMFET.loc2sub )
	filename =  'hydrogen-sub.molden'
	with open( filename, 'w' ) as thefile:
            molden.header( myInts.mol, thefile )
            molden.orbital_coeff( myInts.mol, thefile, transfo )


        umat = theDMFET.embedding_potential()
	print umat
	exit()
	energy = theDMFET.correction_energy()

#INFO: ******************** input file end ********************


System: ('Linux', 'tigercpu.princeton.edu', '3.10.0-693.21.1.el7.x86_64', '#1 SMP Wed Mar 7 15:59:45 EST 2018', 'x86_64', 'x86_64')  Threads 40
Python 2.7.14 |Anaconda, Inc.| (default, Oct 16 2017, 17:29:19) 
[GCC 7.2.0]
numpy 1.14.3  scipy 1.1.0
Date: Thu Jun  7 01:17:15 2018
PySCF version 1.4.2
PySCF path  /tigress/xingz/pyscf/pyscf
GIT ORIG_HEAD e0edd131499dcc18d035a120533a8a1ddda110d4
GIT HEAD      e0edd131499dcc18d035a120533a8a1ddda110d4

[INPUT] VERBOSE 4
[INPUT] num atoms = 30
[INPUT] num electrons = 120
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT]  1 Be    13.871819738583   0.000000000000   0.000000000000 AA   26.213940155258   0.000000000000   0.000000000000 Bohr
[INPUT]  2 Be    13.568687195107   2.884113496568   0.000000000000 AA   25.641102668645   5.450184620675   0.000000000000 Bohr
[INPUT]  3 Be    12.672537911420   5.642177393824   0.000000000000 AA   23.947625955751  10.662170020540   0.000000000000 Bohr
[INPUT]  4 Be    11.222537911420   8.153651064799   0.000000000000 AA   21.207523075131  15.408167427738   0.000000000000 Bohr
[INPUT]  5 Be     9.282059152979  10.308771058683   0.000000000000 AA   17.540549671143  19.480753981754   0.000000000000 Bohr
[INPUT]  6 Be     6.935909869292  12.013348290331   0.000000000000 AA   13.106970077629  22.701938107738   0.000000000000 Bohr
[INPUT]  7 Be     4.286628042128  13.192884555251   0.000000000000 AA    8.100552997503  24.930938602429   0.000000000000 Bohr
[INPUT]  8 Be     1.450000000000  13.795828458623   0.000000000000 AA    2.740102880619  26.070337448278   0.000000000000 Bohr
[INPUT]  9 Be    -1.450000000000  13.795828458623   0.000000000000 AA   -2.740102880619  26.070337448278   0.000000000000 Bohr
[INPUT] 10 Be    -4.286628042128  13.192884555251   0.000000000000 AA   -8.100552997503  24.930938602429   0.000000000000 Bohr
[INPUT] 11 Be    -6.935909869292  12.013348290331   0.000000000000 AA  -13.106970077629  22.701938107738   0.000000000000 Bohr
[INPUT] 12 Be    -9.282059152979  10.308771058683   0.000000000000 AA  -17.540549671143  19.480753981754   0.000000000000 Bohr
[INPUT] 13 Be   -11.222537911420   8.153651064799   0.000000000000 AA  -21.207523075131  15.408167427738   0.000000000000 Bohr
[INPUT] 14 Be   -12.672537911420   5.642177393824   0.000000000000 AA  -23.947625955751  10.662170020540   0.000000000000 Bohr
[INPUT] 15 Be   -13.568687195107   2.884113496568   0.000000000000 AA  -25.641102668645   5.450184620675   0.000000000000 Bohr
[INPUT] 16 Be   -13.871819738583   0.000000000000   0.000000000000 AA  -26.213940155258   0.000000000000   0.000000000000 Bohr
[INPUT] 17 Be   -13.568687195107  -2.884113496568   0.000000000000 AA  -25.641102668645  -5.450184620675   0.000000000000 Bohr
[INPUT] 18 Be   -12.672537911420  -5.642177393824   0.000000000000 AA  -23.947625955751 -10.662170020540   0.000000000000 Bohr
[INPUT] 19 Be   -11.222537911420  -8.153651064799   0.000000000000 AA  -21.207523075131 -15.408167427738   0.000000000000 Bohr
[INPUT] 20 Be    -9.282059152979 -10.308771058683   0.000000000000 AA  -17.540549671143 -19.480753981754   0.000000000000 Bohr
[INPUT] 21 Be    -6.935909869292 -12.013348290331   0.000000000000 AA  -13.106970077629 -22.701938107738   0.000000000000 Bohr
[INPUT] 22 Be    -4.286628042128 -13.192884555251   0.000000000000 AA   -8.100552997503 -24.930938602429   0.000000000000 Bohr
[INPUT] 23 Be    -1.450000000000 -13.795828458623   0.000000000000 AA   -2.740102880619 -26.070337448278   0.000000000000 Bohr
[INPUT] 24 Be     1.450000000000 -13.795828458623   0.000000000000 AA    2.740102880619 -26.070337448278   0.000000000000 Bohr
[INPUT] 25 Be     4.286628042128 -13.192884555251   0.000000000000 AA    8.100552997503 -24.930938602429   0.000000000000 Bohr
[INPUT] 26 Be     6.935909869292 -12.013348290331   0.000000000000 AA   13.106970077629 -22.701938107738   0.000000000000 Bohr
[INPUT] 27 Be     9.282059152979 -10.308771058683   0.000000000000 AA   17.540549671143 -19.480753981754   0.000000000000 Bohr
[INPUT] 28 Be    11.222537911420  -8.153651064799   0.000000000000 AA   21.207523075131 -15.408167427738   0.000000000000 Bohr
[INPUT] 29 Be    12.672537911420  -5.642177393824   0.000000000000 AA   23.947625955751 -10.662170020540   0.000000000000 Bohr
[INPUT] 30 Be    13.568687195107  -2.884113496568   0.000000000000 AA   25.641102668645  -5.450184620675   0.000000000000 Bohr
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [6    /1   ]  312.8704937       0.00916359628
                                57.36446253       0.04936149294
                                16.0485094        0.1685383049
                                5.513096119       0.3705627997
                                2.140896553       0.4164915298
                                0.8817394283      0.1303340841
[INPUT] 0    0    [6    /1   ]  13.63324744       -0.01325278809
                                2.698375464       -0.04699171014
                                0.8386530829      -0.03378537151
                                0.3226600698      0.2502417861
                                0.1401314882      0.5951172526
                                0.0642325139      0.2407061763
[INPUT] 1    0    [6    /1   ]  13.63324744       0.0037596966
                                2.698375464       0.0376793698
                                0.8386530829      0.1738967435
                                0.3226600698      0.4180364347
                                0.1401314882      0.4258595477
                                0.0642325139      0.1017082955
nuclear repulsion = 308.330250067768
number of shells = 90
number of NR pGTOs = 900
number of NR cGTOs = 150
basis = sto-6g
ecp = {}
CPU time:      1428.44


******** <class 'pyscf.scf.hf.RHF'> flags ********
method = RHF
initial guess = minao
damping factor = 0
level shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
DIIS start cycle = 1
DIIS space = 8
SCF tol = 1e-09
SCF gradient tol = None
max. SCF cycles = 50
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /tigress/xingz/pydmfet/examples/tmpI2_cGY
max_memory 16000 MB (current use 229 MB)
Set gradient conv threshold to 3.16228e-05
init E= -436.477908311553
  HOMO = -0.112062252205195  LUMO = 0.0301593993833294
cycle= 1 E= -435.128227069588  delta_E= 1.35  |g|= 0.13  |ddm|= 4.43
  HOMO = -0.107203657878087  LUMO = 0.0666914659904498
cycle= 2 E= -435.154626588786  delta_E= -0.0264  |g|= 0.0665  |ddm|= 0.514
  HOMO = -0.0937295963203738  LUMO = 0.0543052266609285
cycle= 3 E= -435.168079585466  delta_E= -0.0135  |g|= 0.0186  |ddm|= 0.616
  HOMO = -0.0856365453770707  LUMO = 0.0469606995034312
cycle= 4 E= -435.170038410866  delta_E= -0.00196  |g|= 0.0027  |ddm|= 0.344
  HOMO = -0.0841444865948982  LUMO = 0.0455318966080575
cycle= 5 E= -435.170087497764  delta_E= -4.91e-05  |g|= 0.000244  |ddm|= 0.0635
  HOMO = -0.0840230757166749  LUMO = 0.0454257535357811
cycle= 6 E= -435.170087685116  delta_E= -1.87e-07  |g|= 5.27e-05  |ddm|= 0.00475
  HOMO = -0.0840572948495743  LUMO = 0.0454556124161943
cycle= 7 E= -435.170087700801  delta_E= -1.57e-08  |g|= 6.41e-06  |ddm|= 0.00134
  HOMO = -0.0840534243607998  LUMO = 0.0454523691741975
cycle= 8 E= -435.170087701054  delta_E= -2.53e-10  |g|= 1.93e-07  |ddm|= 0.000146
  HOMO = -0.0840533810293233  LUMO = 0.045452329485409
Extra cycle  E= -435.170087701054  delta_E= 3.41e-13  |g|= 1.4e-07  |ddm|= 1.42e-06
converged SCF energy = -435.170087701054
e_mf =  -435.1700877010536
#INFO: **** input file is /tigress/xingz/pydmfet/examples/Be.py ****
from pydmfet import locints, sdmfet, oep, tools
from pyscf import gto, scf,dft, ao2mo,cc
import numpy as np
from pyscf.tools import molden, cubegen
import copy,time

DMguess  = None

bondlengths = np.arange(1.8, 4.1, 0.1)
energies = []

bas = 'sto-6g'

for bondlength in bondlengths:

    nat = 30
    mol = gto.Mole()
    mol.atom = []
    r = 0.5 * bondlength / np.sin(np.pi/nat)
    for i in range(nat):
        theta = i * (2*np.pi/nat)
        mol.atom.append(('Be', (r*np.cos(theta), r*np.sin(theta), 0)))

    mol.basis = bas
    mol.build(max_memory=16000, verbose=4)

    mf = scf.RHF(mol)
    #mf = dft.RKS(mol)
    #mf.xc = 'pbe,pbe'
    #mf.smear_sigma = 0.005
    mf.max_cycle = 50
    mf.scf()

    #P=mf.make_rdm1()
    #tools.MatPrint(P,"P_ref_ao")
    #cubegen.density(mol, "h20_dens.cube", P, nx=100, ny=100, nz=100)
    print 'e_mf = ',  mf.e_tot
    continue
    if ( True ):   
#        ENUCL = mf.mol.energy_nuc()
#        OEI   = np.dot(np.dot(mf.mo_coeff.T, mol.intor('cint1e_kin_sph') + mol.intor('cint1e_nuc_sph')), mf.mo_coeff)
#        TEI   = ao2mo.outcore.full_iofree(mol, mf.mo_coeff, compact=False).reshape(mol.nao_nr(), mol.nao_nr(), mol.nao_nr(), mol.nao_nr())
#        import chemps2
#        Energy, OneDM = chemps2.solve( ENUCL, OEI, OEI, TEI, mol.nao_nr(), mol.nelectron, mol.nao_nr(), 0.0, False )
#        print "bl =", bondlength," and energy =", Energy

        mycc = cc.CCSD(mf).run()
	et=0.0
        #et = mycc.ccsd_t()
        e_hf = mf.e_tot
        e_ccsd = e_hf + mycc.e_corr + et

        print 'e_tot = ', e_ccsd    #-4.96124910741
        
    else:
        myInts = locints.LocalIntegrals( mf, range( mol.nao_nr() ), 'meta_lowdin' )
        #myInts.loc_molden( 'hydrogen-loc.molden' )
        #myInts.TI_OK = True # Only s functions

	nbas =  mol.nao_nr()
	natoms = mol.natm

	impAtom = np.zeros([natoms], dtype=int)
	for i in range(20):
	    impAtom[i] = 1

	ghost_frag = 1-impAtom
	ghost_env = 1-ghost_frag

	mol_frag = gto.Mole()
	mol_frag.atom = tools.add_ghost(mol.atom, ghost_frag)
	mol_frag.basis = bas
	mol_frag.build(max_memory = 16000,verbose = 4)
	'''
	mf_frag = dft.RKS(mol_frag)
        mf_frag.xc = 'pbe,pbe'
        mf_frag.smear_sigma = 0.00
        mf_frag.scf()
        P_frag=mf_frag.make_rdm1()
        cubegen.density(mol_frag, "h10_dens_1.cube", P_frag, nx=100, ny=100, nz=100)
	'''

	mol_env = gto.Mole()
	mol_env.atom = tools.add_ghost(mol.atom, ghost_env)
	mol_env.basis =  bas
	mol_env.build(max_memory = 16000,verbose = 4)

	'''
	mf_env = dft.RKS(mol_env)
        mf_env.xc = 'pbe,pbe'
        mf_env.smear_sigma = 0.00
        mf_env.scf()
        P_env=mf_env.make_rdm1()
        cubegen.density(mol_env, "h10_dens_2.cube", P_env, nx=100, ny=100, nz=100)
	exit()
	'''



	aoslice = mol.aoslice_by_atom()
	impurities = np.zeros([nbas], dtype = int)
	for i in range(natoms):
	    if(impAtom[i] == 1):
		impurities[aoslice[i,2]:aoslice[i,3]] = 1

	Ne_frag = 20
	boundary_atoms = np.zeros((natoms))
	boundary_atoms[20:40] = 1.0
	#boundary_atoms[19] = -1
	boundary_atoms2 = np.zeros((natoms),dtype =int)
	#boundary_atoms2[9] = -1
	boundary_atoms2[0:20] = 1

	boundary_atoms = None
	boundary_atoms2 =None

	umat=None
	P_frag=None
	P_env=None
	params = oep.OEPparams(algorithm = '2011', opt_method = 'L-BFGS-B', \
                       ftol = 1e-11, gtol = 1e-5,diffP_tol=1e-5, outer_maxit = 200, maxit = 200,l2_lambda = 0.0, oep_print = 0)
	theDMFET = sdmfet.DMFET( mf, mol_frag, mol_env,myInts,impurities, impAtom, Ne_frag, boundary_atoms=boundary_atoms, boundary_atoms2=boundary_atoms2,\
                         umat = umat, P_frag_ao = P_frag, P_env_ao = P_env, \
                         dim_imp = nbas, dim_bath=nbas, dim_big =nbas, smear_sigma = 0.005, oep_params=params,ecw_method='hf', mf_method = mf.xc)

	umat = theDMFET.embedding_potential()

	exit()

	#write subspace orbitals
	transfo = np.dot( myInts.ao2loc, theDMFET.loc2sub )
	filename =  'hydrogen-sub.molden'
	with open( filename, 'w' ) as thefile:
            molden.header( myInts.mol, thefile )
            molden.orbital_coeff( myInts.mol, thefile, transfo )


        umat = theDMFET.embedding_potential()
	print umat
	exit()
	energy = theDMFET.correction_energy()

#INFO: ******************** input file end ********************


System: ('Linux', 'tigercpu.princeton.edu', '3.10.0-693.21.1.el7.x86_64', '#1 SMP Wed Mar 7 15:59:45 EST 2018', 'x86_64', 'x86_64')  Threads 40
Python 2.7.14 |Anaconda, Inc.| (default, Oct 16 2017, 17:29:19) 
[GCC 7.2.0]
numpy 1.14.3  scipy 1.1.0
Date: Thu Jun  7 01:17:17 2018
PySCF version 1.4.2
PySCF path  /tigress/xingz/pyscf/pyscf
GIT ORIG_HEAD e0edd131499dcc18d035a120533a8a1ddda110d4
GIT HEAD      e0edd131499dcc18d035a120533a8a1ddda110d4

[INPUT] VERBOSE 4
[INPUT] num atoms = 30
[INPUT] num electrons = 120
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT]  1 Be    14.350158350258   0.000000000000   0.000000000000 AA   27.117869126129   0.000000000000   0.000000000000 Bohr
[INPUT]  2 Be    14.036572960455   2.983565686105   0.000000000000 AA   26.525278622736   5.638122021388   0.000000000000 Bohr
[INPUT]  3 Be    13.109521977331   5.836735234990   0.000000000000 AA   24.773406161122  11.029831055731   0.000000000000 Bohr
[INPUT]  4 Be    11.609521977331   8.434811446344   0.000000000000 AA   21.938816974274  15.939483545936   0.000000000000 Bohr
[INPUT]  5 Be     9.602130158254  10.664245922776   0.000000000000 AA   18.145396211527  20.152504119056   0.000000000000 Bohr
[INPUT]  6 Be     7.175079175129  12.427601679653   0.000000000000 AA   13.558934563064  23.484763559729   0.000000000000 Bohr
[INPUT]  7 Be     4.434442802201  13.647811608881   0.000000000000 AA    8.379882411210  25.790626140444   0.000000000000 Bohr
[INPUT]  8 Be     1.500000000000  14.271546681334   0.000000000000 AA    2.834589186848  26.969314601666   0.000000000000 Bohr
[INPUT]  9 Be    -1.500000000000  14.271546681334   0.000000000000 AA   -2.834589186848  26.969314601666   0.000000000000 Bohr
[INPUT] 10 Be    -4.434442802201  13.647811608881   0.000000000000 AA   -8.379882411210  25.790626140444   0.000000000000 Bohr
[INPUT] 11 Be    -7.175079175129  12.427601679653   0.000000000000 AA  -13.558934563064  23.484763559729   0.000000000000 Bohr
[INPUT] 12 Be    -9.602130158254  10.664245922776   0.000000000000 AA  -18.145396211527  20.152504119056   0.000000000000 Bohr
[INPUT] 13 Be   -11.609521977331   8.434811446344   0.000000000000 AA  -21.938816974274  15.939483545936   0.000000000000 Bohr
[INPUT] 14 Be   -13.109521977331   5.836735234990   0.000000000000 AA  -24.773406161122  11.029831055731   0.000000000000 Bohr
[INPUT] 15 Be   -14.036572960455   2.983565686105   0.000000000000 AA  -26.525278622736   5.638122021388   0.000000000000 Bohr
[INPUT] 16 Be   -14.350158350258   0.000000000000   0.000000000000 AA  -27.117869126129   0.000000000000   0.000000000000 Bohr
[INPUT] 17 Be   -14.036572960455  -2.983565686105   0.000000000000 AA  -26.525278622736  -5.638122021388   0.000000000000 Bohr
[INPUT] 18 Be   -13.109521977331  -5.836735234990   0.000000000000 AA  -24.773406161122 -11.029831055731   0.000000000000 Bohr
[INPUT] 19 Be   -11.609521977331  -8.434811446344   0.000000000000 AA  -21.938816974274 -15.939483545936   0.000000000000 Bohr
[INPUT] 20 Be    -9.602130158254 -10.664245922776   0.000000000000 AA  -18.145396211527 -20.152504119056   0.000000000000 Bohr
[INPUT] 21 Be    -7.175079175129 -12.427601679653   0.000000000000 AA  -13.558934563064 -23.484763559729   0.000000000000 Bohr
[INPUT] 22 Be    -4.434442802201 -13.647811608881   0.000000000000 AA   -8.379882411210 -25.790626140444   0.000000000000 Bohr
[INPUT] 23 Be    -1.500000000000 -14.271546681334   0.000000000000 AA   -2.834589186848 -26.969314601666   0.000000000000 Bohr
[INPUT] 24 Be     1.500000000000 -14.271546681334   0.000000000000 AA    2.834589186848 -26.969314601666   0.000000000000 Bohr
[INPUT] 25 Be     4.434442802201 -13.647811608881   0.000000000000 AA    8.379882411210 -25.790626140444   0.000000000000 Bohr
[INPUT] 26 Be     7.175079175129 -12.427601679653   0.000000000000 AA   13.558934563064 -23.484763559729   0.000000000000 Bohr
[INPUT] 27 Be     9.602130158254 -10.664245922776   0.000000000000 AA   18.145396211527 -20.152504119056   0.000000000000 Bohr
[INPUT] 28 Be    11.609521977331  -8.434811446344   0.000000000000 AA   21.938816974274 -15.939483545936   0.000000000000 Bohr
[INPUT] 29 Be    13.109521977331  -5.836735234990   0.000000000000 AA   24.773406161122 -11.029831055731   0.000000000000 Bohr
[INPUT] 30 Be    14.036572960455  -2.983565686105   0.000000000000 AA   26.525278622736  -5.638122021388   0.000000000000 Bohr
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [6    /1   ]  312.8704937       0.00916359628
                                57.36446253       0.04936149294
                                16.0485094        0.1685383049
                                5.513096119       0.3705627997
                                2.140896553       0.4164915298
                                0.8817394283      0.1303340841
[INPUT] 0    0    [6    /1   ]  13.63324744       -0.01325278809
                                2.698375464       -0.04699171014
                                0.8386530829      -0.03378537151
                                0.3226600698      0.2502417861
                                0.1401314882      0.5951172526
                                0.0642325139      0.2407061763
[INPUT] 1    0    [6    /1   ]  13.63324744       0.0037596966
                                2.698375464       0.0376793698
                                0.8386530829      0.1738967435
                                0.3226600698      0.4180364347
                                0.1401314882      0.4258595477
                                0.0642325139      0.1017082955
nuclear repulsion = 298.052575065509
number of shells = 90
number of NR pGTOs = 900
number of NR cGTOs = 150
basis = sto-6g
ecp = {}
CPU time:      1502.03


******** <class 'pyscf.scf.hf.RHF'> flags ********
method = RHF
initial guess = minao
damping factor = 0
level shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
DIIS start cycle = 1
DIIS space = 8
SCF tol = 1e-09
SCF gradient tol = None
max. SCF cycles = 50
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /tigress/xingz/pydmfet/examples/tmpX0NsNw
max_memory 16000 MB (current use 228 MB)
Set gradient conv threshold to 3.16228e-05
init E= -436.167541760981
  HOMO = -0.133077825050722  LUMO = 0.0371833316521075
cycle= 1 E= -435.120337800769  delta_E= 1.05  |g|= 0.102  |ddm|= 4.05
  HOMO = -0.127163171101784  LUMO = 0.0786779549444428
cycle= 2 E= -435.136099980734  delta_E= -0.0158  |g|= 0.0484  |ddm|= 0.383
  HOMO = -0.118573698150617  LUMO = 0.0704013814888996
cycle= 3 E= -435.142018170251  delta_E= -0.00592  |g|= 0.00912  |ddm|= 0.382
  HOMO = -0.115579420748955  LUMO = 0.0676743479929233
cycle= 4 E= -435.142330991711  delta_E= -0.000313  |g|= 0.000612  |ddm|= 0.113
  HOMO = -0.115401215100519  LUMO = 0.0674746712981692
cycle= 5 E= -435.142332350095  delta_E= -1.36e-06  |g|= 8.51e-05  |ddm|= 0.0077
  HOMO = -0.115395686777666  LUMO = 0.0674701694325007
cycle= 6 E= -435.142332362404  delta_E= -1.23e-08  |g|= 8.38e-06  |ddm|= 0.000465
  HOMO = -0.115398211215164  LUMO = 0.0674722602842268
cycle= 7 E= -435.142332362585  delta_E= -1.81e-10  |g|= 4.48e-07  |ddm|= 8.43e-05
  HOMO = -0.115398116549301  LUMO = 0.0674722365326371
Extra cycle  E= -435.142332362584  delta_E= 1.02e-12  |g|= 2.07e-07  |ddm|= 1.7e-06
converged SCF energy = -435.142332362584
e_mf =  -435.14233236258406
#INFO: **** input file is /tigress/xingz/pydmfet/examples/Be.py ****
from pydmfet import locints, sdmfet, oep, tools
from pyscf import gto, scf,dft, ao2mo,cc
import numpy as np
from pyscf.tools import molden, cubegen
import copy,time

DMguess  = None

bondlengths = np.arange(1.8, 4.1, 0.1)
energies = []

bas = 'sto-6g'

for bondlength in bondlengths:

    nat = 30
    mol = gto.Mole()
    mol.atom = []
    r = 0.5 * bondlength / np.sin(np.pi/nat)
    for i in range(nat):
        theta = i * (2*np.pi/nat)
        mol.atom.append(('Be', (r*np.cos(theta), r*np.sin(theta), 0)))

    mol.basis = bas
    mol.build(max_memory=16000, verbose=4)

    mf = scf.RHF(mol)
    #mf = dft.RKS(mol)
    #mf.xc = 'pbe,pbe'
    #mf.smear_sigma = 0.005
    mf.max_cycle = 50
    mf.scf()

    #P=mf.make_rdm1()
    #tools.MatPrint(P,"P_ref_ao")
    #cubegen.density(mol, "h20_dens.cube", P, nx=100, ny=100, nz=100)
    print 'e_mf = ',  mf.e_tot
    continue
    if ( True ):   
#        ENUCL = mf.mol.energy_nuc()
#        OEI   = np.dot(np.dot(mf.mo_coeff.T, mol.intor('cint1e_kin_sph') + mol.intor('cint1e_nuc_sph')), mf.mo_coeff)
#        TEI   = ao2mo.outcore.full_iofree(mol, mf.mo_coeff, compact=False).reshape(mol.nao_nr(), mol.nao_nr(), mol.nao_nr(), mol.nao_nr())
#        import chemps2
#        Energy, OneDM = chemps2.solve( ENUCL, OEI, OEI, TEI, mol.nao_nr(), mol.nelectron, mol.nao_nr(), 0.0, False )
#        print "bl =", bondlength," and energy =", Energy

        mycc = cc.CCSD(mf).run()
	et=0.0
        #et = mycc.ccsd_t()
        e_hf = mf.e_tot
        e_ccsd = e_hf + mycc.e_corr + et

        print 'e_tot = ', e_ccsd    #-4.96124910741
        
    else:
        myInts = locints.LocalIntegrals( mf, range( mol.nao_nr() ), 'meta_lowdin' )
        #myInts.loc_molden( 'hydrogen-loc.molden' )
        #myInts.TI_OK = True # Only s functions

	nbas =  mol.nao_nr()
	natoms = mol.natm

	impAtom = np.zeros([natoms], dtype=int)
	for i in range(20):
	    impAtom[i] = 1

	ghost_frag = 1-impAtom
	ghost_env = 1-ghost_frag

	mol_frag = gto.Mole()
	mol_frag.atom = tools.add_ghost(mol.atom, ghost_frag)
	mol_frag.basis = bas
	mol_frag.build(max_memory = 16000,verbose = 4)
	'''
	mf_frag = dft.RKS(mol_frag)
        mf_frag.xc = 'pbe,pbe'
        mf_frag.smear_sigma = 0.00
        mf_frag.scf()
        P_frag=mf_frag.make_rdm1()
        cubegen.density(mol_frag, "h10_dens_1.cube", P_frag, nx=100, ny=100, nz=100)
	'''

	mol_env = gto.Mole()
	mol_env.atom = tools.add_ghost(mol.atom, ghost_env)
	mol_env.basis =  bas
	mol_env.build(max_memory = 16000,verbose = 4)

	'''
	mf_env = dft.RKS(mol_env)
        mf_env.xc = 'pbe,pbe'
        mf_env.smear_sigma = 0.00
        mf_env.scf()
        P_env=mf_env.make_rdm1()
        cubegen.density(mol_env, "h10_dens_2.cube", P_env, nx=100, ny=100, nz=100)
	exit()
	'''



	aoslice = mol.aoslice_by_atom()
	impurities = np.zeros([nbas], dtype = int)
	for i in range(natoms):
	    if(impAtom[i] == 1):
		impurities[aoslice[i,2]:aoslice[i,3]] = 1

	Ne_frag = 20
	boundary_atoms = np.zeros((natoms))
	boundary_atoms[20:40] = 1.0
	#boundary_atoms[19] = -1
	boundary_atoms2 = np.zeros((natoms),dtype =int)
	#boundary_atoms2[9] = -1
	boundary_atoms2[0:20] = 1

	boundary_atoms = None
	boundary_atoms2 =None

	umat=None
	P_frag=None
	P_env=None
	params = oep.OEPparams(algorithm = '2011', opt_method = 'L-BFGS-B', \
                       ftol = 1e-11, gtol = 1e-5,diffP_tol=1e-5, outer_maxit = 200, maxit = 200,l2_lambda = 0.0, oep_print = 0)
	theDMFET = sdmfet.DMFET( mf, mol_frag, mol_env,myInts,impurities, impAtom, Ne_frag, boundary_atoms=boundary_atoms, boundary_atoms2=boundary_atoms2,\
                         umat = umat, P_frag_ao = P_frag, P_env_ao = P_env, \
                         dim_imp = nbas, dim_bath=nbas, dim_big =nbas, smear_sigma = 0.005, oep_params=params,ecw_method='hf', mf_method = mf.xc)

	umat = theDMFET.embedding_potential()

	exit()

	#write subspace orbitals
	transfo = np.dot( myInts.ao2loc, theDMFET.loc2sub )
	filename =  'hydrogen-sub.molden'
	with open( filename, 'w' ) as thefile:
            molden.header( myInts.mol, thefile )
            molden.orbital_coeff( myInts.mol, thefile, transfo )


        umat = theDMFET.embedding_potential()
	print umat
	exit()
	energy = theDMFET.correction_energy()

#INFO: ******************** input file end ********************


System: ('Linux', 'tigercpu.princeton.edu', '3.10.0-693.21.1.el7.x86_64', '#1 SMP Wed Mar 7 15:59:45 EST 2018', 'x86_64', 'x86_64')  Threads 40
Python 2.7.14 |Anaconda, Inc.| (default, Oct 16 2017, 17:29:19) 
[GCC 7.2.0]
numpy 1.14.3  scipy 1.1.0
Date: Thu Jun  7 01:17:20 2018
PySCF version 1.4.2
PySCF path  /tigress/xingz/pyscf/pyscf
GIT ORIG_HEAD e0edd131499dcc18d035a120533a8a1ddda110d4
GIT HEAD      e0edd131499dcc18d035a120533a8a1ddda110d4

[INPUT] VERBOSE 4
[INPUT] num atoms = 30
[INPUT] num electrons = 120
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT]  1 Be    14.828496961934   0.000000000000   0.000000000000 AA   28.021798097000   0.000000000000   0.000000000000 Bohr
[INPUT]  2 Be    14.504458725804   3.083017875642   0.000000000000 AA   27.409454576827   5.826059422101   0.000000000000 Bohr
[INPUT]  3 Be    13.546506043242   6.031293076157   0.000000000000 AA   25.599186366492  11.397492090922   0.000000000000 Bohr
[INPUT]  4 Be    11.996506043242   8.715971827888   0.000000000000 AA   22.670110873416  16.470799664134   0.000000000000 Bohr
[INPUT]  5 Be     9.922201163529  11.019720786868   0.000000000000 AA   18.750242751911  20.824254256358   0.000000000000 Bohr
[INPUT]  6 Be     7.414248480967  12.841855068975   0.000000000000 AA   14.010899048500  24.267589011720   0.000000000000 Bohr
[INPUT]  7 Be     4.582257562275  14.102738662510   0.000000000000 AA    8.659211824917  26.650313678459   0.000000000000 Bohr
[INPUT]  8 Be     1.550000000000  14.747264904045   0.000000000000 AA    2.929075493076  27.868291755055   0.000000000000 Bohr
[INPUT]  9 Be    -1.550000000000  14.747264904045   0.000000000000 AA   -2.929075493076  27.868291755055   0.000000000000 Bohr
[INPUT] 10 Be    -4.582257562275  14.102738662510   0.000000000000 AA   -8.659211824917  26.650313678459   0.000000000000 Bohr
[INPUT] 11 Be    -7.414248480967  12.841855068975   0.000000000000 AA  -14.010899048500  24.267589011720   0.000000000000 Bohr
[INPUT] 12 Be    -9.922201163529  11.019720786868   0.000000000000 AA  -18.750242751911  20.824254256358   0.000000000000 Bohr
[INPUT] 13 Be   -11.996506043242   8.715971827888   0.000000000000 AA  -22.670110873416  16.470799664134   0.000000000000 Bohr
[INPUT] 14 Be   -13.546506043242   6.031293076157   0.000000000000 AA  -25.599186366492  11.397492090922   0.000000000000 Bohr
[INPUT] 15 Be   -14.504458725804   3.083017875642   0.000000000000 AA  -27.409454576827   5.826059422101   0.000000000000 Bohr
[INPUT] 16 Be   -14.828496961934   0.000000000000   0.000000000000 AA  -28.021798097000   0.000000000000   0.000000000000 Bohr
[INPUT] 17 Be   -14.504458725804  -3.083017875642   0.000000000000 AA  -27.409454576827  -5.826059422101   0.000000000000 Bohr
[INPUT] 18 Be   -13.546506043242  -6.031293076157   0.000000000000 AA  -25.599186366492 -11.397492090922   0.000000000000 Bohr
[INPUT] 19 Be   -11.996506043242  -8.715971827888   0.000000000000 AA  -22.670110873416 -16.470799664134   0.000000000000 Bohr
[INPUT] 20 Be    -9.922201163529 -11.019720786868   0.000000000000 AA  -18.750242751911 -20.824254256358   0.000000000000 Bohr
[INPUT] 21 Be    -7.414248480967 -12.841855068975   0.000000000000 AA  -14.010899048500 -24.267589011720   0.000000000000 Bohr
[INPUT] 22 Be    -4.582257562275 -14.102738662510   0.000000000000 AA   -8.659211824917 -26.650313678459   0.000000000000 Bohr
[INPUT] 23 Be    -1.550000000000 -14.747264904045   0.000000000000 AA   -2.929075493076 -27.868291755055   0.000000000000 Bohr
[INPUT] 24 Be     1.550000000000 -14.747264904045   0.000000000000 AA    2.929075493076 -27.868291755055   0.000000000000 Bohr
[INPUT] 25 Be     4.582257562275 -14.102738662510   0.000000000000 AA    8.659211824916 -26.650313678459   0.000000000000 Bohr
[INPUT] 26 Be     7.414248480967 -12.841855068975   0.000000000000 AA   14.010899048500 -24.267589011720   0.000000000000 Bohr
[INPUT] 27 Be     9.922201163529 -11.019720786868   0.000000000000 AA   18.750242751911 -20.824254256358   0.000000000000 Bohr
[INPUT] 28 Be    11.996506043242  -8.715971827888   0.000000000000 AA   22.670110873416 -16.470799664134   0.000000000000 Bohr
[INPUT] 29 Be    13.546506043242  -6.031293076157   0.000000000000 AA   25.599186366492 -11.397492090922   0.000000000000 Bohr
[INPUT] 30 Be    14.504458725804  -3.083017875642   0.000000000000 AA   27.409454576827  -5.826059422101   0.000000000000 Bohr
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [6    /1   ]  312.8704937       0.00916359628
                                57.36446253       0.04936149294
                                16.0485094        0.1685383049
                                5.513096119       0.3705627997
                                2.140896553       0.4164915298
                                0.8817394283      0.1303340841
[INPUT] 0    0    [6    /1   ]  13.63324744       -0.01325278809
                                2.698375464       -0.04699171014
                                0.8386530829      -0.03378537151
                                0.3226600698      0.2502417861
                                0.1401314882      0.5951172526
                                0.0642325139      0.2407061763
[INPUT] 1    0    [6    /1   ]  13.63324744       0.0037596966
                                2.698375464       0.0376793698
                                0.8386530829      0.1738967435
                                0.3226600698      0.4180364347
                                0.1401314882      0.4258595477
                                0.0642325139      0.1017082955
nuclear repulsion = 288.437975869848
number of shells = 90
number of NR pGTOs = 900
number of NR cGTOs = 150
basis = sto-6g
ecp = {}
CPU time:      1583.73


******** <class 'pyscf.scf.hf.RHF'> flags ********
method = RHF
initial guess = minao
damping factor = 0
level shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
DIIS start cycle = 1
DIIS space = 8
SCF tol = 1e-09
SCF gradient tol = None
max. SCF cycles = 50
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /tigress/xingz/pydmfet/examples/tmpkZaGdO
max_memory 16000 MB (current use 228 MB)
Set gradient conv threshold to 3.16228e-05
init E= -435.905604629979
  HOMO = -0.151974601771852  LUMO = 0.044327437183872
cycle= 1 E= -435.116193870495  delta_E= 0.789  |g|= 0.081  |ddm|=  3.7
  HOMO = -0.144063158684838  LUMO = 0.0894696482852415
cycle= 2 E= -435.125752250809  delta_E= -0.00956  |g|= 0.0358  |ddm|= 0.29
  HOMO = -0.138451343349769  LUMO = 0.0837617142343026
cycle= 3 E= -435.128599063594  delta_E= -0.00285  |g|= 0.00493  |ddm|= 0.25
  HOMO = -0.137106812074748  LUMO = 0.0825513988726335
cycle= 4 E= -435.128672188314  delta_E= -7.31e-05  |g|= 0.000276  |ddm|= 0.0477
  HOMO = -0.13705469219644  LUMO = 0.082485057502339
cycle= 5 E= -435.128672397469  delta_E= -2.09e-07  |g|= 4.09e-05  |ddm|= 0.00254
  HOMO = -0.137052831401865  LUMO = 0.0824834633824038
cycle= 6 E= -435.128672400274  delta_E= -2.81e-09  |g|= 3e-06  |ddm|= 0.00021
  HOMO = -0.137053488158614  LUMO = 0.0824839699830465
cycle= 7 E= -435.128672400292  delta_E= -1.73e-11  |g|= 1.67e-07  |ddm|= 2.01e-05
  HOMO = -0.137053466021875  LUMO = 0.0824839739872967
Extra cycle  E= -435.128672400291  delta_E= 2.27e-13  |g|= 4.05e-08  |ddm|= 5.89e-07
converged SCF energy = -435.128672400291
e_mf =  -435.12867240029135
#INFO: **** input file is /tigress/xingz/pydmfet/examples/Be.py ****
from pydmfet import locints, sdmfet, oep, tools
from pyscf import gto, scf,dft, ao2mo,cc
import numpy as np
from pyscf.tools import molden, cubegen
import copy,time

DMguess  = None

bondlengths = np.arange(1.8, 4.1, 0.1)
energies = []

bas = 'sto-6g'

for bondlength in bondlengths:

    nat = 30
    mol = gto.Mole()
    mol.atom = []
    r = 0.5 * bondlength / np.sin(np.pi/nat)
    for i in range(nat):
        theta = i * (2*np.pi/nat)
        mol.atom.append(('Be', (r*np.cos(theta), r*np.sin(theta), 0)))

    mol.basis = bas
    mol.build(max_memory=16000, verbose=4)

    mf = scf.RHF(mol)
    #mf = dft.RKS(mol)
    #mf.xc = 'pbe,pbe'
    #mf.smear_sigma = 0.005
    mf.max_cycle = 50
    mf.scf()

    #P=mf.make_rdm1()
    #tools.MatPrint(P,"P_ref_ao")
    #cubegen.density(mol, "h20_dens.cube", P, nx=100, ny=100, nz=100)
    print 'e_mf = ',  mf.e_tot
    continue
    if ( True ):   
#        ENUCL = mf.mol.energy_nuc()
#        OEI   = np.dot(np.dot(mf.mo_coeff.T, mol.intor('cint1e_kin_sph') + mol.intor('cint1e_nuc_sph')), mf.mo_coeff)
#        TEI   = ao2mo.outcore.full_iofree(mol, mf.mo_coeff, compact=False).reshape(mol.nao_nr(), mol.nao_nr(), mol.nao_nr(), mol.nao_nr())
#        import chemps2
#        Energy, OneDM = chemps2.solve( ENUCL, OEI, OEI, TEI, mol.nao_nr(), mol.nelectron, mol.nao_nr(), 0.0, False )
#        print "bl =", bondlength," and energy =", Energy

        mycc = cc.CCSD(mf).run()
	et=0.0
        #et = mycc.ccsd_t()
        e_hf = mf.e_tot
        e_ccsd = e_hf + mycc.e_corr + et

        print 'e_tot = ', e_ccsd    #-4.96124910741
        
    else:
        myInts = locints.LocalIntegrals( mf, range( mol.nao_nr() ), 'meta_lowdin' )
        #myInts.loc_molden( 'hydrogen-loc.molden' )
        #myInts.TI_OK = True # Only s functions

	nbas =  mol.nao_nr()
	natoms = mol.natm

	impAtom = np.zeros([natoms], dtype=int)
	for i in range(20):
	    impAtom[i] = 1

	ghost_frag = 1-impAtom
	ghost_env = 1-ghost_frag

	mol_frag = gto.Mole()
	mol_frag.atom = tools.add_ghost(mol.atom, ghost_frag)
	mol_frag.basis = bas
	mol_frag.build(max_memory = 16000,verbose = 4)
	'''
	mf_frag = dft.RKS(mol_frag)
        mf_frag.xc = 'pbe,pbe'
        mf_frag.smear_sigma = 0.00
        mf_frag.scf()
        P_frag=mf_frag.make_rdm1()
        cubegen.density(mol_frag, "h10_dens_1.cube", P_frag, nx=100, ny=100, nz=100)
	'''

	mol_env = gto.Mole()
	mol_env.atom = tools.add_ghost(mol.atom, ghost_env)
	mol_env.basis =  bas
	mol_env.build(max_memory = 16000,verbose = 4)

	'''
	mf_env = dft.RKS(mol_env)
        mf_env.xc = 'pbe,pbe'
        mf_env.smear_sigma = 0.00
        mf_env.scf()
        P_env=mf_env.make_rdm1()
        cubegen.density(mol_env, "h10_dens_2.cube", P_env, nx=100, ny=100, nz=100)
	exit()
	'''



	aoslice = mol.aoslice_by_atom()
	impurities = np.zeros([nbas], dtype = int)
	for i in range(natoms):
	    if(impAtom[i] == 1):
		impurities[aoslice[i,2]:aoslice[i,3]] = 1

	Ne_frag = 20
	boundary_atoms = np.zeros((natoms))
	boundary_atoms[20:40] = 1.0
	#boundary_atoms[19] = -1
	boundary_atoms2 = np.zeros((natoms),dtype =int)
	#boundary_atoms2[9] = -1
	boundary_atoms2[0:20] = 1

	boundary_atoms = None
	boundary_atoms2 =None

	umat=None
	P_frag=None
	P_env=None
	params = oep.OEPparams(algorithm = '2011', opt_method = 'L-BFGS-B', \
                       ftol = 1e-11, gtol = 1e-5,diffP_tol=1e-5, outer_maxit = 200, maxit = 200,l2_lambda = 0.0, oep_print = 0)
	theDMFET = sdmfet.DMFET( mf, mol_frag, mol_env,myInts,impurities, impAtom, Ne_frag, boundary_atoms=boundary_atoms, boundary_atoms2=boundary_atoms2,\
                         umat = umat, P_frag_ao = P_frag, P_env_ao = P_env, \
                         dim_imp = nbas, dim_bath=nbas, dim_big =nbas, smear_sigma = 0.005, oep_params=params,ecw_method='hf', mf_method = mf.xc)

	umat = theDMFET.embedding_potential()

	exit()

	#write subspace orbitals
	transfo = np.dot( myInts.ao2loc, theDMFET.loc2sub )
	filename =  'hydrogen-sub.molden'
	with open( filename, 'w' ) as thefile:
            molden.header( myInts.mol, thefile )
            molden.orbital_coeff( myInts.mol, thefile, transfo )


        umat = theDMFET.embedding_potential()
	print umat
	exit()
	energy = theDMFET.correction_energy()

#INFO: ******************** input file end ********************


System: ('Linux', 'tigercpu.princeton.edu', '3.10.0-693.21.1.el7.x86_64', '#1 SMP Wed Mar 7 15:59:45 EST 2018', 'x86_64', 'x86_64')  Threads 40
Python 2.7.14 |Anaconda, Inc.| (default, Oct 16 2017, 17:29:19) 
[GCC 7.2.0]
numpy 1.14.3  scipy 1.1.0
Date: Thu Jun  7 01:17:22 2018
PySCF version 1.4.2
PySCF path  /tigress/xingz/pyscf/pyscf
GIT ORIG_HEAD e0edd131499dcc18d035a120533a8a1ddda110d4
GIT HEAD      e0edd131499dcc18d035a120533a8a1ddda110d4

[INPUT] VERBOSE 4
[INPUT] num atoms = 30
[INPUT] num electrons = 120
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT]  1 Be    15.306835573609   0.000000000000   0.000000000000 AA   28.925727067871   0.000000000000   0.000000000000 Bohr
[INPUT]  2 Be    14.972344491153   3.182470065178   0.000000000000 AA   28.293630530919   6.013996822814   0.000000000000 Bohr
[INPUT]  3 Be    13.983490109153   6.225850917323   0.000000000000 AA   26.424966571863  11.765153126113   0.000000000000 Bohr
[INPUT]  4 Be    12.383490109153   8.997132209433   0.000000000000 AA   23.401404772559  17.002115782332   0.000000000000 Bohr
[INPUT]  5 Be    10.242272168804  11.375195650961   0.000000000000 AA   19.355089292295  21.496004393660   0.000000000000 Bohr
[INPUT]  6 Be     7.653417786805  13.256108458297   0.000000000000 AA   14.462863533935  25.050414463711   0.000000000000 Bohr
[INPUT]  7 Be     4.730072322348  14.557665716139   0.000000000000 AA    8.938541238623  27.510001216474   0.000000000000 Bohr
[INPUT]  8 Be     1.600000000000  15.222983126756   0.000000000000 AA    3.023561799304  28.767268908444   0.000000000000 Bohr
[INPUT]  9 Be    -1.600000000000  15.222983126756   0.000000000000 AA   -3.023561799304  28.767268908444   0.000000000000 Bohr
[INPUT] 10 Be    -4.730072322348  14.557665716139   0.000000000000 AA   -8.938541238623  27.510001216474   0.000000000000 Bohr
[INPUT] 11 Be    -7.653417786805  13.256108458297   0.000000000000 AA  -14.462863533935  25.050414463711   0.000000000000 Bohr
[INPUT] 12 Be   -10.242272168804  11.375195650961   0.000000000000 AA  -19.355089292295  21.496004393660   0.000000000000 Bohr
[INPUT] 13 Be   -12.383490109153   8.997132209433   0.000000000000 AA  -23.401404772559  17.002115782332   0.000000000000 Bohr
[INPUT] 14 Be   -13.983490109153   6.225850917323   0.000000000000 AA  -26.424966571863  11.765153126113   0.000000000000 Bohr
[INPUT] 15 Be   -14.972344491153   3.182470065178   0.000000000000 AA  -28.293630530919   6.013996822814   0.000000000000 Bohr
[INPUT] 16 Be   -15.306835573609   0.000000000000   0.000000000000 AA  -28.925727067871   0.000000000000   0.000000000000 Bohr
[INPUT] 17 Be   -14.972344491153  -3.182470065178   0.000000000000 AA  -28.293630530919  -6.013996822814   0.000000000000 Bohr
[INPUT] 18 Be   -13.983490109153  -6.225850917323   0.000000000000 AA  -26.424966571863 -11.765153126113   0.000000000000 Bohr
[INPUT] 19 Be   -12.383490109153  -8.997132209433   0.000000000000 AA  -23.401404772559 -17.002115782332   0.000000000000 Bohr
[INPUT] 20 Be   -10.242272168804 -11.375195650961   0.000000000000 AA  -19.355089292295 -21.496004393660   0.000000000000 Bohr
[INPUT] 21 Be    -7.653417786805 -13.256108458297   0.000000000000 AA  -14.462863533935 -25.050414463711   0.000000000000 Bohr
[INPUT] 22 Be    -4.730072322348 -14.557665716139   0.000000000000 AA   -8.938541238623 -27.510001216474   0.000000000000 Bohr
[INPUT] 23 Be    -1.600000000000 -15.222983126756   0.000000000000 AA   -3.023561799304 -28.767268908444   0.000000000000 Bohr
[INPUT] 24 Be     1.600000000000 -15.222983126756   0.000000000000 AA    3.023561799304 -28.767268908444   0.000000000000 Bohr
[INPUT] 25 Be     4.730072322348 -14.557665716139   0.000000000000 AA    8.938541238623 -27.510001216474   0.000000000000 Bohr
[INPUT] 26 Be     7.653417786804 -13.256108458297   0.000000000000 AA   14.462863533935 -25.050414463711   0.000000000000 Bohr
[INPUT] 27 Be    10.242272168804 -11.375195650961   0.000000000000 AA   19.355089292295 -21.496004393660   0.000000000000 Bohr
[INPUT] 28 Be    12.383490109153  -8.997132209433   0.000000000000 AA   23.401404772559 -17.002115782332   0.000000000000 Bohr
[INPUT] 29 Be    13.983490109153  -6.225850917323   0.000000000000 AA   26.424966571863 -11.765153126113   0.000000000000 Bohr
[INPUT] 30 Be    14.972344491153  -3.182470065178   0.000000000000 AA   28.293630530919  -6.013996822814   0.000000000000 Bohr
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [6    /1   ]  312.8704937       0.00916359628
                                57.36446253       0.04936149294
                                16.0485094        0.1685383049
                                5.513096119       0.3705627997
                                2.140896553       0.4164915298
                                0.8817394283      0.1303340841
[INPUT] 0    0    [6    /1   ]  13.63324744       -0.01325278809
                                2.698375464       -0.04699171014
                                0.8386530829      -0.03378537151
                                0.3226600698      0.2502417861
                                0.1401314882      0.5951172526
                                0.0642325139      0.2407061763
[INPUT] 1    0    [6    /1   ]  13.63324744       0.0037596966
                                2.698375464       0.0376793698
                                0.8386530829      0.1738967435
                                0.3226600698      0.4180364347
                                0.1401314882      0.4258595477
                                0.0642325139      0.1017082955
nuclear repulsion = 279.424289123915
number of shells = 90
number of NR pGTOs = 900
number of NR cGTOs = 150
basis = sto-6g
ecp = {}
CPU time:      1659.84


******** <class 'pyscf.scf.hf.RHF'> flags ********
method = RHF
initial guess = minao
damping factor = 0
level shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
DIIS start cycle = 1
DIIS space = 8
SCF tol = 1e-09
SCF gradient tol = None
max. SCF cycles = 50
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /tigress/xingz/pydmfet/examples/tmpJcTJrx
max_memory 16000 MB (current use 229 MB)
Set gradient conv threshold to 3.16228e-05
init E= -435.685423510642
  HOMO = -0.168915235859859  LUMO = 0.0515441539152998
cycle= 1 E= -435.113863462836  delta_E= 0.572  |g|= 0.0639  |ddm|= 3.36
  HOMO = -0.158505082444529  LUMO = 0.0993880156368179
cycle= 2 E= -435.119677382458  delta_E= -0.00581  |g|= 0.0266  |ddm|= 0.222
  HOMO = -0.154797503617633  LUMO = 0.0953808849772033
cycle= 3 E= -435.121112590956  delta_E= -0.00144  |g|= 0.00287  |ddm|= 0.17
  HOMO = -0.154119661075418  LUMO = 0.0947886398678594
cycle= 4 E= -435.121133812782  delta_E= -2.12e-05  |g|= 0.000171  |ddm|= 0.0231
  HOMO = -0.154092989197118  LUMO = 0.0947557360005742
cycle= 5 E= -435.121133878467  delta_E= -6.57e-08  |g|= 2.07e-05  |ddm|= 0.0013
  HOMO = -0.154092216183034  LUMO = 0.0947552594495796
cycle= 6 E= -435.121133879162  delta_E= -6.96e-10  |g|= 2.13e-06  |ddm|= 9.77e-05
  HOMO = -0.154092397140598  LUMO = 0.094755350529128
Extra cycle  E= -435.121133879169  delta_E= -6.82e-12  |g|= 7.24e-07  |ddm|= 7.2e-06
converged SCF energy = -435.121133879169
e_mf =  -435.12113387916907
#INFO: **** input file is /tigress/xingz/pydmfet/examples/Be.py ****
from pydmfet import locints, sdmfet, oep, tools
from pyscf import gto, scf,dft, ao2mo,cc
import numpy as np
from pyscf.tools import molden, cubegen
import copy,time

DMguess  = None

bondlengths = np.arange(1.8, 4.1, 0.1)
energies = []

bas = 'sto-6g'

for bondlength in bondlengths:

    nat = 30
    mol = gto.Mole()
    mol.atom = []
    r = 0.5 * bondlength / np.sin(np.pi/nat)
    for i in range(nat):
        theta = i * (2*np.pi/nat)
        mol.atom.append(('Be', (r*np.cos(theta), r*np.sin(theta), 0)))

    mol.basis = bas
    mol.build(max_memory=16000, verbose=4)

    mf = scf.RHF(mol)
    #mf = dft.RKS(mol)
    #mf.xc = 'pbe,pbe'
    #mf.smear_sigma = 0.005
    mf.max_cycle = 50
    mf.scf()

    #P=mf.make_rdm1()
    #tools.MatPrint(P,"P_ref_ao")
    #cubegen.density(mol, "h20_dens.cube", P, nx=100, ny=100, nz=100)
    print 'e_mf = ',  mf.e_tot
    continue
    if ( True ):   
#        ENUCL = mf.mol.energy_nuc()
#        OEI   = np.dot(np.dot(mf.mo_coeff.T, mol.intor('cint1e_kin_sph') + mol.intor('cint1e_nuc_sph')), mf.mo_coeff)
#        TEI   = ao2mo.outcore.full_iofree(mol, mf.mo_coeff, compact=False).reshape(mol.nao_nr(), mol.nao_nr(), mol.nao_nr(), mol.nao_nr())
#        import chemps2
#        Energy, OneDM = chemps2.solve( ENUCL, OEI, OEI, TEI, mol.nao_nr(), mol.nelectron, mol.nao_nr(), 0.0, False )
#        print "bl =", bondlength," and energy =", Energy

        mycc = cc.CCSD(mf).run()
	et=0.0
        #et = mycc.ccsd_t()
        e_hf = mf.e_tot
        e_ccsd = e_hf + mycc.e_corr + et

        print 'e_tot = ', e_ccsd    #-4.96124910741
        
    else:
        myInts = locints.LocalIntegrals( mf, range( mol.nao_nr() ), 'meta_lowdin' )
        #myInts.loc_molden( 'hydrogen-loc.molden' )
        #myInts.TI_OK = True # Only s functions

	nbas =  mol.nao_nr()
	natoms = mol.natm

	impAtom = np.zeros([natoms], dtype=int)
	for i in range(20):
	    impAtom[i] = 1

	ghost_frag = 1-impAtom
	ghost_env = 1-ghost_frag

	mol_frag = gto.Mole()
	mol_frag.atom = tools.add_ghost(mol.atom, ghost_frag)
	mol_frag.basis = bas
	mol_frag.build(max_memory = 16000,verbose = 4)
	'''
	mf_frag = dft.RKS(mol_frag)
        mf_frag.xc = 'pbe,pbe'
        mf_frag.smear_sigma = 0.00
        mf_frag.scf()
        P_frag=mf_frag.make_rdm1()
        cubegen.density(mol_frag, "h10_dens_1.cube", P_frag, nx=100, ny=100, nz=100)
	'''

	mol_env = gto.Mole()
	mol_env.atom = tools.add_ghost(mol.atom, ghost_env)
	mol_env.basis =  bas
	mol_env.build(max_memory = 16000,verbose = 4)

	'''
	mf_env = dft.RKS(mol_env)
        mf_env.xc = 'pbe,pbe'
        mf_env.smear_sigma = 0.00
        mf_env.scf()
        P_env=mf_env.make_rdm1()
        cubegen.density(mol_env, "h10_dens_2.cube", P_env, nx=100, ny=100, nz=100)
	exit()
	'''



	aoslice = mol.aoslice_by_atom()
	impurities = np.zeros([nbas], dtype = int)
	for i in range(natoms):
	    if(impAtom[i] == 1):
		impurities[aoslice[i,2]:aoslice[i,3]] = 1

	Ne_frag = 20
	boundary_atoms = np.zeros((natoms))
	boundary_atoms[20:40] = 1.0
	#boundary_atoms[19] = -1
	boundary_atoms2 = np.zeros((natoms),dtype =int)
	#boundary_atoms2[9] = -1
	boundary_atoms2[0:20] = 1

	boundary_atoms = None
	boundary_atoms2 =None

	umat=None
	P_frag=None
	P_env=None
	params = oep.OEPparams(algorithm = '2011', opt_method = 'L-BFGS-B', \
                       ftol = 1e-11, gtol = 1e-5,diffP_tol=1e-5, outer_maxit = 200, maxit = 200,l2_lambda = 0.0, oep_print = 0)
	theDMFET = sdmfet.DMFET( mf, mol_frag, mol_env,myInts,impurities, impAtom, Ne_frag, boundary_atoms=boundary_atoms, boundary_atoms2=boundary_atoms2,\
                         umat = umat, P_frag_ao = P_frag, P_env_ao = P_env, \
                         dim_imp = nbas, dim_bath=nbas, dim_big =nbas, smear_sigma = 0.005, oep_params=params,ecw_method='hf', mf_method = mf.xc)

	umat = theDMFET.embedding_potential()

	exit()

	#write subspace orbitals
	transfo = np.dot( myInts.ao2loc, theDMFET.loc2sub )
	filename =  'hydrogen-sub.molden'
	with open( filename, 'w' ) as thefile:
            molden.header( myInts.mol, thefile )
            molden.orbital_coeff( myInts.mol, thefile, transfo )


        umat = theDMFET.embedding_potential()
	print umat
	exit()
	energy = theDMFET.correction_energy()

#INFO: ******************** input file end ********************


System: ('Linux', 'tigercpu.princeton.edu', '3.10.0-693.21.1.el7.x86_64', '#1 SMP Wed Mar 7 15:59:45 EST 2018', 'x86_64', 'x86_64')  Threads 40
Python 2.7.14 |Anaconda, Inc.| (default, Oct 16 2017, 17:29:19) 
[GCC 7.2.0]
numpy 1.14.3  scipy 1.1.0
Date: Thu Jun  7 01:17:24 2018
PySCF version 1.4.2
PySCF path  /tigress/xingz/pyscf/pyscf
GIT ORIG_HEAD e0edd131499dcc18d035a120533a8a1ddda110d4
GIT HEAD      e0edd131499dcc18d035a120533a8a1ddda110d4

[INPUT] VERBOSE 4
[INPUT] num atoms = 30
[INPUT] num electrons = 120
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT]  1 Be    15.785174185284   0.000000000000   0.000000000000 AA   29.829656038742   0.000000000000   0.000000000000 Bohr
[INPUT]  2 Be    15.440230256501   3.281922254715   0.000000000000 AA   29.177806485010   6.201934223527   0.000000000000 Bohr
[INPUT]  3 Be    14.420474175064   6.420408758489   0.000000000000 AA   27.250746777234  12.132814161304   0.000000000000 Bohr
[INPUT]  4 Be    12.770474175064   9.278292590978   0.000000000000 AA   24.132698671701  17.533431900530   0.000000000000 Bohr
[INPUT]  5 Be    10.562343174079  11.730670515053   0.000000000000 AA   19.959935832679  22.167754530961   0.000000000000 Bohr
[INPUT]  6 Be     7.892587092642  13.670361847619   0.000000000000 AA   14.914828019371  25.833239915702   0.000000000000 Bohr
[INPUT]  7 Be     4.877887082422  15.012592769769   0.000000000000 AA    9.217870652330  28.369688754488   0.000000000000 Bohr
[INPUT]  8 Be     1.650000000000  15.698701349467   0.000000000000 AA    3.118048105532  29.666246061833   0.000000000000 Bohr
[INPUT]  9 Be    -1.650000000000  15.698701349467   0.000000000000 AA   -3.118048105532  29.666246061833   0.000000000000 Bohr
[INPUT] 10 Be    -4.877887082422  15.012592769769   0.000000000000 AA   -9.217870652330  28.369688754488   0.000000000000 Bohr
[INPUT] 11 Be    -7.892587092642  13.670361847619   0.000000000000 AA  -14.914828019371  25.833239915702   0.000000000000 Bohr
[INPUT] 12 Be   -10.562343174079  11.730670515053   0.000000000000 AA  -19.959935832679  22.167754530961   0.000000000000 Bohr
[INPUT] 13 Be   -12.770474175064   9.278292590978   0.000000000000 AA  -24.132698671701  17.533431900530   0.000000000000 Bohr
[INPUT] 14 Be   -14.420474175064   6.420408758489   0.000000000000 AA  -27.250746777234  12.132814161304   0.000000000000 Bohr
[INPUT] 15 Be   -15.440230256501   3.281922254715   0.000000000000 AA  -29.177806485010   6.201934223527   0.000000000000 Bohr
[INPUT] 16 Be   -15.785174185284   0.000000000000   0.000000000000 AA  -29.829656038742   0.000000000000   0.000000000000 Bohr
[INPUT] 17 Be   -15.440230256501  -3.281922254715   0.000000000000 AA  -29.177806485010  -6.201934223527   0.000000000000 Bohr
[INPUT] 18 Be   -14.420474175064  -6.420408758489   0.000000000000 AA  -27.250746777234 -12.132814161304   0.000000000000 Bohr
[INPUT] 19 Be   -12.770474175064  -9.278292590978   0.000000000000 AA  -24.132698671701 -17.533431900530   0.000000000000 Bohr
[INPUT] 20 Be   -10.562343174079 -11.730670515053   0.000000000000 AA  -19.959935832679 -22.167754530961   0.000000000000 Bohr
[INPUT] 21 Be    -7.892587092642 -13.670361847619   0.000000000000 AA  -14.914828019371 -25.833239915702   0.000000000000 Bohr
[INPUT] 22 Be    -4.877887082422 -15.012592769769   0.000000000000 AA   -9.217870652330 -28.369688754488   0.000000000000 Bohr
[INPUT] 23 Be    -1.650000000000 -15.698701349467   0.000000000000 AA   -3.118048105532 -29.666246061833   0.000000000000 Bohr
[INPUT] 24 Be     1.650000000000 -15.698701349467   0.000000000000 AA    3.118048105532 -29.666246061833   0.000000000000 Bohr
[INPUT] 25 Be     4.877887082422 -15.012592769769   0.000000000000 AA    9.217870652330 -28.369688754488   0.000000000000 Bohr
[INPUT] 26 Be     7.892587092642 -13.670361847619   0.000000000000 AA   14.914828019371 -25.833239915702   0.000000000000 Bohr
[INPUT] 27 Be    10.562343174079 -11.730670515053   0.000000000000 AA   19.959935832679 -22.167754530961   0.000000000000 Bohr
[INPUT] 28 Be    12.770474175064  -9.278292590978   0.000000000000 AA   24.132698671701 -17.533431900530   0.000000000000 Bohr
[INPUT] 29 Be    14.420474175064  -6.420408758489   0.000000000000 AA   27.250746777234 -12.132814161304   0.000000000000 Bohr
[INPUT] 30 Be    15.440230256501  -3.281922254715   0.000000000000 AA   29.177806485010  -6.201934223527   0.000000000000 Bohr
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [6    /1   ]  312.8704937       0.00916359628
                                57.36446253       0.04936149294
                                16.0485094        0.1685383049
                                5.513096119       0.3705627997
                                2.140896553       0.4164915298
                                0.8817394283      0.1303340841
[INPUT] 0    0    [6    /1   ]  13.63324744       -0.01325278809
                                2.698375464       -0.04699171014
                                0.8386530829      -0.03378537151
                                0.3226600698      0.2502417861
                                0.1401314882      0.5951172526
                                0.0642325139      0.2407061763
[INPUT] 1    0    [6    /1   ]  13.63324744       0.0037596966
                                2.698375464       0.0376793698
                                0.8386530829      0.1738967435
                                0.3226600698      0.4180364347
                                0.1401314882      0.4258595477
                                0.0642325139      0.1017082955
nuclear repulsion = 270.95688642319
number of shells = 90
number of NR pGTOs = 900
number of NR cGTOs = 150
basis = sto-6g
ecp = {}
CPU time:      1736.77


******** <class 'pyscf.scf.hf.RHF'> flags ********
method = RHF
initial guess = minao
damping factor = 0
level shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
DIIS start cycle = 1
DIIS space = 8
SCF tol = 1e-09
SCF gradient tol = None
max. SCF cycles = 50
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /tigress/xingz/pydmfet/examples/tmpjPBbJd
max_memory 16000 MB (current use 229 MB)
Set gradient conv threshold to 3.16228e-05
init E= -435.501063012809
  HOMO = -0.184056152555547  LUMO = 0.0587870803409746
cycle= 1 E= -435.112365914616  delta_E= 0.389  |g|= 0.0502  |ddm|= 3.05
  HOMO = -0.17092246696643  LUMO = 0.108627510093779
cycle= 2 E= -435.115881896338  delta_E= -0.00352  |g|= 0.0198  |ddm|= 0.17
  HOMO = -0.168471467743218  LUMO = 0.105791331248915
cycle= 3 E= -435.116621625169  delta_E= -0.00074  |g|= 0.00177  |ddm|= 0.117
  HOMO = -0.168099395524939  LUMO = 0.10548084327714
cycle= 4 E= -435.116628864346  delta_E= -7.24e-06  |g|= 0.000124  |ddm|= 0.0124
  HOMO = -0.16808138017475  LUMO = 0.105461873417044
cycle= 5 E= -435.116628892519  delta_E= -2.82e-08  |g|= 1.09e-05  |ddm|= 0.000801
  HOMO = -0.168081046273524  LUMO = 0.105461934769929
cycle= 6 E= -435.1166288927  delta_E= -1.81e-10  |g|= 1.76e-06  |ddm|= 4.68e-05
  HOMO = -0.168081106382738  LUMO = 0.105461953111146
Extra cycle  E= -435.116628892704  delta_E= -3.52e-12  |g|= 5.92e-07  |ddm|= 5.89e-06
converged SCF energy = -435.116628892704
e_mf =  -435.1166288927038
#INFO: **** input file is /tigress/xingz/pydmfet/examples/Be.py ****
from pydmfet import locints, sdmfet, oep, tools
from pyscf import gto, scf,dft, ao2mo,cc
import numpy as np
from pyscf.tools import molden, cubegen
import copy,time

DMguess  = None

bondlengths = np.arange(1.8, 4.1, 0.1)
energies = []

bas = 'sto-6g'

for bondlength in bondlengths:

    nat = 30
    mol = gto.Mole()
    mol.atom = []
    r = 0.5 * bondlength / np.sin(np.pi/nat)
    for i in range(nat):
        theta = i * (2*np.pi/nat)
        mol.atom.append(('Be', (r*np.cos(theta), r*np.sin(theta), 0)))

    mol.basis = bas
    mol.build(max_memory=16000, verbose=4)

    mf = scf.RHF(mol)
    #mf = dft.RKS(mol)
    #mf.xc = 'pbe,pbe'
    #mf.smear_sigma = 0.005
    mf.max_cycle = 50
    mf.scf()

    #P=mf.make_rdm1()
    #tools.MatPrint(P,"P_ref_ao")
    #cubegen.density(mol, "h20_dens.cube", P, nx=100, ny=100, nz=100)
    print 'e_mf = ',  mf.e_tot
    continue
    if ( True ):   
#        ENUCL = mf.mol.energy_nuc()
#        OEI   = np.dot(np.dot(mf.mo_coeff.T, mol.intor('cint1e_kin_sph') + mol.intor('cint1e_nuc_sph')), mf.mo_coeff)
#        TEI   = ao2mo.outcore.full_iofree(mol, mf.mo_coeff, compact=False).reshape(mol.nao_nr(), mol.nao_nr(), mol.nao_nr(), mol.nao_nr())
#        import chemps2
#        Energy, OneDM = chemps2.solve( ENUCL, OEI, OEI, TEI, mol.nao_nr(), mol.nelectron, mol.nao_nr(), 0.0, False )
#        print "bl =", bondlength," and energy =", Energy

        mycc = cc.CCSD(mf).run()
	et=0.0
        #et = mycc.ccsd_t()
        e_hf = mf.e_tot
        e_ccsd = e_hf + mycc.e_corr + et

        print 'e_tot = ', e_ccsd    #-4.96124910741
        
    else:
        myInts = locints.LocalIntegrals( mf, range( mol.nao_nr() ), 'meta_lowdin' )
        #myInts.loc_molden( 'hydrogen-loc.molden' )
        #myInts.TI_OK = True # Only s functions

	nbas =  mol.nao_nr()
	natoms = mol.natm

	impAtom = np.zeros([natoms], dtype=int)
	for i in range(20):
	    impAtom[i] = 1

	ghost_frag = 1-impAtom
	ghost_env = 1-ghost_frag

	mol_frag = gto.Mole()
	mol_frag.atom = tools.add_ghost(mol.atom, ghost_frag)
	mol_frag.basis = bas
	mol_frag.build(max_memory = 16000,verbose = 4)
	'''
	mf_frag = dft.RKS(mol_frag)
        mf_frag.xc = 'pbe,pbe'
        mf_frag.smear_sigma = 0.00
        mf_frag.scf()
        P_frag=mf_frag.make_rdm1()
        cubegen.density(mol_frag, "h10_dens_1.cube", P_frag, nx=100, ny=100, nz=100)
	'''

	mol_env = gto.Mole()
	mol_env.atom = tools.add_ghost(mol.atom, ghost_env)
	mol_env.basis =  bas
	mol_env.build(max_memory = 16000,verbose = 4)

	'''
	mf_env = dft.RKS(mol_env)
        mf_env.xc = 'pbe,pbe'
        mf_env.smear_sigma = 0.00
        mf_env.scf()
        P_env=mf_env.make_rdm1()
        cubegen.density(mol_env, "h10_dens_2.cube", P_env, nx=100, ny=100, nz=100)
	exit()
	'''



	aoslice = mol.aoslice_by_atom()
	impurities = np.zeros([nbas], dtype = int)
	for i in range(natoms):
	    if(impAtom[i] == 1):
		impurities[aoslice[i,2]:aoslice[i,3]] = 1

	Ne_frag = 20
	boundary_atoms = np.zeros((natoms))
	boundary_atoms[20:40] = 1.0
	#boundary_atoms[19] = -1
	boundary_atoms2 = np.zeros((natoms),dtype =int)
	#boundary_atoms2[9] = -1
	boundary_atoms2[0:20] = 1

	boundary_atoms = None
	boundary_atoms2 =None

	umat=None
	P_frag=None
	P_env=None
	params = oep.OEPparams(algorithm = '2011', opt_method = 'L-BFGS-B', \
                       ftol = 1e-11, gtol = 1e-5,diffP_tol=1e-5, outer_maxit = 200, maxit = 200,l2_lambda = 0.0, oep_print = 0)
	theDMFET = sdmfet.DMFET( mf, mol_frag, mol_env,myInts,impurities, impAtom, Ne_frag, boundary_atoms=boundary_atoms, boundary_atoms2=boundary_atoms2,\
                         umat = umat, P_frag_ao = P_frag, P_env_ao = P_env, \
                         dim_imp = nbas, dim_bath=nbas, dim_big =nbas, smear_sigma = 0.005, oep_params=params,ecw_method='hf', mf_method = mf.xc)

	umat = theDMFET.embedding_potential()

	exit()

	#write subspace orbitals
	transfo = np.dot( myInts.ao2loc, theDMFET.loc2sub )
	filename =  'hydrogen-sub.molden'
	with open( filename, 'w' ) as thefile:
            molden.header( myInts.mol, thefile )
            molden.orbital_coeff( myInts.mol, thefile, transfo )


        umat = theDMFET.embedding_potential()
	print umat
	exit()
	energy = theDMFET.correction_energy()

#INFO: ******************** input file end ********************


System: ('Linux', 'tigercpu.princeton.edu', '3.10.0-693.21.1.el7.x86_64', '#1 SMP Wed Mar 7 15:59:45 EST 2018', 'x86_64', 'x86_64')  Threads 40
Python 2.7.14 |Anaconda, Inc.| (default, Oct 16 2017, 17:29:19) 
[GCC 7.2.0]
numpy 1.14.3  scipy 1.1.0
Date: Thu Jun  7 01:17:25 2018
PySCF version 1.4.2
PySCF path  /tigress/xingz/pyscf/pyscf
GIT ORIG_HEAD e0edd131499dcc18d035a120533a8a1ddda110d4
GIT HEAD      e0edd131499dcc18d035a120533a8a1ddda110d4

[INPUT] VERBOSE 4
[INPUT] num atoms = 30
[INPUT] num electrons = 120
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT]  1 Be    16.263512796960   0.000000000000   0.000000000000 AA   30.733585009613   0.000000000000   0.000000000000 Bohr
[INPUT]  2 Be    15.908116021850   3.381374444252   0.000000000000 AA   30.061982439101   6.389871624240   0.000000000000 Bohr
[INPUT]  3 Be    14.857458240975   6.614966599656   0.000000000000 AA   28.076526982604  12.500475196495   0.000000000000 Bohr
[INPUT]  4 Be    13.157458240975   9.559452972523   0.000000000000 AA   24.863992570844  18.064748018727   0.000000000000 Bohr
[INPUT]  5 Be    10.882414179355  12.086145379146   0.000000000000 AA   20.564782373064  22.839504668263   0.000000000000 Bohr
[INPUT]  6 Be     8.131756398480  14.084615236940   0.000000000000 AA   15.366792504806  26.616065367693   0.000000000000 Bohr
[INPUT]  7 Be     5.025701842495  15.467519823398   0.000000000000 AA    9.497200066037  29.229376292503   0.000000000000 Bohr
[INPUT]  8 Be     1.700000000000  16.174419572178   0.000000000000 AA    3.212534411761  30.565223215222   0.000000000000 Bohr
[INPUT]  9 Be    -1.700000000000  16.174419572178   0.000000000000 AA   -3.212534411761  30.565223215222   0.000000000000 Bohr
[INPUT] 10 Be    -5.025701842495  15.467519823398   0.000000000000 AA   -9.497200066037  29.229376292503   0.000000000000 Bohr
[INPUT] 11 Be    -8.131756398480  14.084615236940   0.000000000000 AA  -15.366792504806  26.616065367693   0.000000000000 Bohr
[INPUT] 12 Be   -10.882414179355  12.086145379146   0.000000000000 AA  -20.564782373064  22.839504668263   0.000000000000 Bohr
[INPUT] 13 Be   -13.157458240975   9.559452972523   0.000000000000 AA  -24.863992570844  18.064748018727   0.000000000000 Bohr
[INPUT] 14 Be   -14.857458240975   6.614966599656   0.000000000000 AA  -28.076526982604  12.500475196495   0.000000000000 Bohr
[INPUT] 15 Be   -15.908116021850   3.381374444252   0.000000000000 AA  -30.061982439101   6.389871624240   0.000000000000 Bohr
[INPUT] 16 Be   -16.263512796960   0.000000000000   0.000000000000 AA  -30.733585009613   0.000000000000   0.000000000000 Bohr
[INPUT] 17 Be   -15.908116021850  -3.381374444252   0.000000000000 AA  -30.061982439101  -6.389871624240   0.000000000000 Bohr
[INPUT] 18 Be   -14.857458240975  -6.614966599656   0.000000000000 AA  -28.076526982604 -12.500475196495   0.000000000000 Bohr
[INPUT] 19 Be   -13.157458240975  -9.559452972523   0.000000000000 AA  -24.863992570844 -18.064748018727   0.000000000000 Bohr
[INPUT] 20 Be   -10.882414179355 -12.086145379146   0.000000000000 AA  -20.564782373064 -22.839504668263   0.000000000000 Bohr
[INPUT] 21 Be    -8.131756398480 -14.084615236940   0.000000000000 AA  -15.366792504806 -26.616065367693   0.000000000000 Bohr
[INPUT] 22 Be    -5.025701842495 -15.467519823398   0.000000000000 AA   -9.497200066037 -29.229376292503   0.000000000000 Bohr
[INPUT] 23 Be    -1.700000000000 -16.174419572178   0.000000000000 AA   -3.212534411761 -30.565223215222   0.000000000000 Bohr
[INPUT] 24 Be     1.700000000000 -16.174419572178   0.000000000000 AA    3.212534411761 -30.565223215222   0.000000000000 Bohr
[INPUT] 25 Be     5.025701842495 -15.467519823398   0.000000000000 AA    9.497200066037 -29.229376292503   0.000000000000 Bohr
[INPUT] 26 Be     8.131756398480 -14.084615236940   0.000000000000 AA   15.366792504806 -26.616065367693   0.000000000000 Bohr
[INPUT] 27 Be    10.882414179355 -12.086145379146   0.000000000000 AA   20.564782373064 -22.839504668263   0.000000000000 Bohr
[INPUT] 28 Be    13.157458240975  -9.559452972523   0.000000000000 AA   24.863992570844 -18.064748018727   0.000000000000 Bohr
[INPUT] 29 Be    14.857458240975  -6.614966599656   0.000000000000 AA   28.076526982604 -12.500475196495   0.000000000000 Bohr
[INPUT] 30 Be    15.908116021850  -3.381374444252   0.000000000000 AA   30.061982439101  -6.389871624240   0.000000000000 Bohr
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [6    /1   ]  312.8704937       0.00916359628
                                57.36446253       0.04936149294
                                16.0485094        0.1685383049
                                5.513096119       0.3705627997
                                2.140896553       0.4164915298
                                0.8817394283      0.1303340841
[INPUT] 0    0    [6    /1   ]  13.63324744       -0.01325278809
                                2.698375464       -0.04699171014
                                0.8386530829      -0.03378537151
                                0.3226600698      0.2502417861
                                0.1401314882      0.5951172526
                                0.0642325139      0.2407061763
[INPUT] 1    0    [6    /1   ]  13.63324744       0.0037596966
                                2.698375464       0.0376793698
                                0.8386530829      0.1738967435
                                0.3226600698      0.4180364347
                                0.1401314882      0.4258595477
                                0.0642325139      0.1017082955
nuclear repulsion = 262.987566234273
number of shells = 90
number of NR pGTOs = 900
number of NR cGTOs = 150
basis = sto-6g
ecp = {}
CPU time:      1777.59


******** <class 'pyscf.scf.hf.RHF'> flags ********
method = RHF
initial guess = minao
damping factor = 0
level shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
DIIS start cycle = 1
DIIS space = 8
SCF tol = 1e-09
SCF gradient tol = None
max. SCF cycles = 50
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /tigress/xingz/pydmfet/examples/tmp1bvB_Y
max_memory 16000 MB (current use 229 MB)
Set gradient conv threshold to 3.16228e-05
init E= -435.347286886861
  HOMO = -0.197546854925  LUMO = 0.066010275384532
cycle= 1 E= -435.111217331469  delta_E= 0.236  |g|= 0.0391  |ddm|= 2.76
  HOMO = -0.181643619736203  LUMO = 0.117307328844848
cycle= 2 E= -435.113316479921  delta_E= -0.0021  |g|= 0.0146  |ddm|= 0.13
  HOMO = -0.180038215054257  LUMO = 0.1152981800235
cycle= 3 E= -435.11369974041  delta_E= -0.000383  |g|= 0.00117  |ddm|= 0.081
  HOMO = -0.179818519082401  LUMO = 0.115123992536589
cycle= 4 E= -435.113702598523  delta_E= -2.86e-06  |g|= 9.85e-05  |ddm|= 0.00729
  HOMO = -0.179805049015132  LUMO = 0.115112689584875
cycle= 5 E= -435.113702612778  delta_E= -1.43e-08  |g|= 6.42e-06  |ddm|= 0.000538
  HOMO = -0.17980489390718  LUMO = 0.115112961989501
cycle= 6 E= -435.113702612831  delta_E= -5.33e-11  |g|= 1.13e-06  |ddm|= 2.55e-05
  HOMO = -0.179804907116229  LUMO = 0.115112975981949
Extra cycle  E= -435.113702612833  delta_E= -1.25e-12  |g|= 3.74e-07  |ddm|= 3.88e-06
converged SCF energy = -435.113702612833
e_mf =  -435.1137026128325
#INFO: **** input file is /tigress/xingz/pydmfet/examples/Be.py ****
from pydmfet import locints, sdmfet, oep, tools
from pyscf import gto, scf,dft, ao2mo,cc
import numpy as np
from pyscf.tools import molden, cubegen
import copy,time

DMguess  = None

bondlengths = np.arange(1.8, 4.1, 0.1)
energies = []

bas = 'sto-6g'

for bondlength in bondlengths:

    nat = 30
    mol = gto.Mole()
    mol.atom = []
    r = 0.5 * bondlength / np.sin(np.pi/nat)
    for i in range(nat):
        theta = i * (2*np.pi/nat)
        mol.atom.append(('Be', (r*np.cos(theta), r*np.sin(theta), 0)))

    mol.basis = bas
    mol.build(max_memory=16000, verbose=4)

    mf = scf.RHF(mol)
    #mf = dft.RKS(mol)
    #mf.xc = 'pbe,pbe'
    #mf.smear_sigma = 0.005
    mf.max_cycle = 50
    mf.scf()

    #P=mf.make_rdm1()
    #tools.MatPrint(P,"P_ref_ao")
    #cubegen.density(mol, "h20_dens.cube", P, nx=100, ny=100, nz=100)
    print 'e_mf = ',  mf.e_tot
    continue
    if ( True ):   
#        ENUCL = mf.mol.energy_nuc()
#        OEI   = np.dot(np.dot(mf.mo_coeff.T, mol.intor('cint1e_kin_sph') + mol.intor('cint1e_nuc_sph')), mf.mo_coeff)
#        TEI   = ao2mo.outcore.full_iofree(mol, mf.mo_coeff, compact=False).reshape(mol.nao_nr(), mol.nao_nr(), mol.nao_nr(), mol.nao_nr())
#        import chemps2
#        Energy, OneDM = chemps2.solve( ENUCL, OEI, OEI, TEI, mol.nao_nr(), mol.nelectron, mol.nao_nr(), 0.0, False )
#        print "bl =", bondlength," and energy =", Energy

        mycc = cc.CCSD(mf).run()
	et=0.0
        #et = mycc.ccsd_t()
        e_hf = mf.e_tot
        e_ccsd = e_hf + mycc.e_corr + et

        print 'e_tot = ', e_ccsd    #-4.96124910741
        
    else:
        myInts = locints.LocalIntegrals( mf, range( mol.nao_nr() ), 'meta_lowdin' )
        #myInts.loc_molden( 'hydrogen-loc.molden' )
        #myInts.TI_OK = True # Only s functions

	nbas =  mol.nao_nr()
	natoms = mol.natm

	impAtom = np.zeros([natoms], dtype=int)
	for i in range(20):
	    impAtom[i] = 1

	ghost_frag = 1-impAtom
	ghost_env = 1-ghost_frag

	mol_frag = gto.Mole()
	mol_frag.atom = tools.add_ghost(mol.atom, ghost_frag)
	mol_frag.basis = bas
	mol_frag.build(max_memory = 16000,verbose = 4)
	'''
	mf_frag = dft.RKS(mol_frag)
        mf_frag.xc = 'pbe,pbe'
        mf_frag.smear_sigma = 0.00
        mf_frag.scf()
        P_frag=mf_frag.make_rdm1()
        cubegen.density(mol_frag, "h10_dens_1.cube", P_frag, nx=100, ny=100, nz=100)
	'''

	mol_env = gto.Mole()
	mol_env.atom = tools.add_ghost(mol.atom, ghost_env)
	mol_env.basis =  bas
	mol_env.build(max_memory = 16000,verbose = 4)

	'''
	mf_env = dft.RKS(mol_env)
        mf_env.xc = 'pbe,pbe'
        mf_env.smear_sigma = 0.00
        mf_env.scf()
        P_env=mf_env.make_rdm1()
        cubegen.density(mol_env, "h10_dens_2.cube", P_env, nx=100, ny=100, nz=100)
	exit()
	'''



	aoslice = mol.aoslice_by_atom()
	impurities = np.zeros([nbas], dtype = int)
	for i in range(natoms):
	    if(impAtom[i] == 1):
		impurities[aoslice[i,2]:aoslice[i,3]] = 1

	Ne_frag = 20
	boundary_atoms = np.zeros((natoms))
	boundary_atoms[20:40] = 1.0
	#boundary_atoms[19] = -1
	boundary_atoms2 = np.zeros((natoms),dtype =int)
	#boundary_atoms2[9] = -1
	boundary_atoms2[0:20] = 1

	boundary_atoms = None
	boundary_atoms2 =None

	umat=None
	P_frag=None
	P_env=None
	params = oep.OEPparams(algorithm = '2011', opt_method = 'L-BFGS-B', \
                       ftol = 1e-11, gtol = 1e-5,diffP_tol=1e-5, outer_maxit = 200, maxit = 200,l2_lambda = 0.0, oep_print = 0)
	theDMFET = sdmfet.DMFET( mf, mol_frag, mol_env,myInts,impurities, impAtom, Ne_frag, boundary_atoms=boundary_atoms, boundary_atoms2=boundary_atoms2,\
                         umat = umat, P_frag_ao = P_frag, P_env_ao = P_env, \
                         dim_imp = nbas, dim_bath=nbas, dim_big =nbas, smear_sigma = 0.005, oep_params=params,ecw_method='hf', mf_method = mf.xc)

	umat = theDMFET.embedding_potential()

	exit()

	#write subspace orbitals
	transfo = np.dot( myInts.ao2loc, theDMFET.loc2sub )
	filename =  'hydrogen-sub.molden'
	with open( filename, 'w' ) as thefile:
            molden.header( myInts.mol, thefile )
            molden.orbital_coeff( myInts.mol, thefile, transfo )


        umat = theDMFET.embedding_potential()
	print umat
	exit()
	energy = theDMFET.correction_energy()

#INFO: ******************** input file end ********************


System: ('Linux', 'tigercpu.princeton.edu', '3.10.0-693.21.1.el7.x86_64', '#1 SMP Wed Mar 7 15:59:45 EST 2018', 'x86_64', 'x86_64')  Threads 40
Python 2.7.14 |Anaconda, Inc.| (default, Oct 16 2017, 17:29:19) 
[GCC 7.2.0]
numpy 1.14.3  scipy 1.1.0
Date: Thu Jun  7 01:17:27 2018
PySCF version 1.4.2
PySCF path  /tigress/xingz/pyscf/pyscf
GIT ORIG_HEAD e0edd131499dcc18d035a120533a8a1ddda110d4
GIT HEAD      e0edd131499dcc18d035a120533a8a1ddda110d4

[INPUT] VERBOSE 4
[INPUT] num atoms = 30
[INPUT] num electrons = 120
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT]  1 Be    16.741851408635   0.000000000000   0.000000000000 AA   31.637513980484   0.000000000000   0.000000000000 Bohr
[INPUT]  2 Be    16.376001787198   3.480826633789   0.000000000000 AA   30.946158393192   6.577809024953   0.000000000000 Bohr
[INPUT]  3 Be    15.294442306886   6.809524440822   0.000000000000 AA   28.902307187975  12.868136231686   0.000000000000 Bohr
[INPUT]  4 Be    13.544442306886   9.840613354068   0.000000000000 AA   25.595286469986  18.596064136925   0.000000000000 Bohr
[INPUT]  5 Be    11.202485184630  12.441620243238   0.000000000000 AA   21.169628913448  23.511254805565   0.000000000000 Bohr
[INPUT]  6 Be     8.370925704317  14.498868626262   0.000000000000 AA   15.818756990242  27.398890819684   0.000000000000 Bohr
[INPUT]  7 Be     5.173516602568  15.922446877027   0.000000000000 AA    9.776529479744  30.089063830518   0.000000000000 Bohr
[INPUT]  8 Be     1.750000000000  16.650137794890   0.000000000000 AA    3.307020717989  31.464200368611   0.000000000000 Bohr
[INPUT]  9 Be    -1.750000000000  16.650137794890   0.000000000000 AA   -3.307020717989  31.464200368611   0.000000000000 Bohr
[INPUT] 10 Be    -5.173516602568  15.922446877027   0.000000000000 AA   -9.776529479744  30.089063830518   0.000000000000 Bohr
[INPUT] 11 Be    -8.370925704317  14.498868626262   0.000000000000 AA  -15.818756990242  27.398890819684   0.000000000000 Bohr
[INPUT] 12 Be   -11.202485184630  12.441620243238   0.000000000000 AA  -21.169628913448  23.511254805565   0.000000000000 Bohr
[INPUT] 13 Be   -13.544442306886   9.840613354068   0.000000000000 AA  -25.595286469986  18.596064136925   0.000000000000 Bohr
[INPUT] 14 Be   -15.294442306886   6.809524440822   0.000000000000 AA  -28.902307187975  12.868136231686   0.000000000000 Bohr
[INPUT] 15 Be   -16.376001787198   3.480826633789   0.000000000000 AA  -30.946158393192   6.577809024953   0.000000000000 Bohr
[INPUT] 16 Be   -16.741851408635   0.000000000000   0.000000000000 AA  -31.637513980484   0.000000000000   0.000000000000 Bohr
[INPUT] 17 Be   -16.376001787198  -3.480826633789   0.000000000000 AA  -30.946158393192  -6.577809024953   0.000000000000 Bohr
[INPUT] 18 Be   -15.294442306886  -6.809524440822   0.000000000000 AA  -28.902307187975 -12.868136231686   0.000000000000 Bohr
[INPUT] 19 Be   -13.544442306886  -9.840613354068   0.000000000000 AA  -25.595286469986 -18.596064136925   0.000000000000 Bohr
[INPUT] 20 Be   -11.202485184630 -12.441620243238   0.000000000000 AA  -21.169628913448 -23.511254805565   0.000000000000 Bohr
[INPUT] 21 Be    -8.370925704317 -14.498868626262   0.000000000000 AA  -15.818756990242 -27.398890819684   0.000000000000 Bohr
[INPUT] 22 Be    -5.173516602568 -15.922446877027   0.000000000000 AA   -9.776529479744 -30.089063830518   0.000000000000 Bohr
[INPUT] 23 Be    -1.750000000000 -16.650137794890   0.000000000000 AA   -3.307020717989 -31.464200368611   0.000000000000 Bohr
[INPUT] 24 Be     1.750000000000 -16.650137794890   0.000000000000 AA    3.307020717989 -31.464200368611   0.000000000000 Bohr
[INPUT] 25 Be     5.173516602568 -15.922446877027   0.000000000000 AA    9.776529479744 -30.089063830518   0.000000000000 Bohr
[INPUT] 26 Be     8.370925704317 -14.498868626262   0.000000000000 AA   15.818756990242 -27.398890819684   0.000000000000 Bohr
[INPUT] 27 Be    11.202485184630 -12.441620243238   0.000000000000 AA   21.169628913448 -23.511254805565   0.000000000000 Bohr
[INPUT] 28 Be    13.544442306886  -9.840613354068   0.000000000000 AA   25.595286469986 -18.596064136925   0.000000000000 Bohr
[INPUT] 29 Be    15.294442306886  -6.809524440822   0.000000000000 AA   28.902307187975 -12.868136231686   0.000000000000 Bohr
[INPUT] 30 Be    16.376001787198  -3.480826633789   0.000000000000 AA   30.946158393192  -6.577809024953   0.000000000000 Bohr
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [6    /1   ]  312.8704937       0.00916359628
                                57.36446253       0.04936149294
                                16.0485094        0.1685383049
                                5.513096119       0.3705627997
                                2.140896553       0.4164915298
                                0.8817394283      0.1303340841
[INPUT] 0    0    [6    /1   ]  13.63324744       -0.01325278809
                                2.698375464       -0.04699171014
                                0.8386530829      -0.03378537151
                                0.3226600698      0.2502417861
                                0.1401314882      0.5951172526
                                0.0642325139      0.2407061763
[INPUT] 1    0    [6    /1   ]  13.63324744       0.0037596966
                                2.698375464       0.0376793698
                                0.8386530829      0.1738967435
                                0.3226600698      0.4180364347
                                0.1401314882      0.4258595477
                                0.0642325139      0.1017082955
nuclear repulsion = 255.473635770437
number of shells = 90
number of NR pGTOs = 900
number of NR cGTOs = 150
basis = sto-6g
ecp = {}
CPU time:      1864.38


******** <class 'pyscf.scf.hf.RHF'> flags ********
method = RHF
initial guess = minao
damping factor = 0
level shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
DIIS start cycle = 1
DIIS space = 8
SCF tol = 1e-09
SCF gradient tol = None
max. SCF cycles = 50
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /tigress/xingz/pydmfet/examples/tmpNM6Ipu
max_memory 16000 MB (current use 229 MB)
Set gradient conv threshold to 3.16228e-05
init E= -435.21950795908
  HOMO = -0.209529611095841  LUMO = 0.0731681903592665
cycle= 1 E= -435.110196115454  delta_E= 0.109  |g|= 0.0301  |ddm|= 2.49
  HOMO = -0.190926549603061  LUMO = 0.125499825805449
cycle= 2 E= -435.111425609156  delta_E= -0.00123  |g|= 0.0107  |ddm|= 0.0984
  HOMO = -0.189896404383306  LUMO = 0.124084224587275
cycle= 3 E= -435.111622556269  delta_E= -0.000197  |g|= 0.000816  |ddm|= 0.0561
  HOMO = -0.189757679315013  LUMO = 0.123977794592548
cycle= 4 E= -435.111623863086  delta_E= -1.31e-06  |g|= 8.07e-05  |ddm|= 0.00468
  HOMO = -0.189747333940629  LUMO = 0.123971140552398
cycle= 5 E= -435.111623871123  delta_E= -8.04e-09  |g|= 4.48e-06  |ddm|= 0.000381
  HOMO = -0.189747254319684  LUMO = 0.123971467218925
cycle= 6 E= -435.111623871145  delta_E= -2.22e-11  |g|= 6.41e-07  |ddm|= 1.67e-05
  HOMO = -0.189747253203382  LUMO = 0.12397148525952
Extra cycle  E= -435.111623871145  delta_E= -2.27e-13  |g|= 2.03e-07  |ddm|= 2.21e-06
converged SCF energy = -435.111623871145
e_mf =  -435.1116238711453
#INFO: **** input file is /tigress/xingz/pydmfet/examples/Be.py ****
from pydmfet import locints, sdmfet, oep, tools
from pyscf import gto, scf,dft, ao2mo,cc
import numpy as np
from pyscf.tools import molden, cubegen
import copy,time

DMguess  = None

bondlengths = np.arange(1.8, 4.1, 0.1)
energies = []

bas = 'sto-6g'

for bondlength in bondlengths:

    nat = 30
    mol = gto.Mole()
    mol.atom = []
    r = 0.5 * bondlength / np.sin(np.pi/nat)
    for i in range(nat):
        theta = i * (2*np.pi/nat)
        mol.atom.append(('Be', (r*np.cos(theta), r*np.sin(theta), 0)))

    mol.basis = bas
    mol.build(max_memory=16000, verbose=4)

    mf = scf.RHF(mol)
    #mf = dft.RKS(mol)
    #mf.xc = 'pbe,pbe'
    #mf.smear_sigma = 0.005
    mf.max_cycle = 50
    mf.scf()

    #P=mf.make_rdm1()
    #tools.MatPrint(P,"P_ref_ao")
    #cubegen.density(mol, "h20_dens.cube", P, nx=100, ny=100, nz=100)
    print 'e_mf = ',  mf.e_tot
    continue
    if ( True ):   
#        ENUCL = mf.mol.energy_nuc()
#        OEI   = np.dot(np.dot(mf.mo_coeff.T, mol.intor('cint1e_kin_sph') + mol.intor('cint1e_nuc_sph')), mf.mo_coeff)
#        TEI   = ao2mo.outcore.full_iofree(mol, mf.mo_coeff, compact=False).reshape(mol.nao_nr(), mol.nao_nr(), mol.nao_nr(), mol.nao_nr())
#        import chemps2
#        Energy, OneDM = chemps2.solve( ENUCL, OEI, OEI, TEI, mol.nao_nr(), mol.nelectron, mol.nao_nr(), 0.0, False )
#        print "bl =", bondlength," and energy =", Energy

        mycc = cc.CCSD(mf).run()
	et=0.0
        #et = mycc.ccsd_t()
        e_hf = mf.e_tot
        e_ccsd = e_hf + mycc.e_corr + et

        print 'e_tot = ', e_ccsd    #-4.96124910741
        
    else:
        myInts = locints.LocalIntegrals( mf, range( mol.nao_nr() ), 'meta_lowdin' )
        #myInts.loc_molden( 'hydrogen-loc.molden' )
        #myInts.TI_OK = True # Only s functions

	nbas =  mol.nao_nr()
	natoms = mol.natm

	impAtom = np.zeros([natoms], dtype=int)
	for i in range(20):
	    impAtom[i] = 1

	ghost_frag = 1-impAtom
	ghost_env = 1-ghost_frag

	mol_frag = gto.Mole()
	mol_frag.atom = tools.add_ghost(mol.atom, ghost_frag)
	mol_frag.basis = bas
	mol_frag.build(max_memory = 16000,verbose = 4)
	'''
	mf_frag = dft.RKS(mol_frag)
        mf_frag.xc = 'pbe,pbe'
        mf_frag.smear_sigma = 0.00
        mf_frag.scf()
        P_frag=mf_frag.make_rdm1()
        cubegen.density(mol_frag, "h10_dens_1.cube", P_frag, nx=100, ny=100, nz=100)
	'''

	mol_env = gto.Mole()
	mol_env.atom = tools.add_ghost(mol.atom, ghost_env)
	mol_env.basis =  bas
	mol_env.build(max_memory = 16000,verbose = 4)

	'''
	mf_env = dft.RKS(mol_env)
        mf_env.xc = 'pbe,pbe'
        mf_env.smear_sigma = 0.00
        mf_env.scf()
        P_env=mf_env.make_rdm1()
        cubegen.density(mol_env, "h10_dens_2.cube", P_env, nx=100, ny=100, nz=100)
	exit()
	'''



	aoslice = mol.aoslice_by_atom()
	impurities = np.zeros([nbas], dtype = int)
	for i in range(natoms):
	    if(impAtom[i] == 1):
		impurities[aoslice[i,2]:aoslice[i,3]] = 1

	Ne_frag = 20
	boundary_atoms = np.zeros((natoms))
	boundary_atoms[20:40] = 1.0
	#boundary_atoms[19] = -1
	boundary_atoms2 = np.zeros((natoms),dtype =int)
	#boundary_atoms2[9] = -1
	boundary_atoms2[0:20] = 1

	boundary_atoms = None
	boundary_atoms2 =None

	umat=None
	P_frag=None
	P_env=None
	params = oep.OEPparams(algorithm = '2011', opt_method = 'L-BFGS-B', \
                       ftol = 1e-11, gtol = 1e-5,diffP_tol=1e-5, outer_maxit = 200, maxit = 200,l2_lambda = 0.0, oep_print = 0)
	theDMFET = sdmfet.DMFET( mf, mol_frag, mol_env,myInts,impurities, impAtom, Ne_frag, boundary_atoms=boundary_atoms, boundary_atoms2=boundary_atoms2,\
                         umat = umat, P_frag_ao = P_frag, P_env_ao = P_env, \
                         dim_imp = nbas, dim_bath=nbas, dim_big =nbas, smear_sigma = 0.005, oep_params=params,ecw_method='hf', mf_method = mf.xc)

	umat = theDMFET.embedding_potential()

	exit()

	#write subspace orbitals
	transfo = np.dot( myInts.ao2loc, theDMFET.loc2sub )
	filename =  'hydrogen-sub.molden'
	with open( filename, 'w' ) as thefile:
            molden.header( myInts.mol, thefile )
            molden.orbital_coeff( myInts.mol, thefile, transfo )


        umat = theDMFET.embedding_potential()
	print umat
	exit()
	energy = theDMFET.correction_energy()

#INFO: ******************** input file end ********************


System: ('Linux', 'tigercpu.princeton.edu', '3.10.0-693.21.1.el7.x86_64', '#1 SMP Wed Mar 7 15:59:45 EST 2018', 'x86_64', 'x86_64')  Threads 40
Python 2.7.14 |Anaconda, Inc.| (default, Oct 16 2017, 17:29:19) 
[GCC 7.2.0]
numpy 1.14.3  scipy 1.1.0
Date: Thu Jun  7 01:17:29 2018
PySCF version 1.4.2
PySCF path  /tigress/xingz/pyscf/pyscf
GIT ORIG_HEAD e0edd131499dcc18d035a120533a8a1ddda110d4
GIT HEAD      e0edd131499dcc18d035a120533a8a1ddda110d4

[INPUT] VERBOSE 4
[INPUT] num atoms = 30
[INPUT] num electrons = 120
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT]  1 Be    17.220190020310   0.000000000000   0.000000000000 AA   32.541442951355   0.000000000000   0.000000000000 Bohr
[INPUT]  2 Be    16.843887552547   3.580278823326   0.000000000000 AA   31.830334347284   6.765746425666   0.000000000000 Bohr
[INPUT]  3 Be    15.731426372797   7.004082281988   0.000000000000 AA   29.728087393346  13.235797266877   0.000000000000 Bohr
[INPUT]  4 Be    13.931426372797  10.121773735612   0.000000000000 AA   26.326580369129  19.127380255123   0.000000000000 Bohr
[INPUT]  5 Be    11.522556189905  12.797095107331   0.000000000000 AA   21.774475453832  24.183004942867   0.000000000000 Bohr
[INPUT]  6 Be     8.610095010155  14.913122015584   0.000000000000 AA   16.270721475677  28.181716271675   0.000000000000 Bohr
[INPUT]  7 Be     5.321331362642  16.377373930657   0.000000000000 AA   10.055858893451  30.948751368533   0.000000000000 Bohr
[INPUT]  8 Be     1.800000000000  17.125856017601   0.000000000000 AA    3.401507024217  32.363177522000   0.000000000000 Bohr
[INPUT]  9 Be    -1.800000000000  17.125856017601   0.000000000000 AA   -3.401507024217  32.363177522000   0.000000000000 Bohr
[INPUT] 10 Be    -5.321331362642  16.377373930657   0.000000000000 AA  -10.055858893451  30.948751368533   0.000000000000 Bohr
[INPUT] 11 Be    -8.610095010155  14.913122015584   0.000000000000 AA  -16.270721475677  28.181716271675   0.000000000000 Bohr
[INPUT] 12 Be   -11.522556189905  12.797095107331   0.000000000000 AA  -21.774475453832  24.183004942867   0.000000000000 Bohr
[INPUT] 13 Be   -13.931426372797  10.121773735612   0.000000000000 AA  -26.326580369129  19.127380255123   0.000000000000 Bohr
[INPUT] 14 Be   -15.731426372797   7.004082281988   0.000000000000 AA  -29.728087393346  13.235797266877   0.000000000000 Bohr
[INPUT] 15 Be   -16.843887552547   3.580278823326   0.000000000000 AA  -31.830334347284   6.765746425666   0.000000000000 Bohr
[INPUT] 16 Be   -17.220190020310   0.000000000000   0.000000000000 AA  -32.541442951355   0.000000000000   0.000000000000 Bohr
[INPUT] 17 Be   -16.843887552547  -3.580278823326   0.000000000000 AA  -31.830334347284  -6.765746425666   0.000000000000 Bohr
[INPUT] 18 Be   -15.731426372797  -7.004082281988   0.000000000000 AA  -29.728087393346 -13.235797266877   0.000000000000 Bohr
[INPUT] 19 Be   -13.931426372797 -10.121773735612   0.000000000000 AA  -26.326580369129 -19.127380255123   0.000000000000 Bohr
[INPUT] 20 Be   -11.522556189905 -12.797095107331   0.000000000000 AA  -21.774475453832 -24.183004942867   0.000000000000 Bohr
[INPUT] 21 Be    -8.610095010155 -14.913122015584   0.000000000000 AA  -16.270721475677 -28.181716271675   0.000000000000 Bohr
[INPUT] 22 Be    -5.321331362642 -16.377373930657   0.000000000000 AA  -10.055858893451 -30.948751368533   0.000000000000 Bohr
[INPUT] 23 Be    -1.800000000000 -17.125856017601   0.000000000000 AA   -3.401507024217 -32.363177522000   0.000000000000 Bohr
[INPUT] 24 Be     1.800000000000 -17.125856017601   0.000000000000 AA    3.401507024217 -32.363177522000   0.000000000000 Bohr
[INPUT] 25 Be     5.321331362642 -16.377373930657   0.000000000000 AA   10.055858893451 -30.948751368533   0.000000000000 Bohr
[INPUT] 26 Be     8.610095010155 -14.913122015584   0.000000000000 AA   16.270721475677 -28.181716271675   0.000000000000 Bohr
[INPUT] 27 Be    11.522556189905 -12.797095107331   0.000000000000 AA   21.774475453832 -24.183004942867   0.000000000000 Bohr
[INPUT] 28 Be    13.931426372797 -10.121773735612   0.000000000000 AA   26.326580369129 -19.127380255123   0.000000000000 Bohr
[INPUT] 29 Be    15.731426372797  -7.004082281988   0.000000000000 AA   29.728087393346 -13.235797266877   0.000000000000 Bohr
[INPUT] 30 Be    16.843887552547  -3.580278823326   0.000000000000 AA   31.830334347284  -6.765746425666   0.000000000000 Bohr
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [6    /1   ]  312.8704937       0.00916359628
                                57.36446253       0.04936149294
                                16.0485094        0.1685383049
                                5.513096119       0.3705627997
                                2.140896553       0.4164915298
                                0.8817394283      0.1303340841
[INPUT] 0    0    [6    /1   ]  13.63324744       -0.01325278809
                                2.698375464       -0.04699171014
                                0.8386530829      -0.03378537151
                                0.3226600698      0.2502417861
                                0.1401314882      0.5951172526
                                0.0642325139      0.2407061763
[INPUT] 1    0    [6    /1   ]  13.63324744       0.0037596966
                                2.698375464       0.0376793698
                                0.8386530829      0.1738967435
                                0.3226600698      0.4180364347
                                0.1401314882      0.4258595477
                                0.0642325139      0.1017082955
nuclear repulsion = 248.377145887925
number of shells = 90
number of NR pGTOs = 900
number of NR cGTOs = 150
basis = sto-6g
ecp = {}
CPU time:      1931.80


******** <class 'pyscf.scf.hf.RHF'> flags ********
method = RHF
initial guess = minao
damping factor = 0
level shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
DIIS start cycle = 1
DIIS space = 8
SCF tol = 1e-09
SCF gradient tol = None
max. SCF cycles = 50
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /tigress/xingz/pydmfet/examples/tmpZCDVBi
max_memory 16000 MB (current use 229 MB)
Set gradient conv threshold to 3.16228e-05
init E= -435.11373230088
  HOMO = -0.220139188925905  LUMO = 0.0802161391053394
cycle= 1 E= -435.109216442522  delta_E= 0.00452  |g|= 0.0229  |ddm|= 2.25
  HOMO = -0.198979670799571  LUMO = 0.133247451668973
cycle= 2 E= -435.109918868402  delta_E= -0.000702  |g|= 0.00777  |ddm|= 0.074
  HOMO = -0.198342286007014  LUMO = 0.132261635110704
cycle= 3 E= -435.11001802324  delta_E= -9.92e-05  |g|= 0.000612  |ddm|= 0.0384
  HOMO = -0.19824944827396  LUMO = 0.132189053158056
cycle= 4 E= -435.110018715979  delta_E= -6.93e-07  |g|= 6.62e-05  |ddm|= 0.00329
  HOMO = -0.198241494748581  LUMO = 0.13218516340796
cycle= 5 E= -435.110018720864  delta_E= -4.89e-09  |g|= 3.5e-06  |ddm|= 0.000282
  HOMO = -0.198241447865694  LUMO = 0.132185467533739
cycle= 6 E= -435.110018720875  delta_E= -1.1e-11  |g|= 3.76e-07  |ddm|= 1.23e-05
  HOMO = -0.198241443534251  LUMO = 0.132185484230706
Extra cycle  E= -435.110018720876  delta_E= -4.55e-13  |g|= 1.11e-07  |ddm|= 1.26e-06
converged SCF energy = -435.110018720876
e_mf =  -435.11001872087587
#INFO: **** input file is /tigress/xingz/pydmfet/examples/Be.py ****
from pydmfet import locints, sdmfet, oep, tools
from pyscf import gto, scf,dft, ao2mo,cc
import numpy as np
from pyscf.tools import molden, cubegen
import copy,time

DMguess  = None

bondlengths = np.arange(1.8, 4.1, 0.1)
energies = []

bas = 'sto-6g'

for bondlength in bondlengths:

    nat = 30
    mol = gto.Mole()
    mol.atom = []
    r = 0.5 * bondlength / np.sin(np.pi/nat)
    for i in range(nat):
        theta = i * (2*np.pi/nat)
        mol.atom.append(('Be', (r*np.cos(theta), r*np.sin(theta), 0)))

    mol.basis = bas
    mol.build(max_memory=16000, verbose=4)

    mf = scf.RHF(mol)
    #mf = dft.RKS(mol)
    #mf.xc = 'pbe,pbe'
    #mf.smear_sigma = 0.005
    mf.max_cycle = 50
    mf.scf()

    #P=mf.make_rdm1()
    #tools.MatPrint(P,"P_ref_ao")
    #cubegen.density(mol, "h20_dens.cube", P, nx=100, ny=100, nz=100)
    print 'e_mf = ',  mf.e_tot
    continue
    if ( True ):   
#        ENUCL = mf.mol.energy_nuc()
#        OEI   = np.dot(np.dot(mf.mo_coeff.T, mol.intor('cint1e_kin_sph') + mol.intor('cint1e_nuc_sph')), mf.mo_coeff)
#        TEI   = ao2mo.outcore.full_iofree(mol, mf.mo_coeff, compact=False).reshape(mol.nao_nr(), mol.nao_nr(), mol.nao_nr(), mol.nao_nr())
#        import chemps2
#        Energy, OneDM = chemps2.solve( ENUCL, OEI, OEI, TEI, mol.nao_nr(), mol.nelectron, mol.nao_nr(), 0.0, False )
#        print "bl =", bondlength," and energy =", Energy

        mycc = cc.CCSD(mf).run()
	et=0.0
        #et = mycc.ccsd_t()
        e_hf = mf.e_tot
        e_ccsd = e_hf + mycc.e_corr + et

        print 'e_tot = ', e_ccsd    #-4.96124910741
        
    else:
        myInts = locints.LocalIntegrals( mf, range( mol.nao_nr() ), 'meta_lowdin' )
        #myInts.loc_molden( 'hydrogen-loc.molden' )
        #myInts.TI_OK = True # Only s functions

	nbas =  mol.nao_nr()
	natoms = mol.natm

	impAtom = np.zeros([natoms], dtype=int)
	for i in range(20):
	    impAtom[i] = 1

	ghost_frag = 1-impAtom
	ghost_env = 1-ghost_frag

	mol_frag = gto.Mole()
	mol_frag.atom = tools.add_ghost(mol.atom, ghost_frag)
	mol_frag.basis = bas
	mol_frag.build(max_memory = 16000,verbose = 4)
	'''
	mf_frag = dft.RKS(mol_frag)
        mf_frag.xc = 'pbe,pbe'
        mf_frag.smear_sigma = 0.00
        mf_frag.scf()
        P_frag=mf_frag.make_rdm1()
        cubegen.density(mol_frag, "h10_dens_1.cube", P_frag, nx=100, ny=100, nz=100)
	'''

	mol_env = gto.Mole()
	mol_env.atom = tools.add_ghost(mol.atom, ghost_env)
	mol_env.basis =  bas
	mol_env.build(max_memory = 16000,verbose = 4)

	'''
	mf_env = dft.RKS(mol_env)
        mf_env.xc = 'pbe,pbe'
        mf_env.smear_sigma = 0.00
        mf_env.scf()
        P_env=mf_env.make_rdm1()
        cubegen.density(mol_env, "h10_dens_2.cube", P_env, nx=100, ny=100, nz=100)
	exit()
	'''



	aoslice = mol.aoslice_by_atom()
	impurities = np.zeros([nbas], dtype = int)
	for i in range(natoms):
	    if(impAtom[i] == 1):
		impurities[aoslice[i,2]:aoslice[i,3]] = 1

	Ne_frag = 20
	boundary_atoms = np.zeros((natoms))
	boundary_atoms[20:40] = 1.0
	#boundary_atoms[19] = -1
	boundary_atoms2 = np.zeros((natoms),dtype =int)
	#boundary_atoms2[9] = -1
	boundary_atoms2[0:20] = 1

	boundary_atoms = None
	boundary_atoms2 =None

	umat=None
	P_frag=None
	P_env=None
	params = oep.OEPparams(algorithm = '2011', opt_method = 'L-BFGS-B', \
                       ftol = 1e-11, gtol = 1e-5,diffP_tol=1e-5, outer_maxit = 200, maxit = 200,l2_lambda = 0.0, oep_print = 0)
	theDMFET = sdmfet.DMFET( mf, mol_frag, mol_env,myInts,impurities, impAtom, Ne_frag, boundary_atoms=boundary_atoms, boundary_atoms2=boundary_atoms2,\
                         umat = umat, P_frag_ao = P_frag, P_env_ao = P_env, \
                         dim_imp = nbas, dim_bath=nbas, dim_big =nbas, smear_sigma = 0.005, oep_params=params,ecw_method='hf', mf_method = mf.xc)

	umat = theDMFET.embedding_potential()

	exit()

	#write subspace orbitals
	transfo = np.dot( myInts.ao2loc, theDMFET.loc2sub )
	filename =  'hydrogen-sub.molden'
	with open( filename, 'w' ) as thefile:
            molden.header( myInts.mol, thefile )
            molden.orbital_coeff( myInts.mol, thefile, transfo )


        umat = theDMFET.embedding_potential()
	print umat
	exit()
	energy = theDMFET.correction_energy()

#INFO: ******************** input file end ********************


System: ('Linux', 'tigercpu.princeton.edu', '3.10.0-693.21.1.el7.x86_64', '#1 SMP Wed Mar 7 15:59:45 EST 2018', 'x86_64', 'x86_64')  Threads 40
Python 2.7.14 |Anaconda, Inc.| (default, Oct 16 2017, 17:29:19) 
[GCC 7.2.0]
numpy 1.14.3  scipy 1.1.0
Date: Thu Jun  7 01:17:30 2018
PySCF version 1.4.2
PySCF path  /tigress/xingz/pyscf/pyscf
GIT ORIG_HEAD e0edd131499dcc18d035a120533a8a1ddda110d4
GIT HEAD      e0edd131499dcc18d035a120533a8a1ddda110d4

[INPUT] VERBOSE 4
[INPUT] num atoms = 30
[INPUT] num electrons = 120
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT]  1 Be    17.698528631985   0.000000000000   0.000000000000 AA   33.445371922226   0.000000000000   0.000000000000 Bohr
[INPUT]  2 Be    17.311773317895   3.679731012863   0.000000000000 AA   32.714510301375   6.953683826379   0.000000000000 Bohr
[INPUT]  3 Be    16.168410438708   7.198640123155   0.000000000000 AA   30.553867598717  13.603458302068   0.000000000000 Bohr
[INPUT]  4 Be    14.318410438708  10.402934117157   0.000000000000 AA   27.057874268271  19.658696373321   0.000000000000 Bohr
[INPUT]  5 Be    11.842627195180  13.152569971423   0.000000000000 AA   22.379321994216  24.854755080169   0.000000000000 Bohr
[INPUT]  6 Be     8.849264315993  15.327375404906   0.000000000000 AA   16.722685961113  28.964541723666   0.000000000000 Bohr
[INPUT]  7 Be     5.469146122715  16.832300984286   0.000000000000 AA   10.335188307158  31.808438906548   0.000000000000 Bohr
[INPUT]  8 Be     1.850000000000  17.601574240312   0.000000000000 AA    3.495993330445  33.262154675389   0.000000000000 Bohr
[INPUT]  9 Be    -1.850000000000  17.601574240312   0.000000000000 AA   -3.495993330445  33.262154675389   0.000000000000 Bohr
[INPUT] 10 Be    -5.469146122715  16.832300984286   0.000000000000 AA  -10.335188307158  31.808438906548   0.000000000000 Bohr
[INPUT] 11 Be    -8.849264315993  15.327375404906   0.000000000000 AA  -16.722685961113  28.964541723666   0.000000000000 Bohr
[INPUT] 12 Be   -11.842627195180  13.152569971423   0.000000000000 AA  -22.379321994216  24.854755080169   0.000000000000 Bohr
[INPUT] 13 Be   -14.318410438708  10.402934117157   0.000000000000 AA  -27.057874268271  19.658696373321   0.000000000000 Bohr
[INPUT] 14 Be   -16.168410438708   7.198640123155   0.000000000000 AA  -30.553867598717  13.603458302068   0.000000000000 Bohr
[INPUT] 15 Be   -17.311773317895   3.679731012863   0.000000000000 AA  -32.714510301375   6.953683826379   0.000000000000 Bohr
[INPUT] 16 Be   -17.698528631985   0.000000000000   0.000000000000 AA  -33.445371922226   0.000000000000   0.000000000000 Bohr
[INPUT] 17 Be   -17.311773317895  -3.679731012863   0.000000000000 AA  -32.714510301375  -6.953683826379   0.000000000000 Bohr
[INPUT] 18 Be   -16.168410438708  -7.198640123155   0.000000000000 AA  -30.553867598717 -13.603458302068   0.000000000000 Bohr
[INPUT] 19 Be   -14.318410438708 -10.402934117157   0.000000000000 AA  -27.057874268271 -19.658696373321   0.000000000000 Bohr
[INPUT] 20 Be   -11.842627195180 -13.152569971423   0.000000000000 AA  -22.379321994216 -24.854755080169   0.000000000000 Bohr
[INPUT] 21 Be    -8.849264315993 -15.327375404906   0.000000000000 AA  -16.722685961113 -28.964541723666   0.000000000000 Bohr
[INPUT] 22 Be    -5.469146122715 -16.832300984286   0.000000000000 AA  -10.335188307158 -31.808438906548   0.000000000000 Bohr
[INPUT] 23 Be    -1.850000000000 -17.601574240312   0.000000000000 AA   -3.495993330445 -33.262154675389   0.000000000000 Bohr
[INPUT] 24 Be     1.850000000000 -17.601574240312   0.000000000000 AA    3.495993330445 -33.262154675389   0.000000000000 Bohr
[INPUT] 25 Be     5.469146122715 -16.832300984286   0.000000000000 AA   10.335188307158 -31.808438906548   0.000000000000 Bohr
[INPUT] 26 Be     8.849264315993 -15.327375404906   0.000000000000 AA   16.722685961113 -28.964541723666   0.000000000000 Bohr
[INPUT] 27 Be    11.842627195180 -13.152569971423   0.000000000000 AA   22.379321994216 -24.854755080169   0.000000000000 Bohr
[INPUT] 28 Be    14.318410438708 -10.402934117157   0.000000000000 AA   27.057874268271 -19.658696373321   0.000000000000 Bohr
[INPUT] 29 Be    16.168410438708  -7.198640123155   0.000000000000 AA   30.553867598717 -13.603458302068   0.000000000000 Bohr
[INPUT] 30 Be    17.311773317895  -3.679731012863   0.000000000000 AA   32.714510301375  -6.953683826379   0.000000000000 Bohr
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [6    /1   ]  312.8704937       0.00916359628
                                57.36446253       0.04936149294
                                16.0485094        0.1685383049
                                5.513096119       0.3705627997
                                2.140896553       0.4164915298
                                0.8817394283      0.1303340841
[INPUT] 0    0    [6    /1   ]  13.63324744       -0.01325278809
                                2.698375464       -0.04699171014
                                0.8386530829      -0.03378537151
                                0.3226600698      0.2502417861
                                0.1401314882      0.5951172526
                                0.0642325139      0.2407061763
[INPUT] 1    0    [6    /1   ]  13.63324744       0.0037596966
                                2.698375464       0.0376793698
                                0.8386530829      0.1738967435
                                0.3226600698      0.4180364347
                                0.1401314882      0.4258595477
                                0.0642325139      0.1017082955
nuclear repulsion = 241.664250053116
number of shells = 90
number of NR pGTOs = 900
number of NR cGTOs = 150
basis = sto-6g
ecp = {}
CPU time:      1985.44


******** <class 'pyscf.scf.hf.RHF'> flags ********
method = RHF
initial guess = minao
damping factor = 0
level shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
DIIS start cycle = 1
DIIS space = 8
SCF tol = 1e-09
SCF gradient tol = None
max. SCF cycles = 50
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /tigress/xingz/pydmfet/examples/tmpPFRS1T
max_memory 16000 MB (current use 229 MB)
Set gradient conv threshold to 3.16228e-05
init E= -435.026501657096
  HOMO = -0.229502710287267  LUMO = 0.0871111512298419
cycle= 1 E= -435.108258772581  delta_E= -0.0818  |g|= 0.0172  |ddm|= 2.02
  HOMO = -0.205974874953489  LUMO = 0.14057360507467
cycle= 2 E= -435.10864849453  delta_E= -0.00039  |g|= 0.00554  |ddm|= 0.055
  HOMO = -0.205604540082947  LUMO = 0.139899841749296
cycle= 3 E= -435.108696816294  delta_E= -4.83e-05  |g|= 0.000492  |ddm|= 0.0258
  HOMO = -0.205540101099896  LUMO = 0.139844116971704
cycle= 4 E= -435.108697235932  delta_E= -4.2e-07  |g|= 5.33e-05  |ddm|= 0.0025
  HOMO = -0.205534038661541  LUMO = 0.139841725558632
cycle= 5 E= -435.108697239014  delta_E= -3.08e-09  |g|= 2.77e-06  |ddm|= 0.000216
  HOMO = -0.205534002931443  LUMO = 0.139841970435594
cycle= 6 E= -435.10869723902  delta_E= -6.37e-12  |g|= 2.4e-07  |ddm|= 9.29e-06
  HOMO = -0.205533998889572  LUMO = 0.13984198292436
Extra cycle  E= -435.10869723902  delta_E= -1.14e-13  |g|= 6.55e-08  |ddm|= 7.67e-07
converged SCF energy = -435.10869723902
e_mf =  -435.1086972390202
#INFO: **** input file is /tigress/xingz/pydmfet/examples/Be.py ****
from pydmfet import locints, sdmfet, oep, tools
from pyscf import gto, scf,dft, ao2mo,cc
import numpy as np
from pyscf.tools import molden, cubegen
import copy,time

DMguess  = None

bondlengths = np.arange(1.8, 4.1, 0.1)
energies = []

bas = 'sto-6g'

for bondlength in bondlengths:

    nat = 30
    mol = gto.Mole()
    mol.atom = []
    r = 0.5 * bondlength / np.sin(np.pi/nat)
    for i in range(nat):
        theta = i * (2*np.pi/nat)
        mol.atom.append(('Be', (r*np.cos(theta), r*np.sin(theta), 0)))

    mol.basis = bas
    mol.build(max_memory=16000, verbose=4)

    mf = scf.RHF(mol)
    #mf = dft.RKS(mol)
    #mf.xc = 'pbe,pbe'
    #mf.smear_sigma = 0.005
    mf.max_cycle = 50
    mf.scf()

    #P=mf.make_rdm1()
    #tools.MatPrint(P,"P_ref_ao")
    #cubegen.density(mol, "h20_dens.cube", P, nx=100, ny=100, nz=100)
    print 'e_mf = ',  mf.e_tot
    continue
    if ( True ):   
#        ENUCL = mf.mol.energy_nuc()
#        OEI   = np.dot(np.dot(mf.mo_coeff.T, mol.intor('cint1e_kin_sph') + mol.intor('cint1e_nuc_sph')), mf.mo_coeff)
#        TEI   = ao2mo.outcore.full_iofree(mol, mf.mo_coeff, compact=False).reshape(mol.nao_nr(), mol.nao_nr(), mol.nao_nr(), mol.nao_nr())
#        import chemps2
#        Energy, OneDM = chemps2.solve( ENUCL, OEI, OEI, TEI, mol.nao_nr(), mol.nelectron, mol.nao_nr(), 0.0, False )
#        print "bl =", bondlength," and energy =", Energy

        mycc = cc.CCSD(mf).run()
	et=0.0
        #et = mycc.ccsd_t()
        e_hf = mf.e_tot
        e_ccsd = e_hf + mycc.e_corr + et

        print 'e_tot = ', e_ccsd    #-4.96124910741
        
    else:
        myInts = locints.LocalIntegrals( mf, range( mol.nao_nr() ), 'meta_lowdin' )
        #myInts.loc_molden( 'hydrogen-loc.molden' )
        #myInts.TI_OK = True # Only s functions

	nbas =  mol.nao_nr()
	natoms = mol.natm

	impAtom = np.zeros([natoms], dtype=int)
	for i in range(20):
	    impAtom[i] = 1

	ghost_frag = 1-impAtom
	ghost_env = 1-ghost_frag

	mol_frag = gto.Mole()
	mol_frag.atom = tools.add_ghost(mol.atom, ghost_frag)
	mol_frag.basis = bas
	mol_frag.build(max_memory = 16000,verbose = 4)
	'''
	mf_frag = dft.RKS(mol_frag)
        mf_frag.xc = 'pbe,pbe'
        mf_frag.smear_sigma = 0.00
        mf_frag.scf()
        P_frag=mf_frag.make_rdm1()
        cubegen.density(mol_frag, "h10_dens_1.cube", P_frag, nx=100, ny=100, nz=100)
	'''

	mol_env = gto.Mole()
	mol_env.atom = tools.add_ghost(mol.atom, ghost_env)
	mol_env.basis =  bas
	mol_env.build(max_memory = 16000,verbose = 4)

	'''
	mf_env = dft.RKS(mol_env)
        mf_env.xc = 'pbe,pbe'
        mf_env.smear_sigma = 0.00
        mf_env.scf()
        P_env=mf_env.make_rdm1()
        cubegen.density(mol_env, "h10_dens_2.cube", P_env, nx=100, ny=100, nz=100)
	exit()
	'''



	aoslice = mol.aoslice_by_atom()
	impurities = np.zeros([nbas], dtype = int)
	for i in range(natoms):
	    if(impAtom[i] == 1):
		impurities[aoslice[i,2]:aoslice[i,3]] = 1

	Ne_frag = 20
	boundary_atoms = np.zeros((natoms))
	boundary_atoms[20:40] = 1.0
	#boundary_atoms[19] = -1
	boundary_atoms2 = np.zeros((natoms),dtype =int)
	#boundary_atoms2[9] = -1
	boundary_atoms2[0:20] = 1

	boundary_atoms = None
	boundary_atoms2 =None

	umat=None
	P_frag=None
	P_env=None
	params = oep.OEPparams(algorithm = '2011', opt_method = 'L-BFGS-B', \
                       ftol = 1e-11, gtol = 1e-5,diffP_tol=1e-5, outer_maxit = 200, maxit = 200,l2_lambda = 0.0, oep_print = 0)
	theDMFET = sdmfet.DMFET( mf, mol_frag, mol_env,myInts,impurities, impAtom, Ne_frag, boundary_atoms=boundary_atoms, boundary_atoms2=boundary_atoms2,\
                         umat = umat, P_frag_ao = P_frag, P_env_ao = P_env, \
                         dim_imp = nbas, dim_bath=nbas, dim_big =nbas, smear_sigma = 0.005, oep_params=params,ecw_method='hf', mf_method = mf.xc)

	umat = theDMFET.embedding_potential()

	exit()

	#write subspace orbitals
	transfo = np.dot( myInts.ao2loc, theDMFET.loc2sub )
	filename =  'hydrogen-sub.molden'
	with open( filename, 'w' ) as thefile:
            molden.header( myInts.mol, thefile )
            molden.orbital_coeff( myInts.mol, thefile, transfo )


        umat = theDMFET.embedding_potential()
	print umat
	exit()
	energy = theDMFET.correction_energy()

#INFO: ******************** input file end ********************


System: ('Linux', 'tigercpu.princeton.edu', '3.10.0-693.21.1.el7.x86_64', '#1 SMP Wed Mar 7 15:59:45 EST 2018', 'x86_64', 'x86_64')  Threads 40
Python 2.7.14 |Anaconda, Inc.| (default, Oct 16 2017, 17:29:19) 
[GCC 7.2.0]
numpy 1.14.3  scipy 1.1.0
Date: Thu Jun  7 01:17:32 2018
PySCF version 1.4.2
PySCF path  /tigress/xingz/pyscf/pyscf
GIT ORIG_HEAD e0edd131499dcc18d035a120533a8a1ddda110d4
GIT HEAD      e0edd131499dcc18d035a120533a8a1ddda110d4

[INPUT] VERBOSE 4
[INPUT] num atoms = 30
[INPUT] num electrons = 120
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT]  1 Be    18.176867243661   0.000000000000   0.000000000000 AA   34.349300893097   0.000000000000   0.000000000000 Bohr
[INPUT]  2 Be    17.779659083244   3.779183202399   0.000000000000 AA   33.598686255466   7.141621227092   0.000000000000 Bohr
[INPUT]  3 Be    16.605394504619   7.393197964321   0.000000000000 AA   31.379647804087  13.971119337259   0.000000000000 Bohr
[INPUT]  4 Be    14.705394504619  10.684094498702   0.000000000000 AA   27.789168167414  20.190012491519   0.000000000000 Bohr
[INPUT]  5 Be    12.162698200455  13.508044835516   0.000000000000 AA   22.984168534601  25.526505217471   0.000000000000 Bohr
[INPUT]  6 Be     9.088433621830  15.741628794227   0.000000000000 AA   17.174650446548  29.747367175657   0.000000000000 Bohr
[INPUT]  7 Be     5.616960882788  17.287228037915   0.000000000000 AA   10.614517720865  32.668126444562   0.000000000000 Bohr
[INPUT]  8 Be     1.900000000000  18.077292463023   0.000000000000 AA    3.590479636674  34.161131828777   0.000000000000 Bohr
[INPUT]  9 Be    -1.900000000000  18.077292463023   0.000000000000 AA   -3.590479636674  34.161131828778   0.000000000000 Bohr
[INPUT] 10 Be    -5.616960882788  17.287228037915   0.000000000000 AA  -10.614517720865  32.668126444562   0.000000000000 Bohr
[INPUT] 11 Be    -9.088433621830  15.741628794227   0.000000000000 AA  -17.174650446548  29.747367175657   0.000000000000 Bohr
[INPUT] 12 Be   -12.162698200455  13.508044835516   0.000000000000 AA  -22.984168534601  25.526505217471   0.000000000000 Bohr
[INPUT] 13 Be   -14.705394504619  10.684094498702   0.000000000000 AA  -27.789168167414  20.190012491519   0.000000000000 Bohr
[INPUT] 14 Be   -16.605394504619   7.393197964321   0.000000000000 AA  -31.379647804087  13.971119337259   0.000000000000 Bohr
[INPUT] 15 Be   -17.779659083244   3.779183202399   0.000000000000 AA  -33.598686255466   7.141621227092   0.000000000000 Bohr
[INPUT] 16 Be   -18.176867243661   0.000000000000   0.000000000000 AA  -34.349300893097   0.000000000000   0.000000000000 Bohr
[INPUT] 17 Be   -17.779659083244  -3.779183202399   0.000000000000 AA  -33.598686255466  -7.141621227092   0.000000000000 Bohr
[INPUT] 18 Be   -16.605394504619  -7.393197964321   0.000000000000 AA  -31.379647804087 -13.971119337259   0.000000000000 Bohr
[INPUT] 19 Be   -14.705394504619 -10.684094498702   0.000000000000 AA  -27.789168167414 -20.190012491519   0.000000000000 Bohr
[INPUT] 20 Be   -12.162698200455 -13.508044835516   0.000000000000 AA  -22.984168534601 -25.526505217471   0.000000000000 Bohr
[INPUT] 21 Be    -9.088433621830 -15.741628794227   0.000000000000 AA  -17.174650446548 -29.747367175657   0.000000000000 Bohr
[INPUT] 22 Be    -5.616960882788 -17.287228037915   0.000000000000 AA  -10.614517720865 -32.668126444562   0.000000000000 Bohr
[INPUT] 23 Be    -1.900000000000 -18.077292463023   0.000000000000 AA   -3.590479636674 -34.161131828777   0.000000000000 Bohr
[INPUT] 24 Be     1.900000000000 -18.077292463023   0.000000000000 AA    3.590479636674 -34.161131828778   0.000000000000 Bohr
[INPUT] 25 Be     5.616960882788 -17.287228037915   0.000000000000 AA   10.614517720865 -32.668126444562   0.000000000000 Bohr
[INPUT] 26 Be     9.088433621830 -15.741628794227   0.000000000000 AA   17.174650446548 -29.747367175657   0.000000000000 Bohr
[INPUT] 27 Be    12.162698200455 -13.508044835516   0.000000000000 AA   22.984168534601 -25.526505217471   0.000000000000 Bohr
[INPUT] 28 Be    14.705394504619 -10.684094498702   0.000000000000 AA   27.789168167414 -20.190012491519   0.000000000000 Bohr
[INPUT] 29 Be    16.605394504619  -7.393197964321   0.000000000000 AA   31.379647804087 -13.971119337259   0.000000000000 Bohr
[INPUT] 30 Be    17.779659083244  -3.779183202399   0.000000000000 AA   33.598686255466  -7.141621227092   0.000000000000 Bohr
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [6    /1   ]  312.8704937       0.00916359628
                                57.36446253       0.04936149294
                                16.0485094        0.1685383049
                                5.513096119       0.3705627997
                                2.140896553       0.4164915298
                                0.8817394283      0.1303340841
[INPUT] 0    0    [6    /1   ]  13.63324744       -0.01325278809
                                2.698375464       -0.04699171014
                                0.8386530829      -0.03378537151
                                0.3226600698      0.2502417861
                                0.1401314882      0.5951172526
                                0.0642325139      0.2407061763
[INPUT] 1    0    [6    /1   ]  13.63324744       0.0037596966
                                2.698375464       0.0376793698
                                0.8386530829      0.1738967435
                                0.3226600698      0.4180364347
                                0.1401314882      0.4258595477
                                0.0642325139      0.1017082955
nuclear repulsion = 235.304664525402
number of shells = 90
number of NR pGTOs = 900
number of NR cGTOs = 150
basis = sto-6g
ecp = {}
CPU time:      2045.94


******** <class 'pyscf.scf.hf.RHF'> flags ********
method = RHF
initial guess = minao
damping factor = 0
level shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
DIIS start cycle = 1
DIIS space = 8
SCF tol = 1e-09
SCF gradient tol = None
max. SCF cycles = 50
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /tigress/xingz/pydmfet/examples/tmp4kz4mv
max_memory 16000 MB (current use 229 MB)
Set gradient conv threshold to 3.16228e-05
init E= -434.954836837377
  HOMO = -0.237739537255133  LUMO = 0.0938130267125425
cycle= 1 E= -435.107331989753  delta_E= -0.152  |g|= 0.0128  |ddm|= 1.82
  HOMO = -0.212056153221245  LUMO = 0.147489975677342
cycle= 2 E= -435.107542034339  delta_E= -0.00021  |g|= 0.00388  |ddm|= 0.0403
  HOMO = -0.211864709271389  LUMO = 0.147041718771654
cycle= 3 E= -435.107564594559  delta_E= -2.26e-05  |g|= 0.000419  |ddm|= 0.0169
  HOMO = -0.211820453314037  LUMO = 0.14699496036625
cycle= 4 E= -435.107564871792  delta_E= -2.77e-07  |g|= 4.13e-05  |ddm|= 0.002
  HOMO = -0.211815934523384  LUMO = 0.146993264375365
cycle= 5 E= -435.107564873704  delta_E= -1.91e-09  |g|= 2.14e-06  |ddm|= 0.000166
  HOMO = -0.211815895496546  LUMO = 0.146993437270693
cycle= 6 E= -435.107564873707  delta_E= -3.41e-12  |g|= 1.61e-07  |ddm|= 6.84e-06
  HOMO = -0.211815892646338  LUMO = 0.146993445465817
Extra cycle  E= -435.107564873707  delta_E= 3.41e-13  |g|= 4.12e-08  |ddm|= 4.98e-07
converged SCF energy = -435.107564873707
e_mf =  -435.1075648737066
#INFO: **** input file is /tigress/xingz/pydmfet/examples/Be.py ****
from pydmfet import locints, sdmfet, oep, tools
from pyscf import gto, scf,dft, ao2mo,cc
import numpy as np
from pyscf.tools import molden, cubegen
import copy,time

DMguess  = None

bondlengths = np.arange(1.8, 4.1, 0.1)
energies = []

bas = 'sto-6g'

for bondlength in bondlengths:

    nat = 30
    mol = gto.Mole()
    mol.atom = []
    r = 0.5 * bondlength / np.sin(np.pi/nat)
    for i in range(nat):
        theta = i * (2*np.pi/nat)
        mol.atom.append(('Be', (r*np.cos(theta), r*np.sin(theta), 0)))

    mol.basis = bas
    mol.build(max_memory=16000, verbose=4)

    mf = scf.RHF(mol)
    #mf = dft.RKS(mol)
    #mf.xc = 'pbe,pbe'
    #mf.smear_sigma = 0.005
    mf.max_cycle = 50
    mf.scf()

    #P=mf.make_rdm1()
    #tools.MatPrint(P,"P_ref_ao")
    #cubegen.density(mol, "h20_dens.cube", P, nx=100, ny=100, nz=100)
    print 'e_mf = ',  mf.e_tot
    continue
    if ( True ):   
#        ENUCL = mf.mol.energy_nuc()
#        OEI   = np.dot(np.dot(mf.mo_coeff.T, mol.intor('cint1e_kin_sph') + mol.intor('cint1e_nuc_sph')), mf.mo_coeff)
#        TEI   = ao2mo.outcore.full_iofree(mol, mf.mo_coeff, compact=False).reshape(mol.nao_nr(), mol.nao_nr(), mol.nao_nr(), mol.nao_nr())
#        import chemps2
#        Energy, OneDM = chemps2.solve( ENUCL, OEI, OEI, TEI, mol.nao_nr(), mol.nelectron, mol.nao_nr(), 0.0, False )
#        print "bl =", bondlength," and energy =", Energy

        mycc = cc.CCSD(mf).run()
	et=0.0
        #et = mycc.ccsd_t()
        e_hf = mf.e_tot
        e_ccsd = e_hf + mycc.e_corr + et

        print 'e_tot = ', e_ccsd    #-4.96124910741
        
    else:
        myInts = locints.LocalIntegrals( mf, range( mol.nao_nr() ), 'meta_lowdin' )
        #myInts.loc_molden( 'hydrogen-loc.molden' )
        #myInts.TI_OK = True # Only s functions

	nbas =  mol.nao_nr()
	natoms = mol.natm

	impAtom = np.zeros([natoms], dtype=int)
	for i in range(20):
	    impAtom[i] = 1

	ghost_frag = 1-impAtom
	ghost_env = 1-ghost_frag

	mol_frag = gto.Mole()
	mol_frag.atom = tools.add_ghost(mol.atom, ghost_frag)
	mol_frag.basis = bas
	mol_frag.build(max_memory = 16000,verbose = 4)
	'''
	mf_frag = dft.RKS(mol_frag)
        mf_frag.xc = 'pbe,pbe'
        mf_frag.smear_sigma = 0.00
        mf_frag.scf()
        P_frag=mf_frag.make_rdm1()
        cubegen.density(mol_frag, "h10_dens_1.cube", P_frag, nx=100, ny=100, nz=100)
	'''

	mol_env = gto.Mole()
	mol_env.atom = tools.add_ghost(mol.atom, ghost_env)
	mol_env.basis =  bas
	mol_env.build(max_memory = 16000,verbose = 4)

	'''
	mf_env = dft.RKS(mol_env)
        mf_env.xc = 'pbe,pbe'
        mf_env.smear_sigma = 0.00
        mf_env.scf()
        P_env=mf_env.make_rdm1()
        cubegen.density(mol_env, "h10_dens_2.cube", P_env, nx=100, ny=100, nz=100)
	exit()
	'''



	aoslice = mol.aoslice_by_atom()
	impurities = np.zeros([nbas], dtype = int)
	for i in range(natoms):
	    if(impAtom[i] == 1):
		impurities[aoslice[i,2]:aoslice[i,3]] = 1

	Ne_frag = 20
	boundary_atoms = np.zeros((natoms))
	boundary_atoms[20:40] = 1.0
	#boundary_atoms[19] = -1
	boundary_atoms2 = np.zeros((natoms),dtype =int)
	#boundary_atoms2[9] = -1
	boundary_atoms2[0:20] = 1

	boundary_atoms = None
	boundary_atoms2 =None

	umat=None
	P_frag=None
	P_env=None
	params = oep.OEPparams(algorithm = '2011', opt_method = 'L-BFGS-B', \
                       ftol = 1e-11, gtol = 1e-5,diffP_tol=1e-5, outer_maxit = 200, maxit = 200,l2_lambda = 0.0, oep_print = 0)
	theDMFET = sdmfet.DMFET( mf, mol_frag, mol_env,myInts,impurities, impAtom, Ne_frag, boundary_atoms=boundary_atoms, boundary_atoms2=boundary_atoms2,\
                         umat = umat, P_frag_ao = P_frag, P_env_ao = P_env, \
                         dim_imp = nbas, dim_bath=nbas, dim_big =nbas, smear_sigma = 0.005, oep_params=params,ecw_method='hf', mf_method = mf.xc)

	umat = theDMFET.embedding_potential()

	exit()

	#write subspace orbitals
	transfo = np.dot( myInts.ao2loc, theDMFET.loc2sub )
	filename =  'hydrogen-sub.molden'
	with open( filename, 'w' ) as thefile:
            molden.header( myInts.mol, thefile )
            molden.orbital_coeff( myInts.mol, thefile, transfo )


        umat = theDMFET.embedding_potential()
	print umat
	exit()
	energy = theDMFET.correction_energy()

#INFO: ******************** input file end ********************


System: ('Linux', 'tigercpu.princeton.edu', '3.10.0-693.21.1.el7.x86_64', '#1 SMP Wed Mar 7 15:59:45 EST 2018', 'x86_64', 'x86_64')  Threads 40
Python 2.7.14 |Anaconda, Inc.| (default, Oct 16 2017, 17:29:19) 
[GCC 7.2.0]
numpy 1.14.3  scipy 1.1.0
Date: Thu Jun  7 01:17:33 2018
PySCF version 1.4.2
PySCF path  /tigress/xingz/pyscf/pyscf
GIT ORIG_HEAD e0edd131499dcc18d035a120533a8a1ddda110d4
GIT HEAD      e0edd131499dcc18d035a120533a8a1ddda110d4

[INPUT] VERBOSE 4
[INPUT] num atoms = 30
[INPUT] num electrons = 120
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT]  1 Be    18.655205855336   0.000000000000   0.000000000000 AA   35.253229863968   0.000000000000   0.000000000000 Bohr
[INPUT]  2 Be    18.247544848592   3.878635391936   0.000000000000 AA   34.482862209557   7.329558627805   0.000000000000 Bohr
[INPUT]  3 Be    17.042378570530   7.587755805487   0.000000000000 AA   32.205428009458  14.338780372450   0.000000000000 Bohr
[INPUT]  4 Be    15.092378570530  10.965254880247   0.000000000000 AA   28.520462066556  20.721328609717   0.000000000000 Bohr
[INPUT]  5 Be    12.482769205730  13.863519699609   0.000000000000 AA   23.589015074985  26.198255354773   0.000000000000 Bohr
[INPUT]  6 Be     9.327602927668  16.155882183549   0.000000000000 AA   17.626614931984  30.530192627648   0.000000000000 Bohr
[INPUT]  7 Be     5.764775642862  17.742155091545   0.000000000000 AA   10.893847134572  33.527813982577   0.000000000000 Bohr
[INPUT]  8 Be     1.950000000000  18.553010685734   0.000000000000 AA    3.684965942902  35.060108982166   0.000000000000 Bohr
[INPUT]  9 Be    -1.950000000000  18.553010685734   0.000000000000 AA   -3.684965942902  35.060108982166   0.000000000000 Bohr
[INPUT] 10 Be    -5.764775642862  17.742155091545   0.000000000000 AA  -10.893847134572  33.527813982577   0.000000000000 Bohr
[INPUT] 11 Be    -9.327602927668  16.155882183549   0.000000000000 AA  -17.626614931984  30.530192627648   0.000000000000 Bohr
[INPUT] 12 Be   -12.482769205730  13.863519699609   0.000000000000 AA  -23.589015074985  26.198255354773   0.000000000000 Bohr
[INPUT] 13 Be   -15.092378570530  10.965254880247   0.000000000000 AA  -28.520462066556  20.721328609717   0.000000000000 Bohr
[INPUT] 14 Be   -17.042378570530   7.587755805487   0.000000000000 AA  -32.205428009458  14.338780372450   0.000000000000 Bohr
[INPUT] 15 Be   -18.247544848592   3.878635391936   0.000000000000 AA  -34.482862209557   7.329558627805   0.000000000000 Bohr
[INPUT] 16 Be   -18.655205855336   0.000000000000   0.000000000000 AA  -35.253229863968   0.000000000000   0.000000000000 Bohr
[INPUT] 17 Be   -18.247544848592  -3.878635391936   0.000000000000 AA  -34.482862209557  -7.329558627805   0.000000000000 Bohr
[INPUT] 18 Be   -17.042378570530  -7.587755805487   0.000000000000 AA  -32.205428009458 -14.338780372450   0.000000000000 Bohr
[INPUT] 19 Be   -15.092378570530 -10.965254880247   0.000000000000 AA  -28.520462066556 -20.721328609717   0.000000000000 Bohr
[INPUT] 20 Be   -12.482769205730 -13.863519699609   0.000000000000 AA  -23.589015074985 -26.198255354773   0.000000000000 Bohr
[INPUT] 21 Be    -9.327602927668 -16.155882183549   0.000000000000 AA  -17.626614931984 -30.530192627648   0.000000000000 Bohr
[INPUT] 22 Be    -5.764775642862 -17.742155091545   0.000000000000 AA  -10.893847134572 -33.527813982577   0.000000000000 Bohr
[INPUT] 23 Be    -1.950000000000 -18.553010685734   0.000000000000 AA   -3.684965942902 -35.060108982166   0.000000000000 Bohr
[INPUT] 24 Be     1.950000000000 -18.553010685734   0.000000000000 AA    3.684965942902 -35.060108982166   0.000000000000 Bohr
[INPUT] 25 Be     5.764775642862 -17.742155091545   0.000000000000 AA   10.893847134572 -33.527813982577   0.000000000000 Bohr
[INPUT] 26 Be     9.327602927668 -16.155882183549   0.000000000000 AA   17.626614931984 -30.530192627648   0.000000000000 Bohr
[INPUT] 27 Be    12.482769205730 -13.863519699609   0.000000000000 AA   23.589015074985 -26.198255354773   0.000000000000 Bohr
[INPUT] 28 Be    15.092378570530 -10.965254880247   0.000000000000 AA   28.520462066556 -20.721328609717   0.000000000000 Bohr
[INPUT] 29 Be    17.042378570530  -7.587755805487   0.000000000000 AA   32.205428009458 -14.338780372450   0.000000000000 Bohr
[INPUT] 30 Be    18.247544848592  -3.878635391936   0.000000000000 AA   34.482862209557  -7.329558627805   0.000000000000 Bohr
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [6    /1   ]  312.8704937       0.00916359628
                                57.36446253       0.04936149294
                                16.0485094        0.1685383049
                                5.513096119       0.3705627997
                                2.140896553       0.4164915298
                                0.8817394283      0.1303340841
[INPUT] 0    0    [6    /1   ]  13.63324744       -0.01325278809
                                2.698375464       -0.04699171014
                                0.8386530829      -0.03378537151
                                0.3226600698      0.2502417861
                                0.1401314882      0.5951172526
                                0.0642325139      0.2407061763
[INPUT] 1    0    [6    /1   ]  13.63324744       0.0037596966
                                2.698375464       0.0376793698
                                0.8386530829      0.1738967435
                                0.3226600698      0.4180364347
                                0.1401314882      0.4258595477
                                0.0642325139      0.1017082955
nuclear repulsion = 229.271211588853
number of shells = 90
number of NR pGTOs = 900
number of NR cGTOs = 150
basis = sto-6g
ecp = {}
CPU time:      2088.34


******** <class 'pyscf.scf.hf.RHF'> flags ********
method = RHF
initial guess = minao
damping factor = 0
level shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
DIIS start cycle = 1
DIIS space = 8
SCF tol = 1e-09
SCF gradient tol = None
max. SCF cycles = 50
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /tigress/xingz/pydmfet/examples/tmp9E75RG
max_memory 16000 MB (current use 229 MB)
Set gradient conv threshold to 3.16228e-05
init E= -434.896183767631
  HOMO = -0.244961203418033  LUMO = 0.100285419559936
cycle= 1 E= -435.106453531771  delta_E= -0.21  |g|= 0.00946  |ddm|= 1.63
  HOMO = -0.217345528949198  LUMO = 0.15400168698882
cycle= 2 E= -435.106565137702  delta_E= -0.000112  |g|= 0.00268  |ddm|= 0.0294
  HOMO = -0.217270231841952  LUMO = 0.153713636011588
cycle= 3 E= -435.106575245854  delta_E= -1.01e-05  |g|= 0.000367  |ddm|= 0.0108
  HOMO = -0.217243043929941  LUMO = 0.153673660453278
cycle= 4 E= -435.106575428953  delta_E= -1.83e-07  |g|= 2.97e-05  |ddm|= 0.0016
  HOMO = -0.217239886761412  LUMO = 0.153672245097825
cycle= 5 E= -435.10657543002  delta_E= -1.07e-09  |g|= 1.63e-06  |ddm|= 0.000122
  HOMO = -0.217239831779591  LUMO = 0.153672343790004
cycle= 6 E= -435.106575430022  delta_E= -2.27e-12  |g|= 1.08e-07  |ddm|= 4.94e-06
  HOMO = -0.217239830027557  LUMO = 0.15367234864071
Extra cycle  E= -435.106575430022  delta_E= -3.41e-13  |g|= 2.62e-08  |ddm|= 3.32e-07
converged SCF energy = -435.106575430022
e_mf =  -435.10657543002213
#INFO: **** input file is /tigress/xingz/pydmfet/examples/Be.py ****
from pydmfet import locints, sdmfet, oep, tools
from pyscf import gto, scf,dft, ao2mo,cc
import numpy as np
from pyscf.tools import molden, cubegen
import copy,time

DMguess  = None

bondlengths = np.arange(1.8, 4.1, 0.1)
energies = []

bas = 'sto-6g'

for bondlength in bondlengths:

    nat = 30
    mol = gto.Mole()
    mol.atom = []
    r = 0.5 * bondlength / np.sin(np.pi/nat)
    for i in range(nat):
        theta = i * (2*np.pi/nat)
        mol.atom.append(('Be', (r*np.cos(theta), r*np.sin(theta), 0)))

    mol.basis = bas
    mol.build(max_memory=16000, verbose=4)

    mf = scf.RHF(mol)
    #mf = dft.RKS(mol)
    #mf.xc = 'pbe,pbe'
    #mf.smear_sigma = 0.005
    mf.max_cycle = 50
    mf.scf()

    #P=mf.make_rdm1()
    #tools.MatPrint(P,"P_ref_ao")
    #cubegen.density(mol, "h20_dens.cube", P, nx=100, ny=100, nz=100)
    print 'e_mf = ',  mf.e_tot
    continue
    if ( True ):   
#        ENUCL = mf.mol.energy_nuc()
#        OEI   = np.dot(np.dot(mf.mo_coeff.T, mol.intor('cint1e_kin_sph') + mol.intor('cint1e_nuc_sph')), mf.mo_coeff)
#        TEI   = ao2mo.outcore.full_iofree(mol, mf.mo_coeff, compact=False).reshape(mol.nao_nr(), mol.nao_nr(), mol.nao_nr(), mol.nao_nr())
#        import chemps2
#        Energy, OneDM = chemps2.solve( ENUCL, OEI, OEI, TEI, mol.nao_nr(), mol.nelectron, mol.nao_nr(), 0.0, False )
#        print "bl =", bondlength," and energy =", Energy

        mycc = cc.CCSD(mf).run()
	et=0.0
        #et = mycc.ccsd_t()
        e_hf = mf.e_tot
        e_ccsd = e_hf + mycc.e_corr + et

        print 'e_tot = ', e_ccsd    #-4.96124910741
        
    else:
        myInts = locints.LocalIntegrals( mf, range( mol.nao_nr() ), 'meta_lowdin' )
        #myInts.loc_molden( 'hydrogen-loc.molden' )
        #myInts.TI_OK = True # Only s functions

	nbas =  mol.nao_nr()
	natoms = mol.natm

	impAtom = np.zeros([natoms], dtype=int)
	for i in range(20):
	    impAtom[i] = 1

	ghost_frag = 1-impAtom
	ghost_env = 1-ghost_frag

	mol_frag = gto.Mole()
	mol_frag.atom = tools.add_ghost(mol.atom, ghost_frag)
	mol_frag.basis = bas
	mol_frag.build(max_memory = 16000,verbose = 4)
	'''
	mf_frag = dft.RKS(mol_frag)
        mf_frag.xc = 'pbe,pbe'
        mf_frag.smear_sigma = 0.00
        mf_frag.scf()
        P_frag=mf_frag.make_rdm1()
        cubegen.density(mol_frag, "h10_dens_1.cube", P_frag, nx=100, ny=100, nz=100)
	'''

	mol_env = gto.Mole()
	mol_env.atom = tools.add_ghost(mol.atom, ghost_env)
	mol_env.basis =  bas
	mol_env.build(max_memory = 16000,verbose = 4)

	'''
	mf_env = dft.RKS(mol_env)
        mf_env.xc = 'pbe,pbe'
        mf_env.smear_sigma = 0.00
        mf_env.scf()
        P_env=mf_env.make_rdm1()
        cubegen.density(mol_env, "h10_dens_2.cube", P_env, nx=100, ny=100, nz=100)
	exit()
	'''



	aoslice = mol.aoslice_by_atom()
	impurities = np.zeros([nbas], dtype = int)
	for i in range(natoms):
	    if(impAtom[i] == 1):
		impurities[aoslice[i,2]:aoslice[i,3]] = 1

	Ne_frag = 20
	boundary_atoms = np.zeros((natoms))
	boundary_atoms[20:40] = 1.0
	#boundary_atoms[19] = -1
	boundary_atoms2 = np.zeros((natoms),dtype =int)
	#boundary_atoms2[9] = -1
	boundary_atoms2[0:20] = 1

	boundary_atoms = None
	boundary_atoms2 =None

	umat=None
	P_frag=None
	P_env=None
	params = oep.OEPparams(algorithm = '2011', opt_method = 'L-BFGS-B', \
                       ftol = 1e-11, gtol = 1e-5,diffP_tol=1e-5, outer_maxit = 200, maxit = 200,l2_lambda = 0.0, oep_print = 0)
	theDMFET = sdmfet.DMFET( mf, mol_frag, mol_env,myInts,impurities, impAtom, Ne_frag, boundary_atoms=boundary_atoms, boundary_atoms2=boundary_atoms2,\
                         umat = umat, P_frag_ao = P_frag, P_env_ao = P_env, \
                         dim_imp = nbas, dim_bath=nbas, dim_big =nbas, smear_sigma = 0.005, oep_params=params,ecw_method='hf', mf_method = mf.xc)

	umat = theDMFET.embedding_potential()

	exit()

	#write subspace orbitals
	transfo = np.dot( myInts.ao2loc, theDMFET.loc2sub )
	filename =  'hydrogen-sub.molden'
	with open( filename, 'w' ) as thefile:
            molden.header( myInts.mol, thefile )
            molden.orbital_coeff( myInts.mol, thefile, transfo )


        umat = theDMFET.embedding_potential()
	print umat
	exit()
	energy = theDMFET.correction_energy()

#INFO: ******************** input file end ********************


System: ('Linux', 'tigercpu.princeton.edu', '3.10.0-693.21.1.el7.x86_64', '#1 SMP Wed Mar 7 15:59:45 EST 2018', 'x86_64', 'x86_64')  Threads 40
Python 2.7.14 |Anaconda, Inc.| (default, Oct 16 2017, 17:29:19) 
[GCC 7.2.0]
numpy 1.14.3  scipy 1.1.0
Date: Thu Jun  7 01:17:34 2018
PySCF version 1.4.2
PySCF path  /tigress/xingz/pyscf/pyscf
GIT ORIG_HEAD e0edd131499dcc18d035a120533a8a1ddda110d4
GIT HEAD      e0edd131499dcc18d035a120533a8a1ddda110d4

[INPUT] VERBOSE 4
[INPUT] num atoms = 30
[INPUT] num electrons = 120
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT]  1 Be    19.133544467011   0.000000000000   0.000000000000 AA   36.157158834838   0.000000000000   0.000000000000 Bohr
[INPUT]  2 Be    18.715430613941   3.978087581473   0.000000000000 AA   35.367038163648   7.517496028518   0.000000000000 Bohr
[INPUT]  3 Be    17.479362636441   7.782313646654   0.000000000000 AA   33.031208214829  14.706441407641   0.000000000000 Bohr
[INPUT]  4 Be    15.479362636441  11.246415261791   0.000000000000 AA   29.251755965699  21.252644727915   0.000000000000 Bohr
[INPUT]  5 Be    12.802840211005  14.218994563701   0.000000000000 AA   24.193861615369  26.870005492074   0.000000000000 Bohr
[INPUT]  6 Be     9.566772233506  16.570135572871   0.000000000000 AA   18.078579417419  31.313018079639   0.000000000000 Bohr
[INPUT]  7 Be     5.912590402935  18.197082145174   0.000000000000 AA   11.173176548279  34.387501520592   0.000000000000 Bohr
[INPUT]  8 Be     2.000000000000  19.028728908445   0.000000000000 AA    3.779452249130  35.959086135555   0.000000000000 Bohr
[INPUT]  9 Be    -2.000000000000  19.028728908445   0.000000000000 AA   -3.779452249130  35.959086135555   0.000000000000 Bohr
[INPUT] 10 Be    -5.912590402935  18.197082145174   0.000000000000 AA  -11.173176548279  34.387501520592   0.000000000000 Bohr
[INPUT] 11 Be    -9.566772233506  16.570135572871   0.000000000000 AA  -18.078579417419  31.313018079639   0.000000000000 Bohr
[INPUT] 12 Be   -12.802840211005  14.218994563701   0.000000000000 AA  -24.193861615369  26.870005492074   0.000000000000 Bohr
[INPUT] 13 Be   -15.479362636441  11.246415261791   0.000000000000 AA  -29.251755965699  21.252644727915   0.000000000000 Bohr
[INPUT] 14 Be   -17.479362636441   7.782313646654   0.000000000000 AA  -33.031208214829  14.706441407641   0.000000000000 Bohr
[INPUT] 15 Be   -18.715430613941   3.978087581473   0.000000000000 AA  -35.367038163648   7.517496028518   0.000000000000 Bohr
[INPUT] 16 Be   -19.133544467011   0.000000000000   0.000000000000 AA  -36.157158834838   0.000000000000   0.000000000000 Bohr
[INPUT] 17 Be   -18.715430613941  -3.978087581473   0.000000000000 AA  -35.367038163648  -7.517496028518   0.000000000000 Bohr
[INPUT] 18 Be   -17.479362636441  -7.782313646654   0.000000000000 AA  -33.031208214829 -14.706441407641   0.000000000000 Bohr
[INPUT] 19 Be   -15.479362636441 -11.246415261791   0.000000000000 AA  -29.251755965699 -21.252644727915   0.000000000000 Bohr
[INPUT] 20 Be   -12.802840211005 -14.218994563701   0.000000000000 AA  -24.193861615369 -26.870005492074   0.000000000000 Bohr
[INPUT] 21 Be    -9.566772233506 -16.570135572871   0.000000000000 AA  -18.078579417419 -31.313018079639   0.000000000000 Bohr
[INPUT] 22 Be    -5.912590402935 -18.197082145174   0.000000000000 AA  -11.173176548279 -34.387501520592   0.000000000000 Bohr
[INPUT] 23 Be    -2.000000000000 -19.028728908445   0.000000000000 AA   -3.779452249130 -35.959086135555   0.000000000000 Bohr
[INPUT] 24 Be     2.000000000000 -19.028728908445   0.000000000000 AA    3.779452249130 -35.959086135555   0.000000000000 Bohr
[INPUT] 25 Be     5.912590402935 -18.197082145174   0.000000000000 AA   11.173176548279 -34.387501520592   0.000000000000 Bohr
[INPUT] 26 Be     9.566772233506 -16.570135572871   0.000000000000 AA   18.078579417419 -31.313018079639   0.000000000000 Bohr
[INPUT] 27 Be    12.802840211005 -14.218994563701   0.000000000000 AA   24.193861615369 -26.870005492074   0.000000000000 Bohr
[INPUT] 28 Be    15.479362636441 -11.246415261791   0.000000000000 AA   29.251755965699 -21.252644727915   0.000000000000 Bohr
[INPUT] 29 Be    17.479362636441  -7.782313646654   0.000000000000 AA   33.031208214829 -14.706441407641   0.000000000000 Bohr
[INPUT] 30 Be    18.715430613941  -3.978087581473   0.000000000000 AA   35.367038163648  -7.517496028518   0.000000000000 Bohr
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [6    /1   ]  312.8704937       0.00916359628
                                57.36446253       0.04936149294
                                16.0485094        0.1685383049
                                5.513096119       0.3705627997
                                2.140896553       0.4164915298
                                0.8817394283      0.1303340841
[INPUT] 0    0    [6    /1   ]  13.63324744       -0.01325278809
                                2.698375464       -0.04699171014
                                0.8386530829      -0.03378537151
                                0.3226600698      0.2502417861
                                0.1401314882      0.5951172526
                                0.0642325139      0.2407061763
[INPUT] 1    0    [6    /1   ]  13.63324744       0.0037596966
                                2.698375464       0.0376793698
                                0.8386530829      0.1738967435
                                0.3226600698      0.4180364347
                                0.1401314882      0.4258595477
                                0.0642325139      0.1017082955
nuclear repulsion = 223.539431299132
number of shells = 90
number of NR pGTOs = 900
number of NR cGTOs = 150
basis = sto-6g
ecp = {}
CPU time:      2131.03


******** <class 'pyscf.scf.hf.RHF'> flags ********
method = RHF
initial guess = minao
damping factor = 0
level shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
DIIS start cycle = 1
DIIS space = 8
SCF tol = 1e-09
SCF gradient tol = None
max. SCF cycles = 50
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /tigress/xingz/pydmfet/examples/tmp0GOmvm
max_memory 16000 MB (current use 229 MB)
Set gradient conv threshold to 3.16228e-05
init E= -434.848363141537
  HOMO = -0.251271398551384  LUMO = 0.106496798304081
cycle= 1 E= -435.105639783269  delta_E= -0.257  |g|= 0.00714  |ddm|= 1.47
  HOMO = -0.221947294490437  LUMO = 0.160110932636294
cycle= 2 E= -435.105701326686  delta_E= -6.15e-05  |g|= 0.00189  |ddm|= 0.0219
  HOMO = -0.221943875555573  LUMO = 0.159932681264837
cycle= 3 E= -435.105705905508  delta_E= -4.58e-06  |g|= 0.000321  |ddm|= 0.00691
  HOMO = -0.221932567174276  LUMO = 0.159901000660553
cycle= 4 E= -435.105706016558  delta_E= -1.11e-07  |g|= 1.78e-05  |ddm|= 0.00122
  HOMO = -0.221930754313322  LUMO = 0.159899840872431
cycle= 5 E= -435.105706016993  delta_E= -4.35e-10  |g|= 1.3e-06  |ddm|= 7.66e-05
  HOMO = -0.221930691699033  LUMO = 0.159899860074626
Extra cycle  E= -435.105706016996  delta_E= -2.27e-12  |g|= 3.4e-07  |ddm|= 3.26e-06
converged SCF energy = -435.105706016996
e_mf =  -435.10570601699555
