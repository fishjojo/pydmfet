/usr/licensed/anaconda/5.0.1/lib/python2.7/site-packages/h5py/__init__.py:34: FutureWarning: Conversion of the second argument of issubdtype from `float` to `np.floating` is deprecated. In future, it will be treated as `np.float64 == np.dtype(float).type`.
  from ._conv import register_converters as _register_converters
#INFO: **** input file is /tigress/xingz/pydmfet/examples/Be.py ****
from pydmfet import locints, sdmfet, oep, tools
from pyscf import gto, scf,dft, ao2mo,cc
import numpy as np
from pyscf.tools import molden, cubegen
import copy,time

DMguess  = None

bondlengths = np.arange(1.8, 4.1, 0.1)
energies = []

bas = 'sto-6g'

for bondlength in bondlengths:

    nat = 30
    mol = gto.Mole()
    mol.atom = []
    r = 0.5 * bondlength / np.sin(np.pi/nat)
    for i in range(nat):
        theta = i * (2*np.pi/nat)
        mol.atom.append(('Be', (r*np.cos(theta), r*np.sin(theta), 0)))

    mol.basis = bas
    mol.build(max_memory=16000, verbose=4)

    #mf = scf.RHF(mol)
    mf = dft.RKS(mol)
    mf.xc = 'pbe,pbe'
    mf.smear_sigma = 0.005
    mf.max_cycle = 100
    mf.scf()

    #P=mf.make_rdm1()
    #tools.MatPrint(P,"P_ref_ao")
    #cubegen.density(mol, "h20_dens.cube", P, nx=100, ny=100, nz=100)
    print 'e_mf = ',  mf.e_tot
    continue
    if ( True ):   
#        ENUCL = mf.mol.energy_nuc()
#        OEI   = np.dot(np.dot(mf.mo_coeff.T, mol.intor('cint1e_kin_sph') + mol.intor('cint1e_nuc_sph')), mf.mo_coeff)
#        TEI   = ao2mo.outcore.full_iofree(mol, mf.mo_coeff, compact=False).reshape(mol.nao_nr(), mol.nao_nr(), mol.nao_nr(), mol.nao_nr())
#        import chemps2
#        Energy, OneDM = chemps2.solve( ENUCL, OEI, OEI, TEI, mol.nao_nr(), mol.nelectron, mol.nao_nr(), 0.0, False )
#        print "bl =", bondlength," and energy =", Energy

        mycc = cc.CCSD(mf).run()
	et=0.0
        #et = mycc.ccsd_t()
        e_hf = mf.e_tot
        e_ccsd = e_hf + mycc.e_corr + et

        print 'e_tot = ', e_ccsd    #-4.96124910741
        
    else:
        myInts = locints.LocalIntegrals( mf, range( mol.nao_nr() ), 'meta_lowdin' )
        #myInts.loc_molden( 'hydrogen-loc.molden' )
        #myInts.TI_OK = True # Only s functions

	nbas =  mol.nao_nr()
	natoms = mol.natm

	impAtom = np.zeros([natoms], dtype=int)
	for i in range(20):
	    impAtom[i] = 1

	ghost_frag = 1-impAtom
	ghost_env = 1-ghost_frag

	mol_frag = gto.Mole()
	mol_frag.atom = tools.add_ghost(mol.atom, ghost_frag)
	mol_frag.basis = bas
	mol_frag.build(max_memory = 16000,verbose = 4)
	'''
	mf_frag = dft.RKS(mol_frag)
        mf_frag.xc = 'pbe,pbe'
        mf_frag.smear_sigma = 0.00
        mf_frag.scf()
        P_frag=mf_frag.make_rdm1()
        cubegen.density(mol_frag, "h10_dens_1.cube", P_frag, nx=100, ny=100, nz=100)
	'''

	mol_env = gto.Mole()
	mol_env.atom = tools.add_ghost(mol.atom, ghost_env)
	mol_env.basis =  bas
	mol_env.build(max_memory = 16000,verbose = 4)

	'''
	mf_env = dft.RKS(mol_env)
        mf_env.xc = 'pbe,pbe'
        mf_env.smear_sigma = 0.00
        mf_env.scf()
        P_env=mf_env.make_rdm1()
        cubegen.density(mol_env, "h10_dens_2.cube", P_env, nx=100, ny=100, nz=100)
	exit()
	'''



	aoslice = mol.aoslice_by_atom()
	impurities = np.zeros([nbas], dtype = int)
	for i in range(natoms):
	    if(impAtom[i] == 1):
		impurities[aoslice[i,2]:aoslice[i,3]] = 1

	Ne_frag = 20
	boundary_atoms = np.zeros((natoms))
	boundary_atoms[20:40] = 1.0
	#boundary_atoms[19] = -1
	boundary_atoms2 = np.zeros((natoms),dtype =int)
	#boundary_atoms2[9] = -1
	boundary_atoms2[0:20] = 1

	boundary_atoms = None
	boundary_atoms2 =None

	umat=None
	P_frag=None
	P_env=None
	params = oep.OEPparams(algorithm = '2011', opt_method = 'L-BFGS-B', \
                       ftol = 1e-11, gtol = 1e-5,diffP_tol=1e-5, outer_maxit = 200, maxit = 200,l2_lambda = 0.0, oep_print = 0)
	theDMFET = sdmfet.DMFET( mf, mol_frag, mol_env,myInts,impurities, impAtom, Ne_frag, boundary_atoms=boundary_atoms, boundary_atoms2=boundary_atoms2,\
                         umat = umat, P_frag_ao = P_frag, P_env_ao = P_env, \
                         dim_imp = nbas, dim_bath=nbas, dim_big =nbas, smear_sigma = 0.005, oep_params=params,ecw_method='hf', mf_method = mf.xc)

	umat = theDMFET.embedding_potential()

	exit()

	#write subspace orbitals
	transfo = np.dot( myInts.ao2loc, theDMFET.loc2sub )
	filename =  'hydrogen-sub.molden'
	with open( filename, 'w' ) as thefile:
            molden.header( myInts.mol, thefile )
            molden.orbital_coeff( myInts.mol, thefile, transfo )


        umat = theDMFET.embedding_potential()
	print umat
	exit()
	energy = theDMFET.correction_energy()

#INFO: ******************** input file end ********************


System: ('Linux', 'tigercpu.princeton.edu', '3.10.0-693.21.1.el7.x86_64', '#1 SMP Wed Mar 7 15:59:45 EST 2018', 'x86_64', 'x86_64')  Threads 40
Python 2.7.14 |Anaconda, Inc.| (default, Oct 16 2017, 17:29:19) 
[GCC 7.2.0]
numpy 1.14.3  scipy 1.1.0
Date: Thu Jun  7 01:35:34 2018
PySCF version 1.4.2
PySCF path  /tigress/xingz/pyscf/pyscf
GIT ORIG_HEAD e0edd131499dcc18d035a120533a8a1ddda110d4
GIT HEAD      e0edd131499dcc18d035a120533a8a1ddda110d4

[INPUT] VERBOSE 4
[INPUT] num atoms = 30
[INPUT] num electrons = 120
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT]  1 Be     8.610095010155   0.000000000000   0.000000000000 AA   16.270721475677   0.000000000000   0.000000000000 Bohr
[INPUT]  2 Be     8.421943776273   1.790139411663   0.000000000000 AA   15.915167173642   3.382873212833   0.000000000000 Bohr
[INPUT]  3 Be     7.865713186398   3.502041140994   0.000000000000 AA   14.864043696673   6.617898633438   0.000000000000 Bohr
[INPUT]  4 Be     6.965713186398   5.060886867806   0.000000000000 AA   13.163290184564   9.563690127562   0.000000000000 Bohr
[INPUT]  5 Be     5.761278094952   6.398547553665   0.000000000000 AA   10.887237726916  12.091502471434   0.000000000000 Bohr
[INPUT]  6 Be     4.305047505078   7.456561007792   0.000000000000 AA    8.135360737839  14.090858135838   0.000000000000 Bohr
[INPUT]  7 Be     2.660665681321   8.188686965328   0.000000000000 AA    5.027929446726  15.474375684266   0.000000000000 Bohr
[INPUT]  8 Be     0.900000000000   8.562928008800   0.000000000000 AA    1.700753512109  16.181588761000   0.000000000000 Bohr
[INPUT]  9 Be    -0.900000000000   8.562928008800   0.000000000000 AA   -1.700753512109  16.181588761000   0.000000000000 Bohr
[INPUT] 10 Be    -2.660665681321   8.188686965328   0.000000000000 AA   -5.027929446726  15.474375684266   0.000000000000 Bohr
[INPUT] 11 Be    -4.305047505078   7.456561007792   0.000000000000 AA   -8.135360737839  14.090858135838   0.000000000000 Bohr
[INPUT] 12 Be    -5.761278094952   6.398547553665   0.000000000000 AA  -10.887237726916  12.091502471434   0.000000000000 Bohr
[INPUT] 13 Be    -6.965713186398   5.060886867806   0.000000000000 AA  -13.163290184564   9.563690127562   0.000000000000 Bohr
[INPUT] 14 Be    -7.865713186398   3.502041140994   0.000000000000 AA  -14.864043696673   6.617898633438   0.000000000000 Bohr
[INPUT] 15 Be    -8.421943776273   1.790139411663   0.000000000000 AA  -15.915167173642   3.382873212833   0.000000000000 Bohr
[INPUT] 16 Be    -8.610095010155   0.000000000000   0.000000000000 AA  -16.270721475677   0.000000000000   0.000000000000 Bohr
[INPUT] 17 Be    -8.421943776273  -1.790139411663   0.000000000000 AA  -15.915167173642  -3.382873212833   0.000000000000 Bohr
[INPUT] 18 Be    -7.865713186398  -3.502041140994   0.000000000000 AA  -14.864043696673  -6.617898633438   0.000000000000 Bohr
[INPUT] 19 Be    -6.965713186398  -5.060886867806   0.000000000000 AA  -13.163290184564  -9.563690127562   0.000000000000 Bohr
[INPUT] 20 Be    -5.761278094952  -6.398547553665   0.000000000000 AA  -10.887237726916 -12.091502471434   0.000000000000 Bohr
[INPUT] 21 Be    -4.305047505078  -7.456561007792   0.000000000000 AA   -8.135360737839 -14.090858135838   0.000000000000 Bohr
[INPUT] 22 Be    -2.660665681321  -8.188686965328   0.000000000000 AA   -5.027929446726 -15.474375684266   0.000000000000 Bohr
[INPUT] 23 Be    -0.900000000000  -8.562928008800   0.000000000000 AA   -1.700753512109 -16.181588761000   0.000000000000 Bohr
[INPUT] 24 Be     0.900000000000  -8.562928008800   0.000000000000 AA    1.700753512109 -16.181588761000   0.000000000000 Bohr
[INPUT] 25 Be     2.660665681321  -8.188686965328   0.000000000000 AA    5.027929446726 -15.474375684266   0.000000000000 Bohr
[INPUT] 26 Be     4.305047505078  -7.456561007792   0.000000000000 AA    8.135360737839 -14.090858135838   0.000000000000 Bohr
[INPUT] 27 Be     5.761278094952  -6.398547553665   0.000000000000 AA   10.887237726916 -12.091502471434   0.000000000000 Bohr
[INPUT] 28 Be     6.965713186398  -5.060886867806   0.000000000000 AA   13.163290184564  -9.563690127562   0.000000000000 Bohr
[INPUT] 29 Be     7.865713186398  -3.502041140994   0.000000000000 AA   14.864043696673  -6.617898633438   0.000000000000 Bohr
[INPUT] 30 Be     8.421943776273  -1.790139411663   0.000000000000 AA   15.915167173642  -3.382873212833   0.000000000000 Bohr
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [6    /1   ]  312.8704937       0.00916359628
                                57.36446253       0.04936149294
                                16.0485094        0.1685383049
                                5.513096119       0.3705627997
                                2.140896553       0.4164915298
                                0.8817394283      0.1303340841
[INPUT] 0    0    [6    /1   ]  13.63324744       -0.01325278809
                                2.698375464       -0.04699171014
                                0.8386530829      -0.03378537151
                                0.3226600698      0.2502417861
                                0.1401314882      0.5951172526
                                0.0642325139      0.2407061763
[INPUT] 1    0    [6    /1   ]  13.63324744       0.0037596966
                                2.698375464       0.0376793698
                                0.8386530829      0.1738967435
                                0.3226600698      0.4180364347
                                0.1401314882      0.4258595477
                                0.0642325139      0.1017082955
nuclear repulsion = 496.754291775849
number of shells = 90
number of NR pGTOs = 900
number of NR cGTOs = 150
basis = sto-6g
ecp = {}
CPU time:         3.30


******** <class 'pyscf.dft.rks.RKS'> flags ********
method = RKS
initial guess = minao
damping factor = 0
level shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
DIIS start cycle = 1
DIIS space = 8
SCF tol = 1e-09
SCF gradient tol = None
max. SCF cycles = 100
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /tigress/xingz/pydmfet/examples/tmplrMT97
max_memory 16000 MB (current use 63 MB)
XC functionals = pbe,pbe
small_rho_cutoff = 1e-07
radial grids: Treutler-Ahlrichs (JCP 102, 346 (M4)) radial grids
becke partition: Becke, JCP, 88, 2547 (1988)
pruning grids: <function nwchem_prune at 0x2aac1c760cf8>
grids dens level: 3
symmetrized grids: False
atomic radii adjust function: <function treutler_atomic_radii_adjust at 0x2aac1c760b18>
Set gradient conv threshold to 3.16228e-05
tot grids = 393300
init E= -442.109148390104
HOMO: -0.21945193341876365 LUMO: -0.20753343663267648
-0.21545469424613176
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    1.999 1.999 1.982 1.982 1.865 1.865 1.562 1.562 1.38
 0.34  0.296 0.235 0.235 0.203 0.203 0.07  0.07  0.06  0.06  0.008 0.008
 0.007 0.007]
entropy corr =  -0.05221621098730845
cycle= 1 E= -438.494764936467  delta_E= 3.61  |g|= 0.105  |ddm|= 8.61
HOMO: -0.07224223518484528 LUMO: -0.07224221649391042
-0.0729074643057876
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 1.990e+00 1.990e+00 1.815e+00 1.815e+00 1.182e+00
 1.152e+00 9.585e-01 9.583e-01 9.336e-01 9.336e-01 9.216e-01 9.215e-01
 3.822e-01 3.822e-01 3.489e-01 3.489e-01 3.011e-01 3.010e-01 1.837e-01
 4.730e-02 4.729e-02 3.980e-02 3.980e-02 1.949e-03 1.949e-03 1.490e-03
 1.490e-03]
entropy corr =  -0.09691518865908126
cycle= 2 E= -438.523399376491  delta_E= -0.0286  |g|=  0.1  |ddm|= 2.28
HOMO: -0.08842544916883427 LUMO: -0.08840694168978468
-0.08997045077041209
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 1.992e+00 1.992e+00 1.870e+00 1.870e+00 1.159e+00
 1.159e+00 1.069e+00 1.023e+00 8.467e-01 8.449e-01 8.006e-01 7.989e-01
 4.558e-01 4.543e-01 3.189e-01 3.189e-01 2.929e-01 2.912e-01 2.912e-01
 3.869e-02 3.869e-02 3.395e-02 3.395e-02 1.620e-03 1.620e-03 1.355e-03
 1.355e-03]
entropy corr =  -0.09571871424155166
cycle= 3 E= -438.56168781247  delta_E= -0.0383  |g|= 0.0153  |ddm|= 0.529
HOMO: -0.09685709108159603 LUMO: -0.09654033930526108
-0.09942517481026757
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 1.994e+00 1.994e+00 1.908e+00 1.908e+00 1.348e+00
 1.347e+00 9.438e-01 9.143e-01 7.487e-01 7.193e-01 7.050e-01 6.764e-01
 6.466e-01 6.010e-01 4.202e-01 2.594e-01 2.589e-01 2.425e-01 2.420e-01
 3.095e-02 3.095e-02 2.791e-02 2.791e-02 1.318e-03 1.318e-03 1.131e-03
 1.131e-03]
entropy corr =  -0.0925353299843274
cycle= 4 E= -438.56099497535  delta_E= 0.000693  |g|= 0.0497  |ddm|= 0.337
HOMO: -0.09676702843566469 LUMO: -0.09645211980760358
-0.09938359619865007
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 1.994e+00 1.994e+00 1.908e+00 1.908e+00 1.347e+00
 1.346e+00 9.440e-01 9.146e-01 7.442e-01 7.150e-01 7.105e-01 6.820e-01
 6.406e-01 6.053e-01 4.199e-01 2.597e-01 2.593e-01 2.429e-01 2.425e-01
 3.099e-02 3.099e-02 2.796e-02 2.795e-02 1.319e-03 1.319e-03 1.133e-03
 1.133e-03]
entropy corr =  -0.09257188558042505
cycle= 5 E= -438.561932443416  delta_E= -0.000937  |g|= 0.0385  |ddm|= 0.117
HOMO: -0.09540487628518818 LUMO: -0.09539224044386735
-0.09800691182652743
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 1.994e+00 1.994e+00 1.902e+00 1.902e+00 1.319e+00
 1.317e+00 9.626e-01 9.344e-01 7.455e-01 7.443e-01 7.174e-01 7.163e-01
 5.944e-01 5.932e-01 3.974e-01 2.686e-01 2.677e-01 2.518e-01 2.509e-01
 3.209e-02 3.209e-02 2.902e-02 2.902e-02 1.363e-03 1.363e-03 1.173e-03
 1.173e-03]
entropy corr =  -0.09321951682422219
cycle= 6 E= -438.563378629325  delta_E= -0.00145  |g|= 0.00193  |ddm|= 0.0729
HOMO: -0.0953974412224129 LUMO: -0.09538552664222866
-0.09799833474582982
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 1.994e+00 1.994e+00 1.902e+00 1.902e+00 1.319e+00
 1.316e+00 9.627e-01 9.345e-01 7.456e-01 7.445e-01 7.175e-01 7.164e-01
 5.942e-01 5.931e-01 3.973e-01 2.689e-01 2.675e-01 2.521e-01 2.508e-01
 3.210e-02 3.210e-02 2.903e-02 2.902e-02 1.363e-03 1.363e-03 1.174e-03
 1.174e-03]
entropy corr =  -0.09322346397204014
cycle= 7 E= -438.563377205305  delta_E= 1.42e-06  |g|= 0.00242  |ddm|= 0.00492
HOMO: -0.09536220575610928 LUMO: -0.09535506001529165
-0.09795848882662134
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 1.994e+00 1.994e+00 1.902e+00 1.902e+00 1.317e+00
 1.317e+00 9.634e-01 9.350e-01 7.461e-01 7.454e-01 7.177e-01 7.171e-01
 5.931e-01 5.924e-01 3.966e-01 2.685e-01 2.685e-01 2.516e-01 2.516e-01
 3.214e-02 3.214e-02 2.905e-02 2.905e-02 1.365e-03 1.365e-03 1.175e-03
 1.175e-03]
entropy corr =  -0.09324193417844333
cycle= 8 E= -438.563381201669  delta_E= -4e-06  |g|= 0.000766  |ddm|= 0.00345
HOMO: -0.0953595712702173 LUMO: -0.09535552613078611
-0.09795726781452077
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 1.994e+00 1.994e+00 1.902e+00 1.902e+00 1.317e+00
 1.317e+00 9.634e-01 9.350e-01 7.459e-01 7.455e-01 7.176e-01 7.172e-01
 5.929e-01 5.925e-01 3.966e-01 2.685e-01 2.685e-01 2.517e-01 2.517e-01
 3.214e-02 3.213e-02 2.906e-02 2.905e-02 1.365e-03 1.365e-03 1.175e-03
 1.175e-03]
entropy corr =  -0.09324249667593183
cycle= 9 E= -438.563381538475  delta_E= -3.37e-07  |g|= 0.000464  |ddm|= 0.000504
HOMO: -0.09535924116830538 LUMO: -0.09535560971293974
-0.0979571289895518
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 1.994e+00 1.994e+00 1.902e+00 1.902e+00 1.317e+00
 1.317e+00 9.635e-01 9.350e-01 7.459e-01 7.456e-01 7.176e-01 7.173e-01
 5.929e-01 5.925e-01 3.966e-01 2.685e-01 2.685e-01 2.517e-01 2.517e-01
 3.214e-02 3.213e-02 2.906e-02 2.905e-02 1.365e-03 1.365e-03 1.175e-03
 1.175e-03]
entropy corr =  -0.09324255958531255
cycle= 10 E= -438.563381585382  delta_E= -4.69e-08  |g|= 0.000412  |ddm|= 0.000413
HOMO: -0.09535917892949891 LUMO: -0.09535686632944283
-0.0979578390975711
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 1.994e+00 1.994e+00 1.902e+00 1.902e+00 1.317e+00
 1.317e+00 9.634e-01 9.350e-01 7.458e-01 7.456e-01 7.175e-01 7.173e-01
 5.928e-01 5.926e-01 3.966e-01 2.685e-01 2.685e-01 2.517e-01 2.516e-01
 3.214e-02 3.214e-02 2.905e-02 2.905e-02 1.365e-03 1.365e-03 1.175e-03
 1.175e-03]
entropy corr =  -0.09324227701259641
cycle= 11 E= -438.563381695814  delta_E= -1.1e-07  |g|= 0.000246  |ddm|= 0.000274
HOMO: -0.09535861937119108 LUMO: -0.09535681946070253
-0.0979574735795661
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 1.994e+00 1.994e+00 1.902e+00 1.902e+00 1.317e+00
 1.317e+00 9.634e-01 9.350e-01 7.458e-01 7.456e-01 7.175e-01 7.173e-01
 5.928e-01 5.926e-01 3.966e-01 2.685e-01 2.685e-01 2.517e-01 2.517e-01
 3.214e-02 3.214e-02 2.905e-02 2.905e-02 1.365e-03 1.365e-03 1.175e-03
 1.175e-03]
entropy corr =  -0.09324239378584923
cycle= 12 E= -438.563381717815  delta_E= -2.2e-08  |g|= 0.000193  |ddm|= 7.64e-05
HOMO: -0.09535793321956247 LUMO: -0.09535779061079919
-0.0979576318699961
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 1.994e+00 1.994e+00 1.902e+00 1.902e+00 1.317e+00
 1.317e+00 9.634e-01 9.350e-01 7.457e-01 7.457e-01 7.174e-01 7.174e-01
 5.927e-01 5.927e-01 3.966e-01 2.685e-01 2.685e-01 2.517e-01 2.516e-01
 3.214e-02 3.214e-02 2.905e-02 2.905e-02 1.365e-03 1.365e-03 1.175e-03
 1.175e-03]
entropy corr =  -0.09324233650787893
cycle= 13 E= -438.563381731687  delta_E= -1.39e-08  |g|= 0.000132  |ddm|= 0.0003
HOMO: -0.09535765200620333 LUMO: -0.09535764797642216
-0.09795739017040943
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 1.994e+00 1.994e+00 1.902e+00 1.902e+00 1.317e+00
 1.317e+00 9.634e-01 9.350e-01 7.457e-01 7.457e-01 7.174e-01 7.174e-01
 5.927e-01 5.927e-01 3.966e-01 2.685e-01 2.685e-01 2.517e-01 2.517e-01
 3.214e-02 3.214e-02 2.905e-02 2.905e-02 1.365e-03 1.365e-03 1.175e-03
 1.175e-03]
entropy corr =  -0.09324243261568642
cycle= 14 E= -438.563381743093  delta_E= -1.14e-08  |g|= 8.54e-05  |ddm|= 0.000263
HOMO: -0.09535777941438439 LUMO: -0.09535777744809419
-0.09795754210089755
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 1.994e+00 1.994e+00 1.902e+00 1.902e+00 1.317e+00
 1.317e+00 9.634e-01 9.350e-01 7.457e-01 7.457e-01 7.174e-01 7.174e-01
 5.927e-01 5.927e-01 3.966e-01 2.685e-01 2.685e-01 2.517e-01 2.517e-01
 3.214e-02 3.214e-02 2.905e-02 2.905e-02 1.365e-03 1.365e-03 1.175e-03
 1.175e-03]
entropy corr =  -0.09324236520846474
cycle= 15 E= -438.563381752708  delta_E= -9.61e-09  |g|= 1.19e-06  |ddm|= 0.000117
HOMO: -0.09535778062324765 LUMO: -0.09535775593345912
-0.09795752330584569
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 1.994e+00 1.994e+00 1.902e+00 1.902e+00 1.317e+00
 1.317e+00 9.634e-01 9.350e-01 7.457e-01 7.457e-01 7.174e-01 7.174e-01
 5.927e-01 5.927e-01 3.966e-01 2.685e-01 2.685e-01 2.517e-01 2.517e-01
 3.214e-02 3.214e-02 2.905e-02 2.905e-02 1.365e-03 1.365e-03 1.175e-03
 1.175e-03]
entropy corr =  -0.09324239457278637
cycle= 16 E= -438.563381752687  delta_E= 2.07e-11  |g|= 5.15e-06  |ddm|= 8.41e-06
HOMO: -0.09535809155660761 LUMO: -0.09535734739451651
-0.09795748140145873
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 1.994e+00 1.994e+00 1.902e+00 1.902e+00 1.317e+00
 1.316e+00 9.634e-01 9.350e-01 7.458e-01 7.457e-01 7.175e-01 7.174e-01
 5.927e-01 5.927e-01 3.966e-01 2.686e-01 2.685e-01 2.517e-01 2.516e-01
 3.214e-02 3.214e-02 2.905e-02 2.905e-02 1.365e-03 1.365e-03 1.175e-03
 1.175e-03]
entropy corr =  -0.09324237954400895
Extra cycle  E= -438.563381743634  delta_E= 9.05e-09  |g|= 0.000102  |ddm|= 0.000146
converged SCF energy = -438.563381743634
e_mf =  -438.56338174363367
#INFO: **** input file is /tigress/xingz/pydmfet/examples/Be.py ****
from pydmfet import locints, sdmfet, oep, tools
from pyscf import gto, scf,dft, ao2mo,cc
import numpy as np
from pyscf.tools import molden, cubegen
import copy,time

DMguess  = None

bondlengths = np.arange(1.8, 4.1, 0.1)
energies = []

bas = 'sto-6g'

for bondlength in bondlengths:

    nat = 30
    mol = gto.Mole()
    mol.atom = []
    r = 0.5 * bondlength / np.sin(np.pi/nat)
    for i in range(nat):
        theta = i * (2*np.pi/nat)
        mol.atom.append(('Be', (r*np.cos(theta), r*np.sin(theta), 0)))

    mol.basis = bas
    mol.build(max_memory=16000, verbose=4)

    #mf = scf.RHF(mol)
    mf = dft.RKS(mol)
    mf.xc = 'pbe,pbe'
    mf.smear_sigma = 0.005
    mf.max_cycle = 100
    mf.scf()

    #P=mf.make_rdm1()
    #tools.MatPrint(P,"P_ref_ao")
    #cubegen.density(mol, "h20_dens.cube", P, nx=100, ny=100, nz=100)
    print 'e_mf = ',  mf.e_tot
    continue
    if ( True ):   
#        ENUCL = mf.mol.energy_nuc()
#        OEI   = np.dot(np.dot(mf.mo_coeff.T, mol.intor('cint1e_kin_sph') + mol.intor('cint1e_nuc_sph')), mf.mo_coeff)
#        TEI   = ao2mo.outcore.full_iofree(mol, mf.mo_coeff, compact=False).reshape(mol.nao_nr(), mol.nao_nr(), mol.nao_nr(), mol.nao_nr())
#        import chemps2
#        Energy, OneDM = chemps2.solve( ENUCL, OEI, OEI, TEI, mol.nao_nr(), mol.nelectron, mol.nao_nr(), 0.0, False )
#        print "bl =", bondlength," and energy =", Energy

        mycc = cc.CCSD(mf).run()
	et=0.0
        #et = mycc.ccsd_t()
        e_hf = mf.e_tot
        e_ccsd = e_hf + mycc.e_corr + et

        print 'e_tot = ', e_ccsd    #-4.96124910741
        
    else:
        myInts = locints.LocalIntegrals( mf, range( mol.nao_nr() ), 'meta_lowdin' )
        #myInts.loc_molden( 'hydrogen-loc.molden' )
        #myInts.TI_OK = True # Only s functions

	nbas =  mol.nao_nr()
	natoms = mol.natm

	impAtom = np.zeros([natoms], dtype=int)
	for i in range(20):
	    impAtom[i] = 1

	ghost_frag = 1-impAtom
	ghost_env = 1-ghost_frag

	mol_frag = gto.Mole()
	mol_frag.atom = tools.add_ghost(mol.atom, ghost_frag)
	mol_frag.basis = bas
	mol_frag.build(max_memory = 16000,verbose = 4)
	'''
	mf_frag = dft.RKS(mol_frag)
        mf_frag.xc = 'pbe,pbe'
        mf_frag.smear_sigma = 0.00
        mf_frag.scf()
        P_frag=mf_frag.make_rdm1()
        cubegen.density(mol_frag, "h10_dens_1.cube", P_frag, nx=100, ny=100, nz=100)
	'''

	mol_env = gto.Mole()
	mol_env.atom = tools.add_ghost(mol.atom, ghost_env)
	mol_env.basis =  bas
	mol_env.build(max_memory = 16000,verbose = 4)

	'''
	mf_env = dft.RKS(mol_env)
        mf_env.xc = 'pbe,pbe'
        mf_env.smear_sigma = 0.00
        mf_env.scf()
        P_env=mf_env.make_rdm1()
        cubegen.density(mol_env, "h10_dens_2.cube", P_env, nx=100, ny=100, nz=100)
	exit()
	'''



	aoslice = mol.aoslice_by_atom()
	impurities = np.zeros([nbas], dtype = int)
	for i in range(natoms):
	    if(impAtom[i] == 1):
		impurities[aoslice[i,2]:aoslice[i,3]] = 1

	Ne_frag = 20
	boundary_atoms = np.zeros((natoms))
	boundary_atoms[20:40] = 1.0
	#boundary_atoms[19] = -1
	boundary_atoms2 = np.zeros((natoms),dtype =int)
	#boundary_atoms2[9] = -1
	boundary_atoms2[0:20] = 1

	boundary_atoms = None
	boundary_atoms2 =None

	umat=None
	P_frag=None
	P_env=None
	params = oep.OEPparams(algorithm = '2011', opt_method = 'L-BFGS-B', \
                       ftol = 1e-11, gtol = 1e-5,diffP_tol=1e-5, outer_maxit = 200, maxit = 200,l2_lambda = 0.0, oep_print = 0)
	theDMFET = sdmfet.DMFET( mf, mol_frag, mol_env,myInts,impurities, impAtom, Ne_frag, boundary_atoms=boundary_atoms, boundary_atoms2=boundary_atoms2,\
                         umat = umat, P_frag_ao = P_frag, P_env_ao = P_env, \
                         dim_imp = nbas, dim_bath=nbas, dim_big =nbas, smear_sigma = 0.005, oep_params=params,ecw_method='hf', mf_method = mf.xc)

	umat = theDMFET.embedding_potential()

	exit()

	#write subspace orbitals
	transfo = np.dot( myInts.ao2loc, theDMFET.loc2sub )
	filename =  'hydrogen-sub.molden'
	with open( filename, 'w' ) as thefile:
            molden.header( myInts.mol, thefile )
            molden.orbital_coeff( myInts.mol, thefile, transfo )


        umat = theDMFET.embedding_potential()
	print umat
	exit()
	energy = theDMFET.correction_energy()

#INFO: ******************** input file end ********************


System: ('Linux', 'tigercpu.princeton.edu', '3.10.0-693.21.1.el7.x86_64', '#1 SMP Wed Mar 7 15:59:45 EST 2018', 'x86_64', 'x86_64')  Threads 40
Python 2.7.14 |Anaconda, Inc.| (default, Oct 16 2017, 17:29:19) 
[GCC 7.2.0]
numpy 1.14.3  scipy 1.1.0
Date: Thu Jun  7 01:36:01 2018
PySCF version 1.4.2
PySCF path  /tigress/xingz/pyscf/pyscf
GIT ORIG_HEAD e0edd131499dcc18d035a120533a8a1ddda110d4
GIT HEAD      e0edd131499dcc18d035a120533a8a1ddda110d4

[INPUT] VERBOSE 4
[INPUT] num atoms = 30
[INPUT] num electrons = 120
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT]  1 Be     9.088433621830   0.000000000000   0.000000000000 AA   17.174650446548   0.000000000000   0.000000000000 Bohr
[INPUT]  2 Be     8.889829541622   1.889591601200   0.000000000000 AA   16.799343127733   3.570810613546   0.000000000000 Bohr
[INPUT]  3 Be     8.302697252309   3.696598982161   0.000000000000 AA   15.689823902044   6.985559668629   0.000000000000 Bohr
[INPUT]  4 Be     7.352697252309   5.342047249351   0.000000000000 AA   13.894584083707  10.095006245759   0.000000000000 Bohr
[INPUT]  5 Be     6.081349100228   6.754022417758   0.000000000000 AA   11.492084267300  12.763252608735   0.000000000000 Bohr
[INPUT]  6 Be     4.544216810915   7.870814397114   0.000000000000 AA    8.587325223274  14.873683587829   0.000000000000 Bohr
[INPUT]  7 Be     2.808480441394   8.643614018958   0.000000000000 AA    5.307258860433  16.334063222281   0.000000000000 Bohr
[INPUT]  8 Be     0.950000000000   9.038646231511   0.000000000000 AA    1.795239818337  17.080565914389   0.000000000000 Bohr
[INPUT]  9 Be    -0.950000000000   9.038646231511   0.000000000000 AA   -1.795239818337  17.080565914389   0.000000000000 Bohr
[INPUT] 10 Be    -2.808480441394   8.643614018958   0.000000000000 AA   -5.307258860433  16.334063222281   0.000000000000 Bohr
[INPUT] 11 Be    -4.544216810915   7.870814397114   0.000000000000 AA   -8.587325223274  14.873683587829   0.000000000000 Bohr
[INPUT] 12 Be    -6.081349100228   6.754022417758   0.000000000000 AA  -11.492084267300  12.763252608735   0.000000000000 Bohr
[INPUT] 13 Be    -7.352697252309   5.342047249351   0.000000000000 AA  -13.894584083707  10.095006245759   0.000000000000 Bohr
[INPUT] 14 Be    -8.302697252309   3.696598982161   0.000000000000 AA  -15.689823902044   6.985559668629   0.000000000000 Bohr
[INPUT] 15 Be    -8.889829541622   1.889591601200   0.000000000000 AA  -16.799343127733   3.570810613546   0.000000000000 Bohr
[INPUT] 16 Be    -9.088433621830   0.000000000000   0.000000000000 AA  -17.174650446548   0.000000000000   0.000000000000 Bohr
[INPUT] 17 Be    -8.889829541622  -1.889591601200   0.000000000000 AA  -16.799343127733  -3.570810613546   0.000000000000 Bohr
[INPUT] 18 Be    -8.302697252309  -3.696598982161   0.000000000000 AA  -15.689823902044  -6.985559668629   0.000000000000 Bohr
[INPUT] 19 Be    -7.352697252309  -5.342047249351   0.000000000000 AA  -13.894584083707 -10.095006245759   0.000000000000 Bohr
[INPUT] 20 Be    -6.081349100228  -6.754022417758   0.000000000000 AA  -11.492084267300 -12.763252608735   0.000000000000 Bohr
[INPUT] 21 Be    -4.544216810915  -7.870814397114   0.000000000000 AA   -8.587325223274 -14.873683587829   0.000000000000 Bohr
[INPUT] 22 Be    -2.808480441394  -8.643614018958   0.000000000000 AA   -5.307258860433 -16.334063222281   0.000000000000 Bohr
[INPUT] 23 Be    -0.950000000000  -9.038646231511   0.000000000000 AA   -1.795239818337 -17.080565914389   0.000000000000 Bohr
[INPUT] 24 Be     0.950000000000  -9.038646231511   0.000000000000 AA    1.795239818337 -17.080565914389   0.000000000000 Bohr
[INPUT] 25 Be     2.808480441394  -8.643614018958   0.000000000000 AA    5.307258860433 -16.334063222281   0.000000000000 Bohr
[INPUT] 26 Be     4.544216810915  -7.870814397114   0.000000000000 AA    8.587325223274 -14.873683587829   0.000000000000 Bohr
[INPUT] 27 Be     6.081349100228  -6.754022417758   0.000000000000 AA   11.492084267300 -12.763252608735   0.000000000000 Bohr
[INPUT] 28 Be     7.352697252309  -5.342047249351   0.000000000000 AA   13.894584083707 -10.095006245759   0.000000000000 Bohr
[INPUT] 29 Be     8.302697252309  -3.696598982161   0.000000000000 AA   15.689823902044  -6.985559668629   0.000000000000 Bohr
[INPUT] 30 Be     8.889829541622  -1.889591601200   0.000000000000 AA   16.799343127733  -3.570810613546   0.000000000000 Bohr
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [6    /1   ]  312.8704937       0.00916359628
                                57.36446253       0.04936149294
                                16.0485094        0.1685383049
                                5.513096119       0.3705627997
                                2.140896553       0.4164915298
                                0.8817394283      0.1303340841
[INPUT] 0    0    [6    /1   ]  13.63324744       -0.01325278809
                                2.698375464       -0.04699171014
                                0.8386530829      -0.03378537151
                                0.3226600698      0.2502417861
                                0.1401314882      0.5951172526
                                0.0642325139      0.2407061763
[INPUT] 1    0    [6    /1   ]  13.63324744       0.0037596966
                                2.698375464       0.0376793698
                                0.8386530829      0.1738967435
                                0.3226600698      0.4180364347
                                0.1401314882      0.4258595477
                                0.0642325139      0.1017082955
nuclear repulsion = 470.609329050805
number of shells = 90
number of NR pGTOs = 900
number of NR cGTOs = 150
basis = sto-6g
ecp = {}
CPU time:       760.02


******** <class 'pyscf.dft.rks.RKS'> flags ********
method = RKS
initial guess = minao
damping factor = 0
level shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
DIIS start cycle = 1
DIIS space = 8
SCF tol = 1e-09
SCF gradient tol = None
max. SCF cycles = 100
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /tigress/xingz/pydmfet/examples/tmpeuyN5R
max_memory 16000 MB (current use 230 MB)
XC functionals = pbe,pbe
small_rho_cutoff = 1e-07
radial grids: Treutler-Ahlrichs (JCP 102, 346 (M4)) radial grids
becke partition: Becke, JCP, 88, 2547 (1988)
pruning grids: <function nwchem_prune at 0x2aac1c760cf8>
grids dens level: 3
symmetrized grids: False
atomic radii adjust function: <function treutler_atomic_radii_adjust at 0x2aac1c760b18>
Set gradient conv threshold to 3.16228e-05
tot grids = 393300
init E= -441.458106359202
HOMO: -0.21103411801183672 LUMO: -0.18879064557895228
-0.20186507198248602
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    1.994 1.994 1.953 1.953 1.822 1.822 1.724
 0.136 0.121 0.094 0.094 0.083 0.083 0.03  0.03  0.026 0.026 0.004 0.004
 0.004 0.004]
entropy corr =  -0.02827788094819199
cycle= 1 E= -438.806953381676  delta_E= 2.65  |g|= 0.0938  |ddm|= 8.37
HOMO: -0.06198291332923483 LUMO: -0.06172622266960426
-0.06505424310916527
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 1.998e+00 1.998e+00 1.962e+00 1.962e+00 1.638e+00
 1.638e+00 9.379e-01 9.379e-01 7.022e-01 6.790e-01 6.625e-01 5.274e-01
 5.274e-01 5.041e-01 5.041e-01 1.878e-01 1.878e-01 1.729e-01 1.729e-01
 2.566e-02 2.566e-02 2.233e-02 2.233e-02 1.396e-03 1.396e-03 1.129e-03
 1.129e-03]
entropy corr =  -0.08233764372700468
cycle= 2 E= -438.82158722249  delta_E= -0.0146  |g|= 0.0851  |ddm|= 1.56
HOMO: -0.07428747585827253 LUMO: -0.07285279317706747
-0.07662930816346268
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 1.998e+00 1.998e+00 1.967e+00 1.967e+00 1.689e+00
 1.689e+00 1.048e+00 1.048e+00 7.700e-01 6.393e-01 6.095e-01 4.750e-01
 4.749e-01 4.492e-01 4.491e-01 1.659e-01 1.659e-01 1.536e-01 1.536e-01
 2.259e-02 2.259e-02 2.034e-02 2.034e-02 1.238e-03 1.238e-03 1.073e-03
 1.073e-03]
entropy corr =  -0.07873121642771674
cycle= 3 E= -438.849303869165  delta_E= -0.0277  |g|= 0.0083  |ddm|= 0.402
HOMO: -0.08182829590319354 LUMO: -0.07831075247171675
-0.08297623809637315
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 1.998e+00 1.998e+00 1.973e+00 1.973e+00 1.741e+00
 1.741e+00 1.164e+00 1.161e+00 8.857e-01 5.646e-01 5.462e-01 4.153e-01
 4.130e-01 3.993e-01 3.971e-01 1.417e-01 1.417e-01 1.339e-01 1.338e-01
 1.925e-02 1.925e-02 1.770e-02 1.770e-02 1.067e-03 1.067e-03]
entropy corr =  -0.07405815123833766
cycle= 4 E= -438.84983107767  delta_E= -0.000527  |g|= 0.00288  |ddm|= 0.178
HOMO: -0.08114581575297043 LUMO: -0.07785925641380582
-0.08243174525410943
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 1.998e+00 1.998e+00 1.972e+00 1.972e+00 1.737e+00
 1.736e+00 1.179e+00 1.122e+00 8.721e-01 5.722e-01 5.547e-01 4.368e-01
 4.210e-01 4.026e-01 3.878e-01 1.437e-01 1.434e-01 1.361e-01 1.358e-01
 1.951e-02 1.951e-02 1.799e-02 1.799e-02 1.080e-03 1.080e-03]
entropy corr =  -0.07454221112346661
cycle= 5 E= -438.848400120838  delta_E= 0.00143  |g|= 0.0389  |ddm|= 0.0633
HOMO: -0.08098443875222627 LUMO: -0.0777190772548608
-0.08228477683458049
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 1.998e+00 1.998e+00 1.972e+00 1.972e+00 1.735e+00
 1.735e+00 1.149e+00 1.148e+00 8.707e-01 5.727e-01 5.555e-01 4.209e-01
 4.205e-01 4.058e-01 4.054e-01 1.443e-01 1.442e-01 1.367e-01 1.367e-01
 1.960e-02 1.960e-02 1.808e-02 1.808e-02 1.085e-03 1.085e-03]
entropy corr =  -0.07468172902633072
cycle= 6 E= -438.849848803386  delta_E= -0.00145  |g|= 0.000533  |ddm|= 0.0561
HOMO: -0.08096124722269309 LUMO: -0.07770315613699222
-0.08226594133012723
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 1.998e+00 1.998e+00 1.972e+00 1.972e+00 1.735e+00
 1.735e+00 1.148e+00 1.148e+00 8.703e-01 5.730e-01 5.558e-01 4.210e-01
 4.208e-01 4.059e-01 4.057e-01 1.445e-01 1.442e-01 1.370e-01 1.366e-01
 1.961e-02 1.961e-02 1.809e-02 1.809e-02 1.085e-03 1.085e-03]
entropy corr =  -0.07469942101995417
cycle= 7 E= -438.849848783755  delta_E= 1.96e-08  |g|= 0.000656  |ddm|= 0.00129
HOMO: -0.08094799649026815 LUMO: -0.07769405657612245
-0.08225517690781327
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 1.998e+00 1.998e+00 1.972e+00 1.972e+00 1.735e+00
 1.735e+00 1.148e+00 1.147e+00 8.700e-01 5.731e-01 5.559e-01 4.210e-01
 4.210e-01 4.060e-01 4.059e-01 1.444e-01 1.444e-01 1.368e-01 1.368e-01
 1.962e-02 1.961e-02 1.810e-02 1.810e-02 1.086e-03 1.086e-03]
entropy corr =  -0.074709513749928
cycle= 8 E= -438.849849089613  delta_E= -3.06e-07  |g|= 4.03e-05  |ddm|= 0.000992
HOMO: -0.08094713520856525 LUMO: -0.07769346882864951
-0.08225447504060762
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 1.998e+00 1.998e+00 1.972e+00 1.972e+00 1.735e+00
 1.735e+00 1.147e+00 1.147e+00 8.700e-01 5.731e-01 5.559e-01 4.210e-01
 4.210e-01 4.060e-01 4.059e-01 1.444e-01 1.444e-01 1.368e-01 1.368e-01
 1.962e-02 1.961e-02 1.810e-02 1.810e-02 1.086e-03 1.086e-03]
entropy corr =  -0.07471016202127909
cycle= 9 E= -438.849849088991  delta_E= 6.22e-10  |g|= 3.8e-05  |ddm|= 7.74e-05
HOMO: -0.08094704842267372 LUMO: -0.07769341011798063
-0.08225440484853948
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 1.998e+00 1.998e+00 1.972e+00 1.972e+00 1.735e+00
 1.735e+00 1.147e+00 1.147e+00 8.700e-01 5.731e-01 5.559e-01 4.210e-01
 4.210e-01 4.060e-01 4.060e-01 1.444e-01 1.444e-01 1.368e-01 1.368e-01
 1.962e-02 1.961e-02 1.810e-02 1.810e-02 1.086e-03 1.086e-03]
entropy corr =  -0.07471022882646645
cycle= 10 E= -438.849849083081  delta_E= 5.91e-09  |g|= 7.41e-05  |ddm|= 0.000165
HOMO: -0.08094694733404019 LUMO: -0.07769334112117207
-0.08225432220450592
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 1.998e+00 1.998e+00 1.972e+00 1.972e+00 1.735e+00
 1.735e+00 1.147e+00 1.147e+00 8.700e-01 5.731e-01 5.559e-01 4.210e-01
 4.210e-01 4.060e-01 4.060e-01 1.444e-01 1.444e-01 1.368e-01 1.368e-01
 1.962e-02 1.962e-02 1.810e-02 1.810e-02 1.086e-03 1.086e-03]
entropy corr =  -0.07471030478121192
cycle= 11 E= -438.849849090871  delta_E= -7.79e-09  |g|= 9.23e-07  |ddm|= 0.000113
HOMO: -0.08094692652223458 LUMO: -0.0776933266680737
-0.08225430502767414
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 1.998e+00 1.998e+00 1.972e+00 1.972e+00 1.735e+00
 1.735e+00 1.147e+00 1.147e+00 8.700e-01 5.731e-01 5.559e-01 4.210e-01
 4.210e-01 4.060e-01 4.060e-01 1.444e-01 1.444e-01 1.368e-01 1.368e-01
 1.962e-02 1.962e-02 1.810e-02 1.810e-02 1.086e-03 1.086e-03]
entropy corr =  -0.07471031957603988
cycle= 12 E= -438.849849090874  delta_E= -2.16e-12  |g|= 3.62e-07  |ddm|= 1.47e-06
HOMO: -0.08094691317641518 LUMO: -0.0776933165714929
-0.08225429362673166
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 1.998e+00 1.998e+00 1.972e+00 1.972e+00 1.735e+00
 1.735e+00 1.147e+00 1.147e+00 8.700e-01 5.731e-01 5.559e-01 4.210e-01
 4.210e-01 4.060e-01 4.059e-01 1.444e-01 1.444e-01 1.368e-01 1.368e-01
 1.962e-02 1.962e-02 1.810e-02 1.810e-02 1.086e-03 1.086e-03]
entropy corr =  -0.07471032737637084
Extra cycle  E= -438.849849090851  delta_E= 2.26e-11  |g|= 5.14e-06  |ddm|= 7.84e-06
converged SCF energy = -438.849849090851
e_mf =  -438.849849090851
#INFO: **** input file is /tigress/xingz/pydmfet/examples/Be.py ****
from pydmfet import locints, sdmfet, oep, tools
from pyscf import gto, scf,dft, ao2mo,cc
import numpy as np
from pyscf.tools import molden, cubegen
import copy,time

DMguess  = None

bondlengths = np.arange(1.8, 4.1, 0.1)
energies = []

bas = 'sto-6g'

for bondlength in bondlengths:

    nat = 30
    mol = gto.Mole()
    mol.atom = []
    r = 0.5 * bondlength / np.sin(np.pi/nat)
    for i in range(nat):
        theta = i * (2*np.pi/nat)
        mol.atom.append(('Be', (r*np.cos(theta), r*np.sin(theta), 0)))

    mol.basis = bas
    mol.build(max_memory=16000, verbose=4)

    #mf = scf.RHF(mol)
    mf = dft.RKS(mol)
    mf.xc = 'pbe,pbe'
    mf.smear_sigma = 0.005
    mf.max_cycle = 100
    mf.scf()

    #P=mf.make_rdm1()
    #tools.MatPrint(P,"P_ref_ao")
    #cubegen.density(mol, "h20_dens.cube", P, nx=100, ny=100, nz=100)
    print 'e_mf = ',  mf.e_tot
    continue
    if ( True ):   
#        ENUCL = mf.mol.energy_nuc()
#        OEI   = np.dot(np.dot(mf.mo_coeff.T, mol.intor('cint1e_kin_sph') + mol.intor('cint1e_nuc_sph')), mf.mo_coeff)
#        TEI   = ao2mo.outcore.full_iofree(mol, mf.mo_coeff, compact=False).reshape(mol.nao_nr(), mol.nao_nr(), mol.nao_nr(), mol.nao_nr())
#        import chemps2
#        Energy, OneDM = chemps2.solve( ENUCL, OEI, OEI, TEI, mol.nao_nr(), mol.nelectron, mol.nao_nr(), 0.0, False )
#        print "bl =", bondlength," and energy =", Energy

        mycc = cc.CCSD(mf).run()
	et=0.0
        #et = mycc.ccsd_t()
        e_hf = mf.e_tot
        e_ccsd = e_hf + mycc.e_corr + et

        print 'e_tot = ', e_ccsd    #-4.96124910741
        
    else:
        myInts = locints.LocalIntegrals( mf, range( mol.nao_nr() ), 'meta_lowdin' )
        #myInts.loc_molden( 'hydrogen-loc.molden' )
        #myInts.TI_OK = True # Only s functions

	nbas =  mol.nao_nr()
	natoms = mol.natm

	impAtom = np.zeros([natoms], dtype=int)
	for i in range(20):
	    impAtom[i] = 1

	ghost_frag = 1-impAtom
	ghost_env = 1-ghost_frag

	mol_frag = gto.Mole()
	mol_frag.atom = tools.add_ghost(mol.atom, ghost_frag)
	mol_frag.basis = bas
	mol_frag.build(max_memory = 16000,verbose = 4)
	'''
	mf_frag = dft.RKS(mol_frag)
        mf_frag.xc = 'pbe,pbe'
        mf_frag.smear_sigma = 0.00
        mf_frag.scf()
        P_frag=mf_frag.make_rdm1()
        cubegen.density(mol_frag, "h10_dens_1.cube", P_frag, nx=100, ny=100, nz=100)
	'''

	mol_env = gto.Mole()
	mol_env.atom = tools.add_ghost(mol.atom, ghost_env)
	mol_env.basis =  bas
	mol_env.build(max_memory = 16000,verbose = 4)

	'''
	mf_env = dft.RKS(mol_env)
        mf_env.xc = 'pbe,pbe'
        mf_env.smear_sigma = 0.00
        mf_env.scf()
        P_env=mf_env.make_rdm1()
        cubegen.density(mol_env, "h10_dens_2.cube", P_env, nx=100, ny=100, nz=100)
	exit()
	'''



	aoslice = mol.aoslice_by_atom()
	impurities = np.zeros([nbas], dtype = int)
	for i in range(natoms):
	    if(impAtom[i] == 1):
		impurities[aoslice[i,2]:aoslice[i,3]] = 1

	Ne_frag = 20
	boundary_atoms = np.zeros((natoms))
	boundary_atoms[20:40] = 1.0
	#boundary_atoms[19] = -1
	boundary_atoms2 = np.zeros((natoms),dtype =int)
	#boundary_atoms2[9] = -1
	boundary_atoms2[0:20] = 1

	boundary_atoms = None
	boundary_atoms2 =None

	umat=None
	P_frag=None
	P_env=None
	params = oep.OEPparams(algorithm = '2011', opt_method = 'L-BFGS-B', \
                       ftol = 1e-11, gtol = 1e-5,diffP_tol=1e-5, outer_maxit = 200, maxit = 200,l2_lambda = 0.0, oep_print = 0)
	theDMFET = sdmfet.DMFET( mf, mol_frag, mol_env,myInts,impurities, impAtom, Ne_frag, boundary_atoms=boundary_atoms, boundary_atoms2=boundary_atoms2,\
                         umat = umat, P_frag_ao = P_frag, P_env_ao = P_env, \
                         dim_imp = nbas, dim_bath=nbas, dim_big =nbas, smear_sigma = 0.005, oep_params=params,ecw_method='hf', mf_method = mf.xc)

	umat = theDMFET.embedding_potential()

	exit()

	#write subspace orbitals
	transfo = np.dot( myInts.ao2loc, theDMFET.loc2sub )
	filename =  'hydrogen-sub.molden'
	with open( filename, 'w' ) as thefile:
            molden.header( myInts.mol, thefile )
            molden.orbital_coeff( myInts.mol, thefile, transfo )


        umat = theDMFET.embedding_potential()
	print umat
	exit()
	energy = theDMFET.correction_energy()

#INFO: ******************** input file end ********************


System: ('Linux', 'tigercpu.princeton.edu', '3.10.0-693.21.1.el7.x86_64', '#1 SMP Wed Mar 7 15:59:45 EST 2018', 'x86_64', 'x86_64')  Threads 40
Python 2.7.14 |Anaconda, Inc.| (default, Oct 16 2017, 17:29:19) 
[GCC 7.2.0]
numpy 1.14.3  scipy 1.1.0
Date: Thu Jun  7 01:36:24 2018
PySCF version 1.4.2
PySCF path  /tigress/xingz/pyscf/pyscf
GIT ORIG_HEAD e0edd131499dcc18d035a120533a8a1ddda110d4
GIT HEAD      e0edd131499dcc18d035a120533a8a1ddda110d4

[INPUT] VERBOSE 4
[INPUT] num atoms = 30
[INPUT] num electrons = 120
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT]  1 Be     9.566772233506   0.000000000000   0.000000000000 AA   18.078579417419   0.000000000000   0.000000000000 Bohr
[INPUT]  2 Be     9.357715306970   1.989043790737   0.000000000000 AA   17.683519081824   3.758748014259   0.000000000000 Bohr
[INPUT]  3 Be     8.739681318220   3.891156823327   0.000000000000 AA   16.515604107414   7.353220703820   0.000000000000 Bohr
[INPUT]  4 Be     7.739681318220   5.623207630896   0.000000000000 AA   14.625877982849  10.626322363957   0.000000000000 Bohr
[INPUT]  5 Be     6.401420105503   7.109497281851   0.000000000000 AA   12.096930807685  13.435002746037   0.000000000000 Bohr
[INPUT]  6 Be     4.783386116753   8.285067786435   0.000000000000 AA    9.039289708710  15.656509039820   0.000000000000 Bohr
[INPUT]  7 Be     2.956295201468   9.098541072587   0.000000000000 AA    5.586588274140  17.193750760296   0.000000000000 Bohr
[INPUT]  8 Be     1.000000000000   9.514364454223   0.000000000000 AA    1.889726124565  17.979543067778   0.000000000000 Bohr
[INPUT]  9 Be    -1.000000000000   9.514364454223   0.000000000000 AA   -1.889726124565  17.979543067778   0.000000000000 Bohr
[INPUT] 10 Be    -2.956295201468   9.098541072587   0.000000000000 AA   -5.586588274140  17.193750760296   0.000000000000 Bohr
[INPUT] 11 Be    -4.783386116753   8.285067786435   0.000000000000 AA   -9.039289708710  15.656509039820   0.000000000000 Bohr
[INPUT] 12 Be    -6.401420105503   7.109497281851   0.000000000000 AA  -12.096930807684  13.435002746037   0.000000000000 Bohr
[INPUT] 13 Be    -7.739681318220   5.623207630896   0.000000000000 AA  -14.625877982849  10.626322363957   0.000000000000 Bohr
[INPUT] 14 Be    -8.739681318220   3.891156823327   0.000000000000 AA  -16.515604107414   7.353220703820   0.000000000000 Bohr
[INPUT] 15 Be    -9.357715306970   1.989043790737   0.000000000000 AA  -17.683519081824   3.758748014259   0.000000000000 Bohr
[INPUT] 16 Be    -9.566772233506   0.000000000000   0.000000000000 AA  -18.078579417419   0.000000000000   0.000000000000 Bohr
[INPUT] 17 Be    -9.357715306970  -1.989043790737   0.000000000000 AA  -17.683519081824  -3.758748014259   0.000000000000 Bohr
[INPUT] 18 Be    -8.739681318220  -3.891156823327   0.000000000000 AA  -16.515604107414  -7.353220703820   0.000000000000 Bohr
[INPUT] 19 Be    -7.739681318220  -5.623207630896   0.000000000000 AA  -14.625877982849 -10.626322363957   0.000000000000 Bohr
[INPUT] 20 Be    -6.401420105503  -7.109497281851   0.000000000000 AA  -12.096930807685 -13.435002746037   0.000000000000 Bohr
[INPUT] 21 Be    -4.783386116753  -8.285067786435   0.000000000000 AA   -9.039289708710 -15.656509039820   0.000000000000 Bohr
[INPUT] 22 Be    -2.956295201468  -9.098541072587   0.000000000000 AA   -5.586588274140 -17.193750760296   0.000000000000 Bohr
[INPUT] 23 Be    -1.000000000000  -9.514364454223   0.000000000000 AA   -1.889726124565 -17.979543067778   0.000000000000 Bohr
[INPUT] 24 Be     1.000000000000  -9.514364454223   0.000000000000 AA    1.889726124565 -17.979543067778   0.000000000000 Bohr
[INPUT] 25 Be     2.956295201468  -9.098541072587   0.000000000000 AA    5.586588274140 -17.193750760296   0.000000000000 Bohr
[INPUT] 26 Be     4.783386116753  -8.285067786435   0.000000000000 AA    9.039289708710 -15.656509039820   0.000000000000 Bohr
[INPUT] 27 Be     6.401420105503  -7.109497281851   0.000000000000 AA   12.096930807684 -13.435002746037   0.000000000000 Bohr
[INPUT] 28 Be     7.739681318220  -5.623207630896   0.000000000000 AA   14.625877982849 -10.626322363957   0.000000000000 Bohr
[INPUT] 29 Be     8.739681318220  -3.891156823327   0.000000000000 AA   16.515604107414  -7.353220703820   0.000000000000 Bohr
[INPUT] 30 Be     9.357715306970  -1.989043790737   0.000000000000 AA   17.683519081824  -3.758748014259   0.000000000000 Bohr
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [6    /1   ]  312.8704937       0.00916359628
                                57.36446253       0.04936149294
                                16.0485094        0.1685383049
                                5.513096119       0.3705627997
                                2.140896553       0.4164915298
                                0.8817394283      0.1303340841
[INPUT] 0    0    [6    /1   ]  13.63324744       -0.01325278809
                                2.698375464       -0.04699171014
                                0.8386530829      -0.03378537151
                                0.3226600698      0.2502417861
                                0.1401314882      0.5951172526
                                0.0642325139      0.2407061763
[INPUT] 1    0    [6    /1   ]  13.63324744       0.0037596966
                                2.698375464       0.0376793698
                                0.8386530829      0.1738967435
                                0.3226600698      0.4180364347
                                0.1401314882      0.4258595477
                                0.0642325139      0.1017082955
nuclear repulsion = 447.078862598264
number of shells = 90
number of NR pGTOs = 900
number of NR cGTOs = 150
basis = sto-6g
ecp = {}
CPU time:      1383.70


******** <class 'pyscf.dft.rks.RKS'> flags ********
method = RKS
initial guess = minao
damping factor = 0
level shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
DIIS start cycle = 1
DIIS space = 8
SCF tol = 1e-09
SCF gradient tol = None
max. SCF cycles = 100
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /tigress/xingz/pydmfet/examples/tmptHKbI4
max_memory 16000 MB (current use 232 MB)
XC functionals = pbe,pbe
small_rho_cutoff = 1e-07
radial grids: Treutler-Ahlrichs (JCP 102, 346 (M4)) radial grids
becke partition: Becke, JCP, 88, 2547 (1988)
pruning grids: <function nwchem_prune at 0x2aac1c760cf8>
grids dens level: 3
symmetrized grids: False
atomic radii adjust function: <function treutler_atomic_radii_adjust at 0x2aac1c760b18>
Set gradient conv threshold to 3.16228e-05
tot grids = 393300
init E= -440.849759234797
HOMO: -0.20293923523207347 LUMO: -0.17216789903980326
-0.18961504158018466
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    1.998 1.998 1.98  1.98  1.92  1.92  1.87
 0.059 0.054 0.042 0.042 0.038 0.038 0.014 0.014 0.013 0.013 0.002 0.002
 0.002 0.002]
entropy corr =  -0.015555652240728045
cycle= 1 E= -438.981776218027  delta_E= 1.87  |g|= 0.082  |ddm|= 8.15
HOMO: -0.0638361222500634 LUMO: -0.052917279786896865
-0.06107560298273656
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    1.999 1.999 1.99  1.99  1.886 1.886 1.518 1.517 1.269
 0.327 0.317 0.237 0.237 0.227 0.227 0.083 0.083 0.078 0.078 0.013 0.013
 0.012 0.012]
entropy corr =  -0.05425978810163914
cycle= 2 E= -438.985987636932  delta_E= -0.00421  |g|= 0.0703  |ddm|= 0.937
HOMO: -0.07158760451777271 LUMO: -0.0600074084099517
-0.06844229301309324
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    1.999 1.999 1.99  1.99  1.891 1.891 1.542 1.542 1.305
 0.312 0.3   0.225 0.225 0.216 0.216 0.079 0.079 0.074 0.074 0.012 0.012
 0.011 0.011]
entropy corr =  -0.052710862566146974
cycle= 3 E= -439.007663157811  delta_E= -0.0217  |g|= 0.004  |ddm|= 0.34
HOMO: -0.07578384848679545 LUMO: -0.0631334553691167
-0.0720786536189991
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    1.999 1.999 1.991 1.991 1.901 1.901 1.579 1.579 1.354
 0.286 0.28  0.206 0.206 0.2   0.2   0.072 0.072 0.069 0.069 0.011 0.011
 0.011 0.011]
entropy corr =  -0.05006532222387405
cycle= 4 E= -439.007760746806  delta_E= -9.76e-05  |g|= 0.000399  |ddm|= 0.061
HOMO: -0.07549565063169252 LUMO: -0.06292633780006186
-0.07183738279121804
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    1.999 1.999 1.991 1.991 1.9   1.9   1.578 1.574 1.35
 0.288 0.282 0.208 0.206 0.203 0.201 0.072 0.072 0.069 0.069 0.011 0.011
 0.011 0.011]
entropy corr =  -0.0502855807105021
cycle= 5 E= -439.007757703133  delta_E= 3.04e-06  |g|= 0.00203  |ddm|= 0.00597
HOMO: -0.07549263112846384 LUMO: -0.06292394479969436
-0.07183476083080681
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    1.999 1.999 1.991 1.991 1.9   1.9   1.576 1.576 1.35
 0.288 0.282 0.207 0.207 0.202 0.202 0.072 0.072 0.069 0.069 0.011 0.011
 0.011 0.011]
entropy corr =  -0.05028785636909299
cycle= 6 E= -439.007761562862  delta_E= -3.86e-06  |g|= 8.57e-05  |ddm|= 0.00316
HOMO: -0.07547337169169778 LUMO: -0.06291017671548095
-0.07181880404681527
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    1.999 1.999 1.991 1.991 1.9   1.9   1.576 1.576 1.35
 0.288 0.282 0.207 0.207 0.202 0.202 0.072 0.072 0.07  0.07  0.011 0.011
 0.011 0.011]
entropy corr =  -0.05030337884449943
cycle= 7 E= -439.00776157124  delta_E= -8.38e-09  |g|= 4.95e-05  |ddm|= 0.000381
HOMO: -0.07547316602259883 LUMO: -0.0629100287941452
-0.07181863304521958
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    1.999 1.999 1.991 1.991 1.9   1.9   1.576 1.576 1.35
 0.288 0.282 0.207 0.207 0.202 0.202 0.072 0.072 0.07  0.07  0.011 0.011
 0.011 0.011]
entropy corr =  -0.05030354186086845
cycle= 8 E= -439.007761572767  delta_E= -1.53e-09  |g|= 3.47e-07  |ddm|= 6.08e-05
HOMO: -0.07547320641131226 LUMO: -0.0629100551433613
-0.07181866471033632
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    1.999 1.999 1.991 1.991 1.9   1.9   1.576 1.576 1.35
 0.288 0.282 0.207 0.207 0.202 0.202 0.072 0.072 0.07  0.07  0.011 0.011
 0.011 0.011]
entropy corr =  -0.05030350128217211
cycle= 9 E= -439.007761572767  delta_E=    0  |g|= 5.68e-07  |ddm|= 1.64e-06
HOMO: -0.07547323098642135 LUMO: -0.0629100728121701
-0.07181868498428182
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    1.999 1.999 1.991 1.991 1.9   1.9   1.576 1.576 1.35
 0.288 0.282 0.207 0.207 0.202 0.202 0.072 0.072 0.07  0.07  0.011 0.011
 0.011 0.011]
entropy corr =  -0.05030348134469256
Extra cycle  E= -439.007761572709  delta_E= 5.78e-11  |g|= 7.14e-06  |ddm|= 1.19e-05
converged SCF energy = -439.007761572709
e_mf =  -439.0077615727093
#INFO: **** input file is /tigress/xingz/pydmfet/examples/Be.py ****
from pydmfet import locints, sdmfet, oep, tools
from pyscf import gto, scf,dft, ao2mo,cc
import numpy as np
from pyscf.tools import molden, cubegen
import copy,time

DMguess  = None

bondlengths = np.arange(1.8, 4.1, 0.1)
energies = []

bas = 'sto-6g'

for bondlength in bondlengths:

    nat = 30
    mol = gto.Mole()
    mol.atom = []
    r = 0.5 * bondlength / np.sin(np.pi/nat)
    for i in range(nat):
        theta = i * (2*np.pi/nat)
        mol.atom.append(('Be', (r*np.cos(theta), r*np.sin(theta), 0)))

    mol.basis = bas
    mol.build(max_memory=16000, verbose=4)

    #mf = scf.RHF(mol)
    mf = dft.RKS(mol)
    mf.xc = 'pbe,pbe'
    mf.smear_sigma = 0.005
    mf.max_cycle = 100
    mf.scf()

    #P=mf.make_rdm1()
    #tools.MatPrint(P,"P_ref_ao")
    #cubegen.density(mol, "h20_dens.cube", P, nx=100, ny=100, nz=100)
    print 'e_mf = ',  mf.e_tot
    continue
    if ( True ):   
#        ENUCL = mf.mol.energy_nuc()
#        OEI   = np.dot(np.dot(mf.mo_coeff.T, mol.intor('cint1e_kin_sph') + mol.intor('cint1e_nuc_sph')), mf.mo_coeff)
#        TEI   = ao2mo.outcore.full_iofree(mol, mf.mo_coeff, compact=False).reshape(mol.nao_nr(), mol.nao_nr(), mol.nao_nr(), mol.nao_nr())
#        import chemps2
#        Energy, OneDM = chemps2.solve( ENUCL, OEI, OEI, TEI, mol.nao_nr(), mol.nelectron, mol.nao_nr(), 0.0, False )
#        print "bl =", bondlength," and energy =", Energy

        mycc = cc.CCSD(mf).run()
	et=0.0
        #et = mycc.ccsd_t()
        e_hf = mf.e_tot
        e_ccsd = e_hf + mycc.e_corr + et

        print 'e_tot = ', e_ccsd    #-4.96124910741
        
    else:
        myInts = locints.LocalIntegrals( mf, range( mol.nao_nr() ), 'meta_lowdin' )
        #myInts.loc_molden( 'hydrogen-loc.molden' )
        #myInts.TI_OK = True # Only s functions

	nbas =  mol.nao_nr()
	natoms = mol.natm

	impAtom = np.zeros([natoms], dtype=int)
	for i in range(20):
	    impAtom[i] = 1

	ghost_frag = 1-impAtom
	ghost_env = 1-ghost_frag

	mol_frag = gto.Mole()
	mol_frag.atom = tools.add_ghost(mol.atom, ghost_frag)
	mol_frag.basis = bas
	mol_frag.build(max_memory = 16000,verbose = 4)
	'''
	mf_frag = dft.RKS(mol_frag)
        mf_frag.xc = 'pbe,pbe'
        mf_frag.smear_sigma = 0.00
        mf_frag.scf()
        P_frag=mf_frag.make_rdm1()
        cubegen.density(mol_frag, "h10_dens_1.cube", P_frag, nx=100, ny=100, nz=100)
	'''

	mol_env = gto.Mole()
	mol_env.atom = tools.add_ghost(mol.atom, ghost_env)
	mol_env.basis =  bas
	mol_env.build(max_memory = 16000,verbose = 4)

	'''
	mf_env = dft.RKS(mol_env)
        mf_env.xc = 'pbe,pbe'
        mf_env.smear_sigma = 0.00
        mf_env.scf()
        P_env=mf_env.make_rdm1()
        cubegen.density(mol_env, "h10_dens_2.cube", P_env, nx=100, ny=100, nz=100)
	exit()
	'''



	aoslice = mol.aoslice_by_atom()
	impurities = np.zeros([nbas], dtype = int)
	for i in range(natoms):
	    if(impAtom[i] == 1):
		impurities[aoslice[i,2]:aoslice[i,3]] = 1

	Ne_frag = 20
	boundary_atoms = np.zeros((natoms))
	boundary_atoms[20:40] = 1.0
	#boundary_atoms[19] = -1
	boundary_atoms2 = np.zeros((natoms),dtype =int)
	#boundary_atoms2[9] = -1
	boundary_atoms2[0:20] = 1

	boundary_atoms = None
	boundary_atoms2 =None

	umat=None
	P_frag=None
	P_env=None
	params = oep.OEPparams(algorithm = '2011', opt_method = 'L-BFGS-B', \
                       ftol = 1e-11, gtol = 1e-5,diffP_tol=1e-5, outer_maxit = 200, maxit = 200,l2_lambda = 0.0, oep_print = 0)
	theDMFET = sdmfet.DMFET( mf, mol_frag, mol_env,myInts,impurities, impAtom, Ne_frag, boundary_atoms=boundary_atoms, boundary_atoms2=boundary_atoms2,\
                         umat = umat, P_frag_ao = P_frag, P_env_ao = P_env, \
                         dim_imp = nbas, dim_bath=nbas, dim_big =nbas, smear_sigma = 0.005, oep_params=params,ecw_method='hf', mf_method = mf.xc)

	umat = theDMFET.embedding_potential()

	exit()

	#write subspace orbitals
	transfo = np.dot( myInts.ao2loc, theDMFET.loc2sub )
	filename =  'hydrogen-sub.molden'
	with open( filename, 'w' ) as thefile:
            molden.header( myInts.mol, thefile )
            molden.orbital_coeff( myInts.mol, thefile, transfo )


        umat = theDMFET.embedding_potential()
	print umat
	exit()
	energy = theDMFET.correction_energy()

#INFO: ******************** input file end ********************


System: ('Linux', 'tigercpu.princeton.edu', '3.10.0-693.21.1.el7.x86_64', '#1 SMP Wed Mar 7 15:59:45 EST 2018', 'x86_64', 'x86_64')  Threads 40
Python 2.7.14 |Anaconda, Inc.| (default, Oct 16 2017, 17:29:19) 
[GCC 7.2.0]
numpy 1.14.3  scipy 1.1.0
Date: Thu Jun  7 01:36:42 2018
PySCF version 1.4.2
PySCF path  /tigress/xingz/pyscf/pyscf
GIT ORIG_HEAD e0edd131499dcc18d035a120533a8a1ddda110d4
GIT HEAD      e0edd131499dcc18d035a120533a8a1ddda110d4

[INPUT] VERBOSE 4
[INPUT] num atoms = 30
[INPUT] num electrons = 120
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT]  1 Be    10.045110845181   0.000000000000   0.000000000000 AA   18.982508388290   0.000000000000   0.000000000000 Bohr
[INPUT]  2 Be     9.825601072319   2.088495980273   0.000000000000 AA   18.567695035915   3.946685414972   0.000000000000 Bohr
[INPUT]  3 Be     9.176665384131   4.085714664493   0.000000000000 AA   17.341384312785   7.720881739011   0.000000000000 Bohr
[INPUT]  4 Be     8.126665384131   5.904368012441   0.000000000000 AA   15.357171881992  11.157638482155   0.000000000000 Bohr
[INPUT]  5 Be     6.721491110778   7.464972145943   0.000000000000 AA   12.701777348069  14.106752883339   0.000000000000 Bohr
[INPUT]  6 Be     5.022555422590   8.699321175757   0.000000000000 AA    9.491254194145  16.439334491811   0.000000000000 Bohr
[INPUT]  7 Be     3.104109961541   9.553468126216   0.000000000000 AA    5.865917687847  18.053438298311   0.000000000000 Bohr
[INPUT]  8 Be     1.050000000000   9.990082676934   0.000000000000 AA    1.984212430793  18.878520221167   0.000000000000 Bohr
[INPUT]  9 Be    -1.050000000000   9.990082676934   0.000000000000 AA   -1.984212430793  18.878520221167   0.000000000000 Bohr
[INPUT] 10 Be    -3.104109961541   9.553468126216   0.000000000000 AA   -5.865917687847  18.053438298311   0.000000000000 Bohr
[INPUT] 11 Be    -5.022555422590   8.699321175757   0.000000000000 AA   -9.491254194145  16.439334491811   0.000000000000 Bohr
[INPUT] 12 Be    -6.721491110778   7.464972145943   0.000000000000 AA  -12.701777348069  14.106752883339   0.000000000000 Bohr
[INPUT] 13 Be    -8.126665384131   5.904368012441   0.000000000000 AA  -15.357171881992  11.157638482155   0.000000000000 Bohr
[INPUT] 14 Be    -9.176665384131   4.085714664493   0.000000000000 AA  -17.341384312785   7.720881739011   0.000000000000 Bohr
[INPUT] 15 Be    -9.825601072319   2.088495980273   0.000000000000 AA  -18.567695035915   3.946685414972   0.000000000000 Bohr
[INPUT] 16 Be   -10.045110845181   0.000000000000   0.000000000000 AA  -18.982508388290   0.000000000000   0.000000000000 Bohr
[INPUT] 17 Be    -9.825601072319  -2.088495980273   0.000000000000 AA  -18.567695035915  -3.946685414972   0.000000000000 Bohr
[INPUT] 18 Be    -9.176665384131  -4.085714664493   0.000000000000 AA  -17.341384312785  -7.720881739011   0.000000000000 Bohr
[INPUT] 19 Be    -8.126665384131  -5.904368012441   0.000000000000 AA  -15.357171881992 -11.157638482155   0.000000000000 Bohr
[INPUT] 20 Be    -6.721491110778  -7.464972145943   0.000000000000 AA  -12.701777348069 -14.106752883339   0.000000000000 Bohr
[INPUT] 21 Be    -5.022555422590  -8.699321175757   0.000000000000 AA   -9.491254194145 -16.439334491811   0.000000000000 Bohr
[INPUT] 22 Be    -3.104109961541  -9.553468126216   0.000000000000 AA   -5.865917687847 -18.053438298311   0.000000000000 Bohr
[INPUT] 23 Be    -1.050000000000  -9.990082676934   0.000000000000 AA   -1.984212430793 -18.878520221167   0.000000000000 Bohr
[INPUT] 24 Be     1.050000000000  -9.990082676934   0.000000000000 AA    1.984212430793 -18.878520221167   0.000000000000 Bohr
[INPUT] 25 Be     3.104109961541  -9.553468126216   0.000000000000 AA    5.865917687847 -18.053438298311   0.000000000000 Bohr
[INPUT] 26 Be     5.022555422590  -8.699321175757   0.000000000000 AA    9.491254194145 -16.439334491811   0.000000000000 Bohr
[INPUT] 27 Be     6.721491110778  -7.464972145943   0.000000000000 AA   12.701777348069 -14.106752883339   0.000000000000 Bohr
[INPUT] 28 Be     8.126665384131  -5.904368012441   0.000000000000 AA   15.357171881992 -11.157638482155   0.000000000000 Bohr
[INPUT] 29 Be     9.176665384131  -4.085714664493   0.000000000000 AA   17.341384312785  -7.720881739011   0.000000000000 Bohr
[INPUT] 30 Be     9.825601072319  -2.088495980273   0.000000000000 AA   18.567695035915  -3.946685414972   0.000000000000 Bohr
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [6    /1   ]  312.8704937       0.00916359628
                                57.36446253       0.04936149294
                                16.0485094        0.1685383049
                                5.513096119       0.3705627997
                                2.140896553       0.4164915298
                                0.8817394283      0.1303340841
[INPUT] 0    0    [6    /1   ]  13.63324744       -0.01325278809
                                2.698375464       -0.04699171014
                                0.8386530829      -0.03378537151
                                0.3226600698      0.2502417861
                                0.1401314882      0.5951172526
                                0.0642325139      0.2407061763
[INPUT] 1    0    [6    /1   ]  13.63324744       0.0037596966
                                2.698375464       0.0376793698
                                0.8386530829      0.1738967435
                                0.3226600698      0.4180364347
                                0.1401314882      0.4258595477
                                0.0642325139      0.1017082955
nuclear repulsion = 425.789392950728
number of shells = 90
number of NR pGTOs = 900
number of NR cGTOs = 150
basis = sto-6g
ecp = {}
CPU time:      1886.70


******** <class 'pyscf.dft.rks.RKS'> flags ********
method = RKS
initial guess = minao
damping factor = 0
level shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
DIIS start cycle = 1
DIIS space = 8
SCF tol = 1e-09
SCF gradient tol = None
max. SCF cycles = 100
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /tigress/xingz/pydmfet/examples/tmpFCa3hj
max_memory 16000 MB (current use 232 MB)
XC functionals = pbe,pbe
small_rho_cutoff = 1e-07
radial grids: Treutler-Ahlrichs (JCP 102, 346 (M4)) radial grids
becke partition: Becke, JCP, 88, 2547 (1988)
pruning grids: <function nwchem_prune at 0x2aac1c760cf8>
grids dens level: 3
symmetrized grids: False
atomic radii adjust function: <function treutler_atomic_radii_adjust at 0x2aac1c760b18>
Set gradient conv threshold to 3.16228e-05
tot grids = 393300
init E= -440.292134712912
HOMO: -0.19517004902178317 LUMO: -0.15738425806021797
-0.17848843945422765
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.999e+00 1.999e+00 1.990e+00
 1.990e+00 1.959e+00 1.959e+00 1.931e+00 2.895e-02 2.677e-02 2.087e-02
 2.087e-02 1.929e-02 1.929e-02 7.762e-03 7.762e-03 7.171e-03 7.171e-03
 1.476e-03 1.476e-03 1.360e-03 1.360e-03]
entropy corr =  -0.009164996599409805
cycle= 1 E= -439.041911168525  delta_E= 1.25  |g|= 0.0775  |ddm|= 7.96
HOMO: -0.06604408686882415 LUMO: -0.04561821695442031
-0.05841581037208741
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    1.996 1.996 1.958 1.958 1.789 1.789 1.643
 0.144 0.14  0.104 0.104 0.101 0.101 0.038 0.038 0.036 0.036 0.007 0.007
 0.006 0.006]
entropy corr =  -0.03170896043207456
cycle= 2 E= -439.042148828918  delta_E= -0.000238  |g|= 0.0605  |ddm|= 0.691
HOMO: -0.0714116056426707 LUMO: -0.05078614674224249
-0.06366848444855785
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    1.996 1.996 1.957 1.957 1.792 1.792 1.649
 0.141 0.138 0.102 0.102 0.099 0.099 0.038 0.038 0.036 0.036 0.007 0.007
 0.006 0.006]
entropy corr =  -0.03142352999197438
cycle= 3 E= -439.059775085717  delta_E= -0.0176  |g|= 0.00222  |ddm|= 0.316
HOMO: -0.0735714603193783 LUMO: -0.05243881595716527
-0.06558273674726951
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    1.996 1.996 1.959 1.959 1.801 1.801 1.663
 0.135 0.133 0.097 0.097 0.096 0.096 0.036 0.036 0.035 0.035 0.007 0.007
 0.006 0.006]
entropy corr =  -0.030501436011803818
cycle= 4 E= -439.059792740029  delta_E= -1.77e-05  |g|= 8.44e-05  |ddm|= 0.0172
HOMO: -0.0735046815983207 LUMO: -0.05239096724135821
-0.06552754848768126
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    1.996 1.996 1.959 1.959 1.8   1.8   1.663
 0.135 0.134 0.098 0.097 0.096 0.096 0.036 0.036 0.035 0.035 0.007 0.007
 0.006 0.006]
entropy corr =  -0.030544407844818867
cycle= 5 E= -439.059792752732  delta_E= -1.27e-08  |g|= 0.000138  |ddm|= 0.000814
HOMO: -0.07350492478312999 LUMO: -0.05239119166990513
-0.06552781908323738
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    1.996 1.996 1.959 1.959 1.8   1.8   1.663
 0.135 0.134 0.098 0.097 0.097 0.096 0.036 0.036 0.035 0.035 0.007 0.007
 0.006 0.006]
entropy corr =  -0.030544488550694988
cycle= 6 E= -439.059792656616  delta_E= 9.61e-08  |g|= 0.000356  |ddm|= 0.000711
HOMO: -0.07350575292603621 LUMO: -0.05239179065037244
-0.06552855787124535
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    1.996 1.996 1.959 1.959 1.8   1.8   1.663
 0.135 0.134 0.098 0.098 0.096 0.096 0.036 0.036 0.035 0.035 0.007 0.007
 0.006 0.006]
entropy corr =  -0.030544175517978025
cycle= 7 E= -439.059792769636  delta_E= -1.13e-07  |g|= 1.56e-06  |ddm|= 0.000514
HOMO: -0.07350576195863975 LUMO: -0.05239179612992563
-0.0655285647224853
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    1.996 1.996 1.959 1.959 1.8   1.8   1.663
 0.135 0.134 0.098 0.098 0.096 0.096 0.036 0.036 0.035 0.035 0.007 0.007
 0.006 0.006]
entropy corr =  -0.030544167480884264
cycle= 8 E= -439.059792769638  delta_E= -1.48e-12  |g|= 3.32e-07  |ddm|= 2.29e-06
HOMO: -0.07350578210920881 LUMO: -0.05239180932562864
-0.06552858061981472
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    1.996 1.996 1.959 1.959 1.8   1.8   1.663
 0.135 0.134 0.098 0.098 0.096 0.096 0.036 0.036 0.035 0.035 0.007 0.007
 0.006 0.006]
entropy corr =  -0.030544151840940916
Extra cycle  E= -439.059792769638  delta_E= -4.55e-13  |g|= 1.12e-06  |ddm|= 1.96e-06
converged SCF energy = -439.059792769638
e_mf =  -439.0597927696381
#INFO: **** input file is /tigress/xingz/pydmfet/examples/Be.py ****
from pydmfet import locints, sdmfet, oep, tools
from pyscf import gto, scf,dft, ao2mo,cc
import numpy as np
from pyscf.tools import molden, cubegen
import copy,time

DMguess  = None

bondlengths = np.arange(1.8, 4.1, 0.1)
energies = []

bas = 'sto-6g'

for bondlength in bondlengths:

    nat = 30
    mol = gto.Mole()
    mol.atom = []
    r = 0.5 * bondlength / np.sin(np.pi/nat)
    for i in range(nat):
        theta = i * (2*np.pi/nat)
        mol.atom.append(('Be', (r*np.cos(theta), r*np.sin(theta), 0)))

    mol.basis = bas
    mol.build(max_memory=16000, verbose=4)

    #mf = scf.RHF(mol)
    mf = dft.RKS(mol)
    mf.xc = 'pbe,pbe'
    mf.smear_sigma = 0.005
    mf.max_cycle = 100
    mf.scf()

    #P=mf.make_rdm1()
    #tools.MatPrint(P,"P_ref_ao")
    #cubegen.density(mol, "h20_dens.cube", P, nx=100, ny=100, nz=100)
    print 'e_mf = ',  mf.e_tot
    continue
    if ( True ):   
#        ENUCL = mf.mol.energy_nuc()
#        OEI   = np.dot(np.dot(mf.mo_coeff.T, mol.intor('cint1e_kin_sph') + mol.intor('cint1e_nuc_sph')), mf.mo_coeff)
#        TEI   = ao2mo.outcore.full_iofree(mol, mf.mo_coeff, compact=False).reshape(mol.nao_nr(), mol.nao_nr(), mol.nao_nr(), mol.nao_nr())
#        import chemps2
#        Energy, OneDM = chemps2.solve( ENUCL, OEI, OEI, TEI, mol.nao_nr(), mol.nelectron, mol.nao_nr(), 0.0, False )
#        print "bl =", bondlength," and energy =", Energy

        mycc = cc.CCSD(mf).run()
	et=0.0
        #et = mycc.ccsd_t()
        e_hf = mf.e_tot
        e_ccsd = e_hf + mycc.e_corr + et

        print 'e_tot = ', e_ccsd    #-4.96124910741
        
    else:
        myInts = locints.LocalIntegrals( mf, range( mol.nao_nr() ), 'meta_lowdin' )
        #myInts.loc_molden( 'hydrogen-loc.molden' )
        #myInts.TI_OK = True # Only s functions

	nbas =  mol.nao_nr()
	natoms = mol.natm

	impAtom = np.zeros([natoms], dtype=int)
	for i in range(20):
	    impAtom[i] = 1

	ghost_frag = 1-impAtom
	ghost_env = 1-ghost_frag

	mol_frag = gto.Mole()
	mol_frag.atom = tools.add_ghost(mol.atom, ghost_frag)
	mol_frag.basis = bas
	mol_frag.build(max_memory = 16000,verbose = 4)
	'''
	mf_frag = dft.RKS(mol_frag)
        mf_frag.xc = 'pbe,pbe'
        mf_frag.smear_sigma = 0.00
        mf_frag.scf()
        P_frag=mf_frag.make_rdm1()
        cubegen.density(mol_frag, "h10_dens_1.cube", P_frag, nx=100, ny=100, nz=100)
	'''

	mol_env = gto.Mole()
	mol_env.atom = tools.add_ghost(mol.atom, ghost_env)
	mol_env.basis =  bas
	mol_env.build(max_memory = 16000,verbose = 4)

	'''
	mf_env = dft.RKS(mol_env)
        mf_env.xc = 'pbe,pbe'
        mf_env.smear_sigma = 0.00
        mf_env.scf()
        P_env=mf_env.make_rdm1()
        cubegen.density(mol_env, "h10_dens_2.cube", P_env, nx=100, ny=100, nz=100)
	exit()
	'''



	aoslice = mol.aoslice_by_atom()
	impurities = np.zeros([nbas], dtype = int)
	for i in range(natoms):
	    if(impAtom[i] == 1):
		impurities[aoslice[i,2]:aoslice[i,3]] = 1

	Ne_frag = 20
	boundary_atoms = np.zeros((natoms))
	boundary_atoms[20:40] = 1.0
	#boundary_atoms[19] = -1
	boundary_atoms2 = np.zeros((natoms),dtype =int)
	#boundary_atoms2[9] = -1
	boundary_atoms2[0:20] = 1

	boundary_atoms = None
	boundary_atoms2 =None

	umat=None
	P_frag=None
	P_env=None
	params = oep.OEPparams(algorithm = '2011', opt_method = 'L-BFGS-B', \
                       ftol = 1e-11, gtol = 1e-5,diffP_tol=1e-5, outer_maxit = 200, maxit = 200,l2_lambda = 0.0, oep_print = 0)
	theDMFET = sdmfet.DMFET( mf, mol_frag, mol_env,myInts,impurities, impAtom, Ne_frag, boundary_atoms=boundary_atoms, boundary_atoms2=boundary_atoms2,\
                         umat = umat, P_frag_ao = P_frag, P_env_ao = P_env, \
                         dim_imp = nbas, dim_bath=nbas, dim_big =nbas, smear_sigma = 0.005, oep_params=params,ecw_method='hf', mf_method = mf.xc)

	umat = theDMFET.embedding_potential()

	exit()

	#write subspace orbitals
	transfo = np.dot( myInts.ao2loc, theDMFET.loc2sub )
	filename =  'hydrogen-sub.molden'
	with open( filename, 'w' ) as thefile:
            molden.header( myInts.mol, thefile )
            molden.orbital_coeff( myInts.mol, thefile, transfo )


        umat = theDMFET.embedding_potential()
	print umat
	exit()
	energy = theDMFET.correction_energy()

#INFO: ******************** input file end ********************


System: ('Linux', 'tigercpu.princeton.edu', '3.10.0-693.21.1.el7.x86_64', '#1 SMP Wed Mar 7 15:59:45 EST 2018', 'x86_64', 'x86_64')  Threads 40
Python 2.7.14 |Anaconda, Inc.| (default, Oct 16 2017, 17:29:19) 
[GCC 7.2.0]
numpy 1.14.3  scipy 1.1.0
Date: Thu Jun  7 01:36:58 2018
PySCF version 1.4.2
PySCF path  /tigress/xingz/pyscf/pyscf
GIT ORIG_HEAD e0edd131499dcc18d035a120533a8a1ddda110d4
GIT HEAD      e0edd131499dcc18d035a120533a8a1ddda110d4

[INPUT] VERBOSE 4
[INPUT] num atoms = 30
[INPUT] num electrons = 120
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT]  1 Be    10.523449456856   0.000000000000   0.000000000000 AA   19.886437359161   0.000000000000   0.000000000000 Bohr
[INPUT]  2 Be    10.293486837667   2.187948169810   0.000000000000 AA   19.451870990007   4.134622815685   0.000000000000 Bohr
[INPUT]  3 Be     9.613649450042   4.280272505660   0.000000000000 AA   18.167164518156   8.088542774202   0.000000000000 Bohr
[INPUT]  4 Be     8.513649450042   6.185528393985   0.000000000000 AA   16.088465781134  11.688954600353   0.000000000000 Bohr
[INPUT]  5 Be     7.041562116053   7.820447010036   0.000000000000 AA   13.306623888453  14.778503020641   0.000000000000 Bohr
[INPUT]  6 Be     5.261724728428   9.113574565079   0.000000000000 AA    9.943218679581  17.222159943801   0.000000000000 Bohr
[INPUT]  7 Be     3.251924721614  10.008395179846   0.000000000000 AA    6.145247101554  18.913125836326   0.000000000000 Bohr
[INPUT]  8 Be     1.100000000000  10.465800899645   0.000000000000 AA    2.078698737022  19.777497374555   0.000000000000 Bohr
[INPUT]  9 Be    -1.100000000000  10.465800899645   0.000000000000 AA   -2.078698737022  19.777497374555   0.000000000000 Bohr
[INPUT] 10 Be    -3.251924721614  10.008395179846   0.000000000000 AA   -6.145247101554  18.913125836326   0.000000000000 Bohr
[INPUT] 11 Be    -5.261724728428   9.113574565079   0.000000000000 AA   -9.943218679581  17.222159943801   0.000000000000 Bohr
[INPUT] 12 Be    -7.041562116053   7.820447010036   0.000000000000 AA  -13.306623888453  14.778503020641   0.000000000000 Bohr
[INPUT] 13 Be    -8.513649450042   6.185528393985   0.000000000000 AA  -16.088465781134  11.688954600353   0.000000000000 Bohr
[INPUT] 14 Be    -9.613649450042   4.280272505660   0.000000000000 AA  -18.167164518156   8.088542774202   0.000000000000 Bohr
[INPUT] 15 Be   -10.293486837667   2.187948169810   0.000000000000 AA  -19.451870990007   4.134622815685   0.000000000000 Bohr
[INPUT] 16 Be   -10.523449456856   0.000000000000   0.000000000000 AA  -19.886437359161   0.000000000000   0.000000000000 Bohr
[INPUT] 17 Be   -10.293486837667  -2.187948169810   0.000000000000 AA  -19.451870990007  -4.134622815685   0.000000000000 Bohr
[INPUT] 18 Be    -9.613649450042  -4.280272505660   0.000000000000 AA  -18.167164518156  -8.088542774202   0.000000000000 Bohr
[INPUT] 19 Be    -8.513649450042  -6.185528393985   0.000000000000 AA  -16.088465781134 -11.688954600353   0.000000000000 Bohr
[INPUT] 20 Be    -7.041562116053  -7.820447010036   0.000000000000 AA  -13.306623888453 -14.778503020641   0.000000000000 Bohr
[INPUT] 21 Be    -5.261724728428  -9.113574565079   0.000000000000 AA   -9.943218679581 -17.222159943801   0.000000000000 Bohr
[INPUT] 22 Be    -3.251924721614 -10.008395179846   0.000000000000 AA   -6.145247101554 -18.913125836326   0.000000000000 Bohr
[INPUT] 23 Be    -1.100000000000 -10.465800899645   0.000000000000 AA   -2.078698737022 -19.777497374555   0.000000000000 Bohr
[INPUT] 24 Be     1.100000000000 -10.465800899645   0.000000000000 AA    2.078698737022 -19.777497374555   0.000000000000 Bohr
[INPUT] 25 Be     3.251924721614 -10.008395179846   0.000000000000 AA    6.145247101554 -18.913125836326   0.000000000000 Bohr
[INPUT] 26 Be     5.261724728428  -9.113574565079   0.000000000000 AA    9.943218679581 -17.222159943801   0.000000000000 Bohr
[INPUT] 27 Be     7.041562116053  -7.820447010036   0.000000000000 AA   13.306623888453 -14.778503020641   0.000000000000 Bohr
[INPUT] 28 Be     8.513649450042  -6.185528393985   0.000000000000 AA   16.088465781134 -11.688954600353   0.000000000000 Bohr
[INPUT] 29 Be     9.613649450042  -4.280272505660   0.000000000000 AA   18.167164518156  -8.088542774202   0.000000000000 Bohr
[INPUT] 30 Be    10.293486837667  -2.187948169810   0.000000000000 AA   19.451870990007  -4.134622815685   0.000000000000 Bohr
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [6    /1   ]  312.8704937       0.00916359628
                                57.36446253       0.04936149294
                                16.0485094        0.1685383049
                                5.513096119       0.3705627997
                                2.140896553       0.4164915298
                                0.8817394283      0.1303340841
[INPUT] 0    0    [6    /1   ]  13.63324744       -0.01325278809
                                2.698375464       -0.04699171014
                                0.8386530829      -0.03378537151
                                0.3226600698      0.2502417861
                                0.1401314882      0.5951172526
                                0.0642325139      0.2407061763
[INPUT] 1    0    [6    /1   ]  13.63324744       0.0037596966
                                2.698375464       0.0376793698
                                0.8386530829      0.1738967435
                                0.3226600698      0.4180364347
                                0.1401314882      0.4258595477
                                0.0642325139      0.1017082955
nuclear repulsion = 406.435329634786
number of shells = 90
number of NR pGTOs = 900
number of NR cGTOs = 150
basis = sto-6g
ecp = {}
CPU time:      2326.27


******** <class 'pyscf.dft.rks.RKS'> flags ********
method = RKS
initial guess = minao
damping factor = 0
level shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
DIIS start cycle = 1
DIIS space = 8
SCF tol = 1e-09
SCF gradient tol = None
max. SCF cycles = 100
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /tigress/xingz/pydmfet/examples/tmp0YnlqI
max_memory 16000 MB (current use 232 MB)
XC functionals = pbe,pbe
small_rho_cutoff = 1e-07
radial grids: Treutler-Ahlrichs (JCP 102, 346 (M4)) radial grids
becke partition: Becke, JCP, 88, 2547 (1988)
pruning grids: <function nwchem_prune at 0x2aac1c760cf8>
grids dens level: 3
symmetrized grids: False
atomic radii adjust function: <function treutler_atomic_radii_adjust at 0x2aac1c760b18>
Set gradient conv threshold to 3.16228e-05
tot grids = 393300
init E= -439.78837057811
HOMO: -0.187703171472328 LUMO: -0.14420591645057687
-0.16833643082275498
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.999e+00 1.999e+00 1.995e+00
 1.995e+00 1.976e+00 1.976e+00 1.959e+00 1.591e-02 1.499e-02 1.176e-02
 1.176e-02 1.109e-02 1.109e-02 4.742e-03 4.742e-03 4.467e-03 4.467e-03
 1.038e-03 1.038e-03]
entropy corr =  -0.005860784568234847
cycle= 1 E= -439.013145671336  delta_E= 0.775  |g|= 0.0691  |ddm|= 7.79
HOMO: -0.06761488353825398 LUMO: -0.03940478256176259
-0.05616266246007642
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    1.998 1.998 1.981 1.981 1.898 1.898 1.816
 0.068 0.067 0.05  0.05  0.049 0.049 0.02  0.02  0.019 0.019 0.004 0.004
 0.004 0.004]
entropy corr =  -0.018732662260463877
cycle= 2 E= -439.01266528814  delta_E= 0.00048  |g|= 0.0542  |ddm|= 0.616
HOMO: -0.07187108537189377 LUMO: -0.043599864962467885
-0.060383284258248446
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    1.998 1.998 1.981 1.981 1.898 1.898 1.817
 0.067 0.067 0.05  0.05  0.049 0.049 0.02  0.02  0.019 0.019 0.004 0.004
 0.004 0.004]
entropy corr =  -0.018726680615956677
cycle= 3 E= -439.027211804443  delta_E= -0.0145  |g|= 0.00166  |ddm|= 0.299
HOMO: -0.07307754916377826 LUMO: -0.04456301542243466
-0.06147205394952318
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    1.998 1.998 1.981 1.981 1.9   1.9   1.821
 0.066 0.065 0.048 0.048 0.048 0.048 0.019 0.019 0.019 0.019 0.004 0.004
 0.004 0.004]
entropy corr =  -0.01842486305906863
cycle= 4 E= -439.027218914618  delta_E= -7.11e-06  |g|= 2.76e-05  |ddm|= 0.00761
HOMO: -0.07307703962601747 LUMO: -0.04456923621050339
-0.061473843548187745
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    1.998 1.998 1.981 1.981 1.9   1.9   1.821
 0.066 0.065 0.048 0.048 0.048 0.048 0.019 0.019 0.019 0.019 0.004 0.004
 0.004 0.004]
entropy corr =  -0.01843063532730655
cycle= 5 E= -439.027218916916  delta_E= -2.3e-09  |g|= 4.73e-06  |ddm|= 0.000163
HOMO: -0.0730775456375972 LUMO: -0.0445694293685298
-0.061474217862254356
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    1.998 1.998 1.981 1.981 1.9   1.9   1.821
 0.066 0.065 0.048 0.048 0.048 0.048 0.019 0.019 0.019 0.019 0.004 0.004
 0.004 0.004]
entropy corr =  -0.01843030261222183
cycle= 6 E= -439.027218916814  delta_E= 1.02e-10  |g|= 1.14e-05  |ddm|= 2.48e-05
HOMO: -0.07307764583220772 LUMO: -0.0445694672068213
-0.061474291563315735
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    1.998 1.998 1.981 1.981 1.9   1.9   1.821
 0.066 0.065 0.048 0.048 0.048 0.048 0.019 0.019 0.019 0.019 0.004 0.004
 0.004 0.004]
entropy corr =  -0.018430235266500842
Extra cycle  E= -439.027218915457  delta_E= 1.36e-09  |g|= 3.91e-05  |ddm|= 7.54e-05
converged SCF energy = -439.027218915457
e_mf =  -439.0272189154574
#INFO: **** input file is /tigress/xingz/pydmfet/examples/Be.py ****
from pydmfet import locints, sdmfet, oep, tools
from pyscf import gto, scf,dft, ao2mo,cc
import numpy as np
from pyscf.tools import molden, cubegen
import copy,time

DMguess  = None

bondlengths = np.arange(1.8, 4.1, 0.1)
energies = []

bas = 'sto-6g'

for bondlength in bondlengths:

    nat = 30
    mol = gto.Mole()
    mol.atom = []
    r = 0.5 * bondlength / np.sin(np.pi/nat)
    for i in range(nat):
        theta = i * (2*np.pi/nat)
        mol.atom.append(('Be', (r*np.cos(theta), r*np.sin(theta), 0)))

    mol.basis = bas
    mol.build(max_memory=16000, verbose=4)

    #mf = scf.RHF(mol)
    mf = dft.RKS(mol)
    mf.xc = 'pbe,pbe'
    mf.smear_sigma = 0.005
    mf.max_cycle = 100
    mf.scf()

    #P=mf.make_rdm1()
    #tools.MatPrint(P,"P_ref_ao")
    #cubegen.density(mol, "h20_dens.cube", P, nx=100, ny=100, nz=100)
    print 'e_mf = ',  mf.e_tot
    continue
    if ( True ):   
#        ENUCL = mf.mol.energy_nuc()
#        OEI   = np.dot(np.dot(mf.mo_coeff.T, mol.intor('cint1e_kin_sph') + mol.intor('cint1e_nuc_sph')), mf.mo_coeff)
#        TEI   = ao2mo.outcore.full_iofree(mol, mf.mo_coeff, compact=False).reshape(mol.nao_nr(), mol.nao_nr(), mol.nao_nr(), mol.nao_nr())
#        import chemps2
#        Energy, OneDM = chemps2.solve( ENUCL, OEI, OEI, TEI, mol.nao_nr(), mol.nelectron, mol.nao_nr(), 0.0, False )
#        print "bl =", bondlength," and energy =", Energy

        mycc = cc.CCSD(mf).run()
	et=0.0
        #et = mycc.ccsd_t()
        e_hf = mf.e_tot
        e_ccsd = e_hf + mycc.e_corr + et

        print 'e_tot = ', e_ccsd    #-4.96124910741
        
    else:
        myInts = locints.LocalIntegrals( mf, range( mol.nao_nr() ), 'meta_lowdin' )
        #myInts.loc_molden( 'hydrogen-loc.molden' )
        #myInts.TI_OK = True # Only s functions

	nbas =  mol.nao_nr()
	natoms = mol.natm

	impAtom = np.zeros([natoms], dtype=int)
	for i in range(20):
	    impAtom[i] = 1

	ghost_frag = 1-impAtom
	ghost_env = 1-ghost_frag

	mol_frag = gto.Mole()
	mol_frag.atom = tools.add_ghost(mol.atom, ghost_frag)
	mol_frag.basis = bas
	mol_frag.build(max_memory = 16000,verbose = 4)
	'''
	mf_frag = dft.RKS(mol_frag)
        mf_frag.xc = 'pbe,pbe'
        mf_frag.smear_sigma = 0.00
        mf_frag.scf()
        P_frag=mf_frag.make_rdm1()
        cubegen.density(mol_frag, "h10_dens_1.cube", P_frag, nx=100, ny=100, nz=100)
	'''

	mol_env = gto.Mole()
	mol_env.atom = tools.add_ghost(mol.atom, ghost_env)
	mol_env.basis =  bas
	mol_env.build(max_memory = 16000,verbose = 4)

	'''
	mf_env = dft.RKS(mol_env)
        mf_env.xc = 'pbe,pbe'
        mf_env.smear_sigma = 0.00
        mf_env.scf()
        P_env=mf_env.make_rdm1()
        cubegen.density(mol_env, "h10_dens_2.cube", P_env, nx=100, ny=100, nz=100)
	exit()
	'''



	aoslice = mol.aoslice_by_atom()
	impurities = np.zeros([nbas], dtype = int)
	for i in range(natoms):
	    if(impAtom[i] == 1):
		impurities[aoslice[i,2]:aoslice[i,3]] = 1

	Ne_frag = 20
	boundary_atoms = np.zeros((natoms))
	boundary_atoms[20:40] = 1.0
	#boundary_atoms[19] = -1
	boundary_atoms2 = np.zeros((natoms),dtype =int)
	#boundary_atoms2[9] = -1
	boundary_atoms2[0:20] = 1

	boundary_atoms = None
	boundary_atoms2 =None

	umat=None
	P_frag=None
	P_env=None
	params = oep.OEPparams(algorithm = '2011', opt_method = 'L-BFGS-B', \
                       ftol = 1e-11, gtol = 1e-5,diffP_tol=1e-5, outer_maxit = 200, maxit = 200,l2_lambda = 0.0, oep_print = 0)
	theDMFET = sdmfet.DMFET( mf, mol_frag, mol_env,myInts,impurities, impAtom, Ne_frag, boundary_atoms=boundary_atoms, boundary_atoms2=boundary_atoms2,\
                         umat = umat, P_frag_ao = P_frag, P_env_ao = P_env, \
                         dim_imp = nbas, dim_bath=nbas, dim_big =nbas, smear_sigma = 0.005, oep_params=params,ecw_method='hf', mf_method = mf.xc)

	umat = theDMFET.embedding_potential()

	exit()

	#write subspace orbitals
	transfo = np.dot( myInts.ao2loc, theDMFET.loc2sub )
	filename =  'hydrogen-sub.molden'
	with open( filename, 'w' ) as thefile:
            molden.header( myInts.mol, thefile )
            molden.orbital_coeff( myInts.mol, thefile, transfo )


        umat = theDMFET.embedding_potential()
	print umat
	exit()
	energy = theDMFET.correction_energy()

#INFO: ******************** input file end ********************


System: ('Linux', 'tigercpu.princeton.edu', '3.10.0-693.21.1.el7.x86_64', '#1 SMP Wed Mar 7 15:59:45 EST 2018', 'x86_64', 'x86_64')  Threads 40
Python 2.7.14 |Anaconda, Inc.| (default, Oct 16 2017, 17:29:19) 
[GCC 7.2.0]
numpy 1.14.3  scipy 1.1.0
Date: Thu Jun  7 01:37:11 2018
PySCF version 1.4.2
PySCF path  /tigress/xingz/pyscf/pyscf
GIT ORIG_HEAD e0edd131499dcc18d035a120533a8a1ddda110d4
GIT HEAD      e0edd131499dcc18d035a120533a8a1ddda110d4

[INPUT] VERBOSE 4
[INPUT] num atoms = 30
[INPUT] num electrons = 120
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT]  1 Be    11.001788068531   0.000000000000   0.000000000000 AA   20.790366330032   0.000000000000   0.000000000000 Bohr
[INPUT]  2 Be    10.761372603016   2.287400359347   0.000000000000 AA   20.336046944098   4.322560216398   0.000000000000 Bohr
[INPUT]  3 Be    10.050633515953   4.474830346826   0.000000000000 AA   18.992944723527   8.456203809393   0.000000000000 Bohr
[INPUT]  4 Be     8.900633515953   6.466688775530   0.000000000000 AA   16.819759680277  12.220270718551   0.000000000000 Bohr
[INPUT]  5 Be     7.361633121328   8.175921874128   0.000000000000 AA   13.911470428837  15.450253157943   0.000000000000 Bohr
[INPUT]  6 Be     5.500894034266   9.527827954401   0.000000000000 AA   10.395183165016  18.004985395792   0.000000000000 Bohr
[INPUT]  7 Be     3.399739481688  10.463322233475   0.000000000000 AA    6.424576515261  19.772813374340   0.000000000000 Bohr
[INPUT]  8 Be     1.150000000000  10.941519122356   0.000000000000 AA    2.173185043250  20.676474527944   0.000000000000 Bohr
[INPUT]  9 Be    -1.150000000000  10.941519122356   0.000000000000 AA   -2.173185043250  20.676474527944   0.000000000000 Bohr
[INPUT] 10 Be    -3.399739481688  10.463322233475   0.000000000000 AA   -6.424576515261  19.772813374340   0.000000000000 Bohr
[INPUT] 11 Be    -5.500894034266   9.527827954401   0.000000000000 AA  -10.395183165016  18.004985395792   0.000000000000 Bohr
[INPUT] 12 Be    -7.361633121328   8.175921874128   0.000000000000 AA  -13.911470428837  15.450253157943   0.000000000000 Bohr
[INPUT] 13 Be    -8.900633515953   6.466688775530   0.000000000000 AA  -16.819759680277  12.220270718551   0.000000000000 Bohr
[INPUT] 14 Be   -10.050633515953   4.474830346826   0.000000000000 AA  -18.992944723527   8.456203809393   0.000000000000 Bohr
[INPUT] 15 Be   -10.761372603016   2.287400359347   0.000000000000 AA  -20.336046944098   4.322560216398   0.000000000000 Bohr
[INPUT] 16 Be   -11.001788068531   0.000000000000   0.000000000000 AA  -20.790366330032   0.000000000000   0.000000000000 Bohr
[INPUT] 17 Be   -10.761372603016  -2.287400359347   0.000000000000 AA  -20.336046944098  -4.322560216398   0.000000000000 Bohr
[INPUT] 18 Be   -10.050633515953  -4.474830346826   0.000000000000 AA  -18.992944723527  -8.456203809393   0.000000000000 Bohr
[INPUT] 19 Be    -8.900633515953  -6.466688775530   0.000000000000 AA  -16.819759680277 -12.220270718551   0.000000000000 Bohr
[INPUT] 20 Be    -7.361633121328  -8.175921874128   0.000000000000 AA  -13.911470428837 -15.450253157943   0.000000000000 Bohr
[INPUT] 21 Be    -5.500894034266  -9.527827954401   0.000000000000 AA  -10.395183165016 -18.004985395792   0.000000000000 Bohr
[INPUT] 22 Be    -3.399739481688 -10.463322233475   0.000000000000 AA   -6.424576515261 -19.772813374340   0.000000000000 Bohr
[INPUT] 23 Be    -1.150000000000 -10.941519122356   0.000000000000 AA   -2.173185043250 -20.676474527944   0.000000000000 Bohr
[INPUT] 24 Be     1.150000000000 -10.941519122356   0.000000000000 AA    2.173185043250 -20.676474527944   0.000000000000 Bohr
[INPUT] 25 Be     3.399739481688 -10.463322233475   0.000000000000 AA    6.424576515261 -19.772813374340   0.000000000000 Bohr
[INPUT] 26 Be     5.500894034266  -9.527827954401   0.000000000000 AA   10.395183165016 -18.004985395792   0.000000000000 Bohr
[INPUT] 27 Be     7.361633121328  -8.175921874128   0.000000000000 AA   13.911470428837 -15.450253157943   0.000000000000 Bohr
[INPUT] 28 Be     8.900633515953  -6.466688775530   0.000000000000 AA   16.819759680277 -12.220270718551   0.000000000000 Bohr
[INPUT] 29 Be    10.050633515953  -4.474830346826   0.000000000000 AA   18.992944723527  -8.456203809393   0.000000000000 Bohr
[INPUT] 30 Be    10.761372603016  -2.287400359347   0.000000000000 AA   20.336046944098  -4.322560216398   0.000000000000 Bohr
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [6    /1   ]  312.8704937       0.00916359628
                                57.36446253       0.04936149294
                                16.0485094        0.1685383049
                                5.513096119       0.3705627997
                                2.140896553       0.4164915298
                                0.8817394283      0.1303340841
[INPUT] 0    0    [6    /1   ]  13.63324744       -0.01325278809
                                2.698375464       -0.04699171014
                                0.8386530829      -0.03378537151
                                0.3226600698      0.2502417861
                                0.1401314882      0.5951172526
                                0.0642325139      0.2407061763
[INPUT] 1    0    [6    /1   ]  13.63324744       0.0037596966
                                2.698375464       0.0376793698
                                0.8386530829      0.1738967435
                                0.3226600698      0.4180364347
                                0.1401314882      0.4258595477
                                0.0642325139      0.1017082955
nuclear repulsion = 388.764228346317
number of shells = 90
number of NR pGTOs = 900
number of NR cGTOs = 150
basis = sto-6g
ecp = {}
CPU time:      2693.33


******** <class 'pyscf.dft.rks.RKS'> flags ********
method = RKS
initial guess = minao
damping factor = 0
level shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
DIIS start cycle = 1
DIIS space = 8
SCF tol = 1e-09
SCF gradient tol = None
max. SCF cycles = 100
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /tigress/xingz/pydmfet/examples/tmp6JrNxb
max_memory 16000 MB (current use 231 MB)
XC functionals = pbe,pbe
small_rho_cutoff = 1e-07
radial grids: Treutler-Ahlrichs (JCP 102, 346 (M4)) radial grids
becke partition: Becke, JCP, 88, 2547 (1988)
pruning grids: <function nwchem_prune at 0x2aac1c760cf8>
grids dens level: 3
symmetrized grids: False
atomic radii adjust function: <function treutler_atomic_radii_adjust at 0x2aac1c760b18>
Set gradient conv threshold to 3.16228e-05
tot grids = 393300
init E= -439.338384407811
HOMO: -0.18050109303457698 LUMO: -0.13243698882486424
-0.15903917940733572
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    1.997 1.997 1.985 1.985 1.973
 0.01  0.009 0.007 0.007 0.007 0.007 0.003 0.003 0.003 0.003]
entropy corr =  -0.004067917597258107
cycle= 1 E= -438.918084284199  delta_E= 0.42  |g|= 0.068  |ddm|= 7.64
HOMO: -0.06850572991948005 LUMO: -0.034013110486220105
-0.05405771562134181
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    1.999 1.999 1.991 1.991 1.945 1.945 1.895
 0.036 0.036 0.027 0.027 0.027 0.027 0.011 0.011 0.011 0.011 0.003 0.003
 0.003 0.003]
entropy corr =  -0.011807213309436659
cycle= 2 E= -438.917876750841  delta_E= 0.000208  |g|= 0.0514  |ddm|= 0.587
HOMO: -0.07215570192719382 LUMO: -0.037658291328827434
-0.05768925258261973
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    1.999 1.999 1.99  1.99  1.944 1.944 1.895
 0.036 0.036 0.027 0.027 0.027 0.027 0.011 0.011 0.011 0.011 0.003 0.003
 0.003 0.003]
entropy corr =  -0.011828570654506177
cycle= 3 E= -438.930097431816  delta_E= -0.0122  |g|= 0.00154  |ddm|= 0.286
HOMO: -0.07292834666039928 LUMO: -0.038330980626047374
-0.058395557267621835
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    1.999 1.999 1.991 1.991 1.945 1.945 1.896
 0.036 0.035 0.027 0.027 0.026 0.026 0.011 0.011 0.011 0.011 0.003 0.003
 0.003 0.003]
entropy corr =  -0.011713507804194334
cycle= 4 E= -438.930103335734  delta_E= -5.9e-06  |g|= 1.82e-05  |ddm|= 0.00639
HOMO: -0.07294235744149691 LUMO: -0.038347589264796686
-0.05840992392509227
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    1.999 1.999 1.991 1.991 1.945 1.945 1.896
 0.036 0.035 0.027 0.027 0.026 0.026 0.011 0.011 0.011 0.011 0.003 0.003
 0.003 0.003]
entropy corr =  -0.01171407036244015
cycle= 5 E= -438.930103336793  delta_E= -1.06e-09  |g|= 3.23e-07  |ddm|= 9.16e-05
HOMO: -0.07294235806854128 LUMO: -0.03834748313563926
-0.05840988557573811
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    1.999 1.999 1.991 1.991 1.945 1.945 1.896
 0.036 0.035 0.027 0.027 0.026 0.026 0.011 0.011 0.011 0.011 0.003 0.003
 0.003 0.003]
entropy corr =  -0.01171400445044704
cycle= 6 E= -438.930103336793  delta_E= -6.82e-13  |g|= 7.89e-08  |ddm|= 2.18e-06
HOMO: -0.07294235584850456 LUMO: -0.03834748021269849
-0.05840988319305313
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    1.999 1.999 1.991 1.991 1.945 1.945 1.896
 0.036 0.035 0.027 0.027 0.026 0.026 0.011 0.011 0.011 0.011 0.003 0.003
 0.003 0.003]
entropy corr =  -0.01171400420207765
Extra cycle  E= -438.930103336793  delta_E= 4.55e-13  |g|= 9.86e-08  |ddm|= 5.33e-07
converged SCF energy = -438.930103336793
e_mf =  -438.93010333679285
#INFO: **** input file is /tigress/xingz/pydmfet/examples/Be.py ****
from pydmfet import locints, sdmfet, oep, tools
from pyscf import gto, scf,dft, ao2mo,cc
import numpy as np
from pyscf.tools import molden, cubegen
import copy,time

DMguess  = None

bondlengths = np.arange(1.8, 4.1, 0.1)
energies = []

bas = 'sto-6g'

for bondlength in bondlengths:

    nat = 30
    mol = gto.Mole()
    mol.atom = []
    r = 0.5 * bondlength / np.sin(np.pi/nat)
    for i in range(nat):
        theta = i * (2*np.pi/nat)
        mol.atom.append(('Be', (r*np.cos(theta), r*np.sin(theta), 0)))

    mol.basis = bas
    mol.build(max_memory=16000, verbose=4)

    #mf = scf.RHF(mol)
    mf = dft.RKS(mol)
    mf.xc = 'pbe,pbe'
    mf.smear_sigma = 0.005
    mf.max_cycle = 100
    mf.scf()

    #P=mf.make_rdm1()
    #tools.MatPrint(P,"P_ref_ao")
    #cubegen.density(mol, "h20_dens.cube", P, nx=100, ny=100, nz=100)
    print 'e_mf = ',  mf.e_tot
    continue
    if ( True ):   
#        ENUCL = mf.mol.energy_nuc()
#        OEI   = np.dot(np.dot(mf.mo_coeff.T, mol.intor('cint1e_kin_sph') + mol.intor('cint1e_nuc_sph')), mf.mo_coeff)
#        TEI   = ao2mo.outcore.full_iofree(mol, mf.mo_coeff, compact=False).reshape(mol.nao_nr(), mol.nao_nr(), mol.nao_nr(), mol.nao_nr())
#        import chemps2
#        Energy, OneDM = chemps2.solve( ENUCL, OEI, OEI, TEI, mol.nao_nr(), mol.nelectron, mol.nao_nr(), 0.0, False )
#        print "bl =", bondlength," and energy =", Energy

        mycc = cc.CCSD(mf).run()
	et=0.0
        #et = mycc.ccsd_t()
        e_hf = mf.e_tot
        e_ccsd = e_hf + mycc.e_corr + et

        print 'e_tot = ', e_ccsd    #-4.96124910741
        
    else:
        myInts = locints.LocalIntegrals( mf, range( mol.nao_nr() ), 'meta_lowdin' )
        #myInts.loc_molden( 'hydrogen-loc.molden' )
        #myInts.TI_OK = True # Only s functions

	nbas =  mol.nao_nr()
	natoms = mol.natm

	impAtom = np.zeros([natoms], dtype=int)
	for i in range(20):
	    impAtom[i] = 1

	ghost_frag = 1-impAtom
	ghost_env = 1-ghost_frag

	mol_frag = gto.Mole()
	mol_frag.atom = tools.add_ghost(mol.atom, ghost_frag)
	mol_frag.basis = bas
	mol_frag.build(max_memory = 16000,verbose = 4)
	'''
	mf_frag = dft.RKS(mol_frag)
        mf_frag.xc = 'pbe,pbe'
        mf_frag.smear_sigma = 0.00
        mf_frag.scf()
        P_frag=mf_frag.make_rdm1()
        cubegen.density(mol_frag, "h10_dens_1.cube", P_frag, nx=100, ny=100, nz=100)
	'''

	mol_env = gto.Mole()
	mol_env.atom = tools.add_ghost(mol.atom, ghost_env)
	mol_env.basis =  bas
	mol_env.build(max_memory = 16000,verbose = 4)

	'''
	mf_env = dft.RKS(mol_env)
        mf_env.xc = 'pbe,pbe'
        mf_env.smear_sigma = 0.00
        mf_env.scf()
        P_env=mf_env.make_rdm1()
        cubegen.density(mol_env, "h10_dens_2.cube", P_env, nx=100, ny=100, nz=100)
	exit()
	'''



	aoslice = mol.aoslice_by_atom()
	impurities = np.zeros([nbas], dtype = int)
	for i in range(natoms):
	    if(impAtom[i] == 1):
		impurities[aoslice[i,2]:aoslice[i,3]] = 1

	Ne_frag = 20
	boundary_atoms = np.zeros((natoms))
	boundary_atoms[20:40] = 1.0
	#boundary_atoms[19] = -1
	boundary_atoms2 = np.zeros((natoms),dtype =int)
	#boundary_atoms2[9] = -1
	boundary_atoms2[0:20] = 1

	boundary_atoms = None
	boundary_atoms2 =None

	umat=None
	P_frag=None
	P_env=None
	params = oep.OEPparams(algorithm = '2011', opt_method = 'L-BFGS-B', \
                       ftol = 1e-11, gtol = 1e-5,diffP_tol=1e-5, outer_maxit = 200, maxit = 200,l2_lambda = 0.0, oep_print = 0)
	theDMFET = sdmfet.DMFET( mf, mol_frag, mol_env,myInts,impurities, impAtom, Ne_frag, boundary_atoms=boundary_atoms, boundary_atoms2=boundary_atoms2,\
                         umat = umat, P_frag_ao = P_frag, P_env_ao = P_env, \
                         dim_imp = nbas, dim_bath=nbas, dim_big =nbas, smear_sigma = 0.005, oep_params=params,ecw_method='hf', mf_method = mf.xc)

	umat = theDMFET.embedding_potential()

	exit()

	#write subspace orbitals
	transfo = np.dot( myInts.ao2loc, theDMFET.loc2sub )
	filename =  'hydrogen-sub.molden'
	with open( filename, 'w' ) as thefile:
            molden.header( myInts.mol, thefile )
            molden.orbital_coeff( myInts.mol, thefile, transfo )


        umat = theDMFET.embedding_potential()
	print umat
	exit()
	energy = theDMFET.correction_energy()

#INFO: ******************** input file end ********************


System: ('Linux', 'tigercpu.princeton.edu', '3.10.0-693.21.1.el7.x86_64', '#1 SMP Wed Mar 7 15:59:45 EST 2018', 'x86_64', 'x86_64')  Threads 40
Python 2.7.14 |Anaconda, Inc.| (default, Oct 16 2017, 17:29:19) 
[GCC 7.2.0]
numpy 1.14.3  scipy 1.1.0
Date: Thu Jun  7 01:37:24 2018
PySCF version 1.4.2
PySCF path  /tigress/xingz/pyscf/pyscf
GIT ORIG_HEAD e0edd131499dcc18d035a120533a8a1ddda110d4
GIT HEAD      e0edd131499dcc18d035a120533a8a1ddda110d4

[INPUT] VERBOSE 4
[INPUT] num atoms = 30
[INPUT] num electrons = 120
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT]  1 Be    11.480126680207   0.000000000000   0.000000000000 AA   21.694295300903   0.000000000000   0.000000000000 Bohr
[INPUT]  2 Be    11.229258368364   2.386852548884   0.000000000000 AA   21.220222898189   4.510497617111   0.000000000000 Bohr
[INPUT]  3 Be    10.487617581865   4.669388187992   0.000000000000 AA   19.818724928897   8.823864844584   0.000000000000 Bohr
[INPUT]  4 Be     9.287617581865   6.747849157075   0.000000000000 AA   17.551053579419  12.751586836749   0.000000000000 Bohr
[INPUT]  5 Be     7.681704126603   8.531396738221   0.000000000000 AA   14.516316969221  16.122003295245   0.000000000000 Bohr
[INPUT]  6 Be     5.740063340103   9.942081343723   0.000000000000 AA   10.847147650452  18.787810847783   0.000000000000 Bohr
[INPUT]  7 Be     3.547554241761  10.918249287104   0.000000000000 AA    6.703905928968  20.632500912355   0.000000000000 Bohr
[INPUT]  8 Be     1.200000000000  11.417237345067   0.000000000000 AA    2.267671349478  21.575451681333   0.000000000000 Bohr
[INPUT]  9 Be    -1.200000000000  11.417237345067   0.000000000000 AA   -2.267671349478  21.575451681333   0.000000000000 Bohr
[INPUT] 10 Be    -3.547554241761  10.918249287104   0.000000000000 AA   -6.703905928968  20.632500912355   0.000000000000 Bohr
[INPUT] 11 Be    -5.740063340103   9.942081343723   0.000000000000 AA  -10.847147650452  18.787810847783   0.000000000000 Bohr
[INPUT] 12 Be    -7.681704126603   8.531396738221   0.000000000000 AA  -14.516316969221  16.122003295245   0.000000000000 Bohr
[INPUT] 13 Be    -9.287617581865   6.747849157075   0.000000000000 AA  -17.551053579419  12.751586836749   0.000000000000 Bohr
[INPUT] 14 Be   -10.487617581865   4.669388187992   0.000000000000 AA  -19.818724928897   8.823864844584   0.000000000000 Bohr
[INPUT] 15 Be   -11.229258368364   2.386852548884   0.000000000000 AA  -21.220222898189   4.510497617111   0.000000000000 Bohr
[INPUT] 16 Be   -11.480126680207   0.000000000000   0.000000000000 AA  -21.694295300903   0.000000000000   0.000000000000 Bohr
[INPUT] 17 Be   -11.229258368364  -2.386852548884   0.000000000000 AA  -21.220222898189  -4.510497617111   0.000000000000 Bohr
[INPUT] 18 Be   -10.487617581865  -4.669388187992   0.000000000000 AA  -19.818724928897  -8.823864844584   0.000000000000 Bohr
[INPUT] 19 Be    -9.287617581865  -6.747849157075   0.000000000000 AA  -17.551053579419 -12.751586836749   0.000000000000 Bohr
[INPUT] 20 Be    -7.681704126603  -8.531396738221   0.000000000000 AA  -14.516316969221 -16.122003295245   0.000000000000 Bohr
[INPUT] 21 Be    -5.740063340103  -9.942081343723   0.000000000000 AA  -10.847147650452 -18.787810847783   0.000000000000 Bohr
[INPUT] 22 Be    -3.547554241761 -10.918249287104   0.000000000000 AA   -6.703905928968 -20.632500912355   0.000000000000 Bohr
[INPUT] 23 Be    -1.200000000000 -11.417237345067   0.000000000000 AA   -2.267671349478 -21.575451681333   0.000000000000 Bohr
[INPUT] 24 Be     1.200000000000 -11.417237345067   0.000000000000 AA    2.267671349478 -21.575451681333   0.000000000000 Bohr
[INPUT] 25 Be     3.547554241761 -10.918249287104   0.000000000000 AA    6.703905928968 -20.632500912355   0.000000000000 Bohr
[INPUT] 26 Be     5.740063340103  -9.942081343723   0.000000000000 AA   10.847147650452 -18.787810847783   0.000000000000 Bohr
[INPUT] 27 Be     7.681704126603  -8.531396738221   0.000000000000 AA   14.516316969221 -16.122003295245   0.000000000000 Bohr
[INPUT] 28 Be     9.287617581865  -6.747849157075   0.000000000000 AA   17.551053579419 -12.751586836749   0.000000000000 Bohr
[INPUT] 29 Be    10.487617581865  -4.669388187992   0.000000000000 AA   19.818724928897  -8.823864844584   0.000000000000 Bohr
[INPUT] 30 Be    11.229258368364  -2.386852548884   0.000000000000 AA   21.220222898189  -4.510497617111   0.000000000000 Bohr
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [6    /1   ]  312.8704937       0.00916359628
                                57.36446253       0.04936149294
                                16.0485094        0.1685383049
                                5.513096119       0.3705627997
                                2.140896553       0.4164915298
                                0.8817394283      0.1303340841
[INPUT] 0    0    [6    /1   ]  13.63324744       -0.01325278809
                                2.698375464       -0.04699171014
                                0.8386530829      -0.03378537151
                                0.3226600698      0.2502417861
                                0.1401314882      0.5951172526
                                0.0642325139      0.2407061763
[INPUT] 1    0    [6    /1   ]  13.63324744       0.0037596966
                                2.698375464       0.0376793698
                                0.8386530829      0.1738967435
                                0.3226600698      0.4180364347
                                0.1401314882      0.4258595477
                                0.0642325139      0.1017082955
nuclear repulsion = 372.565718831887
number of shells = 90
number of NR pGTOs = 900
number of NR cGTOs = 150
basis = sto-6g
ecp = {}
CPU time:      3060.27


******** <class 'pyscf.dft.rks.RKS'> flags ********
method = RKS
initial guess = minao
damping factor = 0
level shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
DIIS start cycle = 1
DIIS space = 8
SCF tol = 1e-09
SCF gradient tol = None
max. SCF cycles = 100
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /tigress/xingz/pydmfet/examples/tmp78iuGg
max_memory 16000 MB (current use 232 MB)
XC functionals = pbe,pbe
small_rho_cutoff = 1e-07
radial grids: Treutler-Ahlrichs (JCP 102, 346 (M4)) radial grids
becke partition: Becke, JCP, 88, 2547 (1988)
pruning grids: <function nwchem_prune at 0x2aac1c760cf8>
grids dens level: 3
symmetrized grids: False
atomic radii adjust function: <function treutler_atomic_radii_adjust at 0x2aac1c760b18>
Set gradient conv threshold to 3.16228e-05
tot grids = 393300
init E= -438.940058928938
HOMO: -0.1735216989599145 LUMO: -0.12191194651585344
-0.15049530454888896
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    1.998 1.998 1.989 1.989 1.98
 0.007 0.006 0.005 0.005 0.005 0.005 0.002 0.002 0.002 0.002]
entropy corr =  -0.003051499667594976
cycle= 1 E= -438.775218157613  delta_E= 0.165  |g|= 0.0604  |ddm|=  7.5
HOMO: -0.06879455741784263 LUMO: -0.02937700256940174
-0.052041865217142415
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    1.995 1.995 1.966 1.966 1.932
 0.021 0.021 0.016 0.016 0.016 0.016 0.007 0.007 0.007 0.007 0.002 0.002
 0.002 0.002]
entropy corr =  -0.008046445656368409
cycle= 2 E= -438.775442175883  delta_E= -0.000224  |g|= 0.0496  |ddm|= 0.572
HOMO: -0.07204839418476963 LUMO: -0.032622501199961226
-0.05527305966572167
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    1.995 1.995 1.966 1.966 1.933
 0.021 0.021 0.016 0.016 0.016 0.016 0.008 0.008 0.007 0.007 0.002 0.002
 0.002 0.002]
entropy corr =  -0.008055692890125478
cycle= 3 E= -438.785905748876  delta_E= -0.0105  |g|= 0.0015  |ddm|= 0.276
HOMO: -0.0726035412421988 LUMO: -0.03311713053709356
-0.055783980622918325
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    1.995 1.995 1.966 1.966 1.933
 0.021 0.021 0.016 0.016 0.016 0.016 0.008 0.008 0.007 0.007 0.002 0.002
 0.002 0.002]
entropy corr =  -0.008001479476008242
cycle= 4 E= -438.785912134087  delta_E= -6.39e-06  |g|= 1.8e-05  |ddm|= 0.00677
HOMO: -0.07261953743579737 LUMO: -0.033135076892475
-0.055800075230545414
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    1.995 1.995 1.966 1.966 1.933
 0.021 0.021 0.016 0.016 0.016 0.016 0.008 0.008 0.007 0.007 0.002 0.002
 0.002 0.002]
entropy corr =  -0.008001564283856802
cycle= 5 E= -438.785912135107  delta_E= -1.02e-09  |g|= 3.03e-07  |ddm|= 8.83e-05
HOMO: -0.07261951259896755 LUMO: -0.03313495224419598
-0.05580001569209838
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    1.995 1.995 1.966 1.966 1.933
 0.021 0.021 0.016 0.016 0.016 0.016 0.008 0.008 0.007 0.007 0.002 0.002
 0.002 0.002]
entropy corr =  -0.008001523021021502
cycle= 6 E= -438.785912135105  delta_E= 2.05e-12  |g|= 1.51e-07  |ddm|= 2.14e-06
HOMO: -0.07261951161413843 LUMO: -0.0331349509814494
-0.05580001467297196
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    1.995 1.995 1.966 1.966 1.933
 0.021 0.021 0.016 0.016 0.016 0.016 0.008 0.008 0.007 0.007 0.002 0.002
 0.002 0.002]
entropy corr =  -0.00800152299368689
Extra cycle  E= -438.785912135107  delta_E= -1.59e-12  |g|= 2.04e-07  |ddm|= 8.83e-07
converged SCF energy = -438.785912135107
e_mf =  -438.7859121351069
#INFO: **** input file is /tigress/xingz/pydmfet/examples/Be.py ****
from pydmfet import locints, sdmfet, oep, tools
from pyscf import gto, scf,dft, ao2mo,cc
import numpy as np
from pyscf.tools import molden, cubegen
import copy,time

DMguess  = None

bondlengths = np.arange(1.8, 4.1, 0.1)
energies = []

bas = 'sto-6g'

for bondlength in bondlengths:

    nat = 30
    mol = gto.Mole()
    mol.atom = []
    r = 0.5 * bondlength / np.sin(np.pi/nat)
    for i in range(nat):
        theta = i * (2*np.pi/nat)
        mol.atom.append(('Be', (r*np.cos(theta), r*np.sin(theta), 0)))

    mol.basis = bas
    mol.build(max_memory=16000, verbose=4)

    #mf = scf.RHF(mol)
    mf = dft.RKS(mol)
    mf.xc = 'pbe,pbe'
    mf.smear_sigma = 0.005
    mf.max_cycle = 100
    mf.scf()

    #P=mf.make_rdm1()
    #tools.MatPrint(P,"P_ref_ao")
    #cubegen.density(mol, "h20_dens.cube", P, nx=100, ny=100, nz=100)
    print 'e_mf = ',  mf.e_tot
    continue
    if ( True ):   
#        ENUCL = mf.mol.energy_nuc()
#        OEI   = np.dot(np.dot(mf.mo_coeff.T, mol.intor('cint1e_kin_sph') + mol.intor('cint1e_nuc_sph')), mf.mo_coeff)
#        TEI   = ao2mo.outcore.full_iofree(mol, mf.mo_coeff, compact=False).reshape(mol.nao_nr(), mol.nao_nr(), mol.nao_nr(), mol.nao_nr())
#        import chemps2
#        Energy, OneDM = chemps2.solve( ENUCL, OEI, OEI, TEI, mol.nao_nr(), mol.nelectron, mol.nao_nr(), 0.0, False )
#        print "bl =", bondlength," and energy =", Energy

        mycc = cc.CCSD(mf).run()
	et=0.0
        #et = mycc.ccsd_t()
        e_hf = mf.e_tot
        e_ccsd = e_hf + mycc.e_corr + et

        print 'e_tot = ', e_ccsd    #-4.96124910741
        
    else:
        myInts = locints.LocalIntegrals( mf, range( mol.nao_nr() ), 'meta_lowdin' )
        #myInts.loc_molden( 'hydrogen-loc.molden' )
        #myInts.TI_OK = True # Only s functions

	nbas =  mol.nao_nr()
	natoms = mol.natm

	impAtom = np.zeros([natoms], dtype=int)
	for i in range(20):
	    impAtom[i] = 1

	ghost_frag = 1-impAtom
	ghost_env = 1-ghost_frag

	mol_frag = gto.Mole()
	mol_frag.atom = tools.add_ghost(mol.atom, ghost_frag)
	mol_frag.basis = bas
	mol_frag.build(max_memory = 16000,verbose = 4)
	'''
	mf_frag = dft.RKS(mol_frag)
        mf_frag.xc = 'pbe,pbe'
        mf_frag.smear_sigma = 0.00
        mf_frag.scf()
        P_frag=mf_frag.make_rdm1()
        cubegen.density(mol_frag, "h10_dens_1.cube", P_frag, nx=100, ny=100, nz=100)
	'''

	mol_env = gto.Mole()
	mol_env.atom = tools.add_ghost(mol.atom, ghost_env)
	mol_env.basis =  bas
	mol_env.build(max_memory = 16000,verbose = 4)

	'''
	mf_env = dft.RKS(mol_env)
        mf_env.xc = 'pbe,pbe'
        mf_env.smear_sigma = 0.00
        mf_env.scf()
        P_env=mf_env.make_rdm1()
        cubegen.density(mol_env, "h10_dens_2.cube", P_env, nx=100, ny=100, nz=100)
	exit()
	'''



	aoslice = mol.aoslice_by_atom()
	impurities = np.zeros([nbas], dtype = int)
	for i in range(natoms):
	    if(impAtom[i] == 1):
		impurities[aoslice[i,2]:aoslice[i,3]] = 1

	Ne_frag = 20
	boundary_atoms = np.zeros((natoms))
	boundary_atoms[20:40] = 1.0
	#boundary_atoms[19] = -1
	boundary_atoms2 = np.zeros((natoms),dtype =int)
	#boundary_atoms2[9] = -1
	boundary_atoms2[0:20] = 1

	boundary_atoms = None
	boundary_atoms2 =None

	umat=None
	P_frag=None
	P_env=None
	params = oep.OEPparams(algorithm = '2011', opt_method = 'L-BFGS-B', \
                       ftol = 1e-11, gtol = 1e-5,diffP_tol=1e-5, outer_maxit = 200, maxit = 200,l2_lambda = 0.0, oep_print = 0)
	theDMFET = sdmfet.DMFET( mf, mol_frag, mol_env,myInts,impurities, impAtom, Ne_frag, boundary_atoms=boundary_atoms, boundary_atoms2=boundary_atoms2,\
                         umat = umat, P_frag_ao = P_frag, P_env_ao = P_env, \
                         dim_imp = nbas, dim_bath=nbas, dim_big =nbas, smear_sigma = 0.005, oep_params=params,ecw_method='hf', mf_method = mf.xc)

	umat = theDMFET.embedding_potential()

	exit()

	#write subspace orbitals
	transfo = np.dot( myInts.ao2loc, theDMFET.loc2sub )
	filename =  'hydrogen-sub.molden'
	with open( filename, 'w' ) as thefile:
            molden.header( myInts.mol, thefile )
            molden.orbital_coeff( myInts.mol, thefile, transfo )


        umat = theDMFET.embedding_potential()
	print umat
	exit()
	energy = theDMFET.correction_energy()

#INFO: ******************** input file end ********************


System: ('Linux', 'tigercpu.princeton.edu', '3.10.0-693.21.1.el7.x86_64', '#1 SMP Wed Mar 7 15:59:45 EST 2018', 'x86_64', 'x86_64')  Threads 40
Python 2.7.14 |Anaconda, Inc.| (default, Oct 16 2017, 17:29:19) 
[GCC 7.2.0]
numpy 1.14.3  scipy 1.1.0
Date: Thu Jun  7 01:37:38 2018
PySCF version 1.4.2
PySCF path  /tigress/xingz/pyscf/pyscf
GIT ORIG_HEAD e0edd131499dcc18d035a120533a8a1ddda110d4
GIT HEAD      e0edd131499dcc18d035a120533a8a1ddda110d4

[INPUT] VERBOSE 4
[INPUT] num atoms = 30
[INPUT] num electrons = 120
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT]  1 Be    11.958465291882   0.000000000000   0.000000000000 AA   22.598224271774   0.000000000000   0.000000000000 Bohr
[INPUT]  2 Be    11.697144133713   2.486304738421   0.000000000000 AA   22.104398852280   4.698435017823   0.000000000000 Bohr
[INPUT]  3 Be    10.924601647776   4.863946029159   0.000000000000 AA   20.644505134268   9.191525879775   0.000000000000 Bohr
[INPUT]  4 Be     9.674601647776   7.029009538620   0.000000000000 AA   18.282347478562  13.282902954947   0.000000000000 Bohr
[INPUT]  5 Be     8.001775131878   8.886871602313   0.000000000000 AA   15.121163509606  16.793753432547   0.000000000000 Bohr
[INPUT]  6 Be     5.979232645941  10.356334733044   0.000000000000 AA   11.299112135887  19.570636299774   0.000000000000 Bohr
[INPUT]  7 Be     3.695369001835  11.373176340734   0.000000000000 AA    6.983235342675  21.492188450370   0.000000000000 Bohr
[INPUT]  8 Be     1.250000000000  11.892955567778   0.000000000000 AA    2.362157655706  22.474428834722   0.000000000000 Bohr
[INPUT]  9 Be    -1.250000000000  11.892955567778   0.000000000000 AA   -2.362157655706  22.474428834722   0.000000000000 Bohr
[INPUT] 10 Be    -3.695369001835  11.373176340734   0.000000000000 AA   -6.983235342675  21.492188450370   0.000000000000 Bohr
[INPUT] 11 Be    -5.979232645941  10.356334733044   0.000000000000 AA  -11.299112135887  19.570636299774   0.000000000000 Bohr
[INPUT] 12 Be    -8.001775131878   8.886871602313   0.000000000000 AA  -15.121163509606  16.793753432547   0.000000000000 Bohr
[INPUT] 13 Be    -9.674601647776   7.029009538620   0.000000000000 AA  -18.282347478562  13.282902954947   0.000000000000 Bohr
[INPUT] 14 Be   -10.924601647776   4.863946029159   0.000000000000 AA  -20.644505134268   9.191525879775   0.000000000000 Bohr
[INPUT] 15 Be   -11.697144133713   2.486304738421   0.000000000000 AA  -22.104398852280   4.698435017823   0.000000000000 Bohr
[INPUT] 16 Be   -11.958465291882   0.000000000000   0.000000000000 AA  -22.598224271774   0.000000000000   0.000000000000 Bohr
[INPUT] 17 Be   -11.697144133713  -2.486304738421   0.000000000000 AA  -22.104398852280  -4.698435017823   0.000000000000 Bohr
[INPUT] 18 Be   -10.924601647776  -4.863946029159   0.000000000000 AA  -20.644505134268  -9.191525879775   0.000000000000 Bohr
[INPUT] 19 Be    -9.674601647776  -7.029009538620   0.000000000000 AA  -18.282347478562 -13.282902954947   0.000000000000 Bohr
[INPUT] 20 Be    -8.001775131878  -8.886871602313   0.000000000000 AA  -15.121163509606 -16.793753432547   0.000000000000 Bohr
[INPUT] 21 Be    -5.979232645941 -10.356334733044   0.000000000000 AA  -11.299112135887 -19.570636299774   0.000000000000 Bohr
[INPUT] 22 Be    -3.695369001835 -11.373176340734   0.000000000000 AA   -6.983235342675 -21.492188450370   0.000000000000 Bohr
[INPUT] 23 Be    -1.250000000000 -11.892955567778   0.000000000000 AA   -2.362157655706 -22.474428834722   0.000000000000 Bohr
[INPUT] 24 Be     1.250000000000 -11.892955567778   0.000000000000 AA    2.362157655706 -22.474428834722   0.000000000000 Bohr
[INPUT] 25 Be     3.695369001835 -11.373176340734   0.000000000000 AA    6.983235342675 -21.492188450370   0.000000000000 Bohr
[INPUT] 26 Be     5.979232645941 -10.356334733044   0.000000000000 AA   11.299112135887 -19.570636299774   0.000000000000 Bohr
[INPUT] 27 Be     8.001775131878  -8.886871602313   0.000000000000 AA   15.121163509606 -16.793753432547   0.000000000000 Bohr
[INPUT] 28 Be     9.674601647776  -7.029009538620   0.000000000000 AA   18.282347478562 -13.282902954947   0.000000000000 Bohr
[INPUT] 29 Be    10.924601647776  -4.863946029159   0.000000000000 AA   20.644505134268  -9.191525879775   0.000000000000 Bohr
[INPUT] 30 Be    11.697144133713  -2.486304738421   0.000000000000 AA   22.104398852280  -4.698435017823   0.000000000000 Bohr
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [6    /1   ]  312.8704937       0.00916359628
                                57.36446253       0.04936149294
                                16.0485094        0.1685383049
                                5.513096119       0.3705627997
                                2.140896553       0.4164915298
                                0.8817394283      0.1303340841
[INPUT] 0    0    [6    /1   ]  13.63324744       -0.01325278809
                                2.698375464       -0.04699171014
                                0.8386530829      -0.03378537151
                                0.3226600698      0.2502417861
                                0.1401314882      0.5951172526
                                0.0642325139      0.2407061763
[INPUT] 1    0    [6    /1   ]  13.63324744       0.0037596966
                                2.698375464       0.0376793698
                                0.8386530829      0.1738967435
                                0.3226600698      0.4180364347
                                0.1401314882      0.4258595477
                                0.0642325139      0.1017082955
nuclear repulsion = 357.663090078611
number of shells = 90
number of NR pGTOs = 900
number of NR cGTOs = 150
basis = sto-6g
ecp = {}
CPU time:      3432.00


******** <class 'pyscf.dft.rks.RKS'> flags ********
method = RKS
initial guess = minao
damping factor = 0
level shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
DIIS start cycle = 1
DIIS space = 8
SCF tol = 1e-09
SCF gradient tol = None
max. SCF cycles = 100
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /tigress/xingz/pydmfet/examples/tmpmijxh8
max_memory 16000 MB (current use 232 MB)
XC functionals = pbe,pbe
small_rho_cutoff = 1e-07
radial grids: Treutler-Ahlrichs (JCP 102, 346 (M4)) radial grids
becke partition: Becke, JCP, 88, 2547 (1988)
pruning grids: <function nwchem_prune at 0x2aac1c760cf8>
grids dens level: 3
symmetrized grids: False
atomic radii adjust function: <function treutler_atomic_radii_adjust at 0x2aac1c760b18>
Set gradient conv threshold to 3.16228e-05
tot grids = 393300
init E= -438.590068993807
HOMO: -0.16672461377605372 LUMO: -0.11248947083271227
-0.1426187938527707
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.999e+00
 1.999e+00 1.992e+00 1.992e+00 1.984e+00 4.819e-03 4.771e-03 3.823e-03
 3.823e-03 3.786e-03 3.786e-03 1.911e-03 1.911e-03 1.893e-03 1.893e-03]
entropy corr =  -0.002459411925695897
cycle= 1 E= -438.599477860716  delta_E= -0.00941  |g|= 0.0384  |ddm|= 7.36
HOMO: -0.0685746179643323 LUMO: -0.02534467143525951
-0.05011028638601876
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.997e+00
 1.997e+00 1.977e+00 1.977e+00 1.951e+00 1.402e-02 1.366e-02 1.106e-02
 1.106e-02 1.079e-02 1.079e-02 5.422e-03 5.422e-03 5.325e-03 5.325e-03
 1.659e-03 1.659e-03 1.645e-03 1.645e-03]
entropy corr =  -0.005917395908460948
cycle= 2 E= -438.600039768639  delta_E= -0.000562  |g|= 0.0244  |ddm|= 0.564
HOMO: -0.07152869668991521 LUMO: -0.028267745415059126
-0.0530295993353282
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.997e+00
 1.997e+00 1.977e+00 1.977e+00 1.952e+00 1.403e-02 1.359e-02 1.108e-02
 1.108e-02 1.074e-02 1.074e-02 5.449e-03 5.449e-03 5.294e-03 5.294e-03
 1.675e-03 1.675e-03 1.634e-03 1.634e-03]
entropy corr =  -0.005914059351196017
cycle= 3 E= -438.609160971563  delta_E= -0.00912  |g|= 0.00097  |ddm|= 0.269
HOMO: -0.07196073309305358 LUMO: -0.028656307633419725
-0.053427554985896464
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.997e+00
 1.997e+00 1.977e+00 1.977e+00 1.952e+00 1.401e-02 1.344e-02 1.106e-02
 1.106e-02 1.062e-02 1.062e-02 5.439e-03 5.439e-03 5.235e-03 5.235e-03
 1.672e-03 1.672e-03 1.617e-03 1.617e-03]
entropy corr =  -0.005882749814294032
cycle= 4 E= -438.60916821449  delta_E= -7.24e-06  |g|= 1.23e-05  |ddm|= 0.00745
HOMO: -0.07197596821693912 LUMO: -0.02867349970530626
-0.05344293494463483
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.997e+00
 1.997e+00 1.977e+00 1.977e+00 1.952e+00 1.401e-02 1.343e-02 1.106e-02
 1.106e-02 1.061e-02 1.061e-02 5.442e-03 5.442e-03 5.233e-03 5.233e-03
 1.673e-03 1.673e-03 1.616e-03 1.616e-03]
entropy corr =  -0.0058828562304922465
cycle= 5 E= -438.609168215702  delta_E= -1.21e-09  |g|= 2.5e-07  |ddm|= 9.81e-05
HOMO: -0.07197594451002184 LUMO: -0.028673362935214497
-0.053442872173462025
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.997e+00
 1.997e+00 1.977e+00 1.977e+00 1.952e+00 1.401e-02 1.343e-02 1.106e-02
 1.106e-02 1.061e-02 1.061e-02 5.441e-03 5.441e-03 5.233e-03 5.233e-03
 1.673e-03 1.673e-03 1.616e-03 1.616e-03]
entropy corr =  -0.005882821541437194
cycle= 6 E= -438.609168215701  delta_E= 1.14e-12  |g|= 1.45e-07  |ddm|= 2.49e-06
HOMO: -0.07197594394742034 LUMO: -0.028673360100901494
-0.05344287086450582
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.997e+00
 1.997e+00 1.977e+00 1.977e+00 1.952e+00 1.401e-02 1.343e-02 1.106e-02
 1.106e-02 1.061e-02 1.061e-02 5.441e-03 5.441e-03 5.233e-03 5.233e-03
 1.673e-03 1.673e-03 1.616e-03 1.616e-03]
entropy corr =  -0.005882820887839867
Extra cycle  E= -438.609168215703  delta_E= -1.59e-12  |g|= 1.9e-07  |ddm|= 1.13e-06
converged SCF energy = -438.609168215703
e_mf =  -438.60916821570277
#INFO: **** input file is /tigress/xingz/pydmfet/examples/Be.py ****
from pydmfet import locints, sdmfet, oep, tools
from pyscf import gto, scf,dft, ao2mo,cc
import numpy as np
from pyscf.tools import molden, cubegen
import copy,time

DMguess  = None

bondlengths = np.arange(1.8, 4.1, 0.1)
energies = []

bas = 'sto-6g'

for bondlength in bondlengths:

    nat = 30
    mol = gto.Mole()
    mol.atom = []
    r = 0.5 * bondlength / np.sin(np.pi/nat)
    for i in range(nat):
        theta = i * (2*np.pi/nat)
        mol.atom.append(('Be', (r*np.cos(theta), r*np.sin(theta), 0)))

    mol.basis = bas
    mol.build(max_memory=16000, verbose=4)

    #mf = scf.RHF(mol)
    mf = dft.RKS(mol)
    mf.xc = 'pbe,pbe'
    mf.smear_sigma = 0.005
    mf.max_cycle = 100
    mf.scf()

    #P=mf.make_rdm1()
    #tools.MatPrint(P,"P_ref_ao")
    #cubegen.density(mol, "h20_dens.cube", P, nx=100, ny=100, nz=100)
    print 'e_mf = ',  mf.e_tot
    continue
    if ( True ):   
#        ENUCL = mf.mol.energy_nuc()
#        OEI   = np.dot(np.dot(mf.mo_coeff.T, mol.intor('cint1e_kin_sph') + mol.intor('cint1e_nuc_sph')), mf.mo_coeff)
#        TEI   = ao2mo.outcore.full_iofree(mol, mf.mo_coeff, compact=False).reshape(mol.nao_nr(), mol.nao_nr(), mol.nao_nr(), mol.nao_nr())
#        import chemps2
#        Energy, OneDM = chemps2.solve( ENUCL, OEI, OEI, TEI, mol.nao_nr(), mol.nelectron, mol.nao_nr(), 0.0, False )
#        print "bl =", bondlength," and energy =", Energy

        mycc = cc.CCSD(mf).run()
	et=0.0
        #et = mycc.ccsd_t()
        e_hf = mf.e_tot
        e_ccsd = e_hf + mycc.e_corr + et

        print 'e_tot = ', e_ccsd    #-4.96124910741
        
    else:
        myInts = locints.LocalIntegrals( mf, range( mol.nao_nr() ), 'meta_lowdin' )
        #myInts.loc_molden( 'hydrogen-loc.molden' )
        #myInts.TI_OK = True # Only s functions

	nbas =  mol.nao_nr()
	natoms = mol.natm

	impAtom = np.zeros([natoms], dtype=int)
	for i in range(20):
	    impAtom[i] = 1

	ghost_frag = 1-impAtom
	ghost_env = 1-ghost_frag

	mol_frag = gto.Mole()
	mol_frag.atom = tools.add_ghost(mol.atom, ghost_frag)
	mol_frag.basis = bas
	mol_frag.build(max_memory = 16000,verbose = 4)
	'''
	mf_frag = dft.RKS(mol_frag)
        mf_frag.xc = 'pbe,pbe'
        mf_frag.smear_sigma = 0.00
        mf_frag.scf()
        P_frag=mf_frag.make_rdm1()
        cubegen.density(mol_frag, "h10_dens_1.cube", P_frag, nx=100, ny=100, nz=100)
	'''

	mol_env = gto.Mole()
	mol_env.atom = tools.add_ghost(mol.atom, ghost_env)
	mol_env.basis =  bas
	mol_env.build(max_memory = 16000,verbose = 4)

	'''
	mf_env = dft.RKS(mol_env)
        mf_env.xc = 'pbe,pbe'
        mf_env.smear_sigma = 0.00
        mf_env.scf()
        P_env=mf_env.make_rdm1()
        cubegen.density(mol_env, "h10_dens_2.cube", P_env, nx=100, ny=100, nz=100)
	exit()
	'''



	aoslice = mol.aoslice_by_atom()
	impurities = np.zeros([nbas], dtype = int)
	for i in range(natoms):
	    if(impAtom[i] == 1):
		impurities[aoslice[i,2]:aoslice[i,3]] = 1

	Ne_frag = 20
	boundary_atoms = np.zeros((natoms))
	boundary_atoms[20:40] = 1.0
	#boundary_atoms[19] = -1
	boundary_atoms2 = np.zeros((natoms),dtype =int)
	#boundary_atoms2[9] = -1
	boundary_atoms2[0:20] = 1

	boundary_atoms = None
	boundary_atoms2 =None

	umat=None
	P_frag=None
	P_env=None
	params = oep.OEPparams(algorithm = '2011', opt_method = 'L-BFGS-B', \
                       ftol = 1e-11, gtol = 1e-5,diffP_tol=1e-5, outer_maxit = 200, maxit = 200,l2_lambda = 0.0, oep_print = 0)
	theDMFET = sdmfet.DMFET( mf, mol_frag, mol_env,myInts,impurities, impAtom, Ne_frag, boundary_atoms=boundary_atoms, boundary_atoms2=boundary_atoms2,\
                         umat = umat, P_frag_ao = P_frag, P_env_ao = P_env, \
                         dim_imp = nbas, dim_bath=nbas, dim_big =nbas, smear_sigma = 0.005, oep_params=params,ecw_method='hf', mf_method = mf.xc)

	umat = theDMFET.embedding_potential()

	exit()

	#write subspace orbitals
	transfo = np.dot( myInts.ao2loc, theDMFET.loc2sub )
	filename =  'hydrogen-sub.molden'
	with open( filename, 'w' ) as thefile:
            molden.header( myInts.mol, thefile )
            molden.orbital_coeff( myInts.mol, thefile, transfo )


        umat = theDMFET.embedding_potential()
	print umat
	exit()
	energy = theDMFET.correction_energy()

#INFO: ******************** input file end ********************


System: ('Linux', 'tigercpu.princeton.edu', '3.10.0-693.21.1.el7.x86_64', '#1 SMP Wed Mar 7 15:59:45 EST 2018', 'x86_64', 'x86_64')  Threads 40
Python 2.7.14 |Anaconda, Inc.| (default, Oct 16 2017, 17:29:19) 
[GCC 7.2.0]
numpy 1.14.3  scipy 1.1.0
Date: Thu Jun  7 01:37:51 2018
PySCF version 1.4.2
PySCF path  /tigress/xingz/pyscf/pyscf
GIT ORIG_HEAD e0edd131499dcc18d035a120533a8a1ddda110d4
GIT HEAD      e0edd131499dcc18d035a120533a8a1ddda110d4

[INPUT] VERBOSE 4
[INPUT] num atoms = 30
[INPUT] num electrons = 120
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT]  1 Be    12.436803903557   0.000000000000   0.000000000000 AA   23.502153242645   0.000000000000   0.000000000000 Bohr
[INPUT]  2 Be    12.165029899061   2.585756927958   0.000000000000 AA   22.988574806371   4.886372418536   0.000000000000 Bohr
[INPUT]  3 Be    11.361585713687   5.058503870325   0.000000000000 AA   21.470285339639   9.559186914966   0.000000000000 Bohr
[INPUT]  4 Be    10.061585713687   7.310169920164   0.000000000000 AA   19.013641377704  13.814219073144   0.000000000000 Bohr
[INPUT]  5 Be     8.321846137154   9.242346466406   0.000000000000 AA   15.726010049990  17.465503569848   0.000000000000 Bohr
[INPUT]  6 Be     6.218401951779  10.770588122366   0.000000000000 AA   11.751076621323  20.353461751765   0.000000000000 Bohr
[INPUT]  7 Be     3.843183761908  11.828103394363   0.000000000000 AA    7.262564756382  22.351875988385   0.000000000000 Bohr
[INPUT]  8 Be     1.300000000000  12.368673790489   0.000000000000 AA    2.456643961935  23.373405988111   0.000000000000 Bohr
[INPUT]  9 Be    -1.300000000000  12.368673790489   0.000000000000 AA   -2.456643961935  23.373405988111   0.000000000000 Bohr
[INPUT] 10 Be    -3.843183761908  11.828103394363   0.000000000000 AA   -7.262564756382  22.351875988385   0.000000000000 Bohr
[INPUT] 11 Be    -6.218401951779  10.770588122366   0.000000000000 AA  -11.751076621322  20.353461751765   0.000000000000 Bohr
[INPUT] 12 Be    -8.321846137154   9.242346466406   0.000000000000 AA  -15.726010049990  17.465503569848   0.000000000000 Bohr
[INPUT] 13 Be   -10.061585713687   7.310169920164   0.000000000000 AA  -19.013641377704  13.814219073144   0.000000000000 Bohr
[INPUT] 14 Be   -11.361585713687   5.058503870325   0.000000000000 AA  -21.470285339639   9.559186914966   0.000000000000 Bohr
[INPUT] 15 Be   -12.165029899061   2.585756927958   0.000000000000 AA  -22.988574806371   4.886372418536   0.000000000000 Bohr
[INPUT] 16 Be   -12.436803903557   0.000000000000   0.000000000000 AA  -23.502153242645   0.000000000000   0.000000000000 Bohr
[INPUT] 17 Be   -12.165029899061  -2.585756927958   0.000000000000 AA  -22.988574806371  -4.886372418536   0.000000000000 Bohr
[INPUT] 18 Be   -11.361585713687  -5.058503870325   0.000000000000 AA  -21.470285339639  -9.559186914966   0.000000000000 Bohr
[INPUT] 19 Be   -10.061585713687  -7.310169920164   0.000000000000 AA  -19.013641377704 -13.814219073144   0.000000000000 Bohr
[INPUT] 20 Be    -8.321846137154  -9.242346466406   0.000000000000 AA  -15.726010049990 -17.465503569848   0.000000000000 Bohr
[INPUT] 21 Be    -6.218401951779 -10.770588122366   0.000000000000 AA  -11.751076621323 -20.353461751765   0.000000000000 Bohr
[INPUT] 22 Be    -3.843183761908 -11.828103394363   0.000000000000 AA   -7.262564756382 -22.351875988385   0.000000000000 Bohr
[INPUT] 23 Be    -1.300000000000 -12.368673790489   0.000000000000 AA   -2.456643961935 -23.373405988111   0.000000000000 Bohr
[INPUT] 24 Be     1.300000000000 -12.368673790489   0.000000000000 AA    2.456643961935 -23.373405988111   0.000000000000 Bohr
[INPUT] 25 Be     3.843183761908 -11.828103394363   0.000000000000 AA    7.262564756382 -22.351875988385   0.000000000000 Bohr
[INPUT] 26 Be     6.218401951779 -10.770588122366   0.000000000000 AA   11.751076621322 -20.353461751765   0.000000000000 Bohr
[INPUT] 27 Be     8.321846137154  -9.242346466406   0.000000000000 AA   15.726010049990 -17.465503569848   0.000000000000 Bohr
[INPUT] 28 Be    10.061585713687  -7.310169920164   0.000000000000 AA   19.013641377704 -13.814219073144   0.000000000000 Bohr
[INPUT] 29 Be    11.361585713687  -5.058503870325   0.000000000000 AA   21.470285339639  -9.559186914966   0.000000000000 Bohr
[INPUT] 30 Be    12.165029899061  -2.585756927958   0.000000000000 AA   22.988574806371  -4.886372418536   0.000000000000 Bohr
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [6    /1   ]  312.8704937       0.00916359628
                                57.36446253       0.04936149294
                                16.0485094        0.1685383049
                                5.513096119       0.3705627997
                                2.140896553       0.4164915298
                                0.8817394283      0.1303340841
[INPUT] 0    0    [6    /1   ]  13.63324744       -0.01325278809
                                2.698375464       -0.04699171014
                                0.8386530829      -0.03378537151
                                0.3226600698      0.2502417861
                                0.1401314882      0.5951172526
                                0.0642325139      0.2407061763
[INPUT] 1    0    [6    /1   ]  13.63324744       0.0037596966
                                2.698375464       0.0376793698
                                0.8386530829      0.1738967435
                                0.3226600698      0.4180364347
                                0.1401314882      0.4258595477
                                0.0642325139      0.1017082955
nuclear repulsion = 343.90681738328
number of shells = 90
number of NR pGTOs = 900
number of NR cGTOs = 150
basis = sto-6g
ecp = {}
CPU time:      3794.57


******** <class 'pyscf.dft.rks.RKS'> flags ********
method = RKS
initial guess = minao
damping factor = 0
level shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
DIIS start cycle = 1
DIIS space = 8
SCF tol = 1e-09
SCF gradient tol = None
max. SCF cycles = 100
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /tigress/xingz/pydmfet/examples/tmpl2Ezn9
max_memory 16000 MB (current use 233 MB)
XC functionals = pbe,pbe
small_rho_cutoff = 1e-07
radial grids: Treutler-Ahlrichs (JCP 102, 346 (M4)) radial grids
becke partition: Becke, JCP, 88, 2547 (1988)
pruning grids: <function nwchem_prune at 0x2aac1c760cf8>
grids dens level: 3
symmetrized grids: False
atomic radii adjust function: <function treutler_atomic_radii_adjust at 0x2aac1c760b18>
Set gradient conv threshold to 3.16228e-05
tot grids = 393300
init E= -438.284452612005
HOMO: -0.1600746689750218 LUMO: -0.10406896561957081
-0.13533804320452186
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.999e+00
 1.999e+00 1.993e+00 1.993e+00 1.986e+00 3.839e-03 3.822e-03 3.111e-03
 3.111e-03 3.096e-03 3.096e-03 1.658e-03 1.658e-03 1.649e-03 1.649e-03]
entropy corr =  -0.0021157318124373375
cycle= 1 E= -438.403005482271  delta_E= -0.119  |g|= 0.031  |ddm|=  7.2
HOMO: -0.06792877922768259 LUMO: -0.021841926290255807
-0.048271008202468456
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.998e+00
 1.998e+00 1.984e+00 1.984e+00 1.962e+00 1.007e-02 9.690e-03 8.123e-03
 8.123e-03 7.824e-03 7.824e-03 4.262e-03 4.262e-03 4.123e-03 4.123e-03
 1.464e-03 1.464e-03 1.426e-03 1.426e-03]
entropy corr =  -0.004661671126639266
cycle= 2 E= -438.403744581748  delta_E= -0.000739  |g|= 0.0187  |ddm|= 0.559
HOMO: -0.07062965507559349 LUMO: -0.024482182816257737
-0.05092192585114027
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.998e+00
 1.998e+00 1.984e+00 1.984e+00 1.962e+00 1.005e-02 9.626e-03 8.112e-03
 8.112e-03 7.771e-03 7.771e-03 4.266e-03 4.266e-03 4.093e-03 4.093e-03
 1.470e-03 1.470e-03 1.414e-03 1.414e-03]
entropy corr =  -0.0046496025966082126
cycle= 3 E= -438.411823238497  delta_E= -0.00808  |g|= 0.000811  |ddm|= 0.263
HOMO: -0.07098454609916051 LUMO: -0.02480049541784112
-0.05124738882373949
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.998e+00
 1.998e+00 1.984e+00 1.984e+00 1.962e+00 1.004e-02 9.529e-03 8.101e-03
 8.101e-03 7.693e-03 7.693e-03 4.260e-03 4.260e-03 4.053e-03 4.053e-03
 1.468e-03 1.468e-03 1.401e-03 1.401e-03]
entropy corr =  -0.004628144402884731
cycle= 4 E= -438.411831160611  delta_E= -7.92e-06  |g|= 1.14e-05  |ddm|= 0.00808
HOMO: -0.07099841172716986 LUMO: -0.024816379457012802
-0.05126146819522033
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.998e+00
 1.998e+00 1.984e+00 1.984e+00 1.962e+00 1.004e-02 9.526e-03 8.104e-03
 8.104e-03 7.691e-03 7.691e-03 4.262e-03 4.262e-03 4.052e-03 4.052e-03
 1.469e-03 1.469e-03 1.400e-03 1.400e-03]
entropy corr =  -0.004628279704145478
cycle= 5 E= -438.411831162122  delta_E= -1.51e-09  |g|= 4.05e-07  |ddm|= 0.000112
HOMO: -0.0709983884747494 LUMO: -0.024816238421564857
-0.051261404190038884
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.998e+00
 1.998e+00 1.984e+00 1.984e+00 1.962e+00 1.004e-02 9.526e-03 8.103e-03
 8.103e-03 7.691e-03 7.691e-03 4.262e-03 4.262e-03 4.052e-03 4.052e-03
 1.469e-03 1.469e-03 1.400e-03 1.400e-03]
entropy corr =  -0.004628251087113261
cycle= 6 E= -438.411831162122  delta_E= -3.41e-13  |g|= 4e-07  |ddm|= 3.66e-06
HOMO: -0.07099838683879199 LUMO: -0.02481622339208445
-0.0512613979115548
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.998e+00
 1.998e+00 1.984e+00 1.984e+00 1.962e+00 1.004e-02 9.526e-03 8.103e-03
 8.103e-03 7.691e-03 7.691e-03 4.262e-03 4.262e-03 4.052e-03 4.052e-03
 1.469e-03 1.469e-03 1.400e-03 1.400e-03]
entropy corr =  -0.0046282478318350135
Extra cycle  E= -438.411831162122  delta_E= -2.27e-13  |g|= 5.93e-07  |ddm|= 3.44e-06
converged SCF energy = -438.411831162122
e_mf =  -438.41183116212244
#INFO: **** input file is /tigress/xingz/pydmfet/examples/Be.py ****
from pydmfet import locints, sdmfet, oep, tools
from pyscf import gto, scf,dft, ao2mo,cc
import numpy as np
from pyscf.tools import molden, cubegen
import copy,time

DMguess  = None

bondlengths = np.arange(1.8, 4.1, 0.1)
energies = []

bas = 'sto-6g'

for bondlength in bondlengths:

    nat = 30
    mol = gto.Mole()
    mol.atom = []
    r = 0.5 * bondlength / np.sin(np.pi/nat)
    for i in range(nat):
        theta = i * (2*np.pi/nat)
        mol.atom.append(('Be', (r*np.cos(theta), r*np.sin(theta), 0)))

    mol.basis = bas
    mol.build(max_memory=16000, verbose=4)

    #mf = scf.RHF(mol)
    mf = dft.RKS(mol)
    mf.xc = 'pbe,pbe'
    mf.smear_sigma = 0.005
    mf.max_cycle = 100
    mf.scf()

    #P=mf.make_rdm1()
    #tools.MatPrint(P,"P_ref_ao")
    #cubegen.density(mol, "h20_dens.cube", P, nx=100, ny=100, nz=100)
    print 'e_mf = ',  mf.e_tot
    continue
    if ( True ):   
#        ENUCL = mf.mol.energy_nuc()
#        OEI   = np.dot(np.dot(mf.mo_coeff.T, mol.intor('cint1e_kin_sph') + mol.intor('cint1e_nuc_sph')), mf.mo_coeff)
#        TEI   = ao2mo.outcore.full_iofree(mol, mf.mo_coeff, compact=False).reshape(mol.nao_nr(), mol.nao_nr(), mol.nao_nr(), mol.nao_nr())
#        import chemps2
#        Energy, OneDM = chemps2.solve( ENUCL, OEI, OEI, TEI, mol.nao_nr(), mol.nelectron, mol.nao_nr(), 0.0, False )
#        print "bl =", bondlength," and energy =", Energy

        mycc = cc.CCSD(mf).run()
	et=0.0
        #et = mycc.ccsd_t()
        e_hf = mf.e_tot
        e_ccsd = e_hf + mycc.e_corr + et

        print 'e_tot = ', e_ccsd    #-4.96124910741
        
    else:
        myInts = locints.LocalIntegrals( mf, range( mol.nao_nr() ), 'meta_lowdin' )
        #myInts.loc_molden( 'hydrogen-loc.molden' )
        #myInts.TI_OK = True # Only s functions

	nbas =  mol.nao_nr()
	natoms = mol.natm

	impAtom = np.zeros([natoms], dtype=int)
	for i in range(20):
	    impAtom[i] = 1

	ghost_frag = 1-impAtom
	ghost_env = 1-ghost_frag

	mol_frag = gto.Mole()
	mol_frag.atom = tools.add_ghost(mol.atom, ghost_frag)
	mol_frag.basis = bas
	mol_frag.build(max_memory = 16000,verbose = 4)
	'''
	mf_frag = dft.RKS(mol_frag)
        mf_frag.xc = 'pbe,pbe'
        mf_frag.smear_sigma = 0.00
        mf_frag.scf()
        P_frag=mf_frag.make_rdm1()
        cubegen.density(mol_frag, "h10_dens_1.cube", P_frag, nx=100, ny=100, nz=100)
	'''

	mol_env = gto.Mole()
	mol_env.atom = tools.add_ghost(mol.atom, ghost_env)
	mol_env.basis =  bas
	mol_env.build(max_memory = 16000,verbose = 4)

	'''
	mf_env = dft.RKS(mol_env)
        mf_env.xc = 'pbe,pbe'
        mf_env.smear_sigma = 0.00
        mf_env.scf()
        P_env=mf_env.make_rdm1()
        cubegen.density(mol_env, "h10_dens_2.cube", P_env, nx=100, ny=100, nz=100)
	exit()
	'''



	aoslice = mol.aoslice_by_atom()
	impurities = np.zeros([nbas], dtype = int)
	for i in range(natoms):
	    if(impAtom[i] == 1):
		impurities[aoslice[i,2]:aoslice[i,3]] = 1

	Ne_frag = 20
	boundary_atoms = np.zeros((natoms))
	boundary_atoms[20:40] = 1.0
	#boundary_atoms[19] = -1
	boundary_atoms2 = np.zeros((natoms),dtype =int)
	#boundary_atoms2[9] = -1
	boundary_atoms2[0:20] = 1

	boundary_atoms = None
	boundary_atoms2 =None

	umat=None
	P_frag=None
	P_env=None
	params = oep.OEPparams(algorithm = '2011', opt_method = 'L-BFGS-B', \
                       ftol = 1e-11, gtol = 1e-5,diffP_tol=1e-5, outer_maxit = 200, maxit = 200,l2_lambda = 0.0, oep_print = 0)
	theDMFET = sdmfet.DMFET( mf, mol_frag, mol_env,myInts,impurities, impAtom, Ne_frag, boundary_atoms=boundary_atoms, boundary_atoms2=boundary_atoms2,\
                         umat = umat, P_frag_ao = P_frag, P_env_ao = P_env, \
                         dim_imp = nbas, dim_bath=nbas, dim_big =nbas, smear_sigma = 0.005, oep_params=params,ecw_method='hf', mf_method = mf.xc)

	umat = theDMFET.embedding_potential()

	exit()

	#write subspace orbitals
	transfo = np.dot( myInts.ao2loc, theDMFET.loc2sub )
	filename =  'hydrogen-sub.molden'
	with open( filename, 'w' ) as thefile:
            molden.header( myInts.mol, thefile )
            molden.orbital_coeff( myInts.mol, thefile, transfo )


        umat = theDMFET.embedding_potential()
	print umat
	exit()
	energy = theDMFET.correction_energy()

#INFO: ******************** input file end ********************


System: ('Linux', 'tigercpu.princeton.edu', '3.10.0-693.21.1.el7.x86_64', '#1 SMP Wed Mar 7 15:59:45 EST 2018', 'x86_64', 'x86_64')  Threads 40
Python 2.7.14 |Anaconda, Inc.| (default, Oct 16 2017, 17:29:19) 
[GCC 7.2.0]
numpy 1.14.3  scipy 1.1.0
Date: Thu Jun  7 01:38:04 2018
PySCF version 1.4.2
PySCF path  /tigress/xingz/pyscf/pyscf
GIT ORIG_HEAD e0edd131499dcc18d035a120533a8a1ddda110d4
GIT HEAD      e0edd131499dcc18d035a120533a8a1ddda110d4

[INPUT] VERBOSE 4
[INPUT] num atoms = 30
[INPUT] num electrons = 120
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT]  1 Be    12.915142515233   0.000000000000   0.000000000000 AA   24.406082213516   0.000000000000   0.000000000000 Bohr
[INPUT]  2 Be    12.632915664410   2.685209117494   0.000000000000 AA   23.872750760463   5.074309819249   0.000000000000 Bohr
[INPUT]  3 Be    11.798569779598   5.253061711491   0.000000000000 AA   22.296065545009   9.926847950157   0.000000000000 Bohr
[INPUT]  4 Be    10.448569779598   7.591330301709   0.000000000000 AA   19.744935276847  14.345535191342   0.000000000000 Bohr
[INPUT]  5 Be     8.641917142429   9.597821330498   0.000000000000 AA   16.330856590374  18.137253707150   0.000000000000 Bohr
[INPUT]  6 Be     6.457571257616  11.184841511688   0.000000000000 AA   12.203041106758  21.136287203756   0.000000000000 Bohr
[INPUT]  7 Be     3.990998521981  12.283030447993   0.000000000000 AA    7.541894170089  23.211563526400   0.000000000000 Bohr
[INPUT]  8 Be     1.350000000000  12.844392013200   0.000000000000 AA    2.551130268163  24.272383141500   0.000000000000 Bohr
[INPUT]  9 Be    -1.350000000000  12.844392013200   0.000000000000 AA   -2.551130268163  24.272383141500   0.000000000000 Bohr
[INPUT] 10 Be    -3.990998521981  12.283030447993   0.000000000000 AA   -7.541894170089  23.211563526400   0.000000000000 Bohr
[INPUT] 11 Be    -6.457571257616  11.184841511688   0.000000000000 AA  -12.203041106758  21.136287203756   0.000000000000 Bohr
[INPUT] 12 Be    -8.641917142429   9.597821330498   0.000000000000 AA  -16.330856590374  18.137253707150   0.000000000000 Bohr
[INPUT] 13 Be   -10.448569779598   7.591330301709   0.000000000000 AA  -19.744935276847  14.345535191342   0.000000000000 Bohr
[INPUT] 14 Be   -11.798569779598   5.253061711491   0.000000000000 AA  -22.296065545009   9.926847950157   0.000000000000 Bohr
[INPUT] 15 Be   -12.632915664410   2.685209117494   0.000000000000 AA  -23.872750760463   5.074309819249   0.000000000000 Bohr
[INPUT] 16 Be   -12.915142515233   0.000000000000   0.000000000000 AA  -24.406082213516   0.000000000000   0.000000000000 Bohr
[INPUT] 17 Be   -12.632915664410  -2.685209117494   0.000000000000 AA  -23.872750760463  -5.074309819249   0.000000000000 Bohr
[INPUT] 18 Be   -11.798569779598  -5.253061711491   0.000000000000 AA  -22.296065545009  -9.926847950157   0.000000000000 Bohr
[INPUT] 19 Be   -10.448569779598  -7.591330301709   0.000000000000 AA  -19.744935276847 -14.345535191342   0.000000000000 Bohr
[INPUT] 20 Be    -8.641917142429  -9.597821330498   0.000000000000 AA  -16.330856590374 -18.137253707150   0.000000000000 Bohr
[INPUT] 21 Be    -6.457571257616 -11.184841511688   0.000000000000 AA  -12.203041106758 -21.136287203756   0.000000000000 Bohr
[INPUT] 22 Be    -3.990998521981 -12.283030447993   0.000000000000 AA   -7.541894170089 -23.211563526400   0.000000000000 Bohr
[INPUT] 23 Be    -1.350000000000 -12.844392013200   0.000000000000 AA   -2.551130268163 -24.272383141500   0.000000000000 Bohr
[INPUT] 24 Be     1.350000000000 -12.844392013200   0.000000000000 AA    2.551130268163 -24.272383141500   0.000000000000 Bohr
[INPUT] 25 Be     3.990998521981 -12.283030447993   0.000000000000 AA    7.541894170089 -23.211563526400   0.000000000000 Bohr
[INPUT] 26 Be     6.457571257616 -11.184841511688   0.000000000000 AA   12.203041106758 -21.136287203756   0.000000000000 Bohr
[INPUT] 27 Be     8.641917142429  -9.597821330498   0.000000000000 AA   16.330856590374 -18.137253707150   0.000000000000 Bohr
[INPUT] 28 Be    10.448569779598  -7.591330301709   0.000000000000 AA   19.744935276847 -14.345535191342   0.000000000000 Bohr
[INPUT] 29 Be    11.798569779598  -5.253061711491   0.000000000000 AA   22.296065545009  -9.926847950157   0.000000000000 Bohr
[INPUT] 30 Be    12.632915664410  -2.685209117494   0.000000000000 AA   23.872750760463  -5.074309819249   0.000000000000 Bohr
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [6    /1   ]  312.8704937       0.00916359628
                                57.36446253       0.04936149294
                                16.0485094        0.1685383049
                                5.513096119       0.3705627997
                                2.140896553       0.4164915298
                                0.8817394283      0.1303340841
[INPUT] 0    0    [6    /1   ]  13.63324744       -0.01325278809
                                2.698375464       -0.04699171014
                                0.8386530829      -0.03378537151
                                0.3226600698      0.2502417861
                                0.1401314882      0.5951172526
                                0.0642325139      0.2407061763
[INPUT] 1    0    [6    /1   ]  13.63324744       0.0037596966
                                2.698375464       0.0376793698
                                0.8386530829      0.1738967435
                                0.3226600698      0.4180364347
                                0.1401314882      0.4258595477
                                0.0642325139      0.1017082955
nuclear repulsion = 331.169527850566
number of shells = 90
number of NR pGTOs = 900
number of NR cGTOs = 150
basis = sto-6g
ecp = {}
CPU time:      4158.07


******** <class 'pyscf.dft.rks.RKS'> flags ********
method = RKS
initial guess = minao
damping factor = 0
level shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
DIIS start cycle = 1
DIIS space = 8
SCF tol = 1e-09
SCF gradient tol = None
max. SCF cycles = 100
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /tigress/xingz/pydmfet/examples/tmpocPyfY
max_memory 16000 MB (current use 232 MB)
XC functionals = pbe,pbe
small_rho_cutoff = 1e-07
radial grids: Treutler-Ahlrichs (JCP 102, 346 (M4)) radial grids
becke partition: Becke, JCP, 88, 2547 (1988)
pruning grids: <function nwchem_prune at 0x2aac1c760cf8>
grids dens level: 3
symmetrized grids: False
atomic radii adjust function: <function treutler_atomic_radii_adjust at 0x2aac1c760b18>
Set gradient conv threshold to 3.16228e-05
tot grids = 393300
init E= -438.018998962831
HOMO: -0.15354341413109024 LUMO: -0.09656704779350067
-0.12860908929010834
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.999e+00
 1.999e+00 1.994e+00 1.994e+00 1.986e+00 3.290e-03 3.233e-03 2.719e-03
 2.719e-03 2.671e-03 2.671e-03 1.538e-03 1.538e-03 1.510e-03 1.510e-03]
entropy corr =  -0.0019361326648393747
cycle= 1 E= -438.19586141862  delta_E= -0.177  |g|= 0.0241  |ddm|= 7.03
HOMO: -0.06692622745655423 LUMO: -0.018803853298754416
-0.046548495082031016
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.999e+00
 1.999e+00 1.987e+00 1.987e+00 1.967e+00 7.753e-03 7.368e-03 6.382e-03
 6.382e-03 6.072e-03 6.072e-03 3.567e-03 3.567e-03 3.404e-03 3.404e-03
 1.364e-03 1.364e-03 1.307e-03 1.307e-03]
entropy corr =  -0.003912825671511409
cycle= 2 E= -438.196605025092  delta_E= -0.000744  |g|= 0.0142  |ddm|= 0.558
HOMO: -0.06939469222530166 LUMO: -0.021180068924179906
-0.04894700910652545
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.999e+00
 1.999e+00 1.987e+00 1.987e+00 1.967e+00 7.719e-03 7.318e-03 6.358e-03
 6.358e-03 6.030e-03 6.030e-03 3.559e-03 3.559e-03 3.379e-03 3.379e-03
 1.364e-03 1.364e-03 1.297e-03 1.297e-03]
entropy corr =  -0.0038910257337032767
cycle= 3 E= -438.203856175954  delta_E= -0.00725  |g|= 0.00065  |ddm|= 0.258
HOMO: -0.06969768930820416 LUMO: -0.021448178171503393
-0.04922245496611692
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.999e+00
 1.999e+00 1.987e+00 1.987e+00 1.967e+00 7.707e-03 7.250e-03 6.349e-03
 6.348e-03 5.974e-03 5.974e-03 3.554e-03 3.554e-03 3.348e-03 3.348e-03
 1.362e-03 1.362e-03 1.285e-03 1.285e-03]
entropy corr =  -0.0038742707561637657
cycle= 4 E= -438.203864175514  delta_E= -8e-06  |g|= 9.97e-06  |ddm|= 0.00842
HOMO: -0.0697100612848555 LUMO: -0.02146254411103306
-0.04923507155350359
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.999e+00
 1.999e+00 1.987e+00 1.987e+00 1.967e+00 7.710e-03 7.248e-03 6.351e-03
 6.351e-03 5.972e-03 5.972e-03 3.556e-03 3.556e-03 3.347e-03 3.347e-03
 1.362e-03 1.362e-03 1.285e-03 1.285e-03]
entropy corr =  -0.003874404812387118
cycle= 5 E= -438.20386417739  delta_E= -1.88e-09  |g|= 8.21e-07  |ddm|= 0.000128
HOMO: -0.06971003935378378 LUMO: -0.02146241346622305
-0.04923501185807482
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.999e+00
 1.999e+00 1.987e+00 1.987e+00 1.967e+00 7.710e-03 7.248e-03 6.351e-03
 6.351e-03 5.972e-03 5.972e-03 3.555e-03 3.555e-03 3.347e-03 3.347e-03
 1.362e-03 1.362e-03 1.285e-03 1.285e-03]
entropy corr =  -0.003874382689155655
cycle= 6 E= -438.20386417739  delta_E= -1.14e-13  |g|= 8.63e-07  |ddm|= 6.78e-06
HOMO: -0.06971003427293662 LUMO: -0.021462373913778268
-0.049234994720834216
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.999e+00
 1.999e+00 1.987e+00 1.987e+00 1.967e+00 7.710e-03 7.248e-03 6.351e-03
 6.351e-03 5.972e-03 5.972e-03 3.555e-03 3.555e-03 3.347e-03 3.347e-03
 1.362e-03 1.362e-03 1.285e-03 1.285e-03]
entropy corr =  -0.003874375620854422
Extra cycle  E= -438.203864177389  delta_E= 4.55e-13  |g|= 1.6e-06  |ddm|= 9.36e-06
converged SCF energy = -438.203864177389
e_mf =  -438.2038641773894
#INFO: **** input file is /tigress/xingz/pydmfet/examples/Be.py ****
from pydmfet import locints, sdmfet, oep, tools
from pyscf import gto, scf,dft, ao2mo,cc
import numpy as np
from pyscf.tools import molden, cubegen
import copy,time

DMguess  = None

bondlengths = np.arange(1.8, 4.1, 0.1)
energies = []

bas = 'sto-6g'

for bondlength in bondlengths:

    nat = 30
    mol = gto.Mole()
    mol.atom = []
    r = 0.5 * bondlength / np.sin(np.pi/nat)
    for i in range(nat):
        theta = i * (2*np.pi/nat)
        mol.atom.append(('Be', (r*np.cos(theta), r*np.sin(theta), 0)))

    mol.basis = bas
    mol.build(max_memory=16000, verbose=4)

    #mf = scf.RHF(mol)
    mf = dft.RKS(mol)
    mf.xc = 'pbe,pbe'
    mf.smear_sigma = 0.005
    mf.max_cycle = 100
    mf.scf()

    #P=mf.make_rdm1()
    #tools.MatPrint(P,"P_ref_ao")
    #cubegen.density(mol, "h20_dens.cube", P, nx=100, ny=100, nz=100)
    print 'e_mf = ',  mf.e_tot
    continue
    if ( True ):   
#        ENUCL = mf.mol.energy_nuc()
#        OEI   = np.dot(np.dot(mf.mo_coeff.T, mol.intor('cint1e_kin_sph') + mol.intor('cint1e_nuc_sph')), mf.mo_coeff)
#        TEI   = ao2mo.outcore.full_iofree(mol, mf.mo_coeff, compact=False).reshape(mol.nao_nr(), mol.nao_nr(), mol.nao_nr(), mol.nao_nr())
#        import chemps2
#        Energy, OneDM = chemps2.solve( ENUCL, OEI, OEI, TEI, mol.nao_nr(), mol.nelectron, mol.nao_nr(), 0.0, False )
#        print "bl =", bondlength," and energy =", Energy

        mycc = cc.CCSD(mf).run()
	et=0.0
        #et = mycc.ccsd_t()
        e_hf = mf.e_tot
        e_ccsd = e_hf + mycc.e_corr + et

        print 'e_tot = ', e_ccsd    #-4.96124910741
        
    else:
        myInts = locints.LocalIntegrals( mf, range( mol.nao_nr() ), 'meta_lowdin' )
        #myInts.loc_molden( 'hydrogen-loc.molden' )
        #myInts.TI_OK = True # Only s functions

	nbas =  mol.nao_nr()
	natoms = mol.natm

	impAtom = np.zeros([natoms], dtype=int)
	for i in range(20):
	    impAtom[i] = 1

	ghost_frag = 1-impAtom
	ghost_env = 1-ghost_frag

	mol_frag = gto.Mole()
	mol_frag.atom = tools.add_ghost(mol.atom, ghost_frag)
	mol_frag.basis = bas
	mol_frag.build(max_memory = 16000,verbose = 4)
	'''
	mf_frag = dft.RKS(mol_frag)
        mf_frag.xc = 'pbe,pbe'
        mf_frag.smear_sigma = 0.00
        mf_frag.scf()
        P_frag=mf_frag.make_rdm1()
        cubegen.density(mol_frag, "h10_dens_1.cube", P_frag, nx=100, ny=100, nz=100)
	'''

	mol_env = gto.Mole()
	mol_env.atom = tools.add_ghost(mol.atom, ghost_env)
	mol_env.basis =  bas
	mol_env.build(max_memory = 16000,verbose = 4)

	'''
	mf_env = dft.RKS(mol_env)
        mf_env.xc = 'pbe,pbe'
        mf_env.smear_sigma = 0.00
        mf_env.scf()
        P_env=mf_env.make_rdm1()
        cubegen.density(mol_env, "h10_dens_2.cube", P_env, nx=100, ny=100, nz=100)
	exit()
	'''



	aoslice = mol.aoslice_by_atom()
	impurities = np.zeros([nbas], dtype = int)
	for i in range(natoms):
	    if(impAtom[i] == 1):
		impurities[aoslice[i,2]:aoslice[i,3]] = 1

	Ne_frag = 20
	boundary_atoms = np.zeros((natoms))
	boundary_atoms[20:40] = 1.0
	#boundary_atoms[19] = -1
	boundary_atoms2 = np.zeros((natoms),dtype =int)
	#boundary_atoms2[9] = -1
	boundary_atoms2[0:20] = 1

	boundary_atoms = None
	boundary_atoms2 =None

	umat=None
	P_frag=None
	P_env=None
	params = oep.OEPparams(algorithm = '2011', opt_method = 'L-BFGS-B', \
                       ftol = 1e-11, gtol = 1e-5,diffP_tol=1e-5, outer_maxit = 200, maxit = 200,l2_lambda = 0.0, oep_print = 0)
	theDMFET = sdmfet.DMFET( mf, mol_frag, mol_env,myInts,impurities, impAtom, Ne_frag, boundary_atoms=boundary_atoms, boundary_atoms2=boundary_atoms2,\
                         umat = umat, P_frag_ao = P_frag, P_env_ao = P_env, \
                         dim_imp = nbas, dim_bath=nbas, dim_big =nbas, smear_sigma = 0.005, oep_params=params,ecw_method='hf', mf_method = mf.xc)

	umat = theDMFET.embedding_potential()

	exit()

	#write subspace orbitals
	transfo = np.dot( myInts.ao2loc, theDMFET.loc2sub )
	filename =  'hydrogen-sub.molden'
	with open( filename, 'w' ) as thefile:
            molden.header( myInts.mol, thefile )
            molden.orbital_coeff( myInts.mol, thefile, transfo )


        umat = theDMFET.embedding_potential()
	print umat
	exit()
	energy = theDMFET.correction_energy()

#INFO: ******************** input file end ********************


System: ('Linux', 'tigercpu.princeton.edu', '3.10.0-693.21.1.el7.x86_64', '#1 SMP Wed Mar 7 15:59:45 EST 2018', 'x86_64', 'x86_64')  Threads 40
Python 2.7.14 |Anaconda, Inc.| (default, Oct 16 2017, 17:29:19) 
[GCC 7.2.0]
numpy 1.14.3  scipy 1.1.0
Date: Thu Jun  7 01:38:18 2018
PySCF version 1.4.2
PySCF path  /tigress/xingz/pyscf/pyscf
GIT ORIG_HEAD e0edd131499dcc18d035a120533a8a1ddda110d4
GIT HEAD      e0edd131499dcc18d035a120533a8a1ddda110d4

[INPUT] VERBOSE 4
[INPUT] num atoms = 30
[INPUT] num electrons = 120
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT]  1 Be    13.393481126908   0.000000000000   0.000000000000 AA   25.310011184387   0.000000000000   0.000000000000 Bohr
[INPUT]  2 Be    13.100801429758   2.784661307031   0.000000000000 AA   24.756926714554   5.262247219962   0.000000000000 Bohr
[INPUT]  3 Be    12.235553845509   5.447619552658   0.000000000000 AA   23.121845750380  10.294508985348   0.000000000000 Bohr
[INPUT]  4 Be    10.835553845509   7.872490683254   0.000000000000 AA   20.476229175989  14.876851309540   0.000000000000 Bohr
[INPUT]  5 Be     8.961988147704   9.953296194591   0.000000000000 AA   16.935703130758  18.809003844452   0.000000000000 Bohr
[INPUT]  6 Be     6.696740563454  11.599094901010   0.000000000000 AA   12.655005592193  21.919112655747   0.000000000000 Bohr
[INPUT]  7 Be     4.138813282055  12.737957501622   0.000000000000 AA    7.821223583796  24.071251064414   0.000000000000 Bohr
[INPUT]  8 Be     1.400000000000  13.320110235912   0.000000000000 AA    2.645616574391  25.171360294889   0.000000000000 Bohr
[INPUT]  9 Be    -1.400000000000  13.320110235912   0.000000000000 AA   -2.645616574391  25.171360294889   0.000000000000 Bohr
[INPUT] 10 Be    -4.138813282055  12.737957501622   0.000000000000 AA   -7.821223583796  24.071251064414   0.000000000000 Bohr
[INPUT] 11 Be    -6.696740563454  11.599094901010   0.000000000000 AA  -12.655005592193  21.919112655747   0.000000000000 Bohr
[INPUT] 12 Be    -8.961988147704   9.953296194591   0.000000000000 AA  -16.935703130758  18.809003844452   0.000000000000 Bohr
[INPUT] 13 Be   -10.835553845509   7.872490683254   0.000000000000 AA  -20.476229175989  14.876851309540   0.000000000000 Bohr
[INPUT] 14 Be   -12.235553845509   5.447619552658   0.000000000000 AA  -23.121845750380  10.294508985349   0.000000000000 Bohr
[INPUT] 15 Be   -13.100801429758   2.784661307031   0.000000000000 AA  -24.756926714554   5.262247219962   0.000000000000 Bohr
[INPUT] 16 Be   -13.393481126908   0.000000000000   0.000000000000 AA  -25.310011184387   0.000000000000   0.000000000000 Bohr
[INPUT] 17 Be   -13.100801429758  -2.784661307031   0.000000000000 AA  -24.756926714554  -5.262247219962   0.000000000000 Bohr
[INPUT] 18 Be   -12.235553845509  -5.447619552658   0.000000000000 AA  -23.121845750380 -10.294508985348   0.000000000000 Bohr
[INPUT] 19 Be   -10.835553845509  -7.872490683254   0.000000000000 AA  -20.476229175989 -14.876851309540   0.000000000000 Bohr
[INPUT] 20 Be    -8.961988147704  -9.953296194591   0.000000000000 AA  -16.935703130758 -18.809003844452   0.000000000000 Bohr
[INPUT] 21 Be    -6.696740563454 -11.599094901010   0.000000000000 AA  -12.655005592193 -21.919112655747   0.000000000000 Bohr
[INPUT] 22 Be    -4.138813282055 -12.737957501622   0.000000000000 AA   -7.821223583796 -24.071251064414   0.000000000000 Bohr
[INPUT] 23 Be    -1.400000000000 -13.320110235912   0.000000000000 AA   -2.645616574391 -25.171360294889   0.000000000000 Bohr
[INPUT] 24 Be     1.400000000000 -13.320110235912   0.000000000000 AA    2.645616574391 -25.171360294889   0.000000000000 Bohr
[INPUT] 25 Be     4.138813282055 -12.737957501622   0.000000000000 AA    7.821223583796 -24.071251064414   0.000000000000 Bohr
[INPUT] 26 Be     6.696740563454 -11.599094901010   0.000000000000 AA   12.655005592193 -21.919112655747   0.000000000000 Bohr
[INPUT] 27 Be     8.961988147704  -9.953296194591   0.000000000000 AA   16.935703130758 -18.809003844452   0.000000000000 Bohr
[INPUT] 28 Be    10.835553845509  -7.872490683254   0.000000000000 AA   20.476229175989 -14.876851309540   0.000000000000 Bohr
[INPUT] 29 Be    12.235553845509  -5.447619552658   0.000000000000 AA   23.121845750380 -10.294508985349   0.000000000000 Bohr
[INPUT] 30 Be    13.100801429758  -2.784661307031   0.000000000000 AA   24.756926714554  -5.262247219962   0.000000000000 Bohr
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [6    /1   ]  312.8704937       0.00916359628
                                57.36446253       0.04936149294
                                16.0485094        0.1685383049
                                5.513096119       0.3705627997
                                2.140896553       0.4164915298
                                0.8817394283      0.1303340841
[INPUT] 0    0    [6    /1   ]  13.63324744       -0.01325278809
                                2.698375464       -0.04699171014
                                0.8386530829      -0.03378537151
                                0.3226600698      0.2502417861
                                0.1401314882      0.5951172526
                                0.0642325139      0.2407061763
[INPUT] 1    0    [6    /1   ]  13.63324744       0.0037596966
                                2.698375464       0.0376793698
                                0.8386530829      0.1738967435
                                0.3226600698      0.4180364347
                                0.1401314882      0.4258595477
                                0.0642325139      0.1017082955
nuclear repulsion = 319.342044713046
number of shells = 90
number of NR pGTOs = 900
number of NR cGTOs = 150
basis = sto-6g
ecp = {}
CPU time:      4528.08


******** <class 'pyscf.dft.rks.RKS'> flags ********
method = RKS
initial guess = minao
damping factor = 0
level shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
DIIS start cycle = 1
DIIS space = 8
SCF tol = 1e-09
SCF gradient tol = None
max. SCF cycles = 100
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /tigress/xingz/pydmfet/examples/tmpPxCDLe
max_memory 16000 MB (current use 233 MB)
XC functionals = pbe,pbe
small_rho_cutoff = 1e-07
radial grids: Treutler-Ahlrichs (JCP 102, 346 (M4)) radial grids
becke partition: Becke, JCP, 88, 2547 (1988)
pruning grids: <function nwchem_prune at 0x2aac1c760cf8>
grids dens level: 3
symmetrized grids: False
atomic radii adjust function: <function treutler_atomic_radii_adjust at 0x2aac1c760b18>
Set gradient conv threshold to 3.16228e-05
tot grids = 393300
init E= -437.789502203067
HOMO: -0.14710974708234892 LUMO: -0.09144118927282335
-0.12293094316675088
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.999e+00
 1.999e+00 1.994e+00 1.994e+00 1.984e+00 3.673e-03 2.667e-03 2.590e-03
 2.246e-03 2.246e-03 2.180e-03 2.180e-03 1.343e-03 1.343e-03 1.303e-03
 1.303e-03 1.069e-03 1.069e-03]
entropy corr =  -0.0020636876723504676
cycle= 1 E= -437.986686564177  delta_E= -0.197  |g|= 0.0177  |ddm|= 6.83
HOMO: -0.06562741338704665 LUMO: -0.0176609372246966
-0.04547344612655594
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.999e+00
 1.999e+00 1.989e+00 1.989e+00 1.965e+00 7.649e-03 5.685e-03 5.346e-03
 4.772e-03 4.772e-03 4.490e-03 4.490e-03 2.828e-03 2.828e-03 2.666e-03
 2.666e-03 1.929e-03 1.929e-03 1.193e-03 1.193e-03 1.128e-03 1.128e-03]
entropy corr =  -0.0037971559519968463
cycle= 2 E= -437.987257442305  delta_E= -0.000571  |g|= 0.0105  |ddm|= 0.558
HOMO: -0.06786796458145278 LUMO: -0.018477676450556424
-0.04751633299986411
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.999e+00
 1.999e+00 1.989e+00 1.989e+00 1.966e+00 5.990e-03 5.770e-03 5.426e-03
 4.845e-03 4.845e-03 4.557e-03 4.557e-03 2.874e-03 2.874e-03 2.705e-03
 2.705e-03 1.530e-03 1.530e-03 1.215e-03 1.215e-03 1.144e-03 1.144e-03]
entropy corr =  -0.003704323158889653
cycle= 3 E= -437.993836654335  delta_E= -0.00658  |g|= 0.000491  |ddm|= 0.254
HOMO: -0.0681343789294417 LUMO: -0.0187283521375257
-0.04775826317657454
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.999e+00
 1.999e+00 1.989e+00 1.989e+00 1.967e+00 6.001e-03 5.756e-03 5.375e-03
 4.833e-03 4.833e-03 4.514e-03 4.514e-03 2.868e-03 2.868e-03 2.680e-03
 2.680e-03 1.534e-03 1.534e-03 1.212e-03 1.212e-03 1.133e-03 1.133e-03]
entropy corr =  -0.0036904298528398754
cycle= 4 E= -437.993843810493  delta_E= -7.16e-06  |g|= 8.35e-06  |ddm|= 0.0083
HOMO: -0.06814523194409507 LUMO: -0.018739406172574587
-0.04776932262507517
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.999e+00
 1.999e+00 1.989e+00 1.989e+00 1.967e+00 6.001e-03 5.758e-03 5.373e-03
 4.835e-03 4.835e-03 4.513e-03 4.513e-03 2.869e-03 2.869e-03 2.679e-03
 2.679e-03 1.534e-03 1.534e-03 1.213e-03 1.213e-03 1.133e-03 1.133e-03]
entropy corr =  -0.0036905374903040706
cycle= 5 E= -437.993843812776  delta_E= -2.28e-09  |g|= 2.47e-06  |ddm|= 0.000145
HOMO: -0.0681452182308746 LUMO: -0.018739348773398886
-0.04776928459810388
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.999e+00
 1.999e+00 1.989e+00 1.989e+00 1.967e+00 6.001e-03 5.758e-03 5.373e-03
 4.835e-03 4.835e-03 4.513e-03 4.513e-03 2.869e-03 2.869e-03 2.679e-03
 2.679e-03 1.534e-03 1.534e-03 1.213e-03 1.213e-03 1.133e-03 1.133e-03]
entropy corr =  -0.003690524136974502
cycle= 6 E= -437.993843812782  delta_E= -6.59e-12  |g|= 1.31e-06  |ddm|= 1.54e-05
HOMO: -0.06814520555051941 LUMO: -0.018739289021795197
-0.04776924475340316
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.999e+00
 1.999e+00 1.989e+00 1.989e+00 1.967e+00 6.001e-03 5.758e-03 5.373e-03
 4.835e-03 4.835e-03 4.513e-03 4.513e-03 2.869e-03 2.869e-03 2.679e-03
 2.679e-03 1.534e-03 1.534e-03 1.213e-03 1.213e-03 1.133e-03 1.133e-03]
entropy corr =  -0.0036905091921364463
Extra cycle  E= -437.993843812773  delta_E= 9.44e-12  |g|= 3.06e-06  |ddm|= 1.8e-05
converged SCF energy = -437.993843812773
e_mf =  -437.993843812773
#INFO: **** input file is /tigress/xingz/pydmfet/examples/Be.py ****
from pydmfet import locints, sdmfet, oep, tools
from pyscf import gto, scf,dft, ao2mo,cc
import numpy as np
from pyscf.tools import molden, cubegen
import copy,time

DMguess  = None

bondlengths = np.arange(1.8, 4.1, 0.1)
energies = []

bas = 'sto-6g'

for bondlength in bondlengths:

    nat = 30
    mol = gto.Mole()
    mol.atom = []
    r = 0.5 * bondlength / np.sin(np.pi/nat)
    for i in range(nat):
        theta = i * (2*np.pi/nat)
        mol.atom.append(('Be', (r*np.cos(theta), r*np.sin(theta), 0)))

    mol.basis = bas
    mol.build(max_memory=16000, verbose=4)

    #mf = scf.RHF(mol)
    mf = dft.RKS(mol)
    mf.xc = 'pbe,pbe'
    mf.smear_sigma = 0.005
    mf.max_cycle = 100
    mf.scf()

    #P=mf.make_rdm1()
    #tools.MatPrint(P,"P_ref_ao")
    #cubegen.density(mol, "h20_dens.cube", P, nx=100, ny=100, nz=100)
    print 'e_mf = ',  mf.e_tot
    continue
    if ( True ):   
#        ENUCL = mf.mol.energy_nuc()
#        OEI   = np.dot(np.dot(mf.mo_coeff.T, mol.intor('cint1e_kin_sph') + mol.intor('cint1e_nuc_sph')), mf.mo_coeff)
#        TEI   = ao2mo.outcore.full_iofree(mol, mf.mo_coeff, compact=False).reshape(mol.nao_nr(), mol.nao_nr(), mol.nao_nr(), mol.nao_nr())
#        import chemps2
#        Energy, OneDM = chemps2.solve( ENUCL, OEI, OEI, TEI, mol.nao_nr(), mol.nelectron, mol.nao_nr(), 0.0, False )
#        print "bl =", bondlength," and energy =", Energy

        mycc = cc.CCSD(mf).run()
	et=0.0
        #et = mycc.ccsd_t()
        e_hf = mf.e_tot
        e_ccsd = e_hf + mycc.e_corr + et

        print 'e_tot = ', e_ccsd    #-4.96124910741
        
    else:
        myInts = locints.LocalIntegrals( mf, range( mol.nao_nr() ), 'meta_lowdin' )
        #myInts.loc_molden( 'hydrogen-loc.molden' )
        #myInts.TI_OK = True # Only s functions

	nbas =  mol.nao_nr()
	natoms = mol.natm

	impAtom = np.zeros([natoms], dtype=int)
	for i in range(20):
	    impAtom[i] = 1

	ghost_frag = 1-impAtom
	ghost_env = 1-ghost_frag

	mol_frag = gto.Mole()
	mol_frag.atom = tools.add_ghost(mol.atom, ghost_frag)
	mol_frag.basis = bas
	mol_frag.build(max_memory = 16000,verbose = 4)
	'''
	mf_frag = dft.RKS(mol_frag)
        mf_frag.xc = 'pbe,pbe'
        mf_frag.smear_sigma = 0.00
        mf_frag.scf()
        P_frag=mf_frag.make_rdm1()
        cubegen.density(mol_frag, "h10_dens_1.cube", P_frag, nx=100, ny=100, nz=100)
	'''

	mol_env = gto.Mole()
	mol_env.atom = tools.add_ghost(mol.atom, ghost_env)
	mol_env.basis =  bas
	mol_env.build(max_memory = 16000,verbose = 4)

	'''
	mf_env = dft.RKS(mol_env)
        mf_env.xc = 'pbe,pbe'
        mf_env.smear_sigma = 0.00
        mf_env.scf()
        P_env=mf_env.make_rdm1()
        cubegen.density(mol_env, "h10_dens_2.cube", P_env, nx=100, ny=100, nz=100)
	exit()
	'''



	aoslice = mol.aoslice_by_atom()
	impurities = np.zeros([nbas], dtype = int)
	for i in range(natoms):
	    if(impAtom[i] == 1):
		impurities[aoslice[i,2]:aoslice[i,3]] = 1

	Ne_frag = 20
	boundary_atoms = np.zeros((natoms))
	boundary_atoms[20:40] = 1.0
	#boundary_atoms[19] = -1
	boundary_atoms2 = np.zeros((natoms),dtype =int)
	#boundary_atoms2[9] = -1
	boundary_atoms2[0:20] = 1

	boundary_atoms = None
	boundary_atoms2 =None

	umat=None
	P_frag=None
	P_env=None
	params = oep.OEPparams(algorithm = '2011', opt_method = 'L-BFGS-B', \
                       ftol = 1e-11, gtol = 1e-5,diffP_tol=1e-5, outer_maxit = 200, maxit = 200,l2_lambda = 0.0, oep_print = 0)
	theDMFET = sdmfet.DMFET( mf, mol_frag, mol_env,myInts,impurities, impAtom, Ne_frag, boundary_atoms=boundary_atoms, boundary_atoms2=boundary_atoms2,\
                         umat = umat, P_frag_ao = P_frag, P_env_ao = P_env, \
                         dim_imp = nbas, dim_bath=nbas, dim_big =nbas, smear_sigma = 0.005, oep_params=params,ecw_method='hf', mf_method = mf.xc)

	umat = theDMFET.embedding_potential()

	exit()

	#write subspace orbitals
	transfo = np.dot( myInts.ao2loc, theDMFET.loc2sub )
	filename =  'hydrogen-sub.molden'
	with open( filename, 'w' ) as thefile:
            molden.header( myInts.mol, thefile )
            molden.orbital_coeff( myInts.mol, thefile, transfo )


        umat = theDMFET.embedding_potential()
	print umat
	exit()
	energy = theDMFET.correction_energy()

#INFO: ******************** input file end ********************


System: ('Linux', 'tigercpu.princeton.edu', '3.10.0-693.21.1.el7.x86_64', '#1 SMP Wed Mar 7 15:59:45 EST 2018', 'x86_64', 'x86_64')  Threads 40
Python 2.7.14 |Anaconda, Inc.| (default, Oct 16 2017, 17:29:19) 
[GCC 7.2.0]
numpy 1.14.3  scipy 1.1.0
Date: Thu Jun  7 01:38:32 2018
PySCF version 1.4.2
PySCF path  /tigress/xingz/pyscf/pyscf
GIT ORIG_HEAD e0edd131499dcc18d035a120533a8a1ddda110d4
GIT HEAD      e0edd131499dcc18d035a120533a8a1ddda110d4

[INPUT] VERBOSE 4
[INPUT] num atoms = 30
[INPUT] num electrons = 120
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT]  1 Be    13.871819738583   0.000000000000   0.000000000000 AA   26.213940155258   0.000000000000   0.000000000000 Bohr
[INPUT]  2 Be    13.568687195107   2.884113496568   0.000000000000 AA   25.641102668645   5.450184620675   0.000000000000 Bohr
[INPUT]  3 Be    12.672537911420   5.642177393824   0.000000000000 AA   23.947625955751  10.662170020540   0.000000000000 Bohr
[INPUT]  4 Be    11.222537911420   8.153651064799   0.000000000000 AA   21.207523075131  15.408167427738   0.000000000000 Bohr
[INPUT]  5 Be     9.282059152979  10.308771058683   0.000000000000 AA   17.540549671143  19.480753981754   0.000000000000 Bohr
[INPUT]  6 Be     6.935909869292  12.013348290331   0.000000000000 AA   13.106970077629  22.701938107738   0.000000000000 Bohr
[INPUT]  7 Be     4.286628042128  13.192884555251   0.000000000000 AA    8.100552997503  24.930938602429   0.000000000000 Bohr
[INPUT]  8 Be     1.450000000000  13.795828458623   0.000000000000 AA    2.740102880619  26.070337448278   0.000000000000 Bohr
[INPUT]  9 Be    -1.450000000000  13.795828458623   0.000000000000 AA   -2.740102880619  26.070337448278   0.000000000000 Bohr
[INPUT] 10 Be    -4.286628042128  13.192884555251   0.000000000000 AA   -8.100552997503  24.930938602429   0.000000000000 Bohr
[INPUT] 11 Be    -6.935909869292  12.013348290331   0.000000000000 AA  -13.106970077629  22.701938107738   0.000000000000 Bohr
[INPUT] 12 Be    -9.282059152979  10.308771058683   0.000000000000 AA  -17.540549671143  19.480753981754   0.000000000000 Bohr
[INPUT] 13 Be   -11.222537911420   8.153651064799   0.000000000000 AA  -21.207523075131  15.408167427738   0.000000000000 Bohr
[INPUT] 14 Be   -12.672537911420   5.642177393824   0.000000000000 AA  -23.947625955751  10.662170020540   0.000000000000 Bohr
[INPUT] 15 Be   -13.568687195107   2.884113496568   0.000000000000 AA  -25.641102668645   5.450184620675   0.000000000000 Bohr
[INPUT] 16 Be   -13.871819738583   0.000000000000   0.000000000000 AA  -26.213940155258   0.000000000000   0.000000000000 Bohr
[INPUT] 17 Be   -13.568687195107  -2.884113496568   0.000000000000 AA  -25.641102668645  -5.450184620675   0.000000000000 Bohr
[INPUT] 18 Be   -12.672537911420  -5.642177393824   0.000000000000 AA  -23.947625955751 -10.662170020540   0.000000000000 Bohr
[INPUT] 19 Be   -11.222537911420  -8.153651064799   0.000000000000 AA  -21.207523075131 -15.408167427738   0.000000000000 Bohr
[INPUT] 20 Be    -9.282059152979 -10.308771058683   0.000000000000 AA  -17.540549671143 -19.480753981754   0.000000000000 Bohr
[INPUT] 21 Be    -6.935909869292 -12.013348290331   0.000000000000 AA  -13.106970077629 -22.701938107738   0.000000000000 Bohr
[INPUT] 22 Be    -4.286628042128 -13.192884555251   0.000000000000 AA   -8.100552997503 -24.930938602429   0.000000000000 Bohr
[INPUT] 23 Be    -1.450000000000 -13.795828458623   0.000000000000 AA   -2.740102880619 -26.070337448278   0.000000000000 Bohr
[INPUT] 24 Be     1.450000000000 -13.795828458623   0.000000000000 AA    2.740102880619 -26.070337448278   0.000000000000 Bohr
[INPUT] 25 Be     4.286628042128 -13.192884555251   0.000000000000 AA    8.100552997503 -24.930938602429   0.000000000000 Bohr
[INPUT] 26 Be     6.935909869292 -12.013348290331   0.000000000000 AA   13.106970077629 -22.701938107738   0.000000000000 Bohr
[INPUT] 27 Be     9.282059152979 -10.308771058683   0.000000000000 AA   17.540549671143 -19.480753981754   0.000000000000 Bohr
[INPUT] 28 Be    11.222537911420  -8.153651064799   0.000000000000 AA   21.207523075131 -15.408167427738   0.000000000000 Bohr
[INPUT] 29 Be    12.672537911420  -5.642177393824   0.000000000000 AA   23.947625955751 -10.662170020540   0.000000000000 Bohr
[INPUT] 30 Be    13.568687195107  -2.884113496568   0.000000000000 AA   25.641102668645  -5.450184620675   0.000000000000 Bohr
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [6    /1   ]  312.8704937       0.00916359628
                                57.36446253       0.04936149294
                                16.0485094        0.1685383049
                                5.513096119       0.3705627997
                                2.140896553       0.4164915298
                                0.8817394283      0.1303340841
[INPUT] 0    0    [6    /1   ]  13.63324744       -0.01325278809
                                2.698375464       -0.04699171014
                                0.8386530829      -0.03378537151
                                0.3226600698      0.2502417861
                                0.1401314882      0.5951172526
                                0.0642325139      0.2407061763
[INPUT] 1    0    [6    /1   ]  13.63324744       0.0037596966
                                2.698375464       0.0376793698
                                0.8386530829      0.1738967435
                                0.3226600698      0.4180364347
                                0.1401314882      0.4258595477
                                0.0642325139      0.1017082955
nuclear repulsion = 308.330250067768
number of shells = 90
number of NR pGTOs = 900
number of NR cGTOs = 150
basis = sto-6g
ecp = {}
CPU time:      4913.24


******** <class 'pyscf.dft.rks.RKS'> flags ********
method = RKS
initial guess = minao
damping factor = 0
level shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
DIIS start cycle = 1
DIIS space = 8
SCF tol = 1e-09
SCF gradient tol = None
max. SCF cycles = 100
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /tigress/xingz/pydmfet/examples/tmpD3dSFM
max_memory 16000 MB (current use 233 MB)
XC functionals = pbe,pbe
small_rho_cutoff = 1e-07
radial grids: Treutler-Ahlrichs (JCP 102, 346 (M4)) radial grids
becke partition: Becke, JCP, 88, 2547 (1988)
pruning grids: <function nwchem_prune at 0x2aac1c760cf8>
grids dens level: 3
symmetrized grids: False
atomic radii adjust function: <function treutler_atomic_radii_adjust at 0x2aac1c760b18>
Set gradient conv threshold to 3.16228e-05
tot grids = 393300
init E= -437.591923219155
HOMO: -0.14076009356511288 LUMO: -0.10292776318736743
-0.12193828491136313
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    1.999 1.999 1.987 1.987 1.955
 0.044 0.01  0.01 ]
entropy corr =  -0.004088290109103912
cycle= 1 E= -437.783791312929  delta_E= -0.192  |g|= 0.0122  |ddm|= 6.55
HOMO: -0.06412140442112184 LUMO: -0.03271709950769592
-0.04859580871373289
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.999e+00
 1.999e+00 1.980e+00 1.980e+00 1.914e+00 8.018e-02 1.547e-02 1.547e-02
 1.944e-03 1.810e-03 1.661e-03 1.661e-03 1.547e-03 1.547e-03 1.039e-03
 1.039e-03]
entropy corr =  -0.00638927429703296
cycle= 2 E= -437.78399951547  delta_E= -0.000208  |g|= 0.00981  |ddm|= 0.563
HOMO: -0.06612849287442757 LUMO: -0.03354814885046831
-0.05007848286078312
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.999e+00
 1.999e+00 1.981e+00 1.981e+00 1.922e+00 7.073e-02 1.392e-02 1.392e-02
 2.092e-03 1.955e-03 1.788e-03 1.788e-03 1.671e-03 1.671e-03 1.119e-03
 1.119e-03 1.046e-03 1.046e-03]
entropy corr =  -0.0059989090786986025
cycle= 3 E= -437.790022790148  delta_E= -0.00602  |g|= 0.000342  |ddm|= 0.25
HOMO: -0.06636894243027772 LUMO: -0.0337567171026247
-0.05030065981947446
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.999e+00
 1.999e+00 1.981e+00 1.981e+00 1.923e+00 7.054e-02 1.390e-02 1.390e-02
 2.083e-03 1.934e-03 1.780e-03 1.780e-03 1.653e-03 1.653e-03 1.114e-03
 1.114e-03 1.035e-03 1.035e-03]
entropy corr =  -0.0059835724181065385
cycle= 4 E= -437.790027806777  delta_E= -5.02e-06  |g|= 7.26e-06  |ddm|= 0.00743
HOMO: -0.06637836772797547 LUMO: -0.033766003332554494
-0.05031004636879908
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.999e+00
 1.999e+00 1.981e+00 1.981e+00 1.923e+00 7.054e-02 1.390e-02 1.390e-02
 2.084e-03 1.934e-03 1.781e-03 1.781e-03 1.653e-03 1.653e-03 1.115e-03
 1.115e-03 1.035e-03 1.035e-03]
entropy corr =  -0.005983544119344006
cycle= 5 E= -437.790027809743  delta_E= -2.97e-09  |g|= 6.99e-06  |ddm|= 0.000175
HOMO: -0.06637836434144538 LUMO: -0.03376597107903824
-0.0503100279694138
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.999e+00
 1.999e+00 1.981e+00 1.981e+00 1.923e+00 7.054e-02 1.390e-02 1.390e-02
 2.084e-03 1.934e-03 1.781e-03 1.781e-03 1.653e-03 1.653e-03 1.115e-03
 1.115e-03 1.035e-03 1.035e-03]
entropy corr =  -0.005983532124634234
cycle= 6 E= -437.790027809806  delta_E= -6.31e-11  |g|= 1.25e-06  |ddm|= 3.8e-05
HOMO: -0.06637835749372739 LUMO: -0.03376590443823524
-0.05030998980842145
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.999e+00
 1.999e+00 1.981e+00 1.981e+00 1.923e+00 7.054e-02 1.390e-02 1.390e-02
 2.084e-03 1.934e-03 1.781e-03 1.781e-03 1.653e-03 1.653e-03 1.115e-03
 1.115e-03 1.035e-03 1.035e-03]
entropy corr =  -0.005983507017646715
Extra cycle  E= -437.790027809791  delta_E= 1.51e-11  |g|= 3.56e-06  |ddm|= 2.41e-05
converged SCF energy = -437.790027809791
e_mf =  -437.790027809791
#INFO: **** input file is /tigress/xingz/pydmfet/examples/Be.py ****
from pydmfet import locints, sdmfet, oep, tools
from pyscf import gto, scf,dft, ao2mo,cc
import numpy as np
from pyscf.tools import molden, cubegen
import copy,time

DMguess  = None

bondlengths = np.arange(1.8, 4.1, 0.1)
energies = []

bas = 'sto-6g'

for bondlength in bondlengths:

    nat = 30
    mol = gto.Mole()
    mol.atom = []
    r = 0.5 * bondlength / np.sin(np.pi/nat)
    for i in range(nat):
        theta = i * (2*np.pi/nat)
        mol.atom.append(('Be', (r*np.cos(theta), r*np.sin(theta), 0)))

    mol.basis = bas
    mol.build(max_memory=16000, verbose=4)

    #mf = scf.RHF(mol)
    mf = dft.RKS(mol)
    mf.xc = 'pbe,pbe'
    mf.smear_sigma = 0.005
    mf.max_cycle = 100
    mf.scf()

    #P=mf.make_rdm1()
    #tools.MatPrint(P,"P_ref_ao")
    #cubegen.density(mol, "h20_dens.cube", P, nx=100, ny=100, nz=100)
    print 'e_mf = ',  mf.e_tot
    continue
    if ( True ):   
#        ENUCL = mf.mol.energy_nuc()
#        OEI   = np.dot(np.dot(mf.mo_coeff.T, mol.intor('cint1e_kin_sph') + mol.intor('cint1e_nuc_sph')), mf.mo_coeff)
#        TEI   = ao2mo.outcore.full_iofree(mol, mf.mo_coeff, compact=False).reshape(mol.nao_nr(), mol.nao_nr(), mol.nao_nr(), mol.nao_nr())
#        import chemps2
#        Energy, OneDM = chemps2.solve( ENUCL, OEI, OEI, TEI, mol.nao_nr(), mol.nelectron, mol.nao_nr(), 0.0, False )
#        print "bl =", bondlength," and energy =", Energy

        mycc = cc.CCSD(mf).run()
	et=0.0
        #et = mycc.ccsd_t()
        e_hf = mf.e_tot
        e_ccsd = e_hf + mycc.e_corr + et

        print 'e_tot = ', e_ccsd    #-4.96124910741
        
    else:
        myInts = locints.LocalIntegrals( mf, range( mol.nao_nr() ), 'meta_lowdin' )
        #myInts.loc_molden( 'hydrogen-loc.molden' )
        #myInts.TI_OK = True # Only s functions

	nbas =  mol.nao_nr()
	natoms = mol.natm

	impAtom = np.zeros([natoms], dtype=int)
	for i in range(20):
	    impAtom[i] = 1

	ghost_frag = 1-impAtom
	ghost_env = 1-ghost_frag

	mol_frag = gto.Mole()
	mol_frag.atom = tools.add_ghost(mol.atom, ghost_frag)
	mol_frag.basis = bas
	mol_frag.build(max_memory = 16000,verbose = 4)
	'''
	mf_frag = dft.RKS(mol_frag)
        mf_frag.xc = 'pbe,pbe'
        mf_frag.smear_sigma = 0.00
        mf_frag.scf()
        P_frag=mf_frag.make_rdm1()
        cubegen.density(mol_frag, "h10_dens_1.cube", P_frag, nx=100, ny=100, nz=100)
	'''

	mol_env = gto.Mole()
	mol_env.atom = tools.add_ghost(mol.atom, ghost_env)
	mol_env.basis =  bas
	mol_env.build(max_memory = 16000,verbose = 4)

	'''
	mf_env = dft.RKS(mol_env)
        mf_env.xc = 'pbe,pbe'
        mf_env.smear_sigma = 0.00
        mf_env.scf()
        P_env=mf_env.make_rdm1()
        cubegen.density(mol_env, "h10_dens_2.cube", P_env, nx=100, ny=100, nz=100)
	exit()
	'''



	aoslice = mol.aoslice_by_atom()
	impurities = np.zeros([nbas], dtype = int)
	for i in range(natoms):
	    if(impAtom[i] == 1):
		impurities[aoslice[i,2]:aoslice[i,3]] = 1

	Ne_frag = 20
	boundary_atoms = np.zeros((natoms))
	boundary_atoms[20:40] = 1.0
	#boundary_atoms[19] = -1
	boundary_atoms2 = np.zeros((natoms),dtype =int)
	#boundary_atoms2[9] = -1
	boundary_atoms2[0:20] = 1

	boundary_atoms = None
	boundary_atoms2 =None

	umat=None
	P_frag=None
	P_env=None
	params = oep.OEPparams(algorithm = '2011', opt_method = 'L-BFGS-B', \
                       ftol = 1e-11, gtol = 1e-5,diffP_tol=1e-5, outer_maxit = 200, maxit = 200,l2_lambda = 0.0, oep_print = 0)
	theDMFET = sdmfet.DMFET( mf, mol_frag, mol_env,myInts,impurities, impAtom, Ne_frag, boundary_atoms=boundary_atoms, boundary_atoms2=boundary_atoms2,\
                         umat = umat, P_frag_ao = P_frag, P_env_ao = P_env, \
                         dim_imp = nbas, dim_bath=nbas, dim_big =nbas, smear_sigma = 0.005, oep_params=params,ecw_method='hf', mf_method = mf.xc)

	umat = theDMFET.embedding_potential()

	exit()

	#write subspace orbitals
	transfo = np.dot( myInts.ao2loc, theDMFET.loc2sub )
	filename =  'hydrogen-sub.molden'
	with open( filename, 'w' ) as thefile:
            molden.header( myInts.mol, thefile )
            molden.orbital_coeff( myInts.mol, thefile, transfo )


        umat = theDMFET.embedding_potential()
	print umat
	exit()
	energy = theDMFET.correction_energy()

#INFO: ******************** input file end ********************


System: ('Linux', 'tigercpu.princeton.edu', '3.10.0-693.21.1.el7.x86_64', '#1 SMP Wed Mar 7 15:59:45 EST 2018', 'x86_64', 'x86_64')  Threads 40
Python 2.7.14 |Anaconda, Inc.| (default, Oct 16 2017, 17:29:19) 
[GCC 7.2.0]
numpy 1.14.3  scipy 1.1.0
Date: Thu Jun  7 01:38:45 2018
PySCF version 1.4.2
PySCF path  /tigress/xingz/pyscf/pyscf
GIT ORIG_HEAD e0edd131499dcc18d035a120533a8a1ddda110d4
GIT HEAD      e0edd131499dcc18d035a120533a8a1ddda110d4

[INPUT] VERBOSE 4
[INPUT] num atoms = 30
[INPUT] num electrons = 120
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT]  1 Be    14.350158350258   0.000000000000   0.000000000000 AA   27.117869126129   0.000000000000   0.000000000000 Bohr
[INPUT]  2 Be    14.036572960455   2.983565686105   0.000000000000 AA   26.525278622736   5.638122021388   0.000000000000 Bohr
[INPUT]  3 Be    13.109521977331   5.836735234990   0.000000000000 AA   24.773406161122  11.029831055731   0.000000000000 Bohr
[INPUT]  4 Be    11.609521977331   8.434811446344   0.000000000000 AA   21.938816974274  15.939483545936   0.000000000000 Bohr
[INPUT]  5 Be     9.602130158254  10.664245922776   0.000000000000 AA   18.145396211527  20.152504119056   0.000000000000 Bohr
[INPUT]  6 Be     7.175079175129  12.427601679653   0.000000000000 AA   13.558934563064  23.484763559729   0.000000000000 Bohr
[INPUT]  7 Be     4.434442802201  13.647811608881   0.000000000000 AA    8.379882411210  25.790626140444   0.000000000000 Bohr
[INPUT]  8 Be     1.500000000000  14.271546681334   0.000000000000 AA    2.834589186848  26.969314601666   0.000000000000 Bohr
[INPUT]  9 Be    -1.500000000000  14.271546681334   0.000000000000 AA   -2.834589186848  26.969314601666   0.000000000000 Bohr
[INPUT] 10 Be    -4.434442802201  13.647811608881   0.000000000000 AA   -8.379882411210  25.790626140444   0.000000000000 Bohr
[INPUT] 11 Be    -7.175079175129  12.427601679653   0.000000000000 AA  -13.558934563064  23.484763559729   0.000000000000 Bohr
[INPUT] 12 Be    -9.602130158254  10.664245922776   0.000000000000 AA  -18.145396211527  20.152504119056   0.000000000000 Bohr
[INPUT] 13 Be   -11.609521977331   8.434811446344   0.000000000000 AA  -21.938816974274  15.939483545936   0.000000000000 Bohr
[INPUT] 14 Be   -13.109521977331   5.836735234990   0.000000000000 AA  -24.773406161122  11.029831055731   0.000000000000 Bohr
[INPUT] 15 Be   -14.036572960455   2.983565686105   0.000000000000 AA  -26.525278622736   5.638122021388   0.000000000000 Bohr
[INPUT] 16 Be   -14.350158350258   0.000000000000   0.000000000000 AA  -27.117869126129   0.000000000000   0.000000000000 Bohr
[INPUT] 17 Be   -14.036572960455  -2.983565686105   0.000000000000 AA  -26.525278622736  -5.638122021388   0.000000000000 Bohr
[INPUT] 18 Be   -13.109521977331  -5.836735234990   0.000000000000 AA  -24.773406161122 -11.029831055731   0.000000000000 Bohr
[INPUT] 19 Be   -11.609521977331  -8.434811446344   0.000000000000 AA  -21.938816974274 -15.939483545936   0.000000000000 Bohr
[INPUT] 20 Be    -9.602130158254 -10.664245922776   0.000000000000 AA  -18.145396211527 -20.152504119056   0.000000000000 Bohr
[INPUT] 21 Be    -7.175079175129 -12.427601679653   0.000000000000 AA  -13.558934563064 -23.484763559729   0.000000000000 Bohr
[INPUT] 22 Be    -4.434442802201 -13.647811608881   0.000000000000 AA   -8.379882411210 -25.790626140444   0.000000000000 Bohr
[INPUT] 23 Be    -1.500000000000 -14.271546681334   0.000000000000 AA   -2.834589186848 -26.969314601666   0.000000000000 Bohr
[INPUT] 24 Be     1.500000000000 -14.271546681334   0.000000000000 AA    2.834589186848 -26.969314601666   0.000000000000 Bohr
[INPUT] 25 Be     4.434442802201 -13.647811608881   0.000000000000 AA    8.379882411210 -25.790626140444   0.000000000000 Bohr
[INPUT] 26 Be     7.175079175129 -12.427601679653   0.000000000000 AA   13.558934563064 -23.484763559729   0.000000000000 Bohr
[INPUT] 27 Be     9.602130158254 -10.664245922776   0.000000000000 AA   18.145396211527 -20.152504119056   0.000000000000 Bohr
[INPUT] 28 Be    11.609521977331  -8.434811446344   0.000000000000 AA   21.938816974274 -15.939483545936   0.000000000000 Bohr
[INPUT] 29 Be    13.109521977331  -5.836735234990   0.000000000000 AA   24.773406161122 -11.029831055731   0.000000000000 Bohr
[INPUT] 30 Be    14.036572960455  -2.983565686105   0.000000000000 AA   26.525278622736  -5.638122021388   0.000000000000 Bohr
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [6    /1   ]  312.8704937       0.00916359628
                                57.36446253       0.04936149294
                                16.0485094        0.1685383049
                                5.513096119       0.3705627997
                                2.140896553       0.4164915298
                                0.8817394283      0.1303340841
[INPUT] 0    0    [6    /1   ]  13.63324744       -0.01325278809
                                2.698375464       -0.04699171014
                                0.8386530829      -0.03378537151
                                0.3226600698      0.2502417861
                                0.1401314882      0.5951172526
                                0.0642325139      0.2407061763
[INPUT] 1    0    [6    /1   ]  13.63324744       0.0037596966
                                2.698375464       0.0376793698
                                0.8386530829      0.1738967435
                                0.3226600698      0.4180364347
                                0.1401314882      0.4258595477
                                0.0642325139      0.1017082955
nuclear repulsion = 298.052575065509
number of shells = 90
number of NR pGTOs = 900
number of NR cGTOs = 150
basis = sto-6g
ecp = {}
CPU time:      5289.98


******** <class 'pyscf.dft.rks.RKS'> flags ********
method = RKS
initial guess = minao
damping factor = 0
level shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
DIIS start cycle = 1
DIIS space = 8
SCF tol = 1e-09
SCF gradient tol = None
max. SCF cycles = 100
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /tigress/xingz/pydmfet/examples/tmpjKeAi1
max_memory 16000 MB (current use 229 MB)
XC functionals = pbe,pbe
small_rho_cutoff = 1e-07
radial grids: Treutler-Ahlrichs (JCP 102, 346 (M4)) radial grids
becke partition: Becke, JCP, 88, 2547 (1988)
pruning grids: <function nwchem_prune at 0x2aac1c760cf8>
grids dens level: 3
symmetrized grids: False
atomic radii adjust function: <function treutler_atomic_radii_adjust at 0x2aac1c760b18>
Set gradient conv threshold to 3.16228e-05
tot grids = 393300
init E= -437.422483175637
HOMO: -0.13448791817680988 LUMO: -0.1131096670070946
-0.12364797272064774
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.997e+00
 1.997e+00 1.959e+00 1.959e+00 1.795e+00 2.167e-01 3.547e-02 3.547e-02
 1.322e-03 1.322e-03]
entropy corr =  -0.010967816403583413
cycle= 1 E= -437.596470376486  delta_E= -0.174  |g|= 0.01  |ddm|=  6.1
HOMO: -0.06257287024317115 LUMO: -0.046270366566553145
-0.05430147345554741
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.997e+00
 1.997e+00 1.949e+00 1.949e+00 1.679e+00 3.342e-01 4.465e-02 4.465e-02
 1.499e-03 1.499e-03]
entropy corr =  -0.014025020959971376
cycle= 2 E= -437.59617033175  delta_E= 0.0003  |g|= 0.00699  |ddm|= 0.585
HOMO: -0.06432339379260049 LUMO: -0.04707099724847929
-0.055576718335810266
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.997e+00
 1.997e+00 1.951e+00 1.951e+00 1.704e+00 3.086e-01 4.225e-02 4.225e-02
 1.412e-03 1.412e-03]
entropy corr =  -0.013409817776782504
cycle= 3 E= -437.601616879295  delta_E= -0.00545  |g|= 0.00029  |ddm|= 0.245
HOMO: -0.06455304655409619 LUMO: -0.0472495413306072
-0.055780462660952115
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.997e+00
 1.997e+00 1.951e+00 1.951e+00 1.705e+00 3.073e-01 4.217e-02 4.217e-02
 1.412e-03 1.412e-03]
entropy corr =  -0.013378795947805666
cycle= 4 E= -437.601619058196  delta_E= -2.18e-06  |g|= 7.59e-06  |ddm|= 0.00659
HOMO: -0.06456107632064274 LUMO: -0.047257017637754556
-0.055788215523219734
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.997e+00
 1.997e+00 1.951e+00 1.951e+00 1.705e+00 3.073e-01 4.216e-02 4.216e-02
 1.412e-03 1.412e-03]
entropy corr =  -0.013378413320484436
cycle= 5 E= -437.601619062535  delta_E= -4.34e-09  |g|= 4.99e-06  |ddm|= 0.000212
HOMO: -0.06456108062300044 LUMO: -0.04725699239719559
-0.055788204876926845
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.997e+00
 1.997e+00 1.951e+00 1.951e+00 1.705e+00 3.073e-01 4.216e-02 4.216e-02
 1.412e-03 1.412e-03]
entropy corr =  -0.013378395298037445
cycle= 6 E= -437.601619062559  delta_E= -2.46e-11  |g|= 2.45e-06  |ddm|= 3.25e-05
HOMO: -0.0645610904857502 LUMO: -0.047256949483653846
-0.05578818802654924
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.997e+00
 1.997e+00 1.951e+00 1.951e+00 1.705e+00 3.073e-01 4.216e-02 4.216e-02
 1.412e-03 1.412e-03]
entropy corr =  -0.01337836315405927
Extra cycle  E= -437.601619062454  delta_E= 1.05e-10  |g|= 8.89e-06  |ddm|= 5.45e-05
converged SCF energy = -437.601619062454
e_mf =  -437.601619062454
#INFO: **** input file is /tigress/xingz/pydmfet/examples/Be.py ****
from pydmfet import locints, sdmfet, oep, tools
from pyscf import gto, scf,dft, ao2mo,cc
import numpy as np
from pyscf.tools import molden, cubegen
import copy,time

DMguess  = None

bondlengths = np.arange(1.8, 4.1, 0.1)
energies = []

bas = 'sto-6g'

for bondlength in bondlengths:

    nat = 30
    mol = gto.Mole()
    mol.atom = []
    r = 0.5 * bondlength / np.sin(np.pi/nat)
    for i in range(nat):
        theta = i * (2*np.pi/nat)
        mol.atom.append(('Be', (r*np.cos(theta), r*np.sin(theta), 0)))

    mol.basis = bas
    mol.build(max_memory=16000, verbose=4)

    #mf = scf.RHF(mol)
    mf = dft.RKS(mol)
    mf.xc = 'pbe,pbe'
    mf.smear_sigma = 0.005
    mf.max_cycle = 100
    mf.scf()

    #P=mf.make_rdm1()
    #tools.MatPrint(P,"P_ref_ao")
    #cubegen.density(mol, "h20_dens.cube", P, nx=100, ny=100, nz=100)
    print 'e_mf = ',  mf.e_tot
    continue
    if ( True ):   
#        ENUCL = mf.mol.energy_nuc()
#        OEI   = np.dot(np.dot(mf.mo_coeff.T, mol.intor('cint1e_kin_sph') + mol.intor('cint1e_nuc_sph')), mf.mo_coeff)
#        TEI   = ao2mo.outcore.full_iofree(mol, mf.mo_coeff, compact=False).reshape(mol.nao_nr(), mol.nao_nr(), mol.nao_nr(), mol.nao_nr())
#        import chemps2
#        Energy, OneDM = chemps2.solve( ENUCL, OEI, OEI, TEI, mol.nao_nr(), mol.nelectron, mol.nao_nr(), 0.0, False )
#        print "bl =", bondlength," and energy =", Energy

        mycc = cc.CCSD(mf).run()
	et=0.0
        #et = mycc.ccsd_t()
        e_hf = mf.e_tot
        e_ccsd = e_hf + mycc.e_corr + et

        print 'e_tot = ', e_ccsd    #-4.96124910741
        
    else:
        myInts = locints.LocalIntegrals( mf, range( mol.nao_nr() ), 'meta_lowdin' )
        #myInts.loc_molden( 'hydrogen-loc.molden' )
        #myInts.TI_OK = True # Only s functions

	nbas =  mol.nao_nr()
	natoms = mol.natm

	impAtom = np.zeros([natoms], dtype=int)
	for i in range(20):
	    impAtom[i] = 1

	ghost_frag = 1-impAtom
	ghost_env = 1-ghost_frag

	mol_frag = gto.Mole()
	mol_frag.atom = tools.add_ghost(mol.atom, ghost_frag)
	mol_frag.basis = bas
	mol_frag.build(max_memory = 16000,verbose = 4)
	'''
	mf_frag = dft.RKS(mol_frag)
        mf_frag.xc = 'pbe,pbe'
        mf_frag.smear_sigma = 0.00
        mf_frag.scf()
        P_frag=mf_frag.make_rdm1()
        cubegen.density(mol_frag, "h10_dens_1.cube", P_frag, nx=100, ny=100, nz=100)
	'''

	mol_env = gto.Mole()
	mol_env.atom = tools.add_ghost(mol.atom, ghost_env)
	mol_env.basis =  bas
	mol_env.build(max_memory = 16000,verbose = 4)

	'''
	mf_env = dft.RKS(mol_env)
        mf_env.xc = 'pbe,pbe'
        mf_env.smear_sigma = 0.00
        mf_env.scf()
        P_env=mf_env.make_rdm1()
        cubegen.density(mol_env, "h10_dens_2.cube", P_env, nx=100, ny=100, nz=100)
	exit()
	'''



	aoslice = mol.aoslice_by_atom()
	impurities = np.zeros([nbas], dtype = int)
	for i in range(natoms):
	    if(impAtom[i] == 1):
		impurities[aoslice[i,2]:aoslice[i,3]] = 1

	Ne_frag = 20
	boundary_atoms = np.zeros((natoms))
	boundary_atoms[20:40] = 1.0
	#boundary_atoms[19] = -1
	boundary_atoms2 = np.zeros((natoms),dtype =int)
	#boundary_atoms2[9] = -1
	boundary_atoms2[0:20] = 1

	boundary_atoms = None
	boundary_atoms2 =None

	umat=None
	P_frag=None
	P_env=None
	params = oep.OEPparams(algorithm = '2011', opt_method = 'L-BFGS-B', \
                       ftol = 1e-11, gtol = 1e-5,diffP_tol=1e-5, outer_maxit = 200, maxit = 200,l2_lambda = 0.0, oep_print = 0)
	theDMFET = sdmfet.DMFET( mf, mol_frag, mol_env,myInts,impurities, impAtom, Ne_frag, boundary_atoms=boundary_atoms, boundary_atoms2=boundary_atoms2,\
                         umat = umat, P_frag_ao = P_frag, P_env_ao = P_env, \
                         dim_imp = nbas, dim_bath=nbas, dim_big =nbas, smear_sigma = 0.005, oep_params=params,ecw_method='hf', mf_method = mf.xc)

	umat = theDMFET.embedding_potential()

	exit()

	#write subspace orbitals
	transfo = np.dot( myInts.ao2loc, theDMFET.loc2sub )
	filename =  'hydrogen-sub.molden'
	with open( filename, 'w' ) as thefile:
            molden.header( myInts.mol, thefile )
            molden.orbital_coeff( myInts.mol, thefile, transfo )


        umat = theDMFET.embedding_potential()
	print umat
	exit()
	energy = theDMFET.correction_energy()

#INFO: ******************** input file end ********************


System: ('Linux', 'tigercpu.princeton.edu', '3.10.0-693.21.1.el7.x86_64', '#1 SMP Wed Mar 7 15:59:45 EST 2018', 'x86_64', 'x86_64')  Threads 40
Python 2.7.14 |Anaconda, Inc.| (default, Oct 16 2017, 17:29:19) 
[GCC 7.2.0]
numpy 1.14.3  scipy 1.1.0
Date: Thu Jun  7 01:38:59 2018
PySCF version 1.4.2
PySCF path  /tigress/xingz/pyscf/pyscf
GIT ORIG_HEAD e0edd131499dcc18d035a120533a8a1ddda110d4
GIT HEAD      e0edd131499dcc18d035a120533a8a1ddda110d4

[INPUT] VERBOSE 4
[INPUT] num atoms = 30
[INPUT] num electrons = 120
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT]  1 Be    14.828496961934   0.000000000000   0.000000000000 AA   28.021798097000   0.000000000000   0.000000000000 Bohr
[INPUT]  2 Be    14.504458725804   3.083017875642   0.000000000000 AA   27.409454576827   5.826059422101   0.000000000000 Bohr
[INPUT]  3 Be    13.546506043242   6.031293076157   0.000000000000 AA   25.599186366492  11.397492090922   0.000000000000 Bohr
[INPUT]  4 Be    11.996506043242   8.715971827888   0.000000000000 AA   22.670110873416  16.470799664134   0.000000000000 Bohr
[INPUT]  5 Be     9.922201163529  11.019720786868   0.000000000000 AA   18.750242751911  20.824254256358   0.000000000000 Bohr
[INPUT]  6 Be     7.414248480967  12.841855068975   0.000000000000 AA   14.010899048500  24.267589011720   0.000000000000 Bohr
[INPUT]  7 Be     4.582257562275  14.102738662510   0.000000000000 AA    8.659211824917  26.650313678459   0.000000000000 Bohr
[INPUT]  8 Be     1.550000000000  14.747264904045   0.000000000000 AA    2.929075493076  27.868291755055   0.000000000000 Bohr
[INPUT]  9 Be    -1.550000000000  14.747264904045   0.000000000000 AA   -2.929075493076  27.868291755055   0.000000000000 Bohr
[INPUT] 10 Be    -4.582257562275  14.102738662510   0.000000000000 AA   -8.659211824917  26.650313678459   0.000000000000 Bohr
[INPUT] 11 Be    -7.414248480967  12.841855068975   0.000000000000 AA  -14.010899048500  24.267589011720   0.000000000000 Bohr
[INPUT] 12 Be    -9.922201163529  11.019720786868   0.000000000000 AA  -18.750242751911  20.824254256358   0.000000000000 Bohr
[INPUT] 13 Be   -11.996506043242   8.715971827888   0.000000000000 AA  -22.670110873416  16.470799664134   0.000000000000 Bohr
[INPUT] 14 Be   -13.546506043242   6.031293076157   0.000000000000 AA  -25.599186366492  11.397492090922   0.000000000000 Bohr
[INPUT] 15 Be   -14.504458725804   3.083017875642   0.000000000000 AA  -27.409454576827   5.826059422101   0.000000000000 Bohr
[INPUT] 16 Be   -14.828496961934   0.000000000000   0.000000000000 AA  -28.021798097000   0.000000000000   0.000000000000 Bohr
[INPUT] 17 Be   -14.504458725804  -3.083017875642   0.000000000000 AA  -27.409454576827  -5.826059422101   0.000000000000 Bohr
[INPUT] 18 Be   -13.546506043242  -6.031293076157   0.000000000000 AA  -25.599186366492 -11.397492090922   0.000000000000 Bohr
[INPUT] 19 Be   -11.996506043242  -8.715971827888   0.000000000000 AA  -22.670110873416 -16.470799664134   0.000000000000 Bohr
[INPUT] 20 Be    -9.922201163529 -11.019720786868   0.000000000000 AA  -18.750242751911 -20.824254256358   0.000000000000 Bohr
[INPUT] 21 Be    -7.414248480967 -12.841855068975   0.000000000000 AA  -14.010899048500 -24.267589011720   0.000000000000 Bohr
[INPUT] 22 Be    -4.582257562275 -14.102738662510   0.000000000000 AA   -8.659211824917 -26.650313678459   0.000000000000 Bohr
[INPUT] 23 Be    -1.550000000000 -14.747264904045   0.000000000000 AA   -2.929075493076 -27.868291755055   0.000000000000 Bohr
[INPUT] 24 Be     1.550000000000 -14.747264904045   0.000000000000 AA    2.929075493076 -27.868291755055   0.000000000000 Bohr
[INPUT] 25 Be     4.582257562275 -14.102738662510   0.000000000000 AA    8.659211824916 -26.650313678459   0.000000000000 Bohr
[INPUT] 26 Be     7.414248480967 -12.841855068975   0.000000000000 AA   14.010899048500 -24.267589011720   0.000000000000 Bohr
[INPUT] 27 Be     9.922201163529 -11.019720786868   0.000000000000 AA   18.750242751911 -20.824254256358   0.000000000000 Bohr
[INPUT] 28 Be    11.996506043242  -8.715971827888   0.000000000000 AA   22.670110873416 -16.470799664134   0.000000000000 Bohr
[INPUT] 29 Be    13.546506043242  -6.031293076157   0.000000000000 AA   25.599186366492 -11.397492090922   0.000000000000 Bohr
[INPUT] 30 Be    14.504458725804  -3.083017875642   0.000000000000 AA   27.409454576827  -5.826059422101   0.000000000000 Bohr
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [6    /1   ]  312.8704937       0.00916359628
                                57.36446253       0.04936149294
                                16.0485094        0.1685383049
                                5.513096119       0.3705627997
                                2.140896553       0.4164915298
                                0.8817394283      0.1303340841
[INPUT] 0    0    [6    /1   ]  13.63324744       -0.01325278809
                                2.698375464       -0.04699171014
                                0.8386530829      -0.03378537151
                                0.3226600698      0.2502417861
                                0.1401314882      0.5951172526
                                0.0642325139      0.2407061763
[INPUT] 1    0    [6    /1   ]  13.63324744       0.0037596966
                                2.698375464       0.0376793698
                                0.8386530829      0.1738967435
                                0.3226600698      0.4180364347
                                0.1401314882      0.4258595477
                                0.0642325139      0.1017082955
nuclear repulsion = 288.437975869848
number of shells = 90
number of NR pGTOs = 900
number of NR cGTOs = 150
basis = sto-6g
ecp = {}
CPU time:      5660.10


******** <class 'pyscf.dft.rks.RKS'> flags ********
method = RKS
initial guess = minao
damping factor = 0
level shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
DIIS start cycle = 1
DIIS space = 8
SCF tol = 1e-09
SCF gradient tol = None
max. SCF cycles = 100
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /tigress/xingz/pydmfet/examples/tmpJ0_2Dk
max_memory 16000 MB (current use 230 MB)
XC functionals = pbe,pbe
small_rho_cutoff = 1e-07
radial grids: Treutler-Ahlrichs (JCP 102, 346 (M4)) radial grids
becke partition: Becke, JCP, 88, 2547 (1988)
pruning grids: <function nwchem_prune at 0x2aac1c760cf8>
grids dens level: 3
symmetrized grids: False
atomic radii adjust function: <function treutler_atomic_radii_adjust at 0x2aac1c760b18>
Set gradient conv threshold to 3.16228e-05
tot grids = 393300
init E= -437.277714134226
HOMO: -0.12829353154190004 LUMO: -0.12210388854654214
-0.1250587622914752
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    1.995 1.995 1.916 1.916 1.313
 0.713 0.074 0.074 0.003 0.003]
entropy corr =  -0.020245698176281354
cycle= 1 E= -437.435100982026  delta_E= -0.157  |g|= 0.0056  |ddm|=  5.4
HOMO: -0.06101411458361102 LUMO: -0.058444314207133606
-0.05959877019532822
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    1.995 1.995 1.913 1.913 1.141
 0.885 0.076 0.076 0.003 0.003]
entropy corr =  -0.02118612041393913
cycle= 2 E= -437.434221049419  delta_E= 0.00088  |g|= 0.00455  |ddm|= 0.565
HOMO: -0.062408391964401067 LUMO: -0.0591315215145056
-0.06063894680027857
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    1.995 1.995 1.914 1.914 1.175
 0.85  0.075 0.075 0.003 0.003]
entropy corr =  -0.02099099530075408
cycle= 3 E= -437.438764541056  delta_E= -0.00454  |g|= 0.000162  |ddm|= 0.229
HOMO: -0.0625964765843418 LUMO: -0.05926406010272606
-0.06079914595163046
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    1.995 1.995 1.915 1.915 1.178
 0.848 0.075 0.075 0.003 0.003]
entropy corr =  -0.020979626711919736
cycle= 4 E= -437.438765024876  delta_E= -4.84e-07  |g|= 2.6e-05  |ddm|= 0.00689
HOMO: -0.0626023525521412 LUMO: -0.05926906652042173
-0.06080458601514786
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    1.995 1.995 1.915 1.915 1.178
 0.848 0.075 0.075 0.003 0.003]
entropy corr =  -0.020979363378755944
cycle= 5 E= -437.438764984977  delta_E= 3.99e-08  |g|= 0.000149  |ddm|= 0.00109
HOMO: -0.0626024831447996 LUMO: -0.05926917014291935
-0.06080470307921751
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    1.995 1.995 1.915 1.915 1.178
 0.848 0.075 0.075 0.003 0.003]
entropy corr =  -0.02097935598886902
cycle= 6 E= -437.438765031843  delta_E= -4.69e-08  |g|= 5.11e-06  |ddm|= 0.000914
HOMO: -0.0626024862014515 LUMO: -0.0592691613790011
-0.06080470020167694
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    1.995 1.995 1.915 1.915 1.178
 0.848 0.075 0.075 0.003 0.003]
entropy corr =  -0.020979353685748388
cycle= 7 E= -437.438765031877  delta_E= -3.41e-11  |g|= 1.61e-06  |ddm|= 3.14e-05
HOMO: -0.06260249414481582 LUMO: -0.05926913712484456
-0.0608046919795688
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    1.995 1.995 1.915 1.915 1.178
 0.848 0.075 0.075 0.003 0.003]
entropy corr =  -0.020979347558245928
Extra cycle  E= -437.438765031816  delta_E= 6.15e-11  |g|= 6.68e-06  |ddm|= 3.93e-05
converged SCF energy = -437.438765031816
e_mf =  -437.43876503181554
#INFO: **** input file is /tigress/xingz/pydmfet/examples/Be.py ****
from pydmfet import locints, sdmfet, oep, tools
from pyscf import gto, scf,dft, ao2mo,cc
import numpy as np
from pyscf.tools import molden, cubegen
import copy,time

DMguess  = None

bondlengths = np.arange(1.8, 4.1, 0.1)
energies = []

bas = 'sto-6g'

for bondlength in bondlengths:

    nat = 30
    mol = gto.Mole()
    mol.atom = []
    r = 0.5 * bondlength / np.sin(np.pi/nat)
    for i in range(nat):
        theta = i * (2*np.pi/nat)
        mol.atom.append(('Be', (r*np.cos(theta), r*np.sin(theta), 0)))

    mol.basis = bas
    mol.build(max_memory=16000, verbose=4)

    #mf = scf.RHF(mol)
    mf = dft.RKS(mol)
    mf.xc = 'pbe,pbe'
    mf.smear_sigma = 0.005
    mf.max_cycle = 100
    mf.scf()

    #P=mf.make_rdm1()
    #tools.MatPrint(P,"P_ref_ao")
    #cubegen.density(mol, "h20_dens.cube", P, nx=100, ny=100, nz=100)
    print 'e_mf = ',  mf.e_tot
    continue
    if ( True ):   
#        ENUCL = mf.mol.energy_nuc()
#        OEI   = np.dot(np.dot(mf.mo_coeff.T, mol.intor('cint1e_kin_sph') + mol.intor('cint1e_nuc_sph')), mf.mo_coeff)
#        TEI   = ao2mo.outcore.full_iofree(mol, mf.mo_coeff, compact=False).reshape(mol.nao_nr(), mol.nao_nr(), mol.nao_nr(), mol.nao_nr())
#        import chemps2
#        Energy, OneDM = chemps2.solve( ENUCL, OEI, OEI, TEI, mol.nao_nr(), mol.nelectron, mol.nao_nr(), 0.0, False )
#        print "bl =", bondlength," and energy =", Energy

        mycc = cc.CCSD(mf).run()
	et=0.0
        #et = mycc.ccsd_t()
        e_hf = mf.e_tot
        e_ccsd = e_hf + mycc.e_corr + et

        print 'e_tot = ', e_ccsd    #-4.96124910741
        
    else:
        myInts = locints.LocalIntegrals( mf, range( mol.nao_nr() ), 'meta_lowdin' )
        #myInts.loc_molden( 'hydrogen-loc.molden' )
        #myInts.TI_OK = True # Only s functions

	nbas =  mol.nao_nr()
	natoms = mol.natm

	impAtom = np.zeros([natoms], dtype=int)
	for i in range(20):
	    impAtom[i] = 1

	ghost_frag = 1-impAtom
	ghost_env = 1-ghost_frag

	mol_frag = gto.Mole()
	mol_frag.atom = tools.add_ghost(mol.atom, ghost_frag)
	mol_frag.basis = bas
	mol_frag.build(max_memory = 16000,verbose = 4)
	'''
	mf_frag = dft.RKS(mol_frag)
        mf_frag.xc = 'pbe,pbe'
        mf_frag.smear_sigma = 0.00
        mf_frag.scf()
        P_frag=mf_frag.make_rdm1()
        cubegen.density(mol_frag, "h10_dens_1.cube", P_frag, nx=100, ny=100, nz=100)
	'''

	mol_env = gto.Mole()
	mol_env.atom = tools.add_ghost(mol.atom, ghost_env)
	mol_env.basis =  bas
	mol_env.build(max_memory = 16000,verbose = 4)

	'''
	mf_env = dft.RKS(mol_env)
        mf_env.xc = 'pbe,pbe'
        mf_env.smear_sigma = 0.00
        mf_env.scf()
        P_env=mf_env.make_rdm1()
        cubegen.density(mol_env, "h10_dens_2.cube", P_env, nx=100, ny=100, nz=100)
	exit()
	'''



	aoslice = mol.aoslice_by_atom()
	impurities = np.zeros([nbas], dtype = int)
	for i in range(natoms):
	    if(impAtom[i] == 1):
		impurities[aoslice[i,2]:aoslice[i,3]] = 1

	Ne_frag = 20
	boundary_atoms = np.zeros((natoms))
	boundary_atoms[20:40] = 1.0
	#boundary_atoms[19] = -1
	boundary_atoms2 = np.zeros((natoms),dtype =int)
	#boundary_atoms2[9] = -1
	boundary_atoms2[0:20] = 1

	boundary_atoms = None
	boundary_atoms2 =None

	umat=None
	P_frag=None
	P_env=None
	params = oep.OEPparams(algorithm = '2011', opt_method = 'L-BFGS-B', \
                       ftol = 1e-11, gtol = 1e-5,diffP_tol=1e-5, outer_maxit = 200, maxit = 200,l2_lambda = 0.0, oep_print = 0)
	theDMFET = sdmfet.DMFET( mf, mol_frag, mol_env,myInts,impurities, impAtom, Ne_frag, boundary_atoms=boundary_atoms, boundary_atoms2=boundary_atoms2,\
                         umat = umat, P_frag_ao = P_frag, P_env_ao = P_env, \
                         dim_imp = nbas, dim_bath=nbas, dim_big =nbas, smear_sigma = 0.005, oep_params=params,ecw_method='hf', mf_method = mf.xc)

	umat = theDMFET.embedding_potential()

	exit()

	#write subspace orbitals
	transfo = np.dot( myInts.ao2loc, theDMFET.loc2sub )
	filename =  'hydrogen-sub.molden'
	with open( filename, 'w' ) as thefile:
            molden.header( myInts.mol, thefile )
            molden.orbital_coeff( myInts.mol, thefile, transfo )


        umat = theDMFET.embedding_potential()
	print umat
	exit()
	energy = theDMFET.correction_energy()

#INFO: ******************** input file end ********************


System: ('Linux', 'tigercpu.princeton.edu', '3.10.0-693.21.1.el7.x86_64', '#1 SMP Wed Mar 7 15:59:45 EST 2018', 'x86_64', 'x86_64')  Threads 40
Python 2.7.14 |Anaconda, Inc.| (default, Oct 16 2017, 17:29:19) 
[GCC 7.2.0]
numpy 1.14.3  scipy 1.1.0
Date: Thu Jun  7 01:39:14 2018
PySCF version 1.4.2
PySCF path  /tigress/xingz/pyscf/pyscf
GIT ORIG_HEAD e0edd131499dcc18d035a120533a8a1ddda110d4
GIT HEAD      e0edd131499dcc18d035a120533a8a1ddda110d4

[INPUT] VERBOSE 4
[INPUT] num atoms = 30
[INPUT] num electrons = 120
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT]  1 Be    15.306835573609   0.000000000000   0.000000000000 AA   28.925727067871   0.000000000000   0.000000000000 Bohr
[INPUT]  2 Be    14.972344491153   3.182470065178   0.000000000000 AA   28.293630530919   6.013996822814   0.000000000000 Bohr
[INPUT]  3 Be    13.983490109153   6.225850917323   0.000000000000 AA   26.424966571863  11.765153126113   0.000000000000 Bohr
[INPUT]  4 Be    12.383490109153   8.997132209433   0.000000000000 AA   23.401404772559  17.002115782332   0.000000000000 Bohr
[INPUT]  5 Be    10.242272168804  11.375195650961   0.000000000000 AA   19.355089292295  21.496004393660   0.000000000000 Bohr
[INPUT]  6 Be     7.653417786805  13.256108458297   0.000000000000 AA   14.462863533935  25.050414463711   0.000000000000 Bohr
[INPUT]  7 Be     4.730072322348  14.557665716139   0.000000000000 AA    8.938541238623  27.510001216474   0.000000000000 Bohr
[INPUT]  8 Be     1.600000000000  15.222983126756   0.000000000000 AA    3.023561799304  28.767268908444   0.000000000000 Bohr
[INPUT]  9 Be    -1.600000000000  15.222983126756   0.000000000000 AA   -3.023561799304  28.767268908444   0.000000000000 Bohr
[INPUT] 10 Be    -4.730072322348  14.557665716139   0.000000000000 AA   -8.938541238623  27.510001216474   0.000000000000 Bohr
[INPUT] 11 Be    -7.653417786805  13.256108458297   0.000000000000 AA  -14.462863533935  25.050414463711   0.000000000000 Bohr
[INPUT] 12 Be   -10.242272168804  11.375195650961   0.000000000000 AA  -19.355089292295  21.496004393660   0.000000000000 Bohr
[INPUT] 13 Be   -12.383490109153   8.997132209433   0.000000000000 AA  -23.401404772559  17.002115782332   0.000000000000 Bohr
[INPUT] 14 Be   -13.983490109153   6.225850917323   0.000000000000 AA  -26.424966571863  11.765153126113   0.000000000000 Bohr
[INPUT] 15 Be   -14.972344491153   3.182470065178   0.000000000000 AA  -28.293630530919   6.013996822814   0.000000000000 Bohr
[INPUT] 16 Be   -15.306835573609   0.000000000000   0.000000000000 AA  -28.925727067871   0.000000000000   0.000000000000 Bohr
[INPUT] 17 Be   -14.972344491153  -3.182470065178   0.000000000000 AA  -28.293630530919  -6.013996822814   0.000000000000 Bohr
[INPUT] 18 Be   -13.983490109153  -6.225850917323   0.000000000000 AA  -26.424966571863 -11.765153126113   0.000000000000 Bohr
[INPUT] 19 Be   -12.383490109153  -8.997132209433   0.000000000000 AA  -23.401404772559 -17.002115782332   0.000000000000 Bohr
[INPUT] 20 Be   -10.242272168804 -11.375195650961   0.000000000000 AA  -19.355089292295 -21.496004393660   0.000000000000 Bohr
[INPUT] 21 Be    -7.653417786805 -13.256108458297   0.000000000000 AA  -14.462863533935 -25.050414463711   0.000000000000 Bohr
[INPUT] 22 Be    -4.730072322348 -14.557665716139   0.000000000000 AA   -8.938541238623 -27.510001216474   0.000000000000 Bohr
[INPUT] 23 Be    -1.600000000000 -15.222983126756   0.000000000000 AA   -3.023561799304 -28.767268908444   0.000000000000 Bohr
[INPUT] 24 Be     1.600000000000 -15.222983126756   0.000000000000 AA    3.023561799304 -28.767268908444   0.000000000000 Bohr
[INPUT] 25 Be     4.730072322348 -14.557665716139   0.000000000000 AA    8.938541238623 -27.510001216474   0.000000000000 Bohr
[INPUT] 26 Be     7.653417786804 -13.256108458297   0.000000000000 AA   14.462863533935 -25.050414463711   0.000000000000 Bohr
[INPUT] 27 Be    10.242272168804 -11.375195650961   0.000000000000 AA   19.355089292295 -21.496004393660   0.000000000000 Bohr
[INPUT] 28 Be    12.383490109153  -8.997132209433   0.000000000000 AA   23.401404772559 -17.002115782332   0.000000000000 Bohr
[INPUT] 29 Be    13.983490109153  -6.225850917323   0.000000000000 AA   26.424966571863 -11.765153126113   0.000000000000 Bohr
[INPUT] 30 Be    14.972344491153  -3.182470065178   0.000000000000 AA   28.293630530919  -6.013996822814   0.000000000000 Bohr
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [6    /1   ]  312.8704937       0.00916359628
                                57.36446253       0.04936149294
                                16.0485094        0.1685383049
                                5.513096119       0.3705627997
                                2.140896553       0.4164915298
                                0.8817394283      0.1303340841
[INPUT] 0    0    [6    /1   ]  13.63324744       -0.01325278809
                                2.698375464       -0.04699171014
                                0.8386530829      -0.03378537151
                                0.3226600698      0.2502417861
                                0.1401314882      0.5951172526
                                0.0642325139      0.2407061763
[INPUT] 1    0    [6    /1   ]  13.63324744       0.0037596966
                                2.698375464       0.0376793698
                                0.8386530829      0.1738967435
                                0.3226600698      0.4180364347
                                0.1401314882      0.4258595477
                                0.0642325139      0.1017082955
nuclear repulsion = 279.424289123915
number of shells = 90
number of NR pGTOs = 900
number of NR cGTOs = 150
basis = sto-6g
ecp = {}
CPU time:      6077.61


******** <class 'pyscf.dft.rks.RKS'> flags ********
method = RKS
initial guess = minao
damping factor = 0
level shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
DIIS start cycle = 1
DIIS space = 8
SCF tol = 1e-09
SCF gradient tol = None
max. SCF cycles = 100
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /tigress/xingz/pydmfet/examples/tmpsaBHll
max_memory 16000 MB (current use 230 MB)
XC functionals = pbe,pbe
small_rho_cutoff = 1e-07
radial grids: Treutler-Ahlrichs (JCP 102, 346 (M4)) radial grids
becke partition: Becke, JCP, 88, 2547 (1988)
pruning grids: <function nwchem_prune at 0x2aac1c760cf8>
grids dens level: 3
symmetrized grids: False
atomic radii adjust function: <function treutler_atomic_radii_adjust at 0x2aac1c760b18>
Set gradient conv threshold to 3.16228e-05
tot grids = 393300
init E= -437.154474373652
HOMO: -0.13002235029583012 LUMO: -0.12218409849600484
-0.12594536654907632
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    1.999 1.999 1.993 1.993 1.906 1.906 1.387
 0.641 0.084 0.084 0.004 0.004]
entropy corr =  -0.02054934530818607
cycle= 1 E= -437.305887705359  delta_E= -0.151  |g|= 0.00262  |ddm|= 4.75
HOMO: -0.06901633924482083 LUMO: -0.05888454757443987
-0.06379170412414091
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    1.999 1.999 1.993 1.993 1.913 1.913 1.48
 0.545 0.078 0.078 0.003 0.003]
entropy corr =  -0.019252760574980595
cycle= 2 E= -437.304709289415  delta_E= 0.00118  |g|= 0.0026  |ddm|= 0.41
HOMO: -0.06954417142495888 LUMO: -0.05988462071316365
-0.06455658801705182
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    1.999 1.999 1.993 1.993 1.912 1.912 1.461
 0.564 0.078 0.078 0.003 0.003]
entropy corr =  -0.019470294373886973
cycle= 3 E= -437.308095883411  delta_E= -0.00339  |g|= 6.36e-05  |ddm|= 0.196
HOMO: -0.06960994029162801 LUMO: -0.0599814656905824
-0.0646379335529196
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    1.999 1.999 1.993 1.993 1.912 1.912 1.46
 0.565 0.079 0.079 0.003 0.003]
entropy corr =  -0.01948734703377895
cycle= 4 E= -437.308096228922  delta_E= -3.46e-07  |g|= 1.46e-05  |ddm|= 0.00358
HOMO: -0.06961227578607337 LUMO: -0.059984449750262424
-0.06464059437219956
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    1.999 1.999 1.993 1.993 1.912 1.912 1.46
 0.565 0.079 0.079 0.003 0.003]
entropy corr =  -0.01948765595445465
cycle= 5 E= -437.30809622071  delta_E= 8.21e-09  |g|= 7.66e-05  |ddm|= 0.000593
HOMO: -0.06961231272463587 LUMO: -0.059984500278043335
-0.06464063812475764
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    1.999 1.999 1.993 1.993 1.912 1.912 1.46
 0.565 0.079 0.079 0.003 0.003]
entropy corr =  -0.019487662661326587
cycle= 6 E= -437.308096233028  delta_E= -1.23e-08  |g|= 4.21e-06  |ddm|= 0.000477
HOMO: -0.06961230927403865 LUMO: -0.0599845005157719
-0.06464063652283021
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    1.999 1.999 1.993 1.993 1.912 1.912 1.46
 0.565 0.079 0.079 0.003 0.003]
entropy corr =  -0.019487664789665123
cycle= 7 E= -437.308096233055  delta_E= -2.69e-11  |g|= 6.43e-07  |ddm|= 2.3e-05
HOMO: -0.06961229606675974 LUMO: -0.05998449829691885
-0.06464062882231378
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    1.999 1.999 1.993 1.993 1.912 1.912 1.46
 0.565 0.079 0.079 0.003 0.003]
entropy corr =  -0.01948767128654173
Extra cycle  E= -437.308096233046  delta_E= 9.09e-12  |g|= 2.44e-06  |ddm|= 1.5e-05
converged SCF energy = -437.308096233046
e_mf =  -437.3080962330456
#INFO: **** input file is /tigress/xingz/pydmfet/examples/Be.py ****
from pydmfet import locints, sdmfet, oep, tools
from pyscf import gto, scf,dft, ao2mo,cc
import numpy as np
from pyscf.tools import molden, cubegen
import copy,time

DMguess  = None

bondlengths = np.arange(1.8, 4.1, 0.1)
energies = []

bas = 'sto-6g'

for bondlength in bondlengths:

    nat = 30
    mol = gto.Mole()
    mol.atom = []
    r = 0.5 * bondlength / np.sin(np.pi/nat)
    for i in range(nat):
        theta = i * (2*np.pi/nat)
        mol.atom.append(('Be', (r*np.cos(theta), r*np.sin(theta), 0)))

    mol.basis = bas
    mol.build(max_memory=16000, verbose=4)

    #mf = scf.RHF(mol)
    mf = dft.RKS(mol)
    mf.xc = 'pbe,pbe'
    mf.smear_sigma = 0.005
    mf.max_cycle = 100
    mf.scf()

    #P=mf.make_rdm1()
    #tools.MatPrint(P,"P_ref_ao")
    #cubegen.density(mol, "h20_dens.cube", P, nx=100, ny=100, nz=100)
    print 'e_mf = ',  mf.e_tot
    continue
    if ( True ):   
#        ENUCL = mf.mol.energy_nuc()
#        OEI   = np.dot(np.dot(mf.mo_coeff.T, mol.intor('cint1e_kin_sph') + mol.intor('cint1e_nuc_sph')), mf.mo_coeff)
#        TEI   = ao2mo.outcore.full_iofree(mol, mf.mo_coeff, compact=False).reshape(mol.nao_nr(), mol.nao_nr(), mol.nao_nr(), mol.nao_nr())
#        import chemps2
#        Energy, OneDM = chemps2.solve( ENUCL, OEI, OEI, TEI, mol.nao_nr(), mol.nelectron, mol.nao_nr(), 0.0, False )
#        print "bl =", bondlength," and energy =", Energy

        mycc = cc.CCSD(mf).run()
	et=0.0
        #et = mycc.ccsd_t()
        e_hf = mf.e_tot
        e_ccsd = e_hf + mycc.e_corr + et

        print 'e_tot = ', e_ccsd    #-4.96124910741
        
    else:
        myInts = locints.LocalIntegrals( mf, range( mol.nao_nr() ), 'meta_lowdin' )
        #myInts.loc_molden( 'hydrogen-loc.molden' )
        #myInts.TI_OK = True # Only s functions

	nbas =  mol.nao_nr()
	natoms = mol.natm

	impAtom = np.zeros([natoms], dtype=int)
	for i in range(20):
	    impAtom[i] = 1

	ghost_frag = 1-impAtom
	ghost_env = 1-ghost_frag

	mol_frag = gto.Mole()
	mol_frag.atom = tools.add_ghost(mol.atom, ghost_frag)
	mol_frag.basis = bas
	mol_frag.build(max_memory = 16000,verbose = 4)
	'''
	mf_frag = dft.RKS(mol_frag)
        mf_frag.xc = 'pbe,pbe'
        mf_frag.smear_sigma = 0.00
        mf_frag.scf()
        P_frag=mf_frag.make_rdm1()
        cubegen.density(mol_frag, "h10_dens_1.cube", P_frag, nx=100, ny=100, nz=100)
	'''

	mol_env = gto.Mole()
	mol_env.atom = tools.add_ghost(mol.atom, ghost_env)
	mol_env.basis =  bas
	mol_env.build(max_memory = 16000,verbose = 4)

	'''
	mf_env = dft.RKS(mol_env)
        mf_env.xc = 'pbe,pbe'
        mf_env.smear_sigma = 0.00
        mf_env.scf()
        P_env=mf_env.make_rdm1()
        cubegen.density(mol_env, "h10_dens_2.cube", P_env, nx=100, ny=100, nz=100)
	exit()
	'''



	aoslice = mol.aoslice_by_atom()
	impurities = np.zeros([nbas], dtype = int)
	for i in range(natoms):
	    if(impAtom[i] == 1):
		impurities[aoslice[i,2]:aoslice[i,3]] = 1

	Ne_frag = 20
	boundary_atoms = np.zeros((natoms))
	boundary_atoms[20:40] = 1.0
	#boundary_atoms[19] = -1
	boundary_atoms2 = np.zeros((natoms),dtype =int)
	#boundary_atoms2[9] = -1
	boundary_atoms2[0:20] = 1

	boundary_atoms = None
	boundary_atoms2 =None

	umat=None
	P_frag=None
	P_env=None
	params = oep.OEPparams(algorithm = '2011', opt_method = 'L-BFGS-B', \
                       ftol = 1e-11, gtol = 1e-5,diffP_tol=1e-5, outer_maxit = 200, maxit = 200,l2_lambda = 0.0, oep_print = 0)
	theDMFET = sdmfet.DMFET( mf, mol_frag, mol_env,myInts,impurities, impAtom, Ne_frag, boundary_atoms=boundary_atoms, boundary_atoms2=boundary_atoms2,\
                         umat = umat, P_frag_ao = P_frag, P_env_ao = P_env, \
                         dim_imp = nbas, dim_bath=nbas, dim_big =nbas, smear_sigma = 0.005, oep_params=params,ecw_method='hf', mf_method = mf.xc)

	umat = theDMFET.embedding_potential()

	exit()

	#write subspace orbitals
	transfo = np.dot( myInts.ao2loc, theDMFET.loc2sub )
	filename =  'hydrogen-sub.molden'
	with open( filename, 'w' ) as thefile:
            molden.header( myInts.mol, thefile )
            molden.orbital_coeff( myInts.mol, thefile, transfo )


        umat = theDMFET.embedding_potential()
	print umat
	exit()
	energy = theDMFET.correction_energy()

#INFO: ******************** input file end ********************


System: ('Linux', 'tigercpu.princeton.edu', '3.10.0-693.21.1.el7.x86_64', '#1 SMP Wed Mar 7 15:59:45 EST 2018', 'x86_64', 'x86_64')  Threads 40
Python 2.7.14 |Anaconda, Inc.| (default, Oct 16 2017, 17:29:19) 
[GCC 7.2.0]
numpy 1.14.3  scipy 1.1.0
Date: Thu Jun  7 01:39:29 2018
PySCF version 1.4.2
PySCF path  /tigress/xingz/pyscf/pyscf
GIT ORIG_HEAD e0edd131499dcc18d035a120533a8a1ddda110d4
GIT HEAD      e0edd131499dcc18d035a120533a8a1ddda110d4

[INPUT] VERBOSE 4
[INPUT] num atoms = 30
[INPUT] num electrons = 120
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT]  1 Be    15.785174185284   0.000000000000   0.000000000000 AA   29.829656038742   0.000000000000   0.000000000000 Bohr
[INPUT]  2 Be    15.440230256501   3.281922254715   0.000000000000 AA   29.177806485010   6.201934223527   0.000000000000 Bohr
[INPUT]  3 Be    14.420474175064   6.420408758489   0.000000000000 AA   27.250746777234  12.132814161304   0.000000000000 Bohr
[INPUT]  4 Be    12.770474175064   9.278292590978   0.000000000000 AA   24.132698671701  17.533431900530   0.000000000000 Bohr
[INPUT]  5 Be    10.562343174079  11.730670515053   0.000000000000 AA   19.959935832679  22.167754530961   0.000000000000 Bohr
[INPUT]  6 Be     7.892587092642  13.670361847619   0.000000000000 AA   14.914828019371  25.833239915702   0.000000000000 Bohr
[INPUT]  7 Be     4.877887082422  15.012592769769   0.000000000000 AA    9.217870652330  28.369688754488   0.000000000000 Bohr
[INPUT]  8 Be     1.650000000000  15.698701349467   0.000000000000 AA    3.118048105532  29.666246061833   0.000000000000 Bohr
[INPUT]  9 Be    -1.650000000000  15.698701349467   0.000000000000 AA   -3.118048105532  29.666246061833   0.000000000000 Bohr
[INPUT] 10 Be    -4.877887082422  15.012592769769   0.000000000000 AA   -9.217870652330  28.369688754488   0.000000000000 Bohr
[INPUT] 11 Be    -7.892587092642  13.670361847619   0.000000000000 AA  -14.914828019371  25.833239915702   0.000000000000 Bohr
[INPUT] 12 Be   -10.562343174079  11.730670515053   0.000000000000 AA  -19.959935832679  22.167754530961   0.000000000000 Bohr
[INPUT] 13 Be   -12.770474175064   9.278292590978   0.000000000000 AA  -24.132698671701  17.533431900530   0.000000000000 Bohr
[INPUT] 14 Be   -14.420474175064   6.420408758489   0.000000000000 AA  -27.250746777234  12.132814161304   0.000000000000 Bohr
[INPUT] 15 Be   -15.440230256501   3.281922254715   0.000000000000 AA  -29.177806485010   6.201934223527   0.000000000000 Bohr
[INPUT] 16 Be   -15.785174185284   0.000000000000   0.000000000000 AA  -29.829656038742   0.000000000000   0.000000000000 Bohr
[INPUT] 17 Be   -15.440230256501  -3.281922254715   0.000000000000 AA  -29.177806485010  -6.201934223527   0.000000000000 Bohr
[INPUT] 18 Be   -14.420474175064  -6.420408758489   0.000000000000 AA  -27.250746777234 -12.132814161304   0.000000000000 Bohr
[INPUT] 19 Be   -12.770474175064  -9.278292590978   0.000000000000 AA  -24.132698671701 -17.533431900530   0.000000000000 Bohr
[INPUT] 20 Be   -10.562343174079 -11.730670515053   0.000000000000 AA  -19.959935832679 -22.167754530961   0.000000000000 Bohr
[INPUT] 21 Be    -7.892587092642 -13.670361847619   0.000000000000 AA  -14.914828019371 -25.833239915702   0.000000000000 Bohr
[INPUT] 22 Be    -4.877887082422 -15.012592769769   0.000000000000 AA   -9.217870652330 -28.369688754488   0.000000000000 Bohr
[INPUT] 23 Be    -1.650000000000 -15.698701349467   0.000000000000 AA   -3.118048105532 -29.666246061833   0.000000000000 Bohr
[INPUT] 24 Be     1.650000000000 -15.698701349467   0.000000000000 AA    3.118048105532 -29.666246061833   0.000000000000 Bohr
[INPUT] 25 Be     4.877887082422 -15.012592769769   0.000000000000 AA    9.217870652330 -28.369688754488   0.000000000000 Bohr
[INPUT] 26 Be     7.892587092642 -13.670361847619   0.000000000000 AA   14.914828019371 -25.833239915702   0.000000000000 Bohr
[INPUT] 27 Be    10.562343174079 -11.730670515053   0.000000000000 AA   19.959935832679 -22.167754530961   0.000000000000 Bohr
[INPUT] 28 Be    12.770474175064  -9.278292590978   0.000000000000 AA   24.132698671701 -17.533431900530   0.000000000000 Bohr
[INPUT] 29 Be    14.420474175064  -6.420408758489   0.000000000000 AA   27.250746777234 -12.132814161304   0.000000000000 Bohr
[INPUT] 30 Be    15.440230256501  -3.281922254715   0.000000000000 AA   29.177806485010  -6.201934223527   0.000000000000 Bohr
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [6    /1   ]  312.8704937       0.00916359628
                                57.36446253       0.04936149294
                                16.0485094        0.1685383049
                                5.513096119       0.3705627997
                                2.140896553       0.4164915298
                                0.8817394283      0.1303340841
[INPUT] 0    0    [6    /1   ]  13.63324744       -0.01325278809
                                2.698375464       -0.04699171014
                                0.8386530829      -0.03378537151
                                0.3226600698      0.2502417861
                                0.1401314882      0.5951172526
                                0.0642325139      0.2407061763
[INPUT] 1    0    [6    /1   ]  13.63324744       0.0037596966
                                2.698375464       0.0376793698
                                0.8386530829      0.1738967435
                                0.3226600698      0.4180364347
                                0.1401314882      0.4258595477
                                0.0642325139      0.1017082955
nuclear repulsion = 270.95688642319
number of shells = 90
number of NR pGTOs = 900
number of NR cGTOs = 150
basis = sto-6g
ecp = {}
CPU time:      6486.27


******** <class 'pyscf.dft.rks.RKS'> flags ********
method = RKS
initial guess = minao
damping factor = 0
level shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
DIIS start cycle = 1
DIIS space = 8
SCF tol = 1e-09
SCF gradient tol = None
max. SCF cycles = 100
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /tigress/xingz/pydmfet/examples/tmppqTH1v
max_memory 16000 MB (current use 230 MB)
XC functionals = pbe,pbe
small_rho_cutoff = 1e-07
radial grids: Treutler-Ahlrichs (JCP 102, 346 (M4)) radial grids
becke partition: Becke, JCP, 88, 2547 (1988)
pruning grids: <function nwchem_prune at 0x2aac1c760cf8>
grids dens level: 3
symmetrized grids: False
atomic radii adjust function: <function treutler_atomic_radii_adjust at 0x2aac1c760b18>
Set gradient conv threshold to 3.16228e-05
tot grids = 393300
init E= -437.049940816498
HOMO: -0.13696978329920592 LUMO: -0.11617217170582969
-0.1263593517779055
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    1.999 1.999 1.993 1.993 1.939 1.939 1.786
 0.231 0.057 0.057 0.004 0.004]
entropy corr =  -0.013129262436300082
cycle= 1 E= -437.205377895602  delta_E= -0.155  |g|= 0.00106  |ddm|= 4.29
HOMO: -0.07780201974206563 LUMO: -0.055618597110173446
-0.06649636993438393
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    1.999 1.999 1.994 1.994 1.944 1.944 1.811
 0.204 0.052 0.052 0.004 0.004]
entropy corr =  -0.012147743057440563
cycle= 2 E= -437.20423992143  delta_E= 0.00114  |g|= 0.0013  |ddm|= 0.311
HOMO: -0.07822513327321431 LUMO: -0.05636183147996618
-0.06708071836463791
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    1.999 1.999 1.994 1.994 1.943 1.943 1.806
 0.21  0.052 0.052 0.004 0.004]
entropy corr =  -0.012331046172365965
cycle= 3 E= -437.206797256989  delta_E= -0.00256  |g|= 2.4e-05  |ddm|= 0.17
HOMO: -0.07825256049815932 LUMO: -0.0563989467673532
-0.06711302121862527
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    1.999 1.999 1.994 1.994 1.943 1.943 1.805
 0.21  0.052 0.052 0.004 0.004]
entropy corr =  -0.01233705591652989
cycle= 4 E= -437.206797861228  delta_E= -6.04e-07  |g|= 3.12e-06  |ddm|= 0.00259
HOMO: -0.07825330984591275 LUMO: -0.05640001306833778
-0.06711393011037095
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    1.999 1.999 1.994 1.994 1.943 1.943 1.805
 0.21  0.052 0.052 0.004 0.004]
entropy corr =  -0.01233724797960881
cycle= 5 E= -437.206797862189  delta_E= -9.61e-10  |g|= 1.09e-05  |ddm|= 0.000143
HOMO: -0.07825330680053276 LUMO: -0.05640001624729247
-0.06711393020064069
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    1.999 1.999 1.994 1.994 1.943 1.943 1.805
 0.21  0.052 0.052 0.004 0.004]
entropy corr =  -0.012337251962278773
Extra cycle  E= -437.206797859397  delta_E= 2.79e-09  |g|= 3.98e-05  |ddm|= 0.000306
converged SCF energy = -437.206797859397
e_mf =  -437.206797859397
#INFO: **** input file is /tigress/xingz/pydmfet/examples/Be.py ****
from pydmfet import locints, sdmfet, oep, tools
from pyscf import gto, scf,dft, ao2mo,cc
import numpy as np
from pyscf.tools import molden, cubegen
import copy,time

DMguess  = None

bondlengths = np.arange(1.8, 4.1, 0.1)
energies = []

bas = 'sto-6g'

for bondlength in bondlengths:

    nat = 30
    mol = gto.Mole()
    mol.atom = []
    r = 0.5 * bondlength / np.sin(np.pi/nat)
    for i in range(nat):
        theta = i * (2*np.pi/nat)
        mol.atom.append(('Be', (r*np.cos(theta), r*np.sin(theta), 0)))

    mol.basis = bas
    mol.build(max_memory=16000, verbose=4)

    #mf = scf.RHF(mol)
    mf = dft.RKS(mol)
    mf.xc = 'pbe,pbe'
    mf.smear_sigma = 0.005
    mf.max_cycle = 100
    mf.scf()

    #P=mf.make_rdm1()
    #tools.MatPrint(P,"P_ref_ao")
    #cubegen.density(mol, "h20_dens.cube", P, nx=100, ny=100, nz=100)
    print 'e_mf = ',  mf.e_tot
    continue
    if ( True ):   
#        ENUCL = mf.mol.energy_nuc()
#        OEI   = np.dot(np.dot(mf.mo_coeff.T, mol.intor('cint1e_kin_sph') + mol.intor('cint1e_nuc_sph')), mf.mo_coeff)
#        TEI   = ao2mo.outcore.full_iofree(mol, mf.mo_coeff, compact=False).reshape(mol.nao_nr(), mol.nao_nr(), mol.nao_nr(), mol.nao_nr())
#        import chemps2
#        Energy, OneDM = chemps2.solve( ENUCL, OEI, OEI, TEI, mol.nao_nr(), mol.nelectron, mol.nao_nr(), 0.0, False )
#        print "bl =", bondlength," and energy =", Energy

        mycc = cc.CCSD(mf).run()
	et=0.0
        #et = mycc.ccsd_t()
        e_hf = mf.e_tot
        e_ccsd = e_hf + mycc.e_corr + et

        print 'e_tot = ', e_ccsd    #-4.96124910741
        
    else:
        myInts = locints.LocalIntegrals( mf, range( mol.nao_nr() ), 'meta_lowdin' )
        #myInts.loc_molden( 'hydrogen-loc.molden' )
        #myInts.TI_OK = True # Only s functions

	nbas =  mol.nao_nr()
	natoms = mol.natm

	impAtom = np.zeros([natoms], dtype=int)
	for i in range(20):
	    impAtom[i] = 1

	ghost_frag = 1-impAtom
	ghost_env = 1-ghost_frag

	mol_frag = gto.Mole()
	mol_frag.atom = tools.add_ghost(mol.atom, ghost_frag)
	mol_frag.basis = bas
	mol_frag.build(max_memory = 16000,verbose = 4)
	'''
	mf_frag = dft.RKS(mol_frag)
        mf_frag.xc = 'pbe,pbe'
        mf_frag.smear_sigma = 0.00
        mf_frag.scf()
        P_frag=mf_frag.make_rdm1()
        cubegen.density(mol_frag, "h10_dens_1.cube", P_frag, nx=100, ny=100, nz=100)
	'''

	mol_env = gto.Mole()
	mol_env.atom = tools.add_ghost(mol.atom, ghost_env)
	mol_env.basis =  bas
	mol_env.build(max_memory = 16000,verbose = 4)

	'''
	mf_env = dft.RKS(mol_env)
        mf_env.xc = 'pbe,pbe'
        mf_env.smear_sigma = 0.00
        mf_env.scf()
        P_env=mf_env.make_rdm1()
        cubegen.density(mol_env, "h10_dens_2.cube", P_env, nx=100, ny=100, nz=100)
	exit()
	'''



	aoslice = mol.aoslice_by_atom()
	impurities = np.zeros([nbas], dtype = int)
	for i in range(natoms):
	    if(impAtom[i] == 1):
		impurities[aoslice[i,2]:aoslice[i,3]] = 1

	Ne_frag = 20
	boundary_atoms = np.zeros((natoms))
	boundary_atoms[20:40] = 1.0
	#boundary_atoms[19] = -1
	boundary_atoms2 = np.zeros((natoms),dtype =int)
	#boundary_atoms2[9] = -1
	boundary_atoms2[0:20] = 1

	boundary_atoms = None
	boundary_atoms2 =None

	umat=None
	P_frag=None
	P_env=None
	params = oep.OEPparams(algorithm = '2011', opt_method = 'L-BFGS-B', \
                       ftol = 1e-11, gtol = 1e-5,diffP_tol=1e-5, outer_maxit = 200, maxit = 200,l2_lambda = 0.0, oep_print = 0)
	theDMFET = sdmfet.DMFET( mf, mol_frag, mol_env,myInts,impurities, impAtom, Ne_frag, boundary_atoms=boundary_atoms, boundary_atoms2=boundary_atoms2,\
                         umat = umat, P_frag_ao = P_frag, P_env_ao = P_env, \
                         dim_imp = nbas, dim_bath=nbas, dim_big =nbas, smear_sigma = 0.005, oep_params=params,ecw_method='hf', mf_method = mf.xc)

	umat = theDMFET.embedding_potential()

	exit()

	#write subspace orbitals
	transfo = np.dot( myInts.ao2loc, theDMFET.loc2sub )
	filename =  'hydrogen-sub.molden'
	with open( filename, 'w' ) as thefile:
            molden.header( myInts.mol, thefile )
            molden.orbital_coeff( myInts.mol, thefile, transfo )


        umat = theDMFET.embedding_potential()
	print umat
	exit()
	energy = theDMFET.correction_energy()

#INFO: ******************** input file end ********************


System: ('Linux', 'tigercpu.princeton.edu', '3.10.0-693.21.1.el7.x86_64', '#1 SMP Wed Mar 7 15:59:45 EST 2018', 'x86_64', 'x86_64')  Threads 40
Python 2.7.14 |Anaconda, Inc.| (default, Oct 16 2017, 17:29:19) 
[GCC 7.2.0]
numpy 1.14.3  scipy 1.1.0
Date: Thu Jun  7 01:39:41 2018
PySCF version 1.4.2
PySCF path  /tigress/xingz/pyscf/pyscf
GIT ORIG_HEAD e0edd131499dcc18d035a120533a8a1ddda110d4
GIT HEAD      e0edd131499dcc18d035a120533a8a1ddda110d4

[INPUT] VERBOSE 4
[INPUT] num atoms = 30
[INPUT] num electrons = 120
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT]  1 Be    16.263512796960   0.000000000000   0.000000000000 AA   30.733585009613   0.000000000000   0.000000000000 Bohr
[INPUT]  2 Be    15.908116021850   3.381374444252   0.000000000000 AA   30.061982439101   6.389871624240   0.000000000000 Bohr
[INPUT]  3 Be    14.857458240975   6.614966599656   0.000000000000 AA   28.076526982604  12.500475196495   0.000000000000 Bohr
[INPUT]  4 Be    13.157458240975   9.559452972523   0.000000000000 AA   24.863992570844  18.064748018727   0.000000000000 Bohr
[INPUT]  5 Be    10.882414179355  12.086145379146   0.000000000000 AA   20.564782373064  22.839504668263   0.000000000000 Bohr
[INPUT]  6 Be     8.131756398480  14.084615236940   0.000000000000 AA   15.366792504806  26.616065367693   0.000000000000 Bohr
[INPUT]  7 Be     5.025701842495  15.467519823398   0.000000000000 AA    9.497200066037  29.229376292503   0.000000000000 Bohr
[INPUT]  8 Be     1.700000000000  16.174419572178   0.000000000000 AA    3.212534411761  30.565223215222   0.000000000000 Bohr
[INPUT]  9 Be    -1.700000000000  16.174419572178   0.000000000000 AA   -3.212534411761  30.565223215222   0.000000000000 Bohr
[INPUT] 10 Be    -5.025701842495  15.467519823398   0.000000000000 AA   -9.497200066037  29.229376292503   0.000000000000 Bohr
[INPUT] 11 Be    -8.131756398480  14.084615236940   0.000000000000 AA  -15.366792504806  26.616065367693   0.000000000000 Bohr
[INPUT] 12 Be   -10.882414179355  12.086145379146   0.000000000000 AA  -20.564782373064  22.839504668263   0.000000000000 Bohr
[INPUT] 13 Be   -13.157458240975   9.559452972523   0.000000000000 AA  -24.863992570844  18.064748018727   0.000000000000 Bohr
[INPUT] 14 Be   -14.857458240975   6.614966599656   0.000000000000 AA  -28.076526982604  12.500475196495   0.000000000000 Bohr
[INPUT] 15 Be   -15.908116021850   3.381374444252   0.000000000000 AA  -30.061982439101   6.389871624240   0.000000000000 Bohr
[INPUT] 16 Be   -16.263512796960   0.000000000000   0.000000000000 AA  -30.733585009613   0.000000000000   0.000000000000 Bohr
[INPUT] 17 Be   -15.908116021850  -3.381374444252   0.000000000000 AA  -30.061982439101  -6.389871624240   0.000000000000 Bohr
[INPUT] 18 Be   -14.857458240975  -6.614966599656   0.000000000000 AA  -28.076526982604 -12.500475196495   0.000000000000 Bohr
[INPUT] 19 Be   -13.157458240975  -9.559452972523   0.000000000000 AA  -24.863992570844 -18.064748018727   0.000000000000 Bohr
[INPUT] 20 Be   -10.882414179355 -12.086145379146   0.000000000000 AA  -20.564782373064 -22.839504668263   0.000000000000 Bohr
[INPUT] 21 Be    -8.131756398480 -14.084615236940   0.000000000000 AA  -15.366792504806 -26.616065367693   0.000000000000 Bohr
[INPUT] 22 Be    -5.025701842495 -15.467519823398   0.000000000000 AA   -9.497200066037 -29.229376292503   0.000000000000 Bohr
[INPUT] 23 Be    -1.700000000000 -16.174419572178   0.000000000000 AA   -3.212534411761 -30.565223215222   0.000000000000 Bohr
[INPUT] 24 Be     1.700000000000 -16.174419572178   0.000000000000 AA    3.212534411761 -30.565223215222   0.000000000000 Bohr
[INPUT] 25 Be     5.025701842495 -15.467519823398   0.000000000000 AA    9.497200066037 -29.229376292503   0.000000000000 Bohr
[INPUT] 26 Be     8.131756398480 -14.084615236940   0.000000000000 AA   15.366792504806 -26.616065367693   0.000000000000 Bohr
[INPUT] 27 Be    10.882414179355 -12.086145379146   0.000000000000 AA   20.564782373064 -22.839504668263   0.000000000000 Bohr
[INPUT] 28 Be    13.157458240975  -9.559452972523   0.000000000000 AA   24.863992570844 -18.064748018727   0.000000000000 Bohr
[INPUT] 29 Be    14.857458240975  -6.614966599656   0.000000000000 AA   28.076526982604 -12.500475196495   0.000000000000 Bohr
[INPUT] 30 Be    15.908116021850  -3.381374444252   0.000000000000 AA   30.061982439101  -6.389871624240   0.000000000000 Bohr
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [6    /1   ]  312.8704937       0.00916359628
                                57.36446253       0.04936149294
                                16.0485094        0.1685383049
                                5.513096119       0.3705627997
                                2.140896553       0.4164915298
                                0.8817394283      0.1303340841
[INPUT] 0    0    [6    /1   ]  13.63324744       -0.01325278809
                                2.698375464       -0.04699171014
                                0.8386530829      -0.03378537151
                                0.3226600698      0.2502417861
                                0.1401314882      0.5951172526
                                0.0642325139      0.2407061763
[INPUT] 1    0    [6    /1   ]  13.63324744       0.0037596966
                                2.698375464       0.0376793698
                                0.8386530829      0.1738967435
                                0.3226600698      0.4180364347
                                0.1401314882      0.4258595477
                                0.0642325139      0.1017082955
nuclear repulsion = 262.987566234273
number of shells = 90
number of NR pGTOs = 900
number of NR cGTOs = 150
basis = sto-6g
ecp = {}
CPU time:      6828.45


******** <class 'pyscf.dft.rks.RKS'> flags ********
method = RKS
initial guess = minao
damping factor = 0
level shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
DIIS start cycle = 1
DIIS space = 8
SCF tol = 1e-09
SCF gradient tol = None
max. SCF cycles = 100
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /tigress/xingz/pydmfet/examples/tmpQQ6ZlU
max_memory 16000 MB (current use 229 MB)
XC functionals = pbe,pbe
small_rho_cutoff = 1e-07
radial grids: Treutler-Ahlrichs (JCP 102, 346 (M4)) radial grids
becke partition: Becke, JCP, 88, 2547 (1988)
pruning grids: <function nwchem_prune at 0x2aac1c760cf8>
grids dens level: 3
symmetrized grids: False
atomic radii adjust function: <function treutler_atomic_radii_adjust at 0x2aac1c760b18>
Set gradient conv threshold to 3.16228e-05
tot grids = 393300
init E= -436.961601211108
HOMO: -0.1430434351325786 LUMO: -0.11027510936704801
-0.12637900183608358
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    1.999 1.999 1.995 1.995 1.97  1.97  1.931
 0.077 0.028 0.028 0.003 0.003]
entropy corr =  -0.006838867565880724
cycle= 1 E= -437.126404817421  delta_E= -0.165  |g|=    0  |ddm|= 3.88
HOMO: -0.08509998777570442 LUMO: -0.051491422436128906
-0.06801440988415766
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    1.999 1.999 1.995 1.995 1.972 1.972 1.936
 0.071 0.026 0.026 0.003 0.003]
entropy corr =  -0.006436418098962386
cycle= 2 E= -437.125397281797  delta_E= 0.00101  |g|=    0  |ddm|= 0.272
HOMO: -0.08546911009473666 LUMO: -0.05209542353618932
-0.068502008845673
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    1.999 1.999 1.995 1.995 1.972 1.972 1.935
 0.072 0.027 0.027 0.003 0.003]
entropy corr =  -0.006525261588107667
cycle= 3 E= -437.127469979927  delta_E= -0.00207  |g|=    0  |ddm|= 0.154
HOMO: -0.08548512158594475 LUMO: -0.05211274331193359
-0.06851868314046512
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    1.999 1.999 1.995 1.995 1.972 1.972 1.935
 0.072 0.027 0.027 0.003 0.003]
entropy corr =  -0.006525582294376279
cycle= 4 E= -437.127470719624  delta_E= -7.4e-07  |g|=    0  |ddm|= 0.00291
HOMO: -0.08548522192644438 LUMO: -0.05211303445930532
-0.06851887963910694
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    1.999 1.999 1.995 1.995 1.972 1.972 1.935
 0.072 0.027 0.027 0.003 0.003]
entropy corr =  -0.006525662247618524
cycle= 5 E= -437.127470719808  delta_E= -1.84e-10  |g|=    0  |ddm|= 4.85e-05
HOMO: -0.0854852241472788 LUMO: -0.05211303828105391
-0.06851888266887804
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    1.999 1.999 1.995 1.995 1.972 1.972 1.935
 0.072 0.027 0.027 0.003 0.003]
entropy corr =  -0.006525662805520423
Extra cycle  E= -437.12747071979  delta_E= 1.83e-11  |g|=    0  |ddm|= 2.71e-05
converged SCF energy = -437.12747071979
e_mf =  -437.1274707197897
#INFO: **** input file is /tigress/xingz/pydmfet/examples/Be.py ****
from pydmfet import locints, sdmfet, oep, tools
from pyscf import gto, scf,dft, ao2mo,cc
import numpy as np
from pyscf.tools import molden, cubegen
import copy,time

DMguess  = None

bondlengths = np.arange(1.8, 4.1, 0.1)
energies = []

bas = 'sto-6g'

for bondlength in bondlengths:

    nat = 30
    mol = gto.Mole()
    mol.atom = []
    r = 0.5 * bondlength / np.sin(np.pi/nat)
    for i in range(nat):
        theta = i * (2*np.pi/nat)
        mol.atom.append(('Be', (r*np.cos(theta), r*np.sin(theta), 0)))

    mol.basis = bas
    mol.build(max_memory=16000, verbose=4)

    #mf = scf.RHF(mol)
    mf = dft.RKS(mol)
    mf.xc = 'pbe,pbe'
    mf.smear_sigma = 0.005
    mf.max_cycle = 100
    mf.scf()

    #P=mf.make_rdm1()
    #tools.MatPrint(P,"P_ref_ao")
    #cubegen.density(mol, "h20_dens.cube", P, nx=100, ny=100, nz=100)
    print 'e_mf = ',  mf.e_tot
    continue
    if ( True ):   
#        ENUCL = mf.mol.energy_nuc()
#        OEI   = np.dot(np.dot(mf.mo_coeff.T, mol.intor('cint1e_kin_sph') + mol.intor('cint1e_nuc_sph')), mf.mo_coeff)
#        TEI   = ao2mo.outcore.full_iofree(mol, mf.mo_coeff, compact=False).reshape(mol.nao_nr(), mol.nao_nr(), mol.nao_nr(), mol.nao_nr())
#        import chemps2
#        Energy, OneDM = chemps2.solve( ENUCL, OEI, OEI, TEI, mol.nao_nr(), mol.nelectron, mol.nao_nr(), 0.0, False )
#        print "bl =", bondlength," and energy =", Energy

        mycc = cc.CCSD(mf).run()
	et=0.0
        #et = mycc.ccsd_t()
        e_hf = mf.e_tot
        e_ccsd = e_hf + mycc.e_corr + et

        print 'e_tot = ', e_ccsd    #-4.96124910741
        
    else:
        myInts = locints.LocalIntegrals( mf, range( mol.nao_nr() ), 'meta_lowdin' )
        #myInts.loc_molden( 'hydrogen-loc.molden' )
        #myInts.TI_OK = True # Only s functions

	nbas =  mol.nao_nr()
	natoms = mol.natm

	impAtom = np.zeros([natoms], dtype=int)
	for i in range(20):
	    impAtom[i] = 1

	ghost_frag = 1-impAtom
	ghost_env = 1-ghost_frag

	mol_frag = gto.Mole()
	mol_frag.atom = tools.add_ghost(mol.atom, ghost_frag)
	mol_frag.basis = bas
	mol_frag.build(max_memory = 16000,verbose = 4)
	'''
	mf_frag = dft.RKS(mol_frag)
        mf_frag.xc = 'pbe,pbe'
        mf_frag.smear_sigma = 0.00
        mf_frag.scf()
        P_frag=mf_frag.make_rdm1()
        cubegen.density(mol_frag, "h10_dens_1.cube", P_frag, nx=100, ny=100, nz=100)
	'''

	mol_env = gto.Mole()
	mol_env.atom = tools.add_ghost(mol.atom, ghost_env)
	mol_env.basis =  bas
	mol_env.build(max_memory = 16000,verbose = 4)

	'''
	mf_env = dft.RKS(mol_env)
        mf_env.xc = 'pbe,pbe'
        mf_env.smear_sigma = 0.00
        mf_env.scf()
        P_env=mf_env.make_rdm1()
        cubegen.density(mol_env, "h10_dens_2.cube", P_env, nx=100, ny=100, nz=100)
	exit()
	'''



	aoslice = mol.aoslice_by_atom()
	impurities = np.zeros([nbas], dtype = int)
	for i in range(natoms):
	    if(impAtom[i] == 1):
		impurities[aoslice[i,2]:aoslice[i,3]] = 1

	Ne_frag = 20
	boundary_atoms = np.zeros((natoms))
	boundary_atoms[20:40] = 1.0
	#boundary_atoms[19] = -1
	boundary_atoms2 = np.zeros((natoms),dtype =int)
	#boundary_atoms2[9] = -1
	boundary_atoms2[0:20] = 1

	boundary_atoms = None
	boundary_atoms2 =None

	umat=None
	P_frag=None
	P_env=None
	params = oep.OEPparams(algorithm = '2011', opt_method = 'L-BFGS-B', \
                       ftol = 1e-11, gtol = 1e-5,diffP_tol=1e-5, outer_maxit = 200, maxit = 200,l2_lambda = 0.0, oep_print = 0)
	theDMFET = sdmfet.DMFET( mf, mol_frag, mol_env,myInts,impurities, impAtom, Ne_frag, boundary_atoms=boundary_atoms, boundary_atoms2=boundary_atoms2,\
                         umat = umat, P_frag_ao = P_frag, P_env_ao = P_env, \
                         dim_imp = nbas, dim_bath=nbas, dim_big =nbas, smear_sigma = 0.005, oep_params=params,ecw_method='hf', mf_method = mf.xc)

	umat = theDMFET.embedding_potential()

	exit()

	#write subspace orbitals
	transfo = np.dot( myInts.ao2loc, theDMFET.loc2sub )
	filename =  'hydrogen-sub.molden'
	with open( filename, 'w' ) as thefile:
            molden.header( myInts.mol, thefile )
            molden.orbital_coeff( myInts.mol, thefile, transfo )


        umat = theDMFET.embedding_potential()
	print umat
	exit()
	energy = theDMFET.correction_energy()

#INFO: ******************** input file end ********************


System: ('Linux', 'tigercpu.princeton.edu', '3.10.0-693.21.1.el7.x86_64', '#1 SMP Wed Mar 7 15:59:45 EST 2018', 'x86_64', 'x86_64')  Threads 40
Python 2.7.14 |Anaconda, Inc.| (default, Oct 16 2017, 17:29:19) 
[GCC 7.2.0]
numpy 1.14.3  scipy 1.1.0
Date: Thu Jun  7 01:39:53 2018
PySCF version 1.4.2
PySCF path  /tigress/xingz/pyscf/pyscf
GIT ORIG_HEAD e0edd131499dcc18d035a120533a8a1ddda110d4
GIT HEAD      e0edd131499dcc18d035a120533a8a1ddda110d4

[INPUT] VERBOSE 4
[INPUT] num atoms = 30
[INPUT] num electrons = 120
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT]  1 Be    16.741851408635   0.000000000000   0.000000000000 AA   31.637513980484   0.000000000000   0.000000000000 Bohr
[INPUT]  2 Be    16.376001787198   3.480826633789   0.000000000000 AA   30.946158393192   6.577809024953   0.000000000000 Bohr
[INPUT]  3 Be    15.294442306886   6.809524440822   0.000000000000 AA   28.902307187975  12.868136231686   0.000000000000 Bohr
[INPUT]  4 Be    13.544442306886   9.840613354068   0.000000000000 AA   25.595286469986  18.596064136925   0.000000000000 Bohr
[INPUT]  5 Be    11.202485184630  12.441620243238   0.000000000000 AA   21.169628913448  23.511254805565   0.000000000000 Bohr
[INPUT]  6 Be     8.370925704317  14.498868626262   0.000000000000 AA   15.818756990242  27.398890819684   0.000000000000 Bohr
[INPUT]  7 Be     5.173516602568  15.922446877027   0.000000000000 AA    9.776529479744  30.089063830518   0.000000000000 Bohr
[INPUT]  8 Be     1.750000000000  16.650137794890   0.000000000000 AA    3.307020717989  31.464200368611   0.000000000000 Bohr
[INPUT]  9 Be    -1.750000000000  16.650137794890   0.000000000000 AA   -3.307020717989  31.464200368611   0.000000000000 Bohr
[INPUT] 10 Be    -5.173516602568  15.922446877027   0.000000000000 AA   -9.776529479744  30.089063830518   0.000000000000 Bohr
[INPUT] 11 Be    -8.370925704317  14.498868626262   0.000000000000 AA  -15.818756990242  27.398890819684   0.000000000000 Bohr
[INPUT] 12 Be   -11.202485184630  12.441620243238   0.000000000000 AA  -21.169628913448  23.511254805565   0.000000000000 Bohr
[INPUT] 13 Be   -13.544442306886   9.840613354068   0.000000000000 AA  -25.595286469986  18.596064136925   0.000000000000 Bohr
[INPUT] 14 Be   -15.294442306886   6.809524440822   0.000000000000 AA  -28.902307187975  12.868136231686   0.000000000000 Bohr
[INPUT] 15 Be   -16.376001787198   3.480826633789   0.000000000000 AA  -30.946158393192   6.577809024953   0.000000000000 Bohr
[INPUT] 16 Be   -16.741851408635   0.000000000000   0.000000000000 AA  -31.637513980484   0.000000000000   0.000000000000 Bohr
[INPUT] 17 Be   -16.376001787198  -3.480826633789   0.000000000000 AA  -30.946158393192  -6.577809024953   0.000000000000 Bohr
[INPUT] 18 Be   -15.294442306886  -6.809524440822   0.000000000000 AA  -28.902307187975 -12.868136231686   0.000000000000 Bohr
[INPUT] 19 Be   -13.544442306886  -9.840613354068   0.000000000000 AA  -25.595286469986 -18.596064136925   0.000000000000 Bohr
[INPUT] 20 Be   -11.202485184630 -12.441620243238   0.000000000000 AA  -21.169628913448 -23.511254805565   0.000000000000 Bohr
[INPUT] 21 Be    -8.370925704317 -14.498868626262   0.000000000000 AA  -15.818756990242 -27.398890819684   0.000000000000 Bohr
[INPUT] 22 Be    -5.173516602568 -15.922446877027   0.000000000000 AA   -9.776529479744 -30.089063830518   0.000000000000 Bohr
[INPUT] 23 Be    -1.750000000000 -16.650137794890   0.000000000000 AA   -3.307020717989 -31.464200368611   0.000000000000 Bohr
[INPUT] 24 Be     1.750000000000 -16.650137794890   0.000000000000 AA    3.307020717989 -31.464200368611   0.000000000000 Bohr
[INPUT] 25 Be     5.173516602568 -15.922446877027   0.000000000000 AA    9.776529479744 -30.089063830518   0.000000000000 Bohr
[INPUT] 26 Be     8.370925704317 -14.498868626262   0.000000000000 AA   15.818756990242 -27.398890819684   0.000000000000 Bohr
[INPUT] 27 Be    11.202485184630 -12.441620243238   0.000000000000 AA   21.169628913448 -23.511254805565   0.000000000000 Bohr
[INPUT] 28 Be    13.544442306886  -9.840613354068   0.000000000000 AA   25.595286469986 -18.596064136925   0.000000000000 Bohr
[INPUT] 29 Be    15.294442306886  -6.809524440822   0.000000000000 AA   28.902307187975 -12.868136231686   0.000000000000 Bohr
[INPUT] 30 Be    16.376001787198  -3.480826633789   0.000000000000 AA   30.946158393192  -6.577809024953   0.000000000000 Bohr
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [6    /1   ]  312.8704937       0.00916359628
                                57.36446253       0.04936149294
                                16.0485094        0.1685383049
                                5.513096119       0.3705627997
                                2.140896553       0.4164915298
                                0.8817394283      0.1303340841
[INPUT] 0    0    [6    /1   ]  13.63324744       -0.01325278809
                                2.698375464       -0.04699171014
                                0.8386530829      -0.03378537151
                                0.3226600698      0.2502417861
                                0.1401314882      0.5951172526
                                0.0642325139      0.2407061763
[INPUT] 1    0    [6    /1   ]  13.63324744       0.0037596966
                                2.698375464       0.0376793698
                                0.8386530829      0.1738967435
                                0.3226600698      0.4180364347
                                0.1401314882      0.4258595477
                                0.0642325139      0.1017082955
nuclear repulsion = 255.473635770437
number of shells = 90
number of NR pGTOs = 900
number of NR cGTOs = 150
basis = sto-6g
ecp = {}
CPU time:      7155.66


******** <class 'pyscf.dft.rks.RKS'> flags ********
method = RKS
initial guess = minao
damping factor = 0
level shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
DIIS start cycle = 1
DIIS space = 8
SCF tol = 1e-09
SCF gradient tol = None
max. SCF cycles = 100
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /tigress/xingz/pydmfet/examples/tmpzhmrXK
max_memory 16000 MB (current use 229 MB)
XC functionals = pbe,pbe
small_rho_cutoff = 1e-07
radial grids: Treutler-Ahlrichs (JCP 102, 346 (M4)) radial grids
becke partition: Becke, JCP, 88, 2547 (1988)
pruning grids: <function nwchem_prune at 0x2aac1c760cf8>
grids dens level: 3
symmetrized grids: False
atomic radii adjust function: <function treutler_atomic_radii_adjust at 0x2aac1c760b18>
Set gradient conv threshold to 3.16228e-05
tot grids = 393300
init E= -436.887221504451
HOMO: -0.1483329804502576 LUMO: -0.10451365306887261
-0.12607000456220188
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    1.999 1.999 1.997 1.997 1.987 1.987 1.977
 0.026 0.013 0.013 0.002 0.002]
entropy corr =  -0.0033573299558937743
cycle= 1 E= -437.063300461215  delta_E= -0.176  |g|=    0  |ddm|= 3.49
HOMO: -0.09126351908909307 LUMO: -0.04692965816864857
-0.06874364707323803
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.999e+00 1.999e+00 1.997e+00
 1.997e+00 1.988e+00 1.988e+00 1.978e+00 2.516e-02 1.200e-02 1.200e-02
 1.918e-03 1.918e-03]
entropy corr =  -0.0032157914817490035
cycle= 2 E= -437.062415786129  delta_E= 0.000885  |g|=    0  |ddm|= 0.25
HOMO: -0.09160056992691665 LUMO: -0.04744924595840508
-0.06917288328177626
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.999e+00 1.999e+00 1.997e+00
 1.997e+00 1.988e+00 1.988e+00 1.978e+00 2.562e-02 1.216e-02 1.216e-02
 1.927e-03 1.927e-03]
entropy corr =  -0.0032537056494136843
cycle= 3 E= -437.064180574153  delta_E= -0.00176  |g|=    0  |ddm|= 0.143
HOMO: -0.09161472496941796 LUMO: -0.047462350311362866
-0.0691865142252223
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.999e+00 1.999e+00 1.997e+00
 1.997e+00 1.988e+00 1.988e+00 1.978e+00 2.562e-02 1.216e-02 1.216e-02
 1.927e-03 1.927e-03]
entropy corr =  -0.0032533267797815514
cycle= 4 E= -437.064181289514  delta_E= -7.15e-07  |g|=    0  |ddm|= 0.00292
HOMO: -0.09161458953704095 LUMO: -0.04746235970529032
-0.06918645178968481
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.999e+00 1.999e+00 1.997e+00
 1.997e+00 1.988e+00 1.988e+00 1.978e+00 2.562e-02 1.216e-02 1.216e-02
 1.927e-03 1.927e-03]
entropy corr =  -0.0032533615450519673
cycle= 5 E= -437.064181289522  delta_E= -8.3e-12  |g|=    0  |ddm|= 1.16e-05
HOMO: -0.09161458768615724 LUMO: -0.04746236245720853
-0.06918645226038472
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.999e+00 1.999e+00 1.997e+00
 1.997e+00 1.988e+00 1.988e+00 1.978e+00 2.562e-02 1.216e-02 1.216e-02
 1.927e-03 1.927e-03]
entropy corr =  -0.0032533626078948314
Extra cycle  E= -437.064181289523  delta_E= -2.27e-13  |g|=    0  |ddm|= 5.62e-06
converged SCF energy = -437.064181289523
e_mf =  -437.0641812895227
#INFO: **** input file is /tigress/xingz/pydmfet/examples/Be.py ****
from pydmfet import locints, sdmfet, oep, tools
from pyscf import gto, scf,dft, ao2mo,cc
import numpy as np
from pyscf.tools import molden, cubegen
import copy,time

DMguess  = None

bondlengths = np.arange(1.8, 4.1, 0.1)
energies = []

bas = 'sto-6g'

for bondlength in bondlengths:

    nat = 30
    mol = gto.Mole()
    mol.atom = []
    r = 0.5 * bondlength / np.sin(np.pi/nat)
    for i in range(nat):
        theta = i * (2*np.pi/nat)
        mol.atom.append(('Be', (r*np.cos(theta), r*np.sin(theta), 0)))

    mol.basis = bas
    mol.build(max_memory=16000, verbose=4)

    #mf = scf.RHF(mol)
    mf = dft.RKS(mol)
    mf.xc = 'pbe,pbe'
    mf.smear_sigma = 0.005
    mf.max_cycle = 100
    mf.scf()

    #P=mf.make_rdm1()
    #tools.MatPrint(P,"P_ref_ao")
    #cubegen.density(mol, "h20_dens.cube", P, nx=100, ny=100, nz=100)
    print 'e_mf = ',  mf.e_tot
    continue
    if ( True ):   
#        ENUCL = mf.mol.energy_nuc()
#        OEI   = np.dot(np.dot(mf.mo_coeff.T, mol.intor('cint1e_kin_sph') + mol.intor('cint1e_nuc_sph')), mf.mo_coeff)
#        TEI   = ao2mo.outcore.full_iofree(mol, mf.mo_coeff, compact=False).reshape(mol.nao_nr(), mol.nao_nr(), mol.nao_nr(), mol.nao_nr())
#        import chemps2
#        Energy, OneDM = chemps2.solve( ENUCL, OEI, OEI, TEI, mol.nao_nr(), mol.nelectron, mol.nao_nr(), 0.0, False )
#        print "bl =", bondlength," and energy =", Energy

        mycc = cc.CCSD(mf).run()
	et=0.0
        #et = mycc.ccsd_t()
        e_hf = mf.e_tot
        e_ccsd = e_hf + mycc.e_corr + et

        print 'e_tot = ', e_ccsd    #-4.96124910741
        
    else:
        myInts = locints.LocalIntegrals( mf, range( mol.nao_nr() ), 'meta_lowdin' )
        #myInts.loc_molden( 'hydrogen-loc.molden' )
        #myInts.TI_OK = True # Only s functions

	nbas =  mol.nao_nr()
	natoms = mol.natm

	impAtom = np.zeros([natoms], dtype=int)
	for i in range(20):
	    impAtom[i] = 1

	ghost_frag = 1-impAtom
	ghost_env = 1-ghost_frag

	mol_frag = gto.Mole()
	mol_frag.atom = tools.add_ghost(mol.atom, ghost_frag)
	mol_frag.basis = bas
	mol_frag.build(max_memory = 16000,verbose = 4)
	'''
	mf_frag = dft.RKS(mol_frag)
        mf_frag.xc = 'pbe,pbe'
        mf_frag.smear_sigma = 0.00
        mf_frag.scf()
        P_frag=mf_frag.make_rdm1()
        cubegen.density(mol_frag, "h10_dens_1.cube", P_frag, nx=100, ny=100, nz=100)
	'''

	mol_env = gto.Mole()
	mol_env.atom = tools.add_ghost(mol.atom, ghost_env)
	mol_env.basis =  bas
	mol_env.build(max_memory = 16000,verbose = 4)

	'''
	mf_env = dft.RKS(mol_env)
        mf_env.xc = 'pbe,pbe'
        mf_env.smear_sigma = 0.00
        mf_env.scf()
        P_env=mf_env.make_rdm1()
        cubegen.density(mol_env, "h10_dens_2.cube", P_env, nx=100, ny=100, nz=100)
	exit()
	'''



	aoslice = mol.aoslice_by_atom()
	impurities = np.zeros([nbas], dtype = int)
	for i in range(natoms):
	    if(impAtom[i] == 1):
		impurities[aoslice[i,2]:aoslice[i,3]] = 1

	Ne_frag = 20
	boundary_atoms = np.zeros((natoms))
	boundary_atoms[20:40] = 1.0
	#boundary_atoms[19] = -1
	boundary_atoms2 = np.zeros((natoms),dtype =int)
	#boundary_atoms2[9] = -1
	boundary_atoms2[0:20] = 1

	boundary_atoms = None
	boundary_atoms2 =None

	umat=None
	P_frag=None
	P_env=None
	params = oep.OEPparams(algorithm = '2011', opt_method = 'L-BFGS-B', \
                       ftol = 1e-11, gtol = 1e-5,diffP_tol=1e-5, outer_maxit = 200, maxit = 200,l2_lambda = 0.0, oep_print = 0)
	theDMFET = sdmfet.DMFET( mf, mol_frag, mol_env,myInts,impurities, impAtom, Ne_frag, boundary_atoms=boundary_atoms, boundary_atoms2=boundary_atoms2,\
                         umat = umat, P_frag_ao = P_frag, P_env_ao = P_env, \
                         dim_imp = nbas, dim_bath=nbas, dim_big =nbas, smear_sigma = 0.005, oep_params=params,ecw_method='hf', mf_method = mf.xc)

	umat = theDMFET.embedding_potential()

	exit()

	#write subspace orbitals
	transfo = np.dot( myInts.ao2loc, theDMFET.loc2sub )
	filename =  'hydrogen-sub.molden'
	with open( filename, 'w' ) as thefile:
            molden.header( myInts.mol, thefile )
            molden.orbital_coeff( myInts.mol, thefile, transfo )


        umat = theDMFET.embedding_potential()
	print umat
	exit()
	energy = theDMFET.correction_energy()

#INFO: ******************** input file end ********************


System: ('Linux', 'tigercpu.princeton.edu', '3.10.0-693.21.1.el7.x86_64', '#1 SMP Wed Mar 7 15:59:45 EST 2018', 'x86_64', 'x86_64')  Threads 40
Python 2.7.14 |Anaconda, Inc.| (default, Oct 16 2017, 17:29:19) 
[GCC 7.2.0]
numpy 1.14.3  scipy 1.1.0
Date: Thu Jun  7 01:40:05 2018
PySCF version 1.4.2
PySCF path  /tigress/xingz/pyscf/pyscf
GIT ORIG_HEAD e0edd131499dcc18d035a120533a8a1ddda110d4
GIT HEAD      e0edd131499dcc18d035a120533a8a1ddda110d4

[INPUT] VERBOSE 4
[INPUT] num atoms = 30
[INPUT] num electrons = 120
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT]  1 Be    17.220190020310   0.000000000000   0.000000000000 AA   32.541442951355   0.000000000000   0.000000000000 Bohr
[INPUT]  2 Be    16.843887552547   3.580278823326   0.000000000000 AA   31.830334347284   6.765746425666   0.000000000000 Bohr
[INPUT]  3 Be    15.731426372797   7.004082281988   0.000000000000 AA   29.728087393346  13.235797266877   0.000000000000 Bohr
[INPUT]  4 Be    13.931426372797  10.121773735612   0.000000000000 AA   26.326580369129  19.127380255123   0.000000000000 Bohr
[INPUT]  5 Be    11.522556189905  12.797095107331   0.000000000000 AA   21.774475453832  24.183004942867   0.000000000000 Bohr
[INPUT]  6 Be     8.610095010155  14.913122015584   0.000000000000 AA   16.270721475677  28.181716271675   0.000000000000 Bohr
[INPUT]  7 Be     5.321331362642  16.377373930657   0.000000000000 AA   10.055858893451  30.948751368533   0.000000000000 Bohr
[INPUT]  8 Be     1.800000000000  17.125856017601   0.000000000000 AA    3.401507024217  32.363177522000   0.000000000000 Bohr
[INPUT]  9 Be    -1.800000000000  17.125856017601   0.000000000000 AA   -3.401507024217  32.363177522000   0.000000000000 Bohr
[INPUT] 10 Be    -5.321331362642  16.377373930657   0.000000000000 AA  -10.055858893451  30.948751368533   0.000000000000 Bohr
[INPUT] 11 Be    -8.610095010155  14.913122015584   0.000000000000 AA  -16.270721475677  28.181716271675   0.000000000000 Bohr
[INPUT] 12 Be   -11.522556189905  12.797095107331   0.000000000000 AA  -21.774475453832  24.183004942867   0.000000000000 Bohr
[INPUT] 13 Be   -13.931426372797  10.121773735612   0.000000000000 AA  -26.326580369129  19.127380255123   0.000000000000 Bohr
[INPUT] 14 Be   -15.731426372797   7.004082281988   0.000000000000 AA  -29.728087393346  13.235797266877   0.000000000000 Bohr
[INPUT] 15 Be   -16.843887552547   3.580278823326   0.000000000000 AA  -31.830334347284   6.765746425666   0.000000000000 Bohr
[INPUT] 16 Be   -17.220190020310   0.000000000000   0.000000000000 AA  -32.541442951355   0.000000000000   0.000000000000 Bohr
[INPUT] 17 Be   -16.843887552547  -3.580278823326   0.000000000000 AA  -31.830334347284  -6.765746425666   0.000000000000 Bohr
[INPUT] 18 Be   -15.731426372797  -7.004082281988   0.000000000000 AA  -29.728087393346 -13.235797266877   0.000000000000 Bohr
[INPUT] 19 Be   -13.931426372797 -10.121773735612   0.000000000000 AA  -26.326580369129 -19.127380255123   0.000000000000 Bohr
[INPUT] 20 Be   -11.522556189905 -12.797095107331   0.000000000000 AA  -21.774475453832 -24.183004942867   0.000000000000 Bohr
[INPUT] 21 Be    -8.610095010155 -14.913122015584   0.000000000000 AA  -16.270721475677 -28.181716271675   0.000000000000 Bohr
[INPUT] 22 Be    -5.321331362642 -16.377373930657   0.000000000000 AA  -10.055858893451 -30.948751368533   0.000000000000 Bohr
[INPUT] 23 Be    -1.800000000000 -17.125856017601   0.000000000000 AA   -3.401507024217 -32.363177522000   0.000000000000 Bohr
[INPUT] 24 Be     1.800000000000 -17.125856017601   0.000000000000 AA    3.401507024217 -32.363177522000   0.000000000000 Bohr
[INPUT] 25 Be     5.321331362642 -16.377373930657   0.000000000000 AA   10.055858893451 -30.948751368533   0.000000000000 Bohr
[INPUT] 26 Be     8.610095010155 -14.913122015584   0.000000000000 AA   16.270721475677 -28.181716271675   0.000000000000 Bohr
[INPUT] 27 Be    11.522556189905 -12.797095107331   0.000000000000 AA   21.774475453832 -24.183004942867   0.000000000000 Bohr
[INPUT] 28 Be    13.931426372797 -10.121773735612   0.000000000000 AA   26.326580369129 -19.127380255123   0.000000000000 Bohr
[INPUT] 29 Be    15.731426372797  -7.004082281988   0.000000000000 AA   29.728087393346 -13.235797266877   0.000000000000 Bohr
[INPUT] 30 Be    16.843887552547  -3.580278823326   0.000000000000 AA   31.830334347284  -6.765746425666   0.000000000000 Bohr
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [6    /1   ]  312.8704937       0.00916359628
                                57.36446253       0.04936149294
                                16.0485094        0.1685383049
                                5.513096119       0.3705627997
                                2.140896553       0.4164915298
                                0.8817394283      0.1303340841
[INPUT] 0    0    [6    /1   ]  13.63324744       -0.01325278809
                                2.698375464       -0.04699171014
                                0.8386530829      -0.03378537151
                                0.3226600698      0.2502417861
                                0.1401314882      0.5951172526
                                0.0642325139      0.2407061763
[INPUT] 1    0    [6    /1   ]  13.63324744       0.0037596966
                                2.698375464       0.0376793698
                                0.8386530829      0.1738967435
                                0.3226600698      0.4180364347
                                0.1401314882      0.4258595477
                                0.0642325139      0.1017082955
nuclear repulsion = 248.377145887925
number of shells = 90
number of NR pGTOs = 900
number of NR cGTOs = 150
basis = sto-6g
ecp = {}
CPU time:      7479.71


******** <class 'pyscf.dft.rks.RKS'> flags ********
method = RKS
initial guess = minao
damping factor = 0
level shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
DIIS start cycle = 1
DIIS space = 8
SCF tol = 1e-09
SCF gradient tol = None
max. SCF cycles = 100
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /tigress/xingz/pydmfet/examples/tmpOKsZ49
max_memory 16000 MB (current use 229 MB)
XC functionals = pbe,pbe
small_rho_cutoff = 1e-07
radial grids: Treutler-Ahlrichs (JCP 102, 346 (M4)) radial grids
becke partition: Becke, JCP, 88, 2547 (1988)
pruning grids: <function nwchem_prune at 0x2aac1c760cf8>
grids dens level: 3
symmetrized grids: False
atomic radii adjust function: <function treutler_atomic_radii_adjust at 0x2aac1c760b18>
Set gradient conv threshold to 3.16228e-05
tot grids = 393300
init E= -436.824832700189
HOMO: -0.15292074572198852 LUMO: -0.0989100586063056
-0.12548756474128028
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.998e+00
 1.998e+00 1.995e+00 1.995e+00 1.992e+00 9.782e-03 5.525e-03 5.525e-03
 1.233e-03 1.233e-03]
entropy corr =  -0.0016510822738356732
cycle= 1 E= -437.01235275358  delta_E= -0.188  |g|=    0  |ddm|= 3.13
HOMO: -0.0965307201124214 LUMO: -0.04219903529891565
-0.06893857657283793
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.998e+00
 1.998e+00 1.995e+00 1.995e+00 1.992e+00 9.471e-03 5.332e-03 5.332e-03
 1.180e-03 1.180e-03]
entropy corr =  -0.0016016074642458114
cycle= 2 E= -437.011571602928  delta_E= 0.000781  |g|=    0  |ddm|= 0.234
HOMO: -0.09684417517579763 LUMO: -0.042659021231123216
-0.06932612923500991
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.998e+00
 1.998e+00 1.995e+00 1.995e+00 1.992e+00 9.609e-03 5.395e-03 5.395e-03
 1.187e-03 1.187e-03]
entropy corr =  -0.0016174594803302247
cycle= 3 E= -437.013115051565  delta_E= -0.00154  |g|=    0  |ddm|= 0.134
HOMO: -0.09685863122873808 LUMO: -0.042672142691379644
-0.06933991932490627
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.998e+00
 1.998e+00 1.995e+00 1.995e+00 1.992e+00 9.607e-03 5.394e-03 5.394e-03
 1.187e-03 1.187e-03]
entropy corr =  -0.0016172306582483403
cycle= 4 E= -437.013115674678  delta_E= -6.23e-07  |g|=    0  |ddm|= 0.00273
HOMO: -0.09685852144458747 LUMO: -0.04267213854772427
-0.06933986281499029
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.998e+00
 1.998e+00 1.995e+00 1.995e+00 1.992e+00 9.607e-03 5.394e-03 5.394e-03
 1.187e-03 1.187e-03]
entropy corr =  -0.0016172438059224538
cycle= 5 E= -437.013115674698  delta_E= -2e-11  |g|=    0  |ddm|= 1.6e-05
HOMO: -0.0968585177643604 LUMO: -0.042672136728664954
-0.06933986007234873
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.998e+00
 1.998e+00 1.995e+00 1.995e+00 1.992e+00 9.607e-03 5.394e-03 5.394e-03
 1.187e-03 1.187e-03]
entropy corr =  -0.001617244044380618
Extra cycle  E= -437.013115674698  delta_E= 9.09e-13  |g|=    0  |ddm|= 2.02e-06
converged SCF energy = -437.013115674698
e_mf =  -437.01311567469753
#INFO: **** input file is /tigress/xingz/pydmfet/examples/Be.py ****
from pydmfet import locints, sdmfet, oep, tools
from pyscf import gto, scf,dft, ao2mo,cc
import numpy as np
from pyscf.tools import molden, cubegen
import copy,time

DMguess  = None

bondlengths = np.arange(1.8, 4.1, 0.1)
energies = []

bas = 'sto-6g'

for bondlength in bondlengths:

    nat = 30
    mol = gto.Mole()
    mol.atom = []
    r = 0.5 * bondlength / np.sin(np.pi/nat)
    for i in range(nat):
        theta = i * (2*np.pi/nat)
        mol.atom.append(('Be', (r*np.cos(theta), r*np.sin(theta), 0)))

    mol.basis = bas
    mol.build(max_memory=16000, verbose=4)

    #mf = scf.RHF(mol)
    mf = dft.RKS(mol)
    mf.xc = 'pbe,pbe'
    mf.smear_sigma = 0.005
    mf.max_cycle = 100
    mf.scf()

    #P=mf.make_rdm1()
    #tools.MatPrint(P,"P_ref_ao")
    #cubegen.density(mol, "h20_dens.cube", P, nx=100, ny=100, nz=100)
    print 'e_mf = ',  mf.e_tot
    continue
    if ( True ):   
#        ENUCL = mf.mol.energy_nuc()
#        OEI   = np.dot(np.dot(mf.mo_coeff.T, mol.intor('cint1e_kin_sph') + mol.intor('cint1e_nuc_sph')), mf.mo_coeff)
#        TEI   = ao2mo.outcore.full_iofree(mol, mf.mo_coeff, compact=False).reshape(mol.nao_nr(), mol.nao_nr(), mol.nao_nr(), mol.nao_nr())
#        import chemps2
#        Energy, OneDM = chemps2.solve( ENUCL, OEI, OEI, TEI, mol.nao_nr(), mol.nelectron, mol.nao_nr(), 0.0, False )
#        print "bl =", bondlength," and energy =", Energy

        mycc = cc.CCSD(mf).run()
	et=0.0
        #et = mycc.ccsd_t()
        e_hf = mf.e_tot
        e_ccsd = e_hf + mycc.e_corr + et

        print 'e_tot = ', e_ccsd    #-4.96124910741
        
    else:
        myInts = locints.LocalIntegrals( mf, range( mol.nao_nr() ), 'meta_lowdin' )
        #myInts.loc_molden( 'hydrogen-loc.molden' )
        #myInts.TI_OK = True # Only s functions

	nbas =  mol.nao_nr()
	natoms = mol.natm

	impAtom = np.zeros([natoms], dtype=int)
	for i in range(20):
	    impAtom[i] = 1

	ghost_frag = 1-impAtom
	ghost_env = 1-ghost_frag

	mol_frag = gto.Mole()
	mol_frag.atom = tools.add_ghost(mol.atom, ghost_frag)
	mol_frag.basis = bas
	mol_frag.build(max_memory = 16000,verbose = 4)
	'''
	mf_frag = dft.RKS(mol_frag)
        mf_frag.xc = 'pbe,pbe'
        mf_frag.smear_sigma = 0.00
        mf_frag.scf()
        P_frag=mf_frag.make_rdm1()
        cubegen.density(mol_frag, "h10_dens_1.cube", P_frag, nx=100, ny=100, nz=100)
	'''

	mol_env = gto.Mole()
	mol_env.atom = tools.add_ghost(mol.atom, ghost_env)
	mol_env.basis =  bas
	mol_env.build(max_memory = 16000,verbose = 4)

	'''
	mf_env = dft.RKS(mol_env)
        mf_env.xc = 'pbe,pbe'
        mf_env.smear_sigma = 0.00
        mf_env.scf()
        P_env=mf_env.make_rdm1()
        cubegen.density(mol_env, "h10_dens_2.cube", P_env, nx=100, ny=100, nz=100)
	exit()
	'''



	aoslice = mol.aoslice_by_atom()
	impurities = np.zeros([nbas], dtype = int)
	for i in range(natoms):
	    if(impAtom[i] == 1):
		impurities[aoslice[i,2]:aoslice[i,3]] = 1

	Ne_frag = 20
	boundary_atoms = np.zeros((natoms))
	boundary_atoms[20:40] = 1.0
	#boundary_atoms[19] = -1
	boundary_atoms2 = np.zeros((natoms),dtype =int)
	#boundary_atoms2[9] = -1
	boundary_atoms2[0:20] = 1

	boundary_atoms = None
	boundary_atoms2 =None

	umat=None
	P_frag=None
	P_env=None
	params = oep.OEPparams(algorithm = '2011', opt_method = 'L-BFGS-B', \
                       ftol = 1e-11, gtol = 1e-5,diffP_tol=1e-5, outer_maxit = 200, maxit = 200,l2_lambda = 0.0, oep_print = 0)
	theDMFET = sdmfet.DMFET( mf, mol_frag, mol_env,myInts,impurities, impAtom, Ne_frag, boundary_atoms=boundary_atoms, boundary_atoms2=boundary_atoms2,\
                         umat = umat, P_frag_ao = P_frag, P_env_ao = P_env, \
                         dim_imp = nbas, dim_bath=nbas, dim_big =nbas, smear_sigma = 0.005, oep_params=params,ecw_method='hf', mf_method = mf.xc)

	umat = theDMFET.embedding_potential()

	exit()

	#write subspace orbitals
	transfo = np.dot( myInts.ao2loc, theDMFET.loc2sub )
	filename =  'hydrogen-sub.molden'
	with open( filename, 'w' ) as thefile:
            molden.header( myInts.mol, thefile )
            molden.orbital_coeff( myInts.mol, thefile, transfo )


        umat = theDMFET.embedding_potential()
	print umat
	exit()
	energy = theDMFET.correction_energy()

#INFO: ******************** input file end ********************


System: ('Linux', 'tigercpu.princeton.edu', '3.10.0-693.21.1.el7.x86_64', '#1 SMP Wed Mar 7 15:59:45 EST 2018', 'x86_64', 'x86_64')  Threads 40
Python 2.7.14 |Anaconda, Inc.| (default, Oct 16 2017, 17:29:19) 
[GCC 7.2.0]
numpy 1.14.3  scipy 1.1.0
Date: Thu Jun  7 01:40:17 2018
PySCF version 1.4.2
PySCF path  /tigress/xingz/pyscf/pyscf
GIT ORIG_HEAD e0edd131499dcc18d035a120533a8a1ddda110d4
GIT HEAD      e0edd131499dcc18d035a120533a8a1ddda110d4

[INPUT] VERBOSE 4
[INPUT] num atoms = 30
[INPUT] num electrons = 120
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT]  1 Be    17.698528631985   0.000000000000   0.000000000000 AA   33.445371922226   0.000000000000   0.000000000000 Bohr
[INPUT]  2 Be    17.311773317895   3.679731012863   0.000000000000 AA   32.714510301375   6.953683826379   0.000000000000 Bohr
[INPUT]  3 Be    16.168410438708   7.198640123155   0.000000000000 AA   30.553867598717  13.603458302068   0.000000000000 Bohr
[INPUT]  4 Be    14.318410438708  10.402934117157   0.000000000000 AA   27.057874268271  19.658696373321   0.000000000000 Bohr
[INPUT]  5 Be    11.842627195180  13.152569971423   0.000000000000 AA   22.379321994216  24.854755080169   0.000000000000 Bohr
[INPUT]  6 Be     8.849264315993  15.327375404906   0.000000000000 AA   16.722685961113  28.964541723666   0.000000000000 Bohr
[INPUT]  7 Be     5.469146122715  16.832300984286   0.000000000000 AA   10.335188307158  31.808438906548   0.000000000000 Bohr
[INPUT]  8 Be     1.850000000000  17.601574240312   0.000000000000 AA    3.495993330445  33.262154675389   0.000000000000 Bohr
[INPUT]  9 Be    -1.850000000000  17.601574240312   0.000000000000 AA   -3.495993330445  33.262154675389   0.000000000000 Bohr
[INPUT] 10 Be    -5.469146122715  16.832300984286   0.000000000000 AA  -10.335188307158  31.808438906548   0.000000000000 Bohr
[INPUT] 11 Be    -8.849264315993  15.327375404906   0.000000000000 AA  -16.722685961113  28.964541723666   0.000000000000 Bohr
[INPUT] 12 Be   -11.842627195180  13.152569971423   0.000000000000 AA  -22.379321994216  24.854755080169   0.000000000000 Bohr
[INPUT] 13 Be   -14.318410438708  10.402934117157   0.000000000000 AA  -27.057874268271  19.658696373321   0.000000000000 Bohr
[INPUT] 14 Be   -16.168410438708   7.198640123155   0.000000000000 AA  -30.553867598717  13.603458302068   0.000000000000 Bohr
[INPUT] 15 Be   -17.311773317895   3.679731012863   0.000000000000 AA  -32.714510301375   6.953683826379   0.000000000000 Bohr
[INPUT] 16 Be   -17.698528631985   0.000000000000   0.000000000000 AA  -33.445371922226   0.000000000000   0.000000000000 Bohr
[INPUT] 17 Be   -17.311773317895  -3.679731012863   0.000000000000 AA  -32.714510301375  -6.953683826379   0.000000000000 Bohr
[INPUT] 18 Be   -16.168410438708  -7.198640123155   0.000000000000 AA  -30.553867598717 -13.603458302068   0.000000000000 Bohr
[INPUT] 19 Be   -14.318410438708 -10.402934117157   0.000000000000 AA  -27.057874268271 -19.658696373321   0.000000000000 Bohr
[INPUT] 20 Be   -11.842627195180 -13.152569971423   0.000000000000 AA  -22.379321994216 -24.854755080169   0.000000000000 Bohr
[INPUT] 21 Be    -8.849264315993 -15.327375404906   0.000000000000 AA  -16.722685961113 -28.964541723666   0.000000000000 Bohr
[INPUT] 22 Be    -5.469146122715 -16.832300984286   0.000000000000 AA  -10.335188307158 -31.808438906548   0.000000000000 Bohr
[INPUT] 23 Be    -1.850000000000 -17.601574240312   0.000000000000 AA   -3.495993330445 -33.262154675389   0.000000000000 Bohr
[INPUT] 24 Be     1.850000000000 -17.601574240312   0.000000000000 AA    3.495993330445 -33.262154675389   0.000000000000 Bohr
[INPUT] 25 Be     5.469146122715 -16.832300984286   0.000000000000 AA   10.335188307158 -31.808438906548   0.000000000000 Bohr
[INPUT] 26 Be     8.849264315993 -15.327375404906   0.000000000000 AA   16.722685961113 -28.964541723666   0.000000000000 Bohr
[INPUT] 27 Be    11.842627195180 -13.152569971423   0.000000000000 AA   22.379321994216 -24.854755080169   0.000000000000 Bohr
[INPUT] 28 Be    14.318410438708 -10.402934117157   0.000000000000 AA   27.057874268271 -19.658696373321   0.000000000000 Bohr
[INPUT] 29 Be    16.168410438708  -7.198640123155   0.000000000000 AA   30.553867598717 -13.603458302068   0.000000000000 Bohr
[INPUT] 30 Be    17.311773317895  -3.679731012863   0.000000000000 AA   32.714510301375  -6.953683826379   0.000000000000 Bohr
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [6    /1   ]  312.8704937       0.00916359628
                                57.36446253       0.04936149294
                                16.0485094        0.1685383049
                                5.513096119       0.3705627997
                                2.140896553       0.4164915298
                                0.8817394283      0.1303340841
[INPUT] 0    0    [6    /1   ]  13.63324744       -0.01325278809
                                2.698375464       -0.04699171014
                                0.8386530829      -0.03378537151
                                0.3226600698      0.2502417861
                                0.1401314882      0.5951172526
                                0.0642325139      0.2407061763
[INPUT] 1    0    [6    /1   ]  13.63324744       0.0037596966
                                2.698375464       0.0376793698
                                0.8386530829      0.1738967435
                                0.3226600698      0.4180364347
                                0.1401314882      0.4258595477
                                0.0642325139      0.1017082955
nuclear repulsion = 241.664250053116
number of shells = 90
number of NR pGTOs = 900
number of NR cGTOs = 150
basis = sto-6g
ecp = {}
CPU time:      7806.69


******** <class 'pyscf.dft.rks.RKS'> flags ********
method = RKS
initial guess = minao
damping factor = 0
level shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
DIIS start cycle = 1
DIIS space = 8
SCF tol = 1e-09
SCF gradient tol = None
max. SCF cycles = 100
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /tigress/xingz/pydmfet/examples/tmpXYZMFC
max_memory 16000 MB (current use 229 MB)
XC functionals = pbe,pbe
small_rho_cutoff = 1e-07
radial grids: Treutler-Ahlrichs (JCP 102, 346 (M4)) radial grids
becke partition: Becke, JCP, 88, 2547 (1988)
pruning grids: <function nwchem_prune at 0x2aac1c760cf8>
grids dens level: 3
symmetrized grids: False
atomic radii adjust function: <function treutler_atomic_radii_adjust at 0x2aac1c760b18>
Set gradient conv threshold to 3.16228e-05
tot grids = 393300
init E= -436.772697330708
HOMO: -0.15688227218596687 LUMO: -0.09348711898586534
-0.12468245268613481
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    1.999 1.999 1.998 1.998 1.997
 0.004 0.002 0.002]
entropy corr =  -0.0008350208036872019
cycle= 1 E= -436.971045533343  delta_E= -0.198  |g|=    0  |ddm|=  2.8
HOMO: -0.10106373324359019 LUMO: -0.03745819254820909
-0.06876124187988464
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    1.999 1.999 1.998 1.998 1.997
 0.004 0.002 0.002]
entropy corr =  -0.00081641506429021
cycle= 2 E= -436.970351907436  delta_E= 0.000694  |g|=    0  |ddm|= 0.221
HOMO: -0.10135701711642056 LUMO: -0.03787122097971232
-0.06911516197205682
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    1.999 1.999 1.998 1.998 1.997
 0.004 0.002 0.002]
entropy corr =  -0.0008231512262408668
cycle= 3 E= -436.971721083614  delta_E= -0.00137  |g|=    0  |ddm|= 0.127
HOMO: -0.10137189137352422 LUMO: -0.03788504466056821
-0.06912951461941952
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    1.999 1.999 1.998 1.998 1.997
 0.004 0.002 0.002]
entropy corr =  -0.00082305252617979
cycle= 4 E= -436.971721607941  delta_E= -5.24e-07  |g|=    0  |ddm|= 0.00251
HOMO: -0.101371839527194 LUMO: -0.03788507141458594
-0.06912950242465643
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    1.999 1.999 1.998 1.998 1.997
 0.004 0.002 0.002]
entropy corr =  -0.0008230575666079608
cycle= 5 E= -436.971721607977  delta_E= -3.64e-11  |g|=    0  |ddm|= 2.11e-05
HOMO: -0.10137183709883336 LUMO: -0.03788506954594192
-0.06912950027688278
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    1.999 1.999 1.998 1.998 1.997
 0.004 0.002 0.002]
entropy corr =  -0.0008230576076956264
Extra cycle  E= -436.971721607976  delta_E= 1.02e-12  |g|=    0  |ddm|= 1.38e-06
converged SCF energy = -436.971721607976
e_mf =  -436.97172160797595
#INFO: **** input file is /tigress/xingz/pydmfet/examples/Be.py ****
from pydmfet import locints, sdmfet, oep, tools
from pyscf import gto, scf,dft, ao2mo,cc
import numpy as np
from pyscf.tools import molden, cubegen
import copy,time

DMguess  = None

bondlengths = np.arange(1.8, 4.1, 0.1)
energies = []

bas = 'sto-6g'

for bondlength in bondlengths:

    nat = 30
    mol = gto.Mole()
    mol.atom = []
    r = 0.5 * bondlength / np.sin(np.pi/nat)
    for i in range(nat):
        theta = i * (2*np.pi/nat)
        mol.atom.append(('Be', (r*np.cos(theta), r*np.sin(theta), 0)))

    mol.basis = bas
    mol.build(max_memory=16000, verbose=4)

    #mf = scf.RHF(mol)
    mf = dft.RKS(mol)
    mf.xc = 'pbe,pbe'
    mf.smear_sigma = 0.005
    mf.max_cycle = 100
    mf.scf()

    #P=mf.make_rdm1()
    #tools.MatPrint(P,"P_ref_ao")
    #cubegen.density(mol, "h20_dens.cube", P, nx=100, ny=100, nz=100)
    print 'e_mf = ',  mf.e_tot
    continue
    if ( True ):   
#        ENUCL = mf.mol.energy_nuc()
#        OEI   = np.dot(np.dot(mf.mo_coeff.T, mol.intor('cint1e_kin_sph') + mol.intor('cint1e_nuc_sph')), mf.mo_coeff)
#        TEI   = ao2mo.outcore.full_iofree(mol, mf.mo_coeff, compact=False).reshape(mol.nao_nr(), mol.nao_nr(), mol.nao_nr(), mol.nao_nr())
#        import chemps2
#        Energy, OneDM = chemps2.solve( ENUCL, OEI, OEI, TEI, mol.nao_nr(), mol.nelectron, mol.nao_nr(), 0.0, False )
#        print "bl =", bondlength," and energy =", Energy

        mycc = cc.CCSD(mf).run()
	et=0.0
        #et = mycc.ccsd_t()
        e_hf = mf.e_tot
        e_ccsd = e_hf + mycc.e_corr + et

        print 'e_tot = ', e_ccsd    #-4.96124910741
        
    else:
        myInts = locints.LocalIntegrals( mf, range( mol.nao_nr() ), 'meta_lowdin' )
        #myInts.loc_molden( 'hydrogen-loc.molden' )
        #myInts.TI_OK = True # Only s functions

	nbas =  mol.nao_nr()
	natoms = mol.natm

	impAtom = np.zeros([natoms], dtype=int)
	for i in range(20):
	    impAtom[i] = 1

	ghost_frag = 1-impAtom
	ghost_env = 1-ghost_frag

	mol_frag = gto.Mole()
	mol_frag.atom = tools.add_ghost(mol.atom, ghost_frag)
	mol_frag.basis = bas
	mol_frag.build(max_memory = 16000,verbose = 4)
	'''
	mf_frag = dft.RKS(mol_frag)
        mf_frag.xc = 'pbe,pbe'
        mf_frag.smear_sigma = 0.00
        mf_frag.scf()
        P_frag=mf_frag.make_rdm1()
        cubegen.density(mol_frag, "h10_dens_1.cube", P_frag, nx=100, ny=100, nz=100)
	'''

	mol_env = gto.Mole()
	mol_env.atom = tools.add_ghost(mol.atom, ghost_env)
	mol_env.basis =  bas
	mol_env.build(max_memory = 16000,verbose = 4)

	'''
	mf_env = dft.RKS(mol_env)
        mf_env.xc = 'pbe,pbe'
        mf_env.smear_sigma = 0.00
        mf_env.scf()
        P_env=mf_env.make_rdm1()
        cubegen.density(mol_env, "h10_dens_2.cube", P_env, nx=100, ny=100, nz=100)
	exit()
	'''



	aoslice = mol.aoslice_by_atom()
	impurities = np.zeros([nbas], dtype = int)
	for i in range(natoms):
	    if(impAtom[i] == 1):
		impurities[aoslice[i,2]:aoslice[i,3]] = 1

	Ne_frag = 20
	boundary_atoms = np.zeros((natoms))
	boundary_atoms[20:40] = 1.0
	#boundary_atoms[19] = -1
	boundary_atoms2 = np.zeros((natoms),dtype =int)
	#boundary_atoms2[9] = -1
	boundary_atoms2[0:20] = 1

	boundary_atoms = None
	boundary_atoms2 =None

	umat=None
	P_frag=None
	P_env=None
	params = oep.OEPparams(algorithm = '2011', opt_method = 'L-BFGS-B', \
                       ftol = 1e-11, gtol = 1e-5,diffP_tol=1e-5, outer_maxit = 200, maxit = 200,l2_lambda = 0.0, oep_print = 0)
	theDMFET = sdmfet.DMFET( mf, mol_frag, mol_env,myInts,impurities, impAtom, Ne_frag, boundary_atoms=boundary_atoms, boundary_atoms2=boundary_atoms2,\
                         umat = umat, P_frag_ao = P_frag, P_env_ao = P_env, \
                         dim_imp = nbas, dim_bath=nbas, dim_big =nbas, smear_sigma = 0.005, oep_params=params,ecw_method='hf', mf_method = mf.xc)

	umat = theDMFET.embedding_potential()

	exit()

	#write subspace orbitals
	transfo = np.dot( myInts.ao2loc, theDMFET.loc2sub )
	filename =  'hydrogen-sub.molden'
	with open( filename, 'w' ) as thefile:
            molden.header( myInts.mol, thefile )
            molden.orbital_coeff( myInts.mol, thefile, transfo )


        umat = theDMFET.embedding_potential()
	print umat
	exit()
	energy = theDMFET.correction_energy()

#INFO: ******************** input file end ********************


System: ('Linux', 'tigercpu.princeton.edu', '3.10.0-693.21.1.el7.x86_64', '#1 SMP Wed Mar 7 15:59:45 EST 2018', 'x86_64', 'x86_64')  Threads 40
Python 2.7.14 |Anaconda, Inc.| (default, Oct 16 2017, 17:29:19) 
[GCC 7.2.0]
numpy 1.14.3  scipy 1.1.0
Date: Thu Jun  7 01:40:29 2018
PySCF version 1.4.2
PySCF path  /tigress/xingz/pyscf/pyscf
GIT ORIG_HEAD e0edd131499dcc18d035a120533a8a1ddda110d4
GIT HEAD      e0edd131499dcc18d035a120533a8a1ddda110d4

[INPUT] VERBOSE 4
[INPUT] num atoms = 30
[INPUT] num electrons = 120
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT]  1 Be    18.176867243661   0.000000000000   0.000000000000 AA   34.349300893097   0.000000000000   0.000000000000 Bohr
[INPUT]  2 Be    17.779659083244   3.779183202399   0.000000000000 AA   33.598686255466   7.141621227092   0.000000000000 Bohr
[INPUT]  3 Be    16.605394504619   7.393197964321   0.000000000000 AA   31.379647804087  13.971119337259   0.000000000000 Bohr
[INPUT]  4 Be    14.705394504619  10.684094498702   0.000000000000 AA   27.789168167414  20.190012491519   0.000000000000 Bohr
[INPUT]  5 Be    12.162698200455  13.508044835516   0.000000000000 AA   22.984168534601  25.526505217471   0.000000000000 Bohr
[INPUT]  6 Be     9.088433621830  15.741628794227   0.000000000000 AA   17.174650446548  29.747367175657   0.000000000000 Bohr
[INPUT]  7 Be     5.616960882788  17.287228037915   0.000000000000 AA   10.614517720865  32.668126444562   0.000000000000 Bohr
[INPUT]  8 Be     1.900000000000  18.077292463023   0.000000000000 AA    3.590479636674  34.161131828777   0.000000000000 Bohr
[INPUT]  9 Be    -1.900000000000  18.077292463023   0.000000000000 AA   -3.590479636674  34.161131828778   0.000000000000 Bohr
[INPUT] 10 Be    -5.616960882788  17.287228037915   0.000000000000 AA  -10.614517720865  32.668126444562   0.000000000000 Bohr
[INPUT] 11 Be    -9.088433621830  15.741628794227   0.000000000000 AA  -17.174650446548  29.747367175657   0.000000000000 Bohr
[INPUT] 12 Be   -12.162698200455  13.508044835516   0.000000000000 AA  -22.984168534601  25.526505217471   0.000000000000 Bohr
[INPUT] 13 Be   -14.705394504619  10.684094498702   0.000000000000 AA  -27.789168167414  20.190012491519   0.000000000000 Bohr
[INPUT] 14 Be   -16.605394504619   7.393197964321   0.000000000000 AA  -31.379647804087  13.971119337259   0.000000000000 Bohr
[INPUT] 15 Be   -17.779659083244   3.779183202399   0.000000000000 AA  -33.598686255466   7.141621227092   0.000000000000 Bohr
[INPUT] 16 Be   -18.176867243661   0.000000000000   0.000000000000 AA  -34.349300893097   0.000000000000   0.000000000000 Bohr
[INPUT] 17 Be   -17.779659083244  -3.779183202399   0.000000000000 AA  -33.598686255466  -7.141621227092   0.000000000000 Bohr
[INPUT] 18 Be   -16.605394504619  -7.393197964321   0.000000000000 AA  -31.379647804087 -13.971119337259   0.000000000000 Bohr
[INPUT] 19 Be   -14.705394504619 -10.684094498702   0.000000000000 AA  -27.789168167414 -20.190012491519   0.000000000000 Bohr
[INPUT] 20 Be   -12.162698200455 -13.508044835516   0.000000000000 AA  -22.984168534601 -25.526505217471   0.000000000000 Bohr
[INPUT] 21 Be    -9.088433621830 -15.741628794227   0.000000000000 AA  -17.174650446548 -29.747367175657   0.000000000000 Bohr
[INPUT] 22 Be    -5.616960882788 -17.287228037915   0.000000000000 AA  -10.614517720865 -32.668126444562   0.000000000000 Bohr
[INPUT] 23 Be    -1.900000000000 -18.077292463023   0.000000000000 AA   -3.590479636674 -34.161131828777   0.000000000000 Bohr
[INPUT] 24 Be     1.900000000000 -18.077292463023   0.000000000000 AA    3.590479636674 -34.161131828778   0.000000000000 Bohr
[INPUT] 25 Be     5.616960882788 -17.287228037915   0.000000000000 AA   10.614517720865 -32.668126444562   0.000000000000 Bohr
[INPUT] 26 Be     9.088433621830 -15.741628794227   0.000000000000 AA   17.174650446548 -29.747367175657   0.000000000000 Bohr
[INPUT] 27 Be    12.162698200455 -13.508044835516   0.000000000000 AA   22.984168534601 -25.526505217471   0.000000000000 Bohr
[INPUT] 28 Be    14.705394504619 -10.684094498702   0.000000000000 AA   27.789168167414 -20.190012491519   0.000000000000 Bohr
[INPUT] 29 Be    16.605394504619  -7.393197964321   0.000000000000 AA   31.379647804087 -13.971119337259   0.000000000000 Bohr
[INPUT] 30 Be    17.779659083244  -3.779183202399   0.000000000000 AA   33.598686255466  -7.141621227092   0.000000000000 Bohr
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [6    /1   ]  312.8704937       0.00916359628
                                57.36446253       0.04936149294
                                16.0485094        0.1685383049
                                5.513096119       0.3705627997
                                2.140896553       0.4164915298
                                0.8817394283      0.1303340841
[INPUT] 0    0    [6    /1   ]  13.63324744       -0.01325278809
                                2.698375464       -0.04699171014
                                0.8386530829      -0.03378537151
                                0.3226600698      0.2502417861
                                0.1401314882      0.5951172526
                                0.0642325139      0.2407061763
[INPUT] 1    0    [6    /1   ]  13.63324744       0.0037596966
                                2.698375464       0.0376793698
                                0.8386530829      0.1738967435
                                0.3226600698      0.4180364347
                                0.1401314882      0.4258595477
                                0.0642325139      0.1017082955
nuclear repulsion = 235.304664525402
number of shells = 90
number of NR pGTOs = 900
number of NR cGTOs = 150
basis = sto-6g
ecp = {}
CPU time:      8125.06


******** <class 'pyscf.dft.rks.RKS'> flags ********
method = RKS
initial guess = minao
damping factor = 0
level shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
DIIS start cycle = 1
DIIS space = 8
SCF tol = 1e-09
SCF gradient tol = None
max. SCF cycles = 100
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /tigress/xingz/pydmfet/examples/tmpVN2yD7
max_memory 16000 MB (current use 229 MB)
XC functionals = pbe,pbe
small_rho_cutoff = 1e-07
radial grids: Treutler-Ahlrichs (JCP 102, 346 (M4)) radial grids
becke partition: Becke, JCP, 88, 2547 (1988)
pruning grids: <function nwchem_prune at 0x2aac1c760cf8>
grids dens level: 3
symmetrized grids: False
atomic radii adjust function: <function treutler_atomic_radii_adjust at 0x2aac1c760b18>
Set gradient conv threshold to 3.16228e-05
tot grids = 393300
init E= -436.729294225853
HOMO: -0.16028653666055206 LUMO: -0.08826600489029345
-0.12370107582051597
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.999e+00
 1.999e+00 1.999e+00 1.999e+00 1.999e+00 1.670e-03 1.151e-03 1.151e-03]
entropy corr =  -0.0004395561920149549
cycle= 1 E= -436.937533810164  delta_E= -0.208  |g|=    0  |ddm|= 2.49
HOMO: -0.10498272625350327 LUMO: -0.03280978154128426
-0.06832450622030209
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.999e+00
 1.999e+00 1.999e+00 1.999e+00 1.999e+00 1.644e-03 1.129e-03 1.129e-03]
entropy corr =  -0.0004316172875723
cycle= 2 E= -436.936915696619  delta_E= 0.000618  |g|=    0  |ddm|= 0.21
HOMO: -0.10525738989006127 LUMO: -0.0331832776333964
-0.06864928947313122
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.999e+00
 1.999e+00 1.999e+00 1.999e+00 1.999e+00 1.660e-03 1.139e-03 1.139e-03]
entropy corr =  -0.0004345697474884315
cycle= 3 E= -436.938139492057  delta_E= -0.00122  |g|=    0  |ddm|= 0.12
HOMO: -0.10527231553739819 LUMO: -0.03319747564808113
-0.06866385767150208
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.999e+00
 1.999e+00 1.999e+00 1.999e+00 1.999e+00 1.660e-03 1.139e-03 1.139e-03]
entropy corr =  -0.00043452947357141246
cycle= 4 E= -436.938139933897  delta_E= -4.42e-07  |g|=    0  |ddm|= 0.00231
HOMO: -0.10527228251358979 LUMO: -0.03319750683418484
-0.06866385700983568
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.999e+00
 1.999e+00 1.999e+00 1.999e+00 1.999e+00 1.660e-03 1.139e-03 1.139e-03]
entropy corr =  -0.00043453168477416325
cycle= 5 E= -436.938139933924  delta_E= -2.63e-11  |g|=    0  |ddm|= 1.82e-05
HOMO: -0.1052722810663592 LUMO: -0.0331975054324327
-0.06866385558372534
[2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00
 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 2.000e+00 1.999e+00
 1.999e+00 1.999e+00 1.999e+00 1.999e+00 1.660e-03 1.139e-03 1.139e-03]
entropy corr =  -0.00043453168846972794
Extra cycle  E= -436.938139933923  delta_E= 5.68e-13  |g|=    0  |ddm|= 1.46e-06
converged SCF energy = -436.938139933923
e_mf =  -436.9381399339231
#INFO: **** input file is /tigress/xingz/pydmfet/examples/Be.py ****
from pydmfet import locints, sdmfet, oep, tools
from pyscf import gto, scf,dft, ao2mo,cc
import numpy as np
from pyscf.tools import molden, cubegen
import copy,time

DMguess  = None

bondlengths = np.arange(1.8, 4.1, 0.1)
energies = []

bas = 'sto-6g'

for bondlength in bondlengths:

    nat = 30
    mol = gto.Mole()
    mol.atom = []
    r = 0.5 * bondlength / np.sin(np.pi/nat)
    for i in range(nat):
        theta = i * (2*np.pi/nat)
        mol.atom.append(('Be', (r*np.cos(theta), r*np.sin(theta), 0)))

    mol.basis = bas
    mol.build(max_memory=16000, verbose=4)

    #mf = scf.RHF(mol)
    mf = dft.RKS(mol)
    mf.xc = 'pbe,pbe'
    mf.smear_sigma = 0.005
    mf.max_cycle = 100
    mf.scf()

    #P=mf.make_rdm1()
    #tools.MatPrint(P,"P_ref_ao")
    #cubegen.density(mol, "h20_dens.cube", P, nx=100, ny=100, nz=100)
    print 'e_mf = ',  mf.e_tot
    continue
    if ( True ):   
#        ENUCL = mf.mol.energy_nuc()
#        OEI   = np.dot(np.dot(mf.mo_coeff.T, mol.intor('cint1e_kin_sph') + mol.intor('cint1e_nuc_sph')), mf.mo_coeff)
#        TEI   = ao2mo.outcore.full_iofree(mol, mf.mo_coeff, compact=False).reshape(mol.nao_nr(), mol.nao_nr(), mol.nao_nr(), mol.nao_nr())
#        import chemps2
#        Energy, OneDM = chemps2.solve( ENUCL, OEI, OEI, TEI, mol.nao_nr(), mol.nelectron, mol.nao_nr(), 0.0, False )
#        print "bl =", bondlength," and energy =", Energy

        mycc = cc.CCSD(mf).run()
	et=0.0
        #et = mycc.ccsd_t()
        e_hf = mf.e_tot
        e_ccsd = e_hf + mycc.e_corr + et

        print 'e_tot = ', e_ccsd    #-4.96124910741
        
    else:
        myInts = locints.LocalIntegrals( mf, range( mol.nao_nr() ), 'meta_lowdin' )
        #myInts.loc_molden( 'hydrogen-loc.molden' )
        #myInts.TI_OK = True # Only s functions

	nbas =  mol.nao_nr()
	natoms = mol.natm

	impAtom = np.zeros([natoms], dtype=int)
	for i in range(20):
	    impAtom[i] = 1

	ghost_frag = 1-impAtom
	ghost_env = 1-ghost_frag

	mol_frag = gto.Mole()
	mol_frag.atom = tools.add_ghost(mol.atom, ghost_frag)
	mol_frag.basis = bas
	mol_frag.build(max_memory = 16000,verbose = 4)
	'''
	mf_frag = dft.RKS(mol_frag)
        mf_frag.xc = 'pbe,pbe'
        mf_frag.smear_sigma = 0.00
        mf_frag.scf()
        P_frag=mf_frag.make_rdm1()
        cubegen.density(mol_frag, "h10_dens_1.cube", P_frag, nx=100, ny=100, nz=100)
	'''

	mol_env = gto.Mole()
	mol_env.atom = tools.add_ghost(mol.atom, ghost_env)
	mol_env.basis =  bas
	mol_env.build(max_memory = 16000,verbose = 4)

	'''
	mf_env = dft.RKS(mol_env)
        mf_env.xc = 'pbe,pbe'
        mf_env.smear_sigma = 0.00
        mf_env.scf()
        P_env=mf_env.make_rdm1()
        cubegen.density(mol_env, "h10_dens_2.cube", P_env, nx=100, ny=100, nz=100)
	exit()
	'''



	aoslice = mol.aoslice_by_atom()
	impurities = np.zeros([nbas], dtype = int)
	for i in range(natoms):
	    if(impAtom[i] == 1):
		impurities[aoslice[i,2]:aoslice[i,3]] = 1

	Ne_frag = 20
	boundary_atoms = np.zeros((natoms))
	boundary_atoms[20:40] = 1.0
	#boundary_atoms[19] = -1
	boundary_atoms2 = np.zeros((natoms),dtype =int)
	#boundary_atoms2[9] = -1
	boundary_atoms2[0:20] = 1

	boundary_atoms = None
	boundary_atoms2 =None

	umat=None
	P_frag=None
	P_env=None
	params = oep.OEPparams(algorithm = '2011', opt_method = 'L-BFGS-B', \
                       ftol = 1e-11, gtol = 1e-5,diffP_tol=1e-5, outer_maxit = 200, maxit = 200,l2_lambda = 0.0, oep_print = 0)
	theDMFET = sdmfet.DMFET( mf, mol_frag, mol_env,myInts,impurities, impAtom, Ne_frag, boundary_atoms=boundary_atoms, boundary_atoms2=boundary_atoms2,\
                         umat = umat, P_frag_ao = P_frag, P_env_ao = P_env, \
                         dim_imp = nbas, dim_bath=nbas, dim_big =nbas, smear_sigma = 0.005, oep_params=params,ecw_method='hf', mf_method = mf.xc)

	umat = theDMFET.embedding_potential()

	exit()

	#write subspace orbitals
	transfo = np.dot( myInts.ao2loc, theDMFET.loc2sub )
	filename =  'hydrogen-sub.molden'
	with open( filename, 'w' ) as thefile:
            molden.header( myInts.mol, thefile )
            molden.orbital_coeff( myInts.mol, thefile, transfo )


        umat = theDMFET.embedding_potential()
	print umat
	exit()
	energy = theDMFET.correction_energy()

#INFO: ******************** input file end ********************


System: ('Linux', 'tigercpu.princeton.edu', '3.10.0-693.21.1.el7.x86_64', '#1 SMP Wed Mar 7 15:59:45 EST 2018', 'x86_64', 'x86_64')  Threads 40
Python 2.7.14 |Anaconda, Inc.| (default, Oct 16 2017, 17:29:19) 
[GCC 7.2.0]
numpy 1.14.3  scipy 1.1.0
Date: Thu Jun  7 01:40:41 2018
PySCF version 1.4.2
PySCF path  /tigress/xingz/pyscf/pyscf
GIT ORIG_HEAD e0edd131499dcc18d035a120533a8a1ddda110d4
GIT HEAD      e0edd131499dcc18d035a120533a8a1ddda110d4

[INPUT] VERBOSE 4
[INPUT] num atoms = 30
[INPUT] num electrons = 120
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT]  1 Be    18.655205855336   0.000000000000   0.000000000000 AA   35.253229863968   0.000000000000   0.000000000000 Bohr
[INPUT]  2 Be    18.247544848592   3.878635391936   0.000000000000 AA   34.482862209557   7.329558627805   0.000000000000 Bohr
[INPUT]  3 Be    17.042378570530   7.587755805487   0.000000000000 AA   32.205428009458  14.338780372450   0.000000000000 Bohr
[INPUT]  4 Be    15.092378570530  10.965254880247   0.000000000000 AA   28.520462066556  20.721328609717   0.000000000000 Bohr
[INPUT]  5 Be    12.482769205730  13.863519699609   0.000000000000 AA   23.589015074985  26.198255354773   0.000000000000 Bohr
[INPUT]  6 Be     9.327602927668  16.155882183549   0.000000000000 AA   17.626614931984  30.530192627648   0.000000000000 Bohr
[INPUT]  7 Be     5.764775642862  17.742155091545   0.000000000000 AA   10.893847134572  33.527813982577   0.000000000000 Bohr
[INPUT]  8 Be     1.950000000000  18.553010685734   0.000000000000 AA    3.684965942902  35.060108982166   0.000000000000 Bohr
[INPUT]  9 Be    -1.950000000000  18.553010685734   0.000000000000 AA   -3.684965942902  35.060108982166   0.000000000000 Bohr
[INPUT] 10 Be    -5.764775642862  17.742155091545   0.000000000000 AA  -10.893847134572  33.527813982577   0.000000000000 Bohr
[INPUT] 11 Be    -9.327602927668  16.155882183549   0.000000000000 AA  -17.626614931984  30.530192627648   0.000000000000 Bohr
[INPUT] 12 Be   -12.482769205730  13.863519699609   0.000000000000 AA  -23.589015074985  26.198255354773   0.000000000000 Bohr
[INPUT] 13 Be   -15.092378570530  10.965254880247   0.000000000000 AA  -28.520462066556  20.721328609717   0.000000000000 Bohr
[INPUT] 14 Be   -17.042378570530   7.587755805487   0.000000000000 AA  -32.205428009458  14.338780372450   0.000000000000 Bohr
[INPUT] 15 Be   -18.247544848592   3.878635391936   0.000000000000 AA  -34.482862209557   7.329558627805   0.000000000000 Bohr
[INPUT] 16 Be   -18.655205855336   0.000000000000   0.000000000000 AA  -35.253229863968   0.000000000000   0.000000000000 Bohr
[INPUT] 17 Be   -18.247544848592  -3.878635391936   0.000000000000 AA  -34.482862209557  -7.329558627805   0.000000000000 Bohr
[INPUT] 18 Be   -17.042378570530  -7.587755805487   0.000000000000 AA  -32.205428009458 -14.338780372450   0.000000000000 Bohr
[INPUT] 19 Be   -15.092378570530 -10.965254880247   0.000000000000 AA  -28.520462066556 -20.721328609717   0.000000000000 Bohr
[INPUT] 20 Be   -12.482769205730 -13.863519699609   0.000000000000 AA  -23.589015074985 -26.198255354773   0.000000000000 Bohr
[INPUT] 21 Be    -9.327602927668 -16.155882183549   0.000000000000 AA  -17.626614931984 -30.530192627648   0.000000000000 Bohr
[INPUT] 22 Be    -5.764775642862 -17.742155091545   0.000000000000 AA  -10.893847134572 -33.527813982577   0.000000000000 Bohr
[INPUT] 23 Be    -1.950000000000 -18.553010685734   0.000000000000 AA   -3.684965942902 -35.060108982166   0.000000000000 Bohr
[INPUT] 24 Be     1.950000000000 -18.553010685734   0.000000000000 AA    3.684965942902 -35.060108982166   0.000000000000 Bohr
[INPUT] 25 Be     5.764775642862 -17.742155091545   0.000000000000 AA   10.893847134572 -33.527813982577   0.000000000000 Bohr
[INPUT] 26 Be     9.327602927668 -16.155882183549   0.000000000000 AA   17.626614931984 -30.530192627648   0.000000000000 Bohr
[INPUT] 27 Be    12.482769205730 -13.863519699609   0.000000000000 AA   23.589015074985 -26.198255354773   0.000000000000 Bohr
[INPUT] 28 Be    15.092378570530 -10.965254880247   0.000000000000 AA   28.520462066556 -20.721328609717   0.000000000000 Bohr
[INPUT] 29 Be    17.042378570530  -7.587755805487   0.000000000000 AA   32.205428009458 -14.338780372450   0.000000000000 Bohr
[INPUT] 30 Be    18.247544848592  -3.878635391936   0.000000000000 AA   34.482862209557  -7.329558627805   0.000000000000 Bohr
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [6    /1   ]  312.8704937       0.00916359628
                                57.36446253       0.04936149294
                                16.0485094        0.1685383049
                                5.513096119       0.3705627997
                                2.140896553       0.4164915298
                                0.8817394283      0.1303340841
[INPUT] 0    0    [6    /1   ]  13.63324744       -0.01325278809
                                2.698375464       -0.04699171014
                                0.8386530829      -0.03378537151
                                0.3226600698      0.2502417861
                                0.1401314882      0.5951172526
                                0.0642325139      0.2407061763
[INPUT] 1    0    [6    /1   ]  13.63324744       0.0037596966
                                2.698375464       0.0376793698
                                0.8386530829      0.1738967435
                                0.3226600698      0.4180364347
                                0.1401314882      0.4258595477
                                0.0642325139      0.1017082955
nuclear repulsion = 229.271211588853
number of shells = 90
number of NR pGTOs = 900
number of NR cGTOs = 150
basis = sto-6g
ecp = {}
CPU time:      8446.02


******** <class 'pyscf.dft.rks.RKS'> flags ********
method = RKS
initial guess = minao
damping factor = 0
level shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
DIIS start cycle = 1
DIIS space = 8
SCF tol = 1e-09
SCF gradient tol = None
max. SCF cycles = 100
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /tigress/xingz/pydmfet/examples/tmpXZcgid
max_memory 16000 MB (current use 234 MB)
XC functionals = pbe,pbe
small_rho_cutoff = 1e-07
radial grids: Treutler-Ahlrichs (JCP 102, 346 (M4)) radial grids
becke partition: Becke, JCP, 88, 2547 (1988)
pruning grids: <function nwchem_prune at 0x2aac1c760cf8>
grids dens level: 3
symmetrized grids: False
atomic radii adjust function: <function treutler_atomic_radii_adjust at 0x2aac1c760b18>
Set gradient conv threshold to 3.16228e-05
tot grids = 393300
init E= -436.693293745573
HOMO: -0.16319656611002242 LUMO: -0.083265620976748
-0.12258566198576315
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    1.999]
entropy corr =  -0.00024223266620781588
cycle= 1 E= -436.910376608679  delta_E= -0.217  |g|=    0  |ddm|= 2.22
HOMO: -0.10838223633425836 LUMO: -0.028324129712836998
-0.06771220902621915
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    1.999]
entropy corr =  -0.00023830781670775928
cycle= 2 E= -436.909824784893  delta_E= 0.000552  |g|=    0  |ddm|= 0.199
HOMO: -0.1086391841831271 LUMO: -0.028663113704803053
-0.06801082098734773
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    1.999]
entropy corr =  -0.00023965102271784278
cycle= 3 E= -436.910923113941  delta_E= -0.0011  |g|=    0  |ddm|= 0.114
HOMO: -0.10865374665610061 LUMO: -0.028677162263813474
-0.06802513559603532
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    1.999]
entropy corr =  -0.00023963352734821504
cycle= 4 E= -436.910923492914  delta_E= -3.79e-07  |g|=    0  |ddm|= 0.00215
HOMO: -0.10865371430433936 LUMO: -0.02867718460056887
-0.06802513073925222
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    1.999]
entropy corr =  -0.00023963458419068228
cycle= 5 E= -436.910923492929  delta_E= -1.44e-11  |g|=    0  |ddm|= 1.35e-05
HOMO: -0.10865371356629497 LUMO: -0.028677183682423113
-0.06802512990905088
[2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.
 2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    2.    1.999]
entropy corr =  -0.00023963458153668796
Extra cycle  E= -436.910923492928  delta_E= 2.27e-13  |g|=    0  |ddm|= 1.6e-06
converged SCF energy = -436.910923492928
e_mf =  -436.91092349292836
#INFO: **** input file is /tigress/xingz/pydmfet/examples/Be.py ****
from pydmfet import locints, sdmfet, oep, tools
from pyscf import gto, scf,dft, ao2mo,cc
import numpy as np
from pyscf.tools import molden, cubegen
import copy,time

DMguess  = None

bondlengths = np.arange(1.8, 4.1, 0.1)
energies = []

bas = 'sto-6g'

for bondlength in bondlengths:

    nat = 30
    mol = gto.Mole()
    mol.atom = []
    r = 0.5 * bondlength / np.sin(np.pi/nat)
    for i in range(nat):
        theta = i * (2*np.pi/nat)
        mol.atom.append(('Be', (r*np.cos(theta), r*np.sin(theta), 0)))

    mol.basis = bas
    mol.build(max_memory=16000, verbose=4)

    #mf = scf.RHF(mol)
    mf = dft.RKS(mol)
    mf.xc = 'pbe,pbe'
    mf.smear_sigma = 0.005
    mf.max_cycle = 100
    mf.scf()

    #P=mf.make_rdm1()
    #tools.MatPrint(P,"P_ref_ao")
    #cubegen.density(mol, "h20_dens.cube", P, nx=100, ny=100, nz=100)
    print 'e_mf = ',  mf.e_tot
    continue
    if ( True ):   
#        ENUCL = mf.mol.energy_nuc()
#        OEI   = np.dot(np.dot(mf.mo_coeff.T, mol.intor('cint1e_kin_sph') + mol.intor('cint1e_nuc_sph')), mf.mo_coeff)
#        TEI   = ao2mo.outcore.full_iofree(mol, mf.mo_coeff, compact=False).reshape(mol.nao_nr(), mol.nao_nr(), mol.nao_nr(), mol.nao_nr())
#        import chemps2
#        Energy, OneDM = chemps2.solve( ENUCL, OEI, OEI, TEI, mol.nao_nr(), mol.nelectron, mol.nao_nr(), 0.0, False )
#        print "bl =", bondlength," and energy =", Energy

        mycc = cc.CCSD(mf).run()
	et=0.0
        #et = mycc.ccsd_t()
        e_hf = mf.e_tot
        e_ccsd = e_hf + mycc.e_corr + et

        print 'e_tot = ', e_ccsd    #-4.96124910741
        
    else:
        myInts = locints.LocalIntegrals( mf, range( mol.nao_nr() ), 'meta_lowdin' )
        #myInts.loc_molden( 'hydrogen-loc.molden' )
        #myInts.TI_OK = True # Only s functions

	nbas =  mol.nao_nr()
	natoms = mol.natm

	impAtom = np.zeros([natoms], dtype=int)
	for i in range(20):
	    impAtom[i] = 1

	ghost_frag = 1-impAtom
	ghost_env = 1-ghost_frag

	mol_frag = gto.Mole()
	mol_frag.atom = tools.add_ghost(mol.atom, ghost_frag)
	mol_frag.basis = bas
	mol_frag.build(max_memory = 16000,verbose = 4)
	'''
	mf_frag = dft.RKS(mol_frag)
        mf_frag.xc = 'pbe,pbe'
        mf_frag.smear_sigma = 0.00
        mf_frag.scf()
        P_frag=mf_frag.make_rdm1()
        cubegen.density(mol_frag, "h10_dens_1.cube", P_frag, nx=100, ny=100, nz=100)
	'''

	mol_env = gto.Mole()
	mol_env.atom = tools.add_ghost(mol.atom, ghost_env)
	mol_env.basis =  bas
	mol_env.build(max_memory = 16000,verbose = 4)

	'''
	mf_env = dft.RKS(mol_env)
        mf_env.xc = 'pbe,pbe'
        mf_env.smear_sigma = 0.00
        mf_env.scf()
        P_env=mf_env.make_rdm1()
        cubegen.density(mol_env, "h10_dens_2.cube", P_env, nx=100, ny=100, nz=100)
	exit()
	'''



	aoslice = mol.aoslice_by_atom()
	impurities = np.zeros([nbas], dtype = int)
	for i in range(natoms):
	    if(impAtom[i] == 1):
		impurities[aoslice[i,2]:aoslice[i,3]] = 1

	Ne_frag = 20
	boundary_atoms = np.zeros((natoms))
	boundary_atoms[20:40] = 1.0
	#boundary_atoms[19] = -1
	boundary_atoms2 = np.zeros((natoms),dtype =int)
	#boundary_atoms2[9] = -1
	boundary_atoms2[0:20] = 1

	boundary_atoms = None
	boundary_atoms2 =None

	umat=None
	P_frag=None
	P_env=None
	params = oep.OEPparams(algorithm = '2011', opt_method = 'L-BFGS-B', \
                       ftol = 1e-11, gtol = 1e-5,diffP_tol=1e-5, outer_maxit = 200, maxit = 200,l2_lambda = 0.0, oep_print = 0)
	theDMFET = sdmfet.DMFET( mf, mol_frag, mol_env,myInts,impurities, impAtom, Ne_frag, boundary_atoms=boundary_atoms, boundary_atoms2=boundary_atoms2,\
                         umat = umat, P_frag_ao = P_frag, P_env_ao = P_env, \
                         dim_imp = nbas, dim_bath=nbas, dim_big =nbas, smear_sigma = 0.005, oep_params=params,ecw_method='hf', mf_method = mf.xc)

	umat = theDMFET.embedding_potential()

	exit()

	#write subspace orbitals
	transfo = np.dot( myInts.ao2loc, theDMFET.loc2sub )
	filename =  'hydrogen-sub.molden'
	with open( filename, 'w' ) as thefile:
            molden.header( myInts.mol, thefile )
            molden.orbital_coeff( myInts.mol, thefile, transfo )


        umat = theDMFET.embedding_potential()
	print umat
	exit()
	energy = theDMFET.correction_energy()

#INFO: ******************** input file end ********************


System: ('Linux', 'tigercpu.princeton.edu', '3.10.0-693.21.1.el7.x86_64', '#1 SMP Wed Mar 7 15:59:45 EST 2018', 'x86_64', 'x86_64')  Threads 40
Python 2.7.14 |Anaconda, Inc.| (default, Oct 16 2017, 17:29:19) 
[GCC 7.2.0]
numpy 1.14.3  scipy 1.1.0
Date: Thu Jun  7 01:40:53 2018
PySCF version 1.4.2
PySCF path  /tigress/xingz/pyscf/pyscf
GIT ORIG_HEAD e0edd131499dcc18d035a120533a8a1ddda110d4
GIT HEAD      e0edd131499dcc18d035a120533a8a1ddda110d4

[INPUT] VERBOSE 4
[INPUT] num atoms = 30
[INPUT] num electrons = 120
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT]  1 Be    19.133544467011   0.000000000000   0.000000000000 AA   36.157158834838   0.000000000000   0.000000000000 Bohr
[INPUT]  2 Be    18.715430613941   3.978087581473   0.000000000000 AA   35.367038163648   7.517496028518   0.000000000000 Bohr
[INPUT]  3 Be    17.479362636441   7.782313646654   0.000000000000 AA   33.031208214829  14.706441407641   0.000000000000 Bohr
[INPUT]  4 Be    15.479362636441  11.246415261791   0.000000000000 AA   29.251755965699  21.252644727915   0.000000000000 Bohr
[INPUT]  5 Be    12.802840211005  14.218994563701   0.000000000000 AA   24.193861615369  26.870005492074   0.000000000000 Bohr
[INPUT]  6 Be     9.566772233506  16.570135572871   0.000000000000 AA   18.078579417419  31.313018079639   0.000000000000 Bohr
[INPUT]  7 Be     5.912590402935  18.197082145174   0.000000000000 AA   11.173176548279  34.387501520592   0.000000000000 Bohr
[INPUT]  8 Be     2.000000000000  19.028728908445   0.000000000000 AA    3.779452249130  35.959086135555   0.000000000000 Bohr
[INPUT]  9 Be    -2.000000000000  19.028728908445   0.000000000000 AA   -3.779452249130  35.959086135555   0.000000000000 Bohr
[INPUT] 10 Be    -5.912590402935  18.197082145174   0.000000000000 AA  -11.173176548279  34.387501520592   0.000000000000 Bohr
[INPUT] 11 Be    -9.566772233506  16.570135572871   0.000000000000 AA  -18.078579417419  31.313018079639   0.000000000000 Bohr
[INPUT] 12 Be   -12.802840211005  14.218994563701   0.000000000000 AA  -24.193861615369  26.870005492074   0.000000000000 Bohr
[INPUT] 13 Be   -15.479362636441  11.246415261791   0.000000000000 AA  -29.251755965699  21.252644727915   0.000000000000 Bohr
[INPUT] 14 Be   -17.479362636441   7.782313646654   0.000000000000 AA  -33.031208214829  14.706441407641   0.000000000000 Bohr
[INPUT] 15 Be   -18.715430613941   3.978087581473   0.000000000000 AA  -35.367038163648   7.517496028518   0.000000000000 Bohr
[INPUT] 16 Be   -19.133544467011   0.000000000000   0.000000000000 AA  -36.157158834838   0.000000000000   0.000000000000 Bohr
[INPUT] 17 Be   -18.715430613941  -3.978087581473   0.000000000000 AA  -35.367038163648  -7.517496028518   0.000000000000 Bohr
[INPUT] 18 Be   -17.479362636441  -7.782313646654   0.000000000000 AA  -33.031208214829 -14.706441407641   0.000000000000 Bohr
[INPUT] 19 Be   -15.479362636441 -11.246415261791   0.000000000000 AA  -29.251755965699 -21.252644727915   0.000000000000 Bohr
[INPUT] 20 Be   -12.802840211005 -14.218994563701   0.000000000000 AA  -24.193861615369 -26.870005492074   0.000000000000 Bohr
[INPUT] 21 Be    -9.566772233506 -16.570135572871   0.000000000000 AA  -18.078579417419 -31.313018079639   0.000000000000 Bohr
[INPUT] 22 Be    -5.912590402935 -18.197082145174   0.000000000000 AA  -11.173176548279 -34.387501520592   0.000000000000 Bohr
[INPUT] 23 Be    -2.000000000000 -19.028728908445   0.000000000000 AA   -3.779452249130 -35.959086135555   0.000000000000 Bohr
[INPUT] 24 Be     2.000000000000 -19.028728908445   0.000000000000 AA    3.779452249130 -35.959086135555   0.000000000000 Bohr
[INPUT] 25 Be     5.912590402935 -18.197082145174   0.000000000000 AA   11.173176548279 -34.387501520592   0.000000000000 Bohr
[INPUT] 26 Be     9.566772233506 -16.570135572871   0.000000000000 AA   18.078579417419 -31.313018079639   0.000000000000 Bohr
[INPUT] 27 Be    12.802840211005 -14.218994563701   0.000000000000 AA   24.193861615369 -26.870005492074   0.000000000000 Bohr
[INPUT] 28 Be    15.479362636441 -11.246415261791   0.000000000000 AA   29.251755965699 -21.252644727915   0.000000000000 Bohr
[INPUT] 29 Be    17.479362636441  -7.782313646654   0.000000000000 AA   33.031208214829 -14.706441407641   0.000000000000 Bohr
[INPUT] 30 Be    18.715430613941  -3.978087581473   0.000000000000 AA   35.367038163648  -7.517496028518   0.000000000000 Bohr
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [6    /1   ]  312.8704937       0.00916359628
                                57.36446253       0.04936149294
                                16.0485094        0.1685383049
                                5.513096119       0.3705627997
                                2.140896553       0.4164915298
                                0.8817394283      0.1303340841
[INPUT] 0    0    [6    /1   ]  13.63324744       -0.01325278809
                                2.698375464       -0.04699171014
                                0.8386530829      -0.03378537151
                                0.3226600698      0.2502417861
                                0.1401314882      0.5951172526
                                0.0642325139      0.2407061763
[INPUT] 1    0    [6    /1   ]  13.63324744       0.0037596966
                                2.698375464       0.0376793698
                                0.8386530829      0.1738967435
                                0.3226600698      0.4180364347
                                0.1401314882      0.4258595477
                                0.0642325139      0.1017082955
nuclear repulsion = 223.539431299132
number of shells = 90
number of NR pGTOs = 900
number of NR cGTOs = 150
basis = sto-6g
ecp = {}
CPU time:      8764.38


******** <class 'pyscf.dft.rks.RKS'> flags ********
method = RKS
initial guess = minao
damping factor = 0
level shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
DIIS start cycle = 1
DIIS space = 8
SCF tol = 1e-09
SCF gradient tol = None
max. SCF cycles = 100
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /tigress/xingz/pydmfet/examples/tmpKECt4Q
max_memory 16000 MB (current use 230 MB)
XC functionals = pbe,pbe
small_rho_cutoff = 1e-07
radial grids: Treutler-Ahlrichs (JCP 102, 346 (M4)) radial grids
becke partition: Becke, JCP, 88, 2547 (1988)
pruning grids: <function nwchem_prune at 0x2aac1c760cf8>
grids dens level: 3
symmetrized grids: False
atomic radii adjust function: <function treutler_atomic_radii_adjust at 0x2aac1c760b18>
Set gradient conv threshold to 3.16228e-05
tot grids = 393300
init E= -436.66353751037
HOMO: -0.16566947444154584 LUMO: -0.07850149083026799
-0.12137400704865518
[2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2.
 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2.
 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2.]
entropy corr =  -0.00014013142363440776
cycle= 1 E= -436.888406832508  delta_E= -0.225  |g|=    0  |ddm|= 1.97
HOMO: -0.11133879232708956 LUMO: -0.024049262963292566
-0.066988265271609
[2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2.
 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2.
 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2.]
entropy corr =  -0.00013791477849055787
cycle= 2 E= -436.887913836618  delta_E= 0.000493  |g|=    0  |ddm|= 0.19
HOMO: -0.1115787593811186 LUMO: -0.024357555828890914
-0.06726298448094381
[2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2.
 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2.
 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2.]
entropy corr =  -0.00013855063131829273
cycle= 3 E= -436.888901825407  delta_E= -0.000988  |g|=    0  |ddm|= 0.109
HOMO: -0.11159264660570646 LUMO: -0.02437102308547361
-0.06727667398021596
[2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2.
 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2.
 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2.]
entropy corr =  -0.0001385419525923963
cycle= 4 E= -436.888902157856  delta_E= -3.32e-07  |g|=    0  |ddm|= 0.00202
HOMO: -0.11159260900259856 LUMO: -0.02437103275886866
-0.06727666003595752
[2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2.
 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2.
 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2.]
entropy corr =  -0.0001385424876081958
cycle= 5 E= -436.888902157863  delta_E= -6.82e-12  |g|=    0  |ddm|= 9.47e-06
HOMO: -0.11159260877420506 LUMO: -0.02437103222831112
-0.06727665965506824
[2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2.
 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2.
 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2. 2.]
entropy corr =  -0.00013854248452357343
Extra cycle  E= -436.888902157864  delta_E= -9.09e-13  |g|=    0  |ddm|= 1.42e-06
converged SCF energy = -436.888902157864
e_mf =  -436.88890215786375
